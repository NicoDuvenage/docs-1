<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2647.2px" preserveAspectRatio="none" style="width:1297px;height:2647px;" version="1.1" viewBox="0 0 1297 2647" width="1297.6px" zoomAndPan="magnify"><defs><filter height="300%" id="fjwz84wgnar5s" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="1.600000023841858"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="3.200000047683716" dy="3.200000047683716" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="11.2" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="232" x="533.6" y="18.8281">1.3.1 Prepare Position Handler Consume</text><rect fill="#FFFFE0" height="2610.9375" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="1060" x="31.2" y="27.5906"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80.8" x="520.8" y="37.6453">Central Service</text><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="2428.6485" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="78" y="116.2109"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="24" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="230.8" y="1829.1094"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="24" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="348" y="2520.8594"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="1308.5906" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="452.8" y="152.4594"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="141.4906" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="900.8" y="1951.6672"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="50.0969" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1045.6" y="229.2047"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="50.0969" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1045.6" y="466.0344"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="24" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1045.6" y="585.6766"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="86.8422" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1045.6" y="672.0219"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="24" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1045.6" y="1111.2813"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="24" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1045.6" y="1209.875"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="24" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1045.6" y="2019.061"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="2435.5453" style="stroke: #000000; stroke-width: 1.600000023841858;" width="1278.4" x="10.4" y="121.8109"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="1273.9422" style="stroke: #000000; stroke-width: 1.600000023841858;" width="870" x="410.8" y="164.7078"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="1078.4578" style="stroke: #000000; stroke-width: 1.600000023841858;" width="1107.2" x="18.4" y="1473.2985"/><rect fill="#FFFFFF" height="691.75" style="stroke: none; stroke-width: 0.800000011920929;" width="1107.2" x="18.4" y="1860.0063"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="190.7875" style="stroke: #000000; stroke-width: 1.600000023841858;" width="1091.2" x="26.4" y="1909.0188"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 5.0,5.0;" x1="81.6" x2="81.6" y1="108.2109" y2="2570.9563"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 5.0,5.0;" x1="234.8" x2="234.8" y1="108.2109" y2="2570.9563"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 5.0,5.0;" x1="351.6" x2="351.6" y1="108.2109" y2="2570.9563"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 5.0,5.0;" x1="456.4" x2="456.4" y1="108.2109" y2="2570.9563"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 5.0,5.0;" x1="904.4" x2="904.4" y1="108.2109" y2="2570.9563"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 5.0,5.0;" x1="1049.6" x2="1049.6" y1="108.2109" y2="2570.9563"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="90.4" x="34.4" y="105.8484">Position Handler</text><ellipse cx="82" cy="82.2203" fill="#FEFECE" filter="url(#fjwz84wgnar5s)" rx="9.6" ry="9.6" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><polygon fill="#A80036" points="78.8,72.6203,83.6,68.6203,82,72.6203,83.6,76.6203,78.8,72.6203" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="90.4" x="34.4" y="2580.9844">Position Handler</text><ellipse cx="82" cy="2596.1469" fill="#FEFECE" filter="url(#fjwz84wgnar5s)" rx="9.6" ry="9.6" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><polygon fill="#A80036" points="78.8,2586.5469,83.6,2582.5469,82,2586.5469,83.6,2590.5469,78.8,2586.5469" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><rect fill="#FEFECE" filter="url(#fjwz84wgnar5s)" height="24.3906" style="stroke: #A80036; stroke-width: 1.2000000178813934;" width="94.4" x="187.6" y="76.6203"/><rect fill="#FEFECE" filter="url(#fjwz84wgnar5s)" height="24.3906" style="stroke: #A80036; stroke-width: 1.2000000178813934;" width="94.4" x="184.4" y="79.8203"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="83.2" x="190" y="96.2484">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#fjwz84wgnar5s)" height="24.3906" style="stroke: #A80036; stroke-width: 1.2000000178813934;" width="94.4" x="187.6" y="2570.1563"/><rect fill="#FEFECE" filter="url(#fjwz84wgnar5s)" height="24.3906" style="stroke: #A80036; stroke-width: 1.2000000178813934;" width="94.4" x="184.4" y="2573.3563"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="83.2" x="190" y="2589.7844">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#fjwz84wgnar5s)" height="24.3906" style="stroke: #A80036; stroke-width: 1.2000000178813934;" width="111.2" x="296.4" y="76.6203"/><rect fill="#FEFECE" filter="url(#fjwz84wgnar5s)" height="24.3906" style="stroke: #A80036; stroke-width: 1.2000000178813934;" width="111.2" x="293.2" y="79.8203"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="100" x="298.8" y="96.2484">Notification-Topic</text><rect fill="#FEFECE" filter="url(#fjwz84wgnar5s)" height="24.3906" style="stroke: #A80036; stroke-width: 1.2000000178813934;" width="111.2" x="296.4" y="2570.1563"/><rect fill="#FEFECE" filter="url(#fjwz84wgnar5s)" height="24.3906" style="stroke: #A80036; stroke-width: 1.2000000178813934;" width="111.2" x="293.2" y="2573.3563"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="100" x="298.8" y="2589.7844">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="44" x="432.4" y="79.4672">Position</text><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="71.2" x="418.8" y="92.6578">Management</text><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="38.4" x="435.2" y="105.8484">Facade</text><ellipse cx="456.8" cy="55.8391" fill="#FEFECE" filter="url(#fjwz84wgnar5s)" rx="9.6" ry="9.6" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><line style="stroke: #A80036; stroke-width: 1.600000023841858;" x1="447.2" x2="466.4" y1="67.0391" y2="67.0391"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="44" x="432.4" y="2580.9844">Position</text><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="71.2" x="418.8" y="2594.175">Management</text><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="38.4" x="435.2" y="2607.3657">Facade</text><ellipse cx="456.8" cy="2622.5282" fill="#FEFECE" filter="url(#fjwz84wgnar5s)" rx="9.6" ry="9.6" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><line style="stroke: #A80036; stroke-width: 1.600000023841858;" x1="447.2" x2="466.4" y1="2633.7282" y2="2633.7282"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="74.4" x="865.2" y="105.8484">Transfer DAO</text><ellipse cx="904.8" cy="82.2203" fill="#FEFECE" filter="url(#fjwz84wgnar5s)" rx="9.6" ry="9.6" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><line style="stroke: #A80036; stroke-width: 1.600000023841858;" x1="895.2" x2="914.4" y1="93.4203" y2="93.4203"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="74.4" x="865.2" y="2580.9844">Transfer DAO</text><ellipse cx="904.8" cy="2596.1469" fill="#FEFECE" filter="url(#fjwz84wgnar5s)" rx="9.6" ry="9.6" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><line style="stroke: #A80036; stroke-width: 1.600000023841858;" x1="895.2" x2="914.4" y1="2607.3469" y2="2607.3469"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="72" x="1011.2" y="105.8484">Central Store</text><path d="M1035.2,66.2203 C1035.2,58.2203 1049.6,58.2203 1049.6,58.2203 C1049.6,58.2203 1064,58.2203 1064,66.2203 L1064,87.0203 C1064,95.0203 1049.6,95.0203 1049.6,95.0203 C1049.6,95.0203 1035.2,95.0203 1035.2,87.0203 L1035.2,66.2203 " fill="#FEFECE" filter="url(#fjwz84wgnar5s)" style="stroke: #000000; stroke-width: 1.2000000178813934;"/><path d="M1035.2,66.2203 C1035.2,74.2203 1049.6,74.2203 1049.6,74.2203 C1049.6,74.2203 1064,74.2203 1064,66.2203 " fill="none" style="stroke: #000000; stroke-width: 1.2000000178813934;"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="72" x="1011.2" y="2580.9844">Central Store</text><path d="M1035.2,2591.3469 C1035.2,2583.3469 1049.6,2583.3469 1049.6,2583.3469 C1049.6,2583.3469 1064,2583.3469 1064,2591.3469 L1064,2612.1469 C1064,2620.1469 1049.6,2620.1469 1049.6,2620.1469 C1049.6,2620.1469 1035.2,2620.1469 1035.2,2612.1469 L1035.2,2591.3469 " fill="#FEFECE" filter="url(#fjwz84wgnar5s)" style="stroke: #000000; stroke-width: 1.2000000178813934;"/><path d="M1035.2,2591.3469 C1035.2,2599.3469 1049.6,2599.3469 1049.6,2599.3469 C1049.6,2599.3469 1064,2599.3469 1064,2591.3469 " fill="none" style="stroke: #000000; stroke-width: 1.2000000178813934;"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="2428.6485" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="78" y="116.2109"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="24" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="230.8" y="1829.1094"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="24" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="348" y="2520.8594"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="1308.5906" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="452.8" y="152.4594"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="141.4906" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="900.8" y="1951.6672"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="50.0969" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1045.6" y="229.2047"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="50.0969" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1045.6" y="466.0344"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="24" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1045.6" y="585.6766"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="86.8422" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1045.6" y="672.0219"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="24" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1045.6" y="1111.2813"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="24" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1045.6" y="1209.875"/><rect fill="#FFFFFF" filter="url(#fjwz84wgnar5s)" height="24" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1045.6" y="2019.061"/><path d="M10.4,121.8109 L234.4,121.8109 L234.4,127.4109 L226.4,135.4109 L10.4,135.4109 L10.4,121.8109 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.800000011920929;"/><rect fill="none" height="2435.5453" style="stroke: #000000; stroke-width: 1.600000023841858;" width="1278.4" x="10.4" y="121.8109"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="188" x="22.4" y="132.6656">Prepare Position Handler Consume</text><polygon fill="#A80036" points="443.2,149.2594,451.2,152.4594,443.2,155.6594,446.4,152.4594" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="86" x2="448" y1="152.4594" y2="152.4594"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="91.6" y="148.9141">1</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="171.2" x="102" y="148.9141">Request transfers to be processed</text><path d="M410.8,164.7078 L542.8,164.7078 L542.8,170.3078 L534.8,178.3078 L410.8,178.3078 L410.8,164.7078 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.800000011920929;"/><rect fill="none" height="1273.9422" style="stroke: #000000; stroke-width: 1.600000023841858;" width="870" x="410.8" y="164.7078"/><text fill="#0000FF" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="96" x="422.8" y="175.5625">DB TRANSACTION</text><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="460.8" x2="494.4" y1="195.6047" y2="195.6047"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="494.4" x2="494.4" y1="195.6047" y2="206.0047"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="461.6" x2="494.4" y1="206.0047" y2="206.0047"/><polygon fill="#A80036" points="469.6,202.8047,461.6,206.0047,469.6,209.2047,466.4,206.0047" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="466.4" y="191.8109">2</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="418.4" x="476.8" y="191.8109">Loop through batch and build list of transferIds and calculate sumTransfersInBatch</text><polygon fill="#A80036" points="1036,226.0047,1044,229.2047,1036,232.4047,1039.2,229.2047" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="460.8" x2="1040.8" y1="229.2047" y2="229.2047"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="466.4" y="225.6594">3</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="368.8" x="476.8" y="225.6594">Retrieve current state of all transfers in array from DB with select whereIn</text><polygon fill="#FFFFE0" filter="url(#fjwz84wgnar5s)" points="996.8,239.8531,1101.6,239.8531,1109.6,248.6531,1101.6,258.2531,996.8,258.2531,988.8,248.6531,996.8,239.8531" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="101.6" x="998.4" y="253.1078">transferStateChange</text><polygon fill="#A80036" points="469.6,276.1016,461.6,279.3016,469.6,282.5016,466.4,279.3016" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 2.0,2.0;" x1="464.8" x2="1048.8" y1="279.3016" y2="279.3016"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="474.4" y="275.7563">4</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="265.6" x="484.8" y="275.7563">Return current state of all selected transfers from DB</text><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="460.8" x2="494.4" y1="315.2469" y2="315.2469"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="494.4" x2="494.4" y1="315.2469" y2="325.6469"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="461.6" x2="494.4" y1="325.6469" y2="325.6469"/><polygon fill="#A80036" points="469.6,322.4469,461.6,325.6469,469.6,328.8469,466.4,325.6469" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="466.4" y="305.3289">5</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="418.4" x="476.8" y="299.2047">Validate current state (transferStateChange.transferStateId == 'RECEIVED_PREPARE')</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="58.4" x="476.8" y="311.4531">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="25.6" x="538.4" y="311.4531">2001</text><path d="M464.8,336.0469 L464.8,441.6469 L886.4,441.6469 L886.4,344.0469 L878.4,336.0469 L464.8,336.0469 " fill="#D3D3D3" filter="url(#fjwz84wgnar5s)" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><path d="M878.4,336.0469 L878.4,344.0469 L886.4,344.0469 L878.4,336.0469 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="86.4" x="469.6" y="350.1016">transferAmount</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="133.6" x="559.2" y="350.1016">= payload.amount.amount</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="82.4" x="469.6" y="362.35">currentPosition</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="136" x="555.2" y="362.35">= participantPosition.value</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90.4" x="469.6" y="374.5984">reservedPosition</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="224" x="563.2" y="374.5984">= participantPosition.{original}reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="88.8" x="469.6" y="386.8469">effectivePosition</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="185.6" x="561.6" y="386.8469">= currentPosition + reservedPosition</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="66.4" x="469.6" y="399.0953">heldPosition</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="215.2" x="539.2" y="399.0953">= effectivePosition + sumTransfersInBatch</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="91.2" x="469.6" y="411.3438">availablePosition</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="172" x="564" y="411.3438">= NetDebitCap - effectivePosition</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="115.2" x="469.6" y="423.5922">sumTransfersInBatch</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="229.6" x="588" y="423.5922">= SUM amount against each Transfer in batch</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="77.6" x="469.6" y="435.8406">sumRESERVED</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="324" x="550.4" y="435.8406">= SUM of transfers that have met rule criteria and processed = 0</text><polygon fill="#A80036" points="1036,462.8344,1044,466.0344,1036,469.2344,1039.2,466.0344" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="460.8" x2="1040.8" y1="466.0344" y2="466.0344"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="466.4" y="462.4891">6</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="274.4" x="476.8" y="462.4891">Select effectivePosition FOR UPDATE from DB for Payer</text><polygon fill="#FFFFE0" filter="url(#fjwz84wgnar5s)" points="1000,476.6828,1098.4,476.6828,1106.4,485.4828,1098.4,495.0828,1000,495.0828,992,485.4828,1000,476.6828" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="95.2" x="1001.6" y="489.9375">participantPosition</text><polygon fill="#A80036" points="469.6,512.9313,461.6,516.1313,469.6,519.3313,466.4,516.1313" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 2.0,2.0;" x1="464.8" x2="1048.8" y1="516.1313" y2="516.1313"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="474.4" y="512.5859">7</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="405.6" x="484.8" y="512.5859">Return effectivePosition (currentPosition and reservedPosition) from DB for Payer</text><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="460.8" x2="494.4" y1="552.0766" y2="552.0766"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="494.4" x2="494.4" y1="552.0766" y2="562.4766"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="461.6" x2="494.4" y1="562.4766" y2="562.4766"/><polygon fill="#A80036" points="469.6,559.2766,461.6,562.4766,469.6,565.6766,466.4,562.4766" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="466.4" y="542.1586">8</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="202.4" x="476.8" y="536.0344">Increment reservedValue to heldPosition</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="267.2" x="476.8" y="548.2828">(reservedValue = reservedPosition + transferAmount)</text><polygon fill="#A80036" points="1036,582.4766,1044,585.6766,1036,588.8766,1039.2,585.6766" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="460.8" x2="1040.8" y1="585.6766" y2="585.6766"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="466.4" y="582.1313">9</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="106.4" x="476.8" y="582.1313">Persist reservedValue</text><polygon fill="#FFFFE0" filter="url(#fjwz84wgnar5s)" points="938.4,620.325,1160,620.325,1168,635.525,1160,650.725,938.4,650.725,930.4,635.525,938.4,620.325" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="40" x="940" y="633.5797">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101.6" x="983.2" y="633.5797">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="218.4" x="940" y="645.8281">SET reservedValue += sumTransfersInBatch</text><polygon fill="#A80036" points="1036,668.8219,1044,672.0219,1036,675.2219,1039.2,672.0219" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="460.8" x2="1040.8" y1="672.0219" y2="672.0219"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="466.4" y="668.4766">10</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="220.8" x="484" y="668.4766">Request position limits for Payer Participant</text><polygon fill="#FFFFE0" filter="url(#fjwz84wgnar5s)" points="896,682.6703,1203.2,682.6703,1211.2,709.8703,1203.2,737.8703,896,737.8703,888,709.8703,896,682.6703" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="28.8" x="897.6" y="695.925">FROM</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="86.4" x="929.6" y="695.925">participantLimit</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="278.4" x="897.6" y="708.1734">WHERE participantLimit.limitTypeId = 'NET-DEBIT-CAP'</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="275.2" x="897.6" y="720.4219">AND participantLimit.participantId = payload.payerFsp</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="304" x="897.6" y="732.6703">AND participantLimit.currencyId = payload.amount.currency</text><polygon fill="#A80036" points="469.6,755.6641,461.6,758.8641,469.6,762.0641,466.4,758.8641" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 2.0,2.0;" x1="464.8" x2="1048.8" y1="758.8641" y2="758.8641"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="474.4" y="755.3188">11</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="109.6" x="492" y="755.3188">Return position limits</text><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="460.8" x2="494.4" y1="782.5609" y2="782.5609"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="494.4" x2="494.4" y1="782.5609" y2="792.9609"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="461.6" x2="494.4" y1="792.9609" y2="792.9609"/><polygon fill="#A80036" points="469.6,789.7609,461.6,792.9609,469.6,796.1609,466.4,792.9609" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="466.4" y="778.7672">12</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="484" y="778.7672">latestPosition</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="322.4" x="559.2" y="778.7672">= payload.amount.amount + currentPosition + reservedPosition</text><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="460.8" x2="494.4" y1="828.6578" y2="828.6578"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="494.4" x2="494.4" y1="828.6578" y2="839.0578"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="461.6" x2="494.4" y1="839.0578" y2="839.0578"/><polygon fill="#A80036" points="469.6,835.8578,461.6,839.0578,469.6,842.2578,466.4,839.0578" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="466.4" y="818.7399">13</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="91.2" x="484" y="812.6156">availablePosition</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="181.6" x="578.4" y="812.6156">= netDebitCap - effectivePosition =</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="259.2" x="487.2" y="824.8641">= netDebitCap - currentPosition - reservedPosition</text><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="460.8" x2="494.4" y1="874.7547" y2="874.7547"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="494.4" x2="494.4" y1="874.7547" y2="885.1547"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="461.6" x2="494.4" y1="885.1547" y2="885.1547"/><polygon fill="#A80036" points="469.6,881.9547,461.6,885.1547,469.6,888.3547,466.4,885.1547" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="466.4" y="864.8367">14</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="229.6" x="484" y="858.7125">Validate availablePosition &gt;= transferAmount</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="58.4" x="484" y="870.961">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="25.6" x="545.6" y="870.961">4001</text><path d="M464.8,895.5547 L464.8,1086.7547 L1086.4,1086.7547 L1086.4,903.5547 L1078.4,895.5547 L464.8,895.5547 " fill="#D3D3D3" filter="url(#fjwz84wgnar5s)" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><path d="M1078.4,895.5547 L1078.4,903.5547 L1086.4,903.5547 L1078.4,895.5547 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="111.2" x="469.6" y="909.6094">01: sumRESERVED = 0</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="268" x="469.6" y="921.8578">02: preparedTransfer.positionValue = currentPosition</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="228" x="469.6" y="934.1063">02: foreach preparedTransfer in transferBatch</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="264" x="482.4" y="946.3547">03: if availablePosition &gt;= preparedTransfer.amount</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="204.8" x="495.2" y="958.6031">04: preparedTransfer.state = "RESERVED"</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="252" x="495.2" y="970.8516">05: availablePosition -= preparedTransfer.amount</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="240" x="495.2" y="983.1">06: sumRESERVED += preparedTransfer.amount</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="326.4" x="495.2" y="995.3485">07: preparedTransfer.positionValue += preparedTransfer.amount</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="579.2" x="495.2" y="1007.5969">08: preparedTransfer.positionReservedValue = reservedPosition + sumTransfersInBatch - preparedTransfer.amount</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="39.2" x="482.4" y="1019.8453">09: else</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="202.4" x="495.2" y="1032.0938">10: preparedTransfer.state = "ABORTED"</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="535.2" x="495.2" y="1044.3422">11: preparedTransfer.reason = "Net Debit Cap exceeded by this request at this time, please try again later"</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="579.2" x="495.2" y="1056.5906">12: preparedTransfer.positionReservedValue = reservedPosition + sumTransfersInBatch - preparedTransfer.amount</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="48" x="482.4" y="1068.8391">13: end if</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="78.4" x="469.6" y="1081.0875">14: end foreach</text><polygon fill="#A80036" points="1036,1108.0813,1044,1111.2813,1036,1114.4813,1039.2,1111.2813" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="460.8" x2="1040.8" y1="1111.2813" y2="1111.2813"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="466.4" y="1107.736">15</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="109.6" x="484" y="1107.736">Persist latest position</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29.6" x="596.8" y="1107.736">value</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="18.4" x="629.6" y="1107.736">and</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78.4" x="651.2" y="1107.736">reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="74.4" x="732.8" y="1107.736">to DB for Payer</text><polygon fill="#FFFFE0" filter="url(#fjwz84wgnar5s)" points="949.6,1145.9297,1148.8,1145.9297,1156.8,1166.7297,1148.8,1188.3297,949.6,1188.3297,941.6,1166.7297,949.6,1145.9297" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="40" x="951.2" y="1159.1844">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101.6" x="994.4" y="1159.1844">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="144" x="951.2" y="1171.4328">SET value += sumRESERVED,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="196" x="951.2" y="1183.6813">reservedValue -= sumTransfersInBatch</text><polygon fill="#A80036" points="1036,1206.675,1044,1209.875,1036,1213.075,1039.2,1209.875" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="460.8" x2="1040.8" y1="1209.875" y2="1209.875"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="466.4" y="1206.3297">16</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="267.2" x="484" y="1206.3297">Persist transfer state and participant position change</text><polygon fill="#FFFFE0" filter="url(#fjwz84wgnar5s)" points="834.4,1244.5235,1264.8,1244.5235,1272.8,1338.9235,1264.8,1434.1235,834.4,1434.1235,826.4,1338.9235,834.4,1244.5235" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="427.2" x="836" y="1257.7781">select for update from transfer table where transferId in ([transferBatch.transferId,...])</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="265.6" x="836" y="1270.0266">build list of transferStateChanges from transferBatch</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="212.8" x="836" y="1282.275">bulk insert for all transferStateChanges</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="0" x="839.2" y="1294.5235"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="409.6" x="836" y="1306.7719">select all transferStateChanges whereIn transferId in ([transferBatch.transferId,...])</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="319.2" x="836" y="1319.0203">Loop through result and build list of participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="0" x="839.2" y="1331.2688"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="349.6" x="836" y="1343.5172">SET transferStateChangeId = preparedTransfer.transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="316" x="836" y="1355.7656">participantPositionId = preparedTransfer.participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="201.6" x="836" y="1368.0141">value = preparedTransfer.positionValue,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="286.4" x="836" y="1380.2625">reservedValue = preparedTransfer.positionReservedValue</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="0" x="839.2" y="1392.511"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="66.4" x="836" y="1404.7594">batch INSERT</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="143.2" x="905.6" y="1404.7594">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="0" x="839.2" y="1417.0078"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="0" x="839.2" y="1429.2563"/><polygon fill="#A80036" points="94.8,1457.85,86.8,1461.05,94.8,1464.25,91.6,1461.05" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 2.0,2.0;" x1="90" x2="456" y1="1461.05" y2="1461.05"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="99.6" y="1457.5047">17</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="296" x="117.2" y="1457.5047">Return a map of transferIds and their transferStateChanges</text><path d="M18.4,1473.2985 L68,1473.2985 L68,1478.8985 L60,1486.8985 L18.4,1486.8985 L18.4,1473.2985 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.800000011920929;"/><rect fill="none" height="1078.4578" style="stroke: #000000; stroke-width: 1.600000023841858;" width="1107.2" x="18.4" y="1473.2985"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="13.6" x="30.4" y="1484.1531">alt</text><text fill="#000000" font-family="sans-serif" font-size="8.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="245.6" x="80" y="1483.4063">[Calculate &amp; Validate Latest Position Prepare (success)]</text><path d="M89.6,1491.1469 L89.6,1792.7469 L299.2,1792.7469 L299.2,1499.1469 L291.2,1491.1469 L89.6,1491.1469 " fill="#FFFF00" filter="url(#fjwz84wgnar5s)" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><path d="M291.2,1491.1469 L291.2,1499.1469 L299.2,1499.1469 L291.2,1491.1469 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="46.4" x="94.4" y="1505.2016">Message:</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="94.4" y="1517.45">{</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="166.4" x="107.2" y="1529.6985">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="180" x="107.2" y="1541.9469">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="168" x="107.2" y="1554.1953">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="111.2" x="107.2" y="1566.4438">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="48" x="107.2" y="1578.6922">content: {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="144.8" x="120" y="1590.9406">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="144" x="120" y="1603.1891">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="6.4" x="107.2" y="1615.4375">},</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="56" x="107.2" y="1627.686">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="36.8" x="120" y="1639.9344">event: {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="57.6" x="132.8" y="1652.1828">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="152.8" x="132.8" y="1664.4313">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="70.4" x="132.8" y="1676.6797">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="78.4" x="132.8" y="1688.9282">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="127.2" x="132.8" y="1701.1766">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="34.4" x="132.8" y="1713.425">state: {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="88.8" x="145.6" y="1725.6735">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="36.8" x="145.6" y="1737.9219">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="132.8" y="1750.1703">}</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="120" y="1762.4188">}</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="107.2" y="1774.6672">}</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="94.4" y="1786.9157">}</text><polygon fill="#A80036" points="221.2,1825.9094,229.2,1829.1094,221.2,1832.3094,224.4,1829.1094" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="86" x2="226" y1="1829.1094" y2="1829.1094"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="91.6" y="1819.6883">18</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="112" x="109.2" y="1813.5641">Publish Transfer event</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="58.4" x="109.2" y="1825.8125">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="25.6" x="170.8" y="1825.8125">2003</text><line style="stroke: #000000; stroke-width: 0.800000011920929; stroke-dasharray: 2.0,2.0;" x1="18.4" x2="1125.6" y1="1860.8063" y2="1860.8063"/><text fill="#000000" font-family="sans-serif" font-size="8.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="240.8" x="22.4" y="1869.3141">[Calculate &amp; Validate Latest Position Prepare (failure)]</text><path d="M89.6,1875.9703 L89.6,1895.9703 L195.2,1895.9703 L195.2,1883.9703 L187.2,1875.9703 L89.6,1875.9703 " fill="#FF0000" filter="url(#fjwz84wgnar5s)" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><path d="M187.2,1875.9703 L187.2,1883.9703 L195.2,1883.9703 L187.2,1875.9703 " fill="#FF0000" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="88.8" x="94.4" y="1890.025">Validation failure!</text><path d="M26.4,1909.0188 L467.2,1909.0188 L467.2,1914.6188 L459.2,1922.6188 L26.4,1922.6188 L26.4,1909.0188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.800000011920929;"/><rect fill="none" height="190.7875" style="stroke: #000000; stroke-width: 1.600000023841858;" width="1091.2" x="26.4" y="1909.0188"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="404.8" x="38.4" y="1919.8735">Persist Transfer State (with transferState='ABORTED' on position check fail)</text><polygon fill="#A80036" points="891.2,1948.4672,899.2,1951.6672,891.2,1954.8672,894.4,1951.6672" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="86" x2="896" y1="1951.6672" y2="1951.6672"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="91.6" y="1942.2461">19</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="133.6" x="109.2" y="1936.1219">Request to persist transfer</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="58.4" x="109.2" y="1948.3703">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="25.6" x="170.8" y="1948.3703">2003</text><path d="M89.6,1962.5641 L89.6,1994.5641 L638.4,1994.5641 L638.4,1970.5641 L630.4,1962.5641 L89.6,1962.5641 " fill="#D3D3D3" filter="url(#fjwz84wgnar5s)" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><path d="M630.4,1962.5641 L630.4,1970.5641 L638.4,1970.5641 L630.4,1962.5641 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="202.4" x="94.4" y="1976.6188">transferStateChange.state = "ABORTED",</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="532" x="94.4" y="1988.8672">transferStateChange.reason = "Net Debit Cap exceeded by this request at this time, please try again later"</text><polygon fill="#A80036" points="1036,2015.861,1044,2019.061,1036,2022.261,1039.2,2019.061" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="908.8" x2="1040.8" y1="2019.061" y2="2019.061"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="914.4" y="2015.5157">20</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="104" x="932" y="2015.5157">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#fjwz84wgnar5s)" points="996.8,2053.7094,1101.6,2053.7094,1109.6,2062.5094,1101.6,2072.1094,996.8,2072.1094,988.8,2062.5094,996.8,2053.7094" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="101.6" x="998.4" y="2066.9641">transferStateChange</text><polygon fill="#A80036" points="94.8,2089.9578,86.8,2093.1578,94.8,2096.3578,91.6,2093.1578" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 2.0,2.0;" x1="90" x2="904" y1="2093.1578" y2="2093.1578"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="99.6" y="2089.6125">21</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="76" x="117.2" y="2089.6125">Return success</text><path d="M89.6,2109.4063 L89.6,2484.6063 L417.6,2484.6063 L417.6,2117.4063 L409.6,2109.4063 L89.6,2109.4063 " fill="#FFFF00" filter="url(#fjwz84wgnar5s)" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><path d="M409.6,2109.4063 L409.6,2117.4063 L417.6,2117.4063 L409.6,2109.4063 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="46.4" x="94.4" y="2123.461">Message:</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="94.4" y="2135.7094">{</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="166.4" x="107.2" y="2147.9578">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="109.6" x="107.2" y="2160.2063">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="166.4" x="107.2" y="2172.4547">to: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="111.2" x="107.2" y="2184.7032">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="48" x="107.2" y="2196.9516">content: {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="144.8" x="120" y="2209.2">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="48.8" x="120" y="2221.4485">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="100.8" x="132.8" y="2233.6969">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="92.8" x="145.6" y="2245.9453">"errorCode": 4001,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="260" x="145.6" y="2258.1938">"errorDescription": "Payer FSP insufficient liquidity",</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="252" x="145.6" y="2270.4422">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="120" y="2282.6907">}</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="6.4" x="107.2" y="2294.9391">},</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="56" x="107.2" y="2307.1875">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="36.8" x="120" y="2319.436">event: {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="57.6" x="132.8" y="2331.6844">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="152.8" x="132.8" y="2343.9328">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="89.6" x="132.8" y="2356.1813">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="78.4" x="132.8" y="2368.4297">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="127.2" x="132.8" y="2380.6782">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="34.4" x="132.8" y="2392.9266">state: {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="69.6" x="145.6" y="2405.175">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="182.4" x="145.6" y="2417.4235">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="248" x="145.6" y="2429.6719">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="132.8" y="2441.9203">}</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="120" y="2454.1688">}</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="107.2" y="2466.4172">}</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="94.4" y="2478.6657">}</text><polygon fill="#A80036" points="338.4,2517.6594,346.4,2520.8594,338.4,2524.0594,341.6,2520.8594" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="86" x2="343.2" y1="2520.8594" y2="2520.8594"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="91.6" y="2511.4383">22</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="219.2" x="109.2" y="2505.3141">Publish Notification (failure) event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="58.4" x="109.2" y="2517.5625">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="25.6" x="170.8" y="2517.5625">2003</text><!--
@startuml
title 1.3.1 Prepare Position Handler Consume

autonumber


control "Position Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
entity "Position\nManagement\nFacade" as POS_MGMT
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Transfer DAO" as TRANS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant TOPIC_NOTIFICATIONS
    participant POS_MGMT
    participant TRANS_DAO
    participant DB
end box

activate POS_HANDLER
group Prepare Position Handler Consume
    POS_HANDLER -> POS_MGMT: Request transfers to be processed
    activate POS_MGMT
    group <color #blue>DB TRANSACTION</color>
        POS_MGMT -> POS_MGMT: Loop through batch and build list of transferIds and calculate sumTransfersInBatch
        POS_MGMT -> DB: Retrieve current state of all transfers in array from DB with select whereIn
        activate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        DB - -> POS_MGMT: Return current state of all selected transfers from DB
        deactivate DB
        POS_MGMT <-> POS_MGMT: Validate current state (transferStateChange.transferStateId == 'RECEIVED_PREPARE')\n<color #FF0000><b>Error code:</b> 2001</color>

        note right of POS_MGMT #lightgray
            **transferAmount** = payload.amount.amount
            **currentPosition** = participantPosition.value
            **reservedPosition** = participantPosition.{original}reservedValue
            **effectivePosition** = currentPosition + reservedPosition
            **heldPosition** = effectivePosition + sumTransfersInBatch
            **availablePosition** = NetDebitCap - effectivePosition
            **sumTransfersInBatch** = SUM amount against each Transfer in batch
            **sumRESERVED** = SUM of transfers that have met rule criteria and processed = 0
        end note
        POS_MGMT -> DB: Select effectivePosition FOR UPDATE from DB for Payer
        activate DB
        hnote over DB #lightyellow
            participantPosition
        end note
        DB - -> POS_MGMT: Return effectivePosition (currentPosition and reservedPosition) from DB for Payer
        deactivate DB
        POS_MGMT -> POS_MGMT: Increment reservedValue to heldPosition\n(reservedValue = reservedPosition + transferAmount)
        POS_MGMT -> DB: Persist reservedValue
        activate DB
        hnote over DB #lightyellow
            UPDATE **participantPosition**
            SET reservedValue += sumTransfersInBatch
        end note
        deactivate DB
        POS_MGMT -> DB: Request position limits for Payer Participant
        activate DB
        hnote over DB #lightyellow
            FROM **participantLimit**
            WHERE participantLimit.limitTypeId = 'NET-DEBIT-CAP'
            AND participantLimit.participantId = payload.payerFsp
            AND participantLimit.currencyId = payload.amount.currency
        end note
        DB - -> POS_MGMT: Return position limits
        deactivate DB
        POS_MGMT <-> POS_MGMT: **latestPosition** = payload.amount.amount + currentPosition + reservedPosition
        POS_MGMT <-> POS_MGMT: **availablePosition** = netDebitCap - effectivePosition =\n = netDebitCap - currentPosition - reservedPosition
        POS_MGMT <-> POS_MGMT: Validate availablePosition >= transferAmount\n<color #FF0000><b>Error code:</b> 4001</color>
        note right of POS_MGMT #lightgray
            01: sumRESERVED = 0
            02: preparedTransfer.positionValue = currentPosition
            02: foreach preparedTransfer in transferBatch
                03: if availablePosition >= preparedTransfer.amount
                    04: preparedTransfer.state = "RESERVED"
                    05: availablePosition -= preparedTransfer.amount
                    06: sumRESERVED += preparedTransfer.amount
                    07: preparedTransfer.positionValue += preparedTransfer.amount
                    08: preparedTransfer.positionReservedValue = reservedPosition + sumTransfersInBatch - preparedTransfer.amount
                09: else
                    10: preparedTransfer.state = "ABORTED"
                    11: preparedTransfer.reason = "Net Debit Cap exceeded by this request at this time, please try again later"
                    12: preparedTransfer.positionReservedValue = reservedPosition + sumTransfersInBatch - preparedTransfer.amount
                13: end if
            14: end foreach
        end note
        POS_MGMT->DB: Persist latest position **value** and **reservedValue** to DB for Payer
            hnote over DB #lightyellow
                UPDATE **participantPosition**
                SET value += sumRESERVED,
                reservedValue -= sumTransfersInBatch
            end note
            activate DB
            deactivate DB
            POS_MGMT -> DB: Persist transfer state and participant position change
            hnote over DB #lightyellow
                    select for update from transfer table where transferId in ([transferBatch.transferId,...])
                    build list of transferStateChanges from transferBatch
                    **bulk insert for all transferStateChanges**

                    select all transferStateChanges whereIn transferId in ([transferBatch.transferId,...])
                    Loop through result and build list of participantPositionChange

                    SET transferStateChangeId = preparedTransfer.transferStateChangeId,
                    participantPositionId = preparedTransfer.participantPositionId,
                    value = preparedTransfer.positionValue,
                    reservedValue = preparedTransfer.positionReservedValue

                    batch INSERT **participantPositionChange**


            end note
            activate DB
            deactivate DB
    end
    POS_MGMT - -> POS_HANDLER: Return a map of transferIds and their transferStateChanges
    deactivate POS_MGMT
    alt Calculate & Validate Latest Position Prepare (success)
        note right of POS_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_TRANSFERS: Publish Transfer event\n<color #FF0000><b>Error code:</b> 2003</color>
        activate TOPIC_TRANSFERS
        deactivate TOPIC_TRANSFERS
   else Calculate & Validate Latest Position Prepare (failure)
        note right of POS_HANDLER #red: Validation failure!

        group Persist Transfer State (with transferState='ABORTED' on position check fail)
            POS_HANDLER -> TRANS_DAO: Request to persist transfer\n<color #FF0000><b>Error code:</b> 2003</color>
            activate TRANS_DAO
            note right of POS_HANDLER #lightgray
                transferStateChange.state = "ABORTED",
                transferStateChange.reason = "Net Debit Cap exceeded by this request at this time, please try again later"
            end note
            TRANS_DAO -> DB: Persist transfer state
            hnote over DB #lightyellow
                transferStateChange
            end note
            activate DB
            deactivate DB
            TRANS_DAO - -> POS_HANDLER: Return success
            deactivate TRANS_DAO
        end

        note right of POS_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <ledgerName>,
                to: <transferMessage.payerFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                        "errorInformation": {
                            "errorCode": 4001,
                            "errorDescription": "Payer FSP insufficient liquidity",
                            "extensionList": <transferMessage.extensionList>
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: notification,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        POS_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification (failure) event for Payer\n<color #FF0000><b>Error code:</b> 2003</color>
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
        deactivate POS_HANDLER
   end
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.01(Sun Jan 28 20:08:22 SAST 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_152-release-1136-b20
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: ZA
--></g></svg>