<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="9225px" preserveAspectRatio="none" style="width:1527px;height:9225px;" version="1.1" viewBox="0 0 1527 9225" width="1527px" zoomAndPan="magnify"><defs><filter height="300%" id="f12mayglpo6wq" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="515" x="506.5" y="23.5352">6.2.5. Acknowledgement of Settlement Transfer (updateSettlementById)</text><rect fill="#FFB6C1" height="9180.4219" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="107" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="122.5" y="47.0566">Central HUB</text><rect fill="#90EE90" height="9180.4219" style="stroke: #A80036; stroke-width: 1.0;" width="636.5" x="263.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="519.75" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="9180.4219" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="1217" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="1220" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="8972.1348" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="158" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="8442.5078" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="341" y="660.9141"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="197.7949" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="834" y="705.5352"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="274.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="834" y="947.9512"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="228.416" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="834" y="1266.9199"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="834" y="1539.957"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="224.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="834" y="6758.1055"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="193.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="834" y="7576.5078"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="1106.7012" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="834" y="8012.7207"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1269" y="734.8457"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="215.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1269" y="977.2617"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="169.7949" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1269" y="1296.2305"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1269" y="1569.2676"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1269" y="6787.416"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1269" y="6952.2793"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1269" y="7605.8184"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1269" y="7740.0605"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1269" y="8042.0313"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1269" y="8133.9629"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="8957.1348" style="stroke: #000000; stroke-width: 2.0;" width="1502" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="534.7422" style="stroke: #000000; stroke-width: 2.0;" width="449.5" x="257.5" y="2908.627"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="165.1523" style="stroke: #000000; stroke-width: 2.0;" width="351" x="346" y="3271.2168"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="351" x="346" y="3327.8379"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="351" x="346" y="3382.1035"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="179.1055" style="stroke: #000000; stroke-width: 2.0;" width="297" x="346" y="3660.9219"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="465.4316" style="stroke: #000000; stroke-width: 2.0;" width="534" x="336" y="3975.959"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="165.1523" style="stroke: #000000; stroke-width: 2.0;" width="369" x="346" y="4269.2383"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="369" x="346" y="4325.8594"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="369" x="346" y="4380.125"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="1794.5723" style="stroke: #000000; stroke-width: 2.0;" width="671.5" x="237.5" y="4871.291"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="1635.709" style="stroke: #000000; stroke-width: 2.0;" width="651.5" x="247.5" y="5023.1543"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="1522.7773" style="stroke: #000000; stroke-width: 2.0;" width="631.5" x="257.5" y="5129.0859"/><rect fill="#FFFFFF" height="249.6816" style="stroke: none; stroke-width: 1.0;" width="631.5" x="257.5" y="5319.8809"/><rect fill="#FFFFFF" height="310.9238" style="stroke: none; stroke-width: 1.0;" width="631.5" x="257.5" y="5569.5625"/><rect fill="#FFFFFF" height="534.6504" style="stroke: none; stroke-width: 1.0;" width="631.5" x="257.5" y="5880.4863"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="148.4844" style="stroke: #000000; stroke-width: 2.0;" width="510" x="346" y="6259.6523"/><rect fill="#FFFFFF" height="236.7266" style="stroke: none; stroke-width: 1.0;" width="631.5" x="257.5" y="6415.1367"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="1539.4102" style="stroke: #000000; stroke-width: 2.0;" width="1231.5" x="237.5" y="6679.8633"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="395.9688" style="stroke: #000000; stroke-width: 2.0;" width="1201.5" x="257.5" y="6704.1738"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="697.2285" style="stroke: #000000; stroke-width: 2.0;" width="1200.5" x="257.5" y="7114.1426"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="293.8809" style="stroke: #000000; stroke-width: 2.0;" width="616" x="326" y="7239.0059"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="207.9492" style="stroke: #000000; stroke-width: 2.0;" width="596" x="336" y="7317.9375"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="126.418" style="stroke: #000000; stroke-width: 2.0;" width="540" x="346" y="7353.1582"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="386.9023" style="stroke: #000000; stroke-width: 2.0;" width="1190.5" x="247.5" y="7825.3711"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="355.5918" style="stroke: #000000; stroke-width: 2.0;" width="1170.5" x="257.5" y="7849.6816"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="163" x2="163" y1="137.2871" y2="9128.4219"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="345.5" x2="345.5" y1="137.2871" y2="9128.4219"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="839" x2="839" y1="137.2871" y2="9128.4219"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1274" x2="1274" y1="137.2871" y2="9128.4219"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="111" y="134.334">Hub Employee</text><ellipse cx="163" cy="63.7988" fill="#FEFECE" filter="url(#f12mayglpo6wq)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M163,71.7988 L163,98.7988 M150,79.7988 L176,79.7988 M163,98.7988 L150,113.7988 M163,98.7988 L176,113.7988 " fill="none" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="111" y="9140.957">Hub Employee</text><ellipse cx="163" cy="9153.9102" fill="#FEFECE" filter="url(#f12mayglpo6wq)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M163,9161.9102 L163,9188.9102 M150,9169.9102 L176,9169.9102 M163,9188.9102 L150,9203.9102 M163,9188.9102 L176,9203.9102 " fill="none" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="267.5" y="134.334">Settlement Service API</text><path d="M325.5,92.7988 L325.5,116.7988 M325.5,104.7988 L342.5,104.7988 " fill="none" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="354.5" cy="104.7988" fill="#FEFECE" filter="url(#f12mayglpo6wq)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="267.5" y="9140.957">Settlement Service API</text><path d="M325.5,9147.9102 L325.5,9171.9102 M325.5,9159.9102 L342.5,9159.9102 " fill="none" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="354.5" cy="9159.9102" fill="#FEFECE" filter="url(#f12mayglpo6wq)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="782" y="134.334">Settlement DAO</text><ellipse cx="839" cy="104.7988" fill="#FEFECE" filter="url(#f12mayglpo6wq)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="827" x2="851" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="782" y="9140.957">Settlement DAO</text><ellipse cx="839" cy="9159.9102" fill="#FEFECE" filter="url(#f12mayglpo6wq)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="827" x2="851" y1="9173.9102" y2="9173.9102"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1226" y="134.334">Central Store</text><path d="M1256,84.7988 C1256,74.7988 1274,74.7988 1274,74.7988 C1274,74.7988 1292,74.7988 1292,84.7988 L1292,110.7988 C1292,120.7988 1274,120.7988 1274,120.7988 C1274,120.7988 1256,120.7988 1256,110.7988 L1256,84.7988 " fill="#FEFECE" filter="url(#f12mayglpo6wq)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1256,84.7988 C1256,94.7988 1274,94.7988 1274,94.7988 C1274,94.7988 1292,94.7988 1292,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1226" y="9140.957">Central Store</text><path d="M1256,9153.9102 C1256,9143.9102 1274,9143.9102 1274,9143.9102 C1274,9143.9102 1292,9143.9102 1292,9153.9102 L1292,9179.9102 C1292,9189.9102 1274,9189.9102 1274,9189.9102 C1274,9189.9102 1256,9189.9102 1256,9179.9102 L1256,9153.9102 " fill="#FEFECE" filter="url(#f12mayglpo6wq)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1256,9153.9102 C1256,9163.9102 1274,9163.9102 1274,9163.9102 C1274,9163.9102 1292,9163.9102 1292,9153.9102 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="8972.1348" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="158" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="8442.5078" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="341" y="660.9141"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="197.7949" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="834" y="705.5352"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="274.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="834" y="947.9512"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="228.416" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="834" y="1266.9199"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="834" y="1539.957"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="224.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="834" y="6758.1055"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="193.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="834" y="7576.5078"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="1106.7012" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="834" y="8012.7207"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="139.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1269" y="734.8457"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="215.7266" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1269" y="977.2617"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="169.7949" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1269" y="1296.2305"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1269" y="1569.2676"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1269" y="6787.416"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1269" y="6952.2793"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1269" y="7605.8184"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1269" y="7740.0605"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1269" y="8042.0313"/><rect fill="#FFFFFF" filter="url(#f12mayglpo6wq)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1269" y="8133.9629"/><path d="M13,154.2871 L339,154.2871 L339,161.2871 L329,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="8957.1348" style="stroke: #000000; stroke-width: 2.0;" width="1502" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="281" x="28" y="167.8555">Acknowledgement of Settlement Transfer</text><path d="M173,176.5977 L173,630.5977 L481,630.5977 L481,186.5977 L471,176.5977 L173,176.5977 " fill="#FFFF00" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M471,176.5977 L471,186.5977 L481,186.5977 L471,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="195" y="209.4766">"participants": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="211" y="224.7871">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="227" y="240.0977">"id": 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="227" y="255.4082">"accounts" : [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="243" y="270.7188">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="259" y="286.0293">"id": 1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="259" y="301.3398">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="259" y="316.6504">"reason": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="243" y="331.9609">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="243" y="347.2715">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="259" y="362.582">"id": 2,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="259" y="377.8926">"state": "SETTLED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="259" y="393.2031">"reason": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="243" y="408.5137">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="227" y="423.8242">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="211" y="439.1348">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="211" y="454.4453">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="227" y="469.7559">"id": 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="227" y="485.0664">"accounts" : [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="243" y="500.377">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="259" y="515.6875">"id": 3,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="259" y="530.998">"state": "NOT_SETTLED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="259" y="546.3086">"reason": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="243" y="561.6191">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="227" y="576.9297">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="211" y="592.2402">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="195" y="607.5508">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="622.8613">}</text><polygon fill="#A80036" points="329,656.9141,339,660.9141,329,664.9141,333,660.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="168" x2="335" y1="660.9141" y2="660.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="175" y="656.1719">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="188" y="656.1719">PUT - /settlement/{id}</text><polygon fill="#A80036" points="822,701.5352,832,705.5352,822,709.5352,826,705.5352" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="828" y1="705.5352" y2="705.5352"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="358" y="693.1377">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="371" y="685.4824">Retrieve full information for settlement</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="371" y="700.793">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="448" y="700.793">2001</text><polygon fill="#A80036" points="1257,730.8457,1267,734.8457,1257,738.8457,1261,734.8457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="844" x2="1263" y1="734.8457" y2="734.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="851" y="730.1035">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="864" y="730.1035">Select from DB</text><polygon fill="#FFFFE0" filter="url(#f12mayglpo6wq)" points="1087,747.8457,1461,747.8457,1471,796.8457,1461,846.8457,1087,846.8457,1077,796.8457,1087,747.8457" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="286" x="1089" y="764.4141">SELECT s.settlementId, ssc.settlementStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="1117" y="779.7246">ssc.reason, ssc.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1089" y="795.0352">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="1129" y="795.0352">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="7" x="1205" y="795.0352">s</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1089" y="810.3457">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="1121" y="810.3457">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1282" y="810.3457">ssc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="1089" y="825.6563">ON ssc.settlementStateChangeId = s.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="1089" y="840.9668">WHERE s.settlementId = {id}</text><polygon fill="#A80036" points="855,870.0195,845,874.0195,855,878.0195,851,874.0195" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="849" x2="1273" y1="874.0195" y2="874.0195"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="861" y="869.2773">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="874" y="869.2773">Return data</text><polygon fill="#A80036" points="362,899.3301,352,903.3301,362,907.3301,358,903.3301" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="356" x2="838" y1="903.3301" y2="903.3301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="368" y="898.5879">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="381" y="898.5879">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="426" y="898.5879">settlementData</text><polygon fill="#A80036" points="822,943.9512,832,947.9512,822,951.9512,826,947.9512" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="828" y1="947.9512" y2="947.9512"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="358" y="935.5537">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="300" x="371" y="927.8984">Retrive full information for settlement accounts</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="371" y="943.209">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="448" y="943.209">2001</text><polygon fill="#A80036" points="1257,973.2617,1267,977.2617,1257,981.2617,1261,977.2617" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="844" x2="1263" y1="977.2617" y2="977.2617"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="851" y="972.5195">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="864" y="972.5195">Select from DB</text><polygon fill="#FFFFE0" filter="url(#f12mayglpo6wq)" points="1090,990.2617,1458,990.2617,1468,1078.2617,1458,1166.2617,1090,1166.2617,1080,1078.2617,1090,990.2617" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="322" x="1092" y="1006.8301">SELECT pc.participantId, spc.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="1120" y="1022.1406">spcsc.settlementStateId, spcsc.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="316" x="1120" y="1037.4512">spcsc.createdDate, spc.netAmount, pc.currencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="248" x="1120" y="1052.7617">spc.settlementParticipantCurrencyId AS</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1372" y="1052.7617">key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1092" y="1068.0723">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="1132" y="1068.0723">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1343" y="1068.0723">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1092" y="1083.3828">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="1124" y="1083.3828">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1420" y="1083.3828">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="1092" y="1098.6934">ON spcsc.settlementParticipantCurrencyStateChangeId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="1104" y="1114.0039">spc.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1092" y="1129.3145">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="1124" y="1129.3145">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1264" y="1129.3145">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="1092" y="1144.625">ON pc.participantCurrencyId = spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="1092" y="1159.9355">WHERE spc.settlementId = {id}</text><polygon fill="#A80036" points="855,1188.9883,845,1192.9883,855,1196.9883,851,1192.9883" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="849" x2="1273" y1="1192.9883" y2="1192.9883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="861" y="1188.2461">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="874" y="1188.2461">Return data</text><polygon fill="#A80036" points="362,1218.2988,352,1222.2988,362,1226.2988,358,1222.2988" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="356" x2="838" y1="1222.2988" y2="1222.2988"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="368" y="1217.5566">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="381" y="1217.5566">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="426" y="1217.5566">settlementAccountsList</text><polygon fill="#A80036" points="822,1262.9199,832,1266.9199,822,1270.9199,826,1266.9199" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="828" y1="1266.9199" y2="1266.9199"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="358" y="1254.5225">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="298" x="380" y="1246.8672">Retrive full information for settlement windows</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="380" y="1262.1777">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="457" y="1262.1777">2001</text><polygon fill="#A80036" points="1257,1292.2305,1267,1296.2305,1257,1300.2305,1261,1296.2305" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="844" x2="1263" y1="1296.2305" y2="1296.2305"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="851" y="1291.4883">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="873" y="1291.4883">Select from DB</text><polygon fill="#FFFFE0" filter="url(#f12mayglpo6wq)" points="1052,1309.2305,1495,1309.2305,1505,1374.2305,1495,1439.2305,1052,1439.2305,1042,1374.2305,1052,1309.2305" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="418" x="1054" y="1325.7988">SELECT ssw.settlementWindowId, sswsc.settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="1082" y="1341.1094">sswsc.reason, sswsc.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1054" y="1356.4199">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="1094" y="1356.4199">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="1295" y="1356.4199">ssw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1054" y="1371.7305">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="1086" y="1371.7305">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="1215" y="1371.7305">sw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="335" x="1054" y="1387.041">ON sw.settlementWindow = ssw.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="1054" y="1402.3516">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="1086" y="1402.3516">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="31" x="1300" y="1402.3516">swsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="439" x="1054" y="1417.6621">ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="1054" y="1432.9727">WHERE ssw.settlementId = {id}</text><polygon fill="#A80036" points="855,1462.0254,845,1466.0254,855,1470.0254,851,1466.0254" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="849" x2="1273" y1="1466.0254" y2="1466.0254"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="861" y="1461.2832">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="883" y="1461.2832">Return data</text><polygon fill="#A80036" points="362,1491.3359,352,1495.3359,362,1499.3359,358,1495.3359" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="356" x2="838" y1="1495.3359" y2="1495.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="368" y="1490.5938">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="390" y="1490.5938">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="83" x="435" y="1490.5938">windowsList</text><polygon fill="#A80036" points="822,1535.957,832,1539.957,822,1543.957,826,1539.957" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="828" y1="1539.957" y2="1539.957"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="358" y="1527.5596">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="380" y="1519.9043">Retrive full information for settlement windows accounts</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="380" y="1535.2148">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="457" y="1535.2148">2001</text><polygon fill="#A80036" points="1257,1565.2676,1267,1569.2676,1257,1573.2676,1261,1569.2676" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="844" x2="1263" y1="1569.2676" y2="1569.2676"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="851" y="1564.5254">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="92" x="873" y="1564.5254">Select from DB</text><polygon fill="#FFFFE0" filter="url(#f12mayglpo6wq)" points="1079,1582.2676,1468,1582.2676,1478,1608.2676,1468,1635.2676,1079,1635.2676,1069,1608.2676,1079,1582.2676" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="385" x="1081" y="1598.8359">SELECT DISTINCT settlementWindowId, participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1081" y="1614.1465">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="203" x="1121" y="1614.1465">settlementTransferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="1081" y="1629.457">WHERE settlementId = {id}</text><polygon fill="#A80036" points="855,1658.5098,845,1662.5098,855,1666.5098,851,1662.5098" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="849" x2="1273" y1="1662.5098" y2="1662.5098"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="861" y="1657.7676">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="883" y="1657.7676">Return data</text><polygon fill="#A80036" points="362,1687.8203,352,1691.8203,362,1695.8203,358,1691.8203" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="356" x2="838" y1="1691.8203" y2="1691.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="368" y="1687.0781">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="390" y="1687.0781">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="145" x="435" y="1687.0781">windowsAccountsList</text><path d="M356,1704.8203 L356,1775.8203 L853,1775.8203 L853,1714.8203 L843,1704.8203 L356,1704.8203 " fill="#ADD8E6" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M843,1704.8203 L843,1714.8203 L853,1714.8203 L843,1704.8203 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="447" x="362" y="1722.3887">All objects below are done for the purposes of the syncronous request.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="462" x="362" y="1737.6992">If at same point Node process memory limit is reached we may decide to:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="476" x="362" y="1753.0098">A. Limit the amount of transfers per window and windows per settlement or</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="442" x="362" y="1768.3203">B. Move to asyncronous processing where we don't need these objects</text><path d="M356,1790.0625 L356,2580.0625 L1045,2580.0625 L1045,1800.0625 L1035,1790.0625 L356,1790.0625 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1035,1790.0625 L1035,1800.0625 L1045,1800.0625 L1035,1790.0625 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="362" y="1807.6309">Available raw datasets from DB:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="362" y="1822.9414">settlementData</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="423" x="469" y="1822.9414">contains information about settlement and its current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="362" y="1838.252">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="524" y="1838.252">holds information about all accounts and their current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="83" x="362" y="1853.5625">windowsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="449" y="1853.5625">has information about all windows and their current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="145" x="362" y="1868.873">windowsAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="511" y="1868.873">has information about all accounts and windows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="366" y="1884.1836"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="362" y="1899.4941">Local variables and objects:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="362" y="1914.8047">settlementAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="496" y="1914.8047">: { // (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="618" y="1914.8047">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="767" y="1914.8047">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="567" x="378" y="1930.1152">pendingSettlementCount: &lt;integer&gt;, // count of accounts in PENDING_SETTLEMENT state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="402" x="378" y="1945.4258">settledCount: &lt;integer&gt;, // count of accounts in SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="454" x="378" y="1960.7363">notSettledCount: &lt;integer&gt; // count of accounts in NOT_SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="362" y="1976.0469">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="362" y="1991.3574">settlementAccountsInit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="427" x="522" y="1991.3574">copy of previous object to be preserved for comparission at the end</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="362" y="2006.668">allAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="440" y="2006.668">: { // same as previous but accessed by account id (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="850" y="2006.668">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="999" y="2006.668">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="523" x="378" y="2021.9785">participantCurrencyId_key: { // number used to access the object in map-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="394" y="2037.2891">id: participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="394" y="2052.5996">state: settlementStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="394" y="2067.9102">reason: reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="394" y="2083.2207">createdDate: createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="394" y="2098.5313">netSettlementAmount: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="410" y="2113.8418">amount: netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="410" y="2129.1523">currency: currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="394" y="2144.4629">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="468" x="394" y="2159.7734">participantId: participantId, // could be used to reconstruct allParticipants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="394" y="2175.084">key:</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="424" y="2175.084">key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="430" x="450" y="2175.084">// will be used to insert new state for settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="378" y="2190.3945">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="362" y="2205.7051">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76" x="362" y="2221.0156">allWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="506" x="438" y="2221.0156">: { // same as settlementWindows response object with initial data (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="948" y="2221.0156">windowsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1026" y="2221.0156">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="515" x="378" y="2236.3262">settlementWindowId_key: { // number used to access the object in map-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="394" y="2251.6367">id: settlementWindowId, // same as key value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="394" y="2266.9473">state: settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="394" y="2282.2578">reason: reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="394" y="2297.5684">createdDate: createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="378" y="2312.8789">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="362" y="2328.1895">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121" x="362" y="2343.5">windowsAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="483" y="2343.5">: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="515" x="378" y="2358.8105">settlementWindowId_key: { // number used to access the object in map-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="394" y="2374.1211">id: settlementWindowId // same as key value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="567" x="394" y="2389.4316">pendingSettlementCount: &lt;integer&gt;, // count of accounts in PENDING_SETTLEMENT state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="402" x="394" y="2404.7422">settledCount: &lt;integer&gt;, // count of accounts in SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="454" x="394" y="2420.0527">notSettledCount: &lt;integer&gt; // count of accounts in NOT_SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="378" y="2435.3633">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="362" y="2450.6738">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="143" x="362" y="2465.9844">windowsAccountsInit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="427" x="509" y="2465.9844">copy of previous object to be preserved for comparission at the end</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="362" y="2481.2949">accountsWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="482" y="2481.2949">: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="523" x="378" y="2496.6055">participantCurrencyId_key: { // number used to access the object in map-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="394" y="2511.916">id: participantCurrencyId, // same as key value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="394" y="2527.2266">windows: [] // array of windows to which the account settlement spans</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="378" y="2542.5371">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="362" y="2557.8477">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="362" y="2573.1582">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="382" y="2573.1582">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="538" y="2573.1582">= now()</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="393" y1="2651.5215" y2="2651.5215"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="393" x2="393" y1="2651.5215" y2="2664.5215"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="352" x2="393" y1="2664.5215" y2="2664.5215"/><polygon fill="#A80036" points="362,2660.5215,352,2664.5215,362,2668.5215,358,2664.5215" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="358" y="2639.124">18</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="106" x="380" y="2631.4688">Acquire DB lock</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="490" y="2631.4688">on settlementParticipantCurrencyStateChange,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="380" y="2646.7793">settlementWindowStateChange and settlementStateChange</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="393" y1="2718.832" y2="2718.832"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="393" x2="393" y1="2718.832" y2="2731.832"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="352" x2="393" y1="2731.832" y2="2731.832"/><polygon fill="#A80036" points="362,2727.832,352,2731.832,362,2735.832,358,2731.832" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="358" y="2714.0898">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="380" y="2714.0898">Declare and initialize variables</text><path d="M356,2744.832 L356,2891.832 L648,2891.832 L648,2754.832 L638,2744.832 L356,2744.832 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M638,2744.832 L638,2754.832 L648,2754.832 L638,2744.832 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="362" y="2762.4004">let settlementAccounts = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="378" y="2777.7109">pendingSettlementAccounts: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="378" y="2793.0215">settledAccounts: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="378" y="2808.332">notSettledAccounts: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="362" y="2823.6426">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="267" x="362" y="2838.9531">let allAccounts = {} // declare sparse array</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="362" y="2854.2637">let pid // participantId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="271" x="362" y="2869.5742">let aid // accountId (participantCurrencyId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="362" y="2884.8848">let state</text><path d="M257.5,2908.627 L331.5,2908.627 L331.5,2915.627 L321.5,2925.627 L257.5,2925.627 L257.5,2908.627 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="534.7422" style="stroke: #000000; stroke-width: 2.0;" width="449.5" x="257.5" y="2908.627"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="272.5" y="2922.1953">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="193" x="346.5" y="2921.2617">[settlementAccountsList as record]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="393" y1="2947.248" y2="2947.248"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="393" x2="393" y1="2947.248" y2="2960.248"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="352" x2="393" y1="2960.248" y2="2960.248"/><polygon fill="#A80036" points="362,2956.248,352,2960.248,362,2964.248,358,2960.248" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="358" y="2942.5059">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="380" y="2942.5059">Populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="438" y="2942.5059">allAccounts</text><path d="M356,2973.248 L356,3212.248 L594,3212.248 L594,2983.248 L584,2973.248 L356,2973.248 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M584,2973.248 L584,2983.248 L594,2983.248 L584,2973.248 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="362" y="2990.8164">pid = record.participantId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="362" y="3006.127">aid = record.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="203" x="362" y="3021.4375">state = record.settlementStateId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="366" y="3036.748"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="362" y="3052.0586">allAccounts[aid] = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="378" y="3067.3691">id: aid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="378" y="3082.6797">state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="378" y="3097.9902">reason: record.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="378" y="3113.3008">createDate: record.createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="378" y="3128.6113">netSettlementAmount: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="394" y="3143.9219">amount: record.netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="394" y="3159.2324">currency: record.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="378" y="3174.543">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="378" y="3189.8535">key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="362" y="3205.1641">}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="393" y1="3243.2168" y2="3243.2168"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="393" x2="393" y1="3243.2168" y2="3256.2168"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="352" x2="393" y1="3256.2168" y2="3256.2168"/><polygon fill="#A80036" points="362,3252.2168,352,3256.2168,362,3260.2168,358,3256.2168" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="358" y="3238.4746">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="380" y="3238.4746">Populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="438" y="3238.4746">settlementAccounts</text><path d="M346,3271.2168 L408,3271.2168 L408,3278.2168 L398,3288.2168 L346,3288.2168 L346,3271.2168 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="165.1523" style="stroke: #000000; stroke-width: 2.0;" width="351" x="346" y="3271.2168"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="361" y="3284.7852">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="198" x="423" y="3283.8516">[state == 'PENDING_SETTLEMENT']</text><path d="M356,3293.5273 L356,3318.5273 L683,3318.5273 L683,3303.5273 L673,3293.5273 L356,3293.5273 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M673,3293.5273 L673,3303.5273 L683,3303.5273 L673,3293.5273 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="362" y="3311.0957">settlementAccounts.pendingSettlementCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="346" x2="697" y1="3328.8379" y2="3328.8379"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="117" x="351" y="3339.4727">[state == 'SETTLED']</text><path d="M356,3347.793 L356,3372.793 L608,3372.793 L608,3357.793 L598,3347.793 L356,3347.793 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M598,3347.793 L598,3357.793 L608,3357.793 L598,3347.793 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="362" y="3365.3613">settlementAccounts.settledCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="346" x2="697" y1="3383.1035" y2="3383.1035"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="148" x="351" y="3393.7383">[state == 'NOT_SETTLED']</text><path d="M356,3402.0586 L356,3427.0586 L629,3427.0586 L629,3412.0586 L619,3402.0586 L356,3402.0586 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M619,3402.0586 L619,3412.0586 L629,3412.0586 L619,3402.0586 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="362" y="3419.627">settlementAccounts.notSettledCount++</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="393" y1="3471.6797" y2="3471.6797"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="393" x2="393" y1="3471.6797" y2="3484.6797"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="352" x2="393" y1="3484.6797" y2="3484.6797"/><polygon fill="#A80036" points="362,3480.6797,352,3484.6797,362,3488.6797,358,3484.6797" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="358" y="3466.9375">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="254" x="380" y="3466.9375">Make a copy of settlementAccounts into</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="638" y="3466.9375">settlementAccountsInit</text><path d="M356,3497.6797 L356,3522.6797 L778,3522.6797 L778,3507.6797 L768,3497.6797 L356,3497.6797 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M768,3497.6797 L768,3507.6797 L778,3507.6797 L768,3497.6797 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="401" x="362" y="3515.248">settlementAccountsInit = Object.assign({}, settlementAccounts)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="393" y1="3578.3008" y2="3578.3008"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="393" x2="393" y1="3578.3008" y2="3591.3008"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="352" x2="393" y1="3591.3008" y2="3591.3008"/><polygon fill="#A80036" points="362,3587.3008,352,3591.3008,362,3595.3008,358,3591.3008" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="358" y="3573.5586">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="380" y="3573.5586">Declare and populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76" x="517" y="3573.5586">allWindows</text><path d="M356,3604.3008 L356,3644.3008 L641,3644.3008 L641,3614.3008 L631,3604.3008 L356,3604.3008 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M631,3604.3008 L631,3614.3008 L641,3614.3008 L631,3604.3008 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="362" y="3621.8691">let allWindows = {} // declare sparse array</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="362" y="3637.1797">let wid // settlementWindowId</text><path d="M346,3660.9219 L420,3660.9219 L420,3667.9219 L410,3677.9219 L346,3677.9219 L346,3660.9219 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="179.1055" style="stroke: #000000; stroke-width: 2.0;" width="297" x="346" y="3660.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="361" y="3674.4902">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="133" x="435" y="3673.5566">[windowsList as record]</text><path d="M356,3683.2324 L356,3830.2324 L629,3830.2324 L629,3693.2324 L619,3683.2324 L356,3683.2324 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M619,3683.2324 L619,3693.2324 L629,3693.2324 L619,3683.2324 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="362" y="3700.8008">wid = record.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="362" y="3716.1113">state = record.settlementWindowStateId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="366" y="3731.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="362" y="3746.7324">allWindows[wid] = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="378" y="3762.043">id: wid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="378" y="3777.3535">state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="378" y="3792.6641">reason: record.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="378" y="3807.9746">createDate: record.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="362" y="3823.2852">}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="393" y1="3893.3379" y2="3893.3379"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="393" x2="393" y1="3893.3379" y2="3906.3379"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="352" x2="393" y1="3906.3379" y2="3906.3379"/><polygon fill="#A80036" points="362,3902.3379,352,3906.3379,362,3910.3379,358,3906.3379" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="358" y="3888.5957">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="380" y="3888.5957">Declare and populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="517" y="3888.5957">accountsWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="641" y="3888.5957">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121" x="668" y="3888.5957">windowsAccounts</text><path d="M356,3919.3379 L356,3959.3379 L684,3959.3379 L684,3929.3379 L674,3919.3379 L356,3919.3379 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M674,3919.3379 L674,3929.3379 L684,3929.3379 L674,3919.3379 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="362" y="3936.9063">let accountsWindows = {} // declare sparse array</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="362" y="3952.2168">let windowsAccounts = {} // declare sparse array</text><path d="M336,3975.959 L410,3975.959 L410,3982.959 L400,3992.959 L336,3992.959 L336,3975.959 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="465.4316" style="stroke: #000000; stroke-width: 2.0;" width="534" x="336" y="3975.959"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="351" y="3989.5273">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="184" x="425" y="3988.5938">[windowsAccountsList as record]</text><path d="M356,3998.2695 L356,4252.2695 L856,4252.2695 L856,4008.2695 L846,3998.2695 L356,3998.2695 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M846,3998.2695 L846,4008.2695 L856,4008.2695 L846,3998.2695 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="362" y="4015.8379">wid = record.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="362" y="4031.1484">aid = record.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="362" y="4046.459">state = allAccounts[aid]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="366" y="4061.7695"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="467" x="362" y="4077.0801">accountsWindows[aid] = accountsWindows[aid] ? accountsWindows[aid] : {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="378" y="4092.3906">id: aid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="378" y="4107.7012">windows: []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="362" y="4123.0117">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="362" y="4138.3223">accountsWindows[aid].windows.push(wid)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="366" y="4153.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="479" x="362" y="4168.9434">windowsAccounts[wid] = windowsAccounts[wid] ? windowsAccounts[wid] : {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="378" y="4184.2539">id: wid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="378" y="4199.5645">pendingSettlementCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="378" y="4214.875">settledCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="378" y="4230.1855">notSettledCount: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="362" y="4245.4961">}</text><path d="M346,4269.2383 L408,4269.2383 L408,4276.2383 L398,4286.2383 L346,4286.2383 L346,4269.2383 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="165.1523" style="stroke: #000000; stroke-width: 2.0;" width="369" x="346" y="4269.2383"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="361" y="4282.8066">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="198" x="423" y="4281.873">[state == 'PENDING_SETTLEMENT']</text><path d="M356,4291.5488 L356,4316.5488 L701,4316.5488 L701,4301.5488 L691,4291.5488 L356,4291.5488 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M691,4291.5488 L691,4301.5488 L701,4301.5488 L691,4291.5488 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="324" x="362" y="4309.1172">windowsAccounts[wid].pendingSettlementCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="346" x2="715" y1="4326.8594" y2="4326.8594"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="117" x="351" y="4337.4941">[state == 'SETTLED']</text><path d="M356,4345.8145 L356,4370.8145 L626,4370.8145 L626,4355.8145 L616,4345.8145 L356,4345.8145 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M616,4345.8145 L616,4355.8145 L626,4355.8145 L616,4345.8145 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249" x="362" y="4363.3828">windowsAccounts[wid].settledCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="346" x2="715" y1="4381.125" y2="4381.125"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="148" x="351" y="4391.7598">[state == 'NOT_SETTLED']</text><path d="M356,4400.0801 L356,4425.0801 L647,4425.0801 L647,4410.0801 L637,4400.0801 L356,4400.0801 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M637,4400.0801 L637,4410.0801 L647,4410.0801 L637,4400.0801 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="362" y="4417.6484">windowsAccounts[wid].notSettledCount++</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="393" y1="4469.7012" y2="4469.7012"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="393" x2="393" y1="4469.7012" y2="4482.7012"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="352" x2="393" y1="4482.7012" y2="4482.7012"/><polygon fill="#A80036" points="362,4478.7012,352,4482.7012,362,4486.7012,358,4482.7012" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="358" y="4464.959">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="242" x="380" y="4464.959">Make a copy of windowsAccounts into</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="143" x="626" y="4464.959">windowsAccountsInit</text><path d="M356,4495.7012 L356,4520.7012 L754,4520.7012 L754,4505.7012 L744,4495.7012 L356,4495.7012 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M744,4495.7012 L744,4505.7012 L754,4505.7012 L744,4495.7012 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="377" x="362" y="4513.2695">windowsAccountsInit = Object.assign({}, windowsAccounts)</text><path d="M356,4560.0117 L356,4830.0117 L1050,4830.0117 L1050,4570.0117 L1040,4560.0117 L356,4560.0117 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1040,4560.0117 L1040,4570.0117 L1050,4570.0117 L1040,4560.0117 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="362" y="4577.5801">Available objects after the setup:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="362" y="4592.8906">settlementAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="414" x="500" y="4592.8906">is used for tracing settlement state and state transition allowance</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="362" y="4608.2012">allAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="474" x="444" y="4608.2012">is helper object, same as previous, providing direct access to account by id</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76" x="362" y="4623.5117">allWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="363" x="442" y="4623.5117">has window information for all windows in the settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121" x="362" y="4638.8223">windowsAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="466" x="487" y="4638.8223">is used for tracing settlement window state and state transition allowance</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="362" y="4654.1328">accountsWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="499" x="486" y="4654.1328">is helper object to show the list of windows to which settlement account spans</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="366" y="4669.4434"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="362" y="4684.7539">Now we are ready to process the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="54" x="570" y="4684.7539">payload</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="624" y="4684.7539">:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="362" y="4700.0645">participants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="588" x="447" y="4700.0645">= [] // part of the response object that lists the affected participants and respective accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="115" x="362" y="4715.375">affectedWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="481" y="4715.375">= [] // array of the affected windows</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="362" y="4730.6855">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="658" y="4730.6855">= [] // array to collect inserts to the table</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="131" x="362" y="4745.9961">processedAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="471" x="497" y="4745.9961">= [] // array to log processed accounts and restrict subsequent processing</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="362" y="4761.3066">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="13" x="382" y="4761.3066">pi</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="399" y="4761.3066">// declare participant index</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="362" y="4776.6172">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="12" x="382" y="4776.6172">ai</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="398" y="4776.6172">// declare account index</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="362" y="4791.9277">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="74" x="382" y="4791.9277">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="460" y="4791.9277">-- declare pointer to current participant in the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="100" x="756" y="4791.9277">response object</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="362" y="4807.2383">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="382" y="4807.2383">participantPayload</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="513" y="4807.2383">-- declare pointer to current participant in the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="92" x="809" y="4807.2383">payload object</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="362" y="4822.5488">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="106" x="382" y="4822.5488">accountPayload</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="492" y="4822.5488">-- declare pointer to current account in the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-style="italic" lengthAdjust="spacingAndGlyphs" textLength="92" x="770" y="4822.5488">payload object</text><path d="M237.5,4871.291 L311.5,4871.291 L311.5,4878.291 L301.5,4888.291 L237.5,4888.291 L237.5,4871.291 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1794.5723" style="stroke: #000000; stroke-width: 2.0;" width="671.5" x="237.5" y="4871.291"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="252.5" y="4884.8594">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="165" x="326.5" y="4883.9258">[let p IN payload.participants]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="393" y1="4909.9121" y2="4909.9121"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="393" x2="393" y1="4909.9121" y2="4922.9121"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="352" x2="393" y1="4922.9121" y2="4922.9121"/><polygon fill="#A80036" points="362,4918.9121,352,4922.9121,362,4926.9121,358,4922.9121" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="358" y="4905.1699">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="380" y="4905.1699">Loop payload for each</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="523" y="4905.1699">participantPayload</text><path d="M356,4935.9121 L356,5006.9121 L736,5006.9121 L736,4945.9121 L726,4935.9121 L356,4935.9121 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M726,4935.9121 L726,4945.9121 L736,4945.9121 L726,4935.9121 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="362" y="4953.4805">participantPayload = payload.participants[p]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="362" y="4968.791">participants.push({id: participantPayload.id, accounts: []})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="173" x="362" y="4984.1016">pi = participants.length - 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="362" y="4999.4121">participant = participants[pi]</text><path d="M247.5,5023.1543 L321.5,5023.1543 L321.5,5030.1543 L311.5,5040.1543 L247.5,5040.1543 L247.5,5023.1543 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1635.709" style="stroke: #000000; stroke-width: 2.0;" width="651.5" x="247.5" y="5023.1543"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="262.5" y="5036.7227">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="336.5" y="5035.7891">[let a IN participantPayload.accounts]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="393" y1="5061.7754" y2="5061.7754"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="393" x2="393" y1="5061.7754" y2="5074.7754"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="352" x2="393" y1="5074.7754" y2="5074.7754"/><polygon fill="#A80036" points="362,5070.7754,352,5074.7754,362,5078.7754,358,5074.7754" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="358" y="5057.0332">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="380" y="5057.0332">Loop payload for each</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="106" x="523" y="5057.0332">accountPayload</text><path d="M356,5087.7754 L356,5112.7754 L685,5112.7754 L685,5097.7754 L675,5087.7754 L356,5087.7754 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M675,5087.7754 L675,5097.7754 L685,5097.7754 L675,5087.7754 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="362" y="5105.3438">accountPayload = participantPayload.accounts[a]</text><path d="M257.5,5129.0859 L319.5,5129.0859 L319.5,5136.0859 L309.5,5146.0859 L257.5,5146.0859 L257.5,5129.0859 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1522.7773" style="stroke: #000000; stroke-width: 2.0;" width="631.5" x="257.5" y="5129.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="272.5" y="5142.6543">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="263" x="334.5" y="5141.7207">[allAccounts[accountPayload.id] == undefined]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="393" y1="5167.707" y2="5167.707"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="393" x2="393" y1="5167.707" y2="5180.707"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="352" x2="393" y1="5180.707" y2="5180.707"/><polygon fill="#A80036" points="362,5176.707,352,5180.707,362,5184.707,358,5180.707" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="358" y="5162.9648">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="380" y="5162.9648">If the account doesn't match the settlement</text><path d="M356,5193.707 L356,5310.707 L644,5310.707 L644,5203.707 L634,5193.707 L356,5193.707 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M634,5193.707 L634,5203.707 L644,5203.707 L634,5193.707 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="362" y="5211.2754">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="378" y="5226.5859">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="378" y="5241.8965">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="394" y="5257.207">errorCode: &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="394" y="5272.5176">errorDescription: 'Account not found'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="378" y="5287.8281">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="362" y="5303.1387">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="257.5" x2="889" y1="5320.8809" y2="5320.8809"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="301" x="262.5" y="5331.5156">[processedAccounts.indexOf(accountPayload.id) &gt; -1]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="393" y1="5356.1465" y2="5356.1465"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="393" x2="393" y1="5356.1465" y2="5369.1465"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="352" x2="393" y1="5369.1465" y2="5369.1465"/><polygon fill="#A80036" points="362,5365.1465,352,5369.1465,362,5373.1465,358,5369.1465" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="358" y="5351.4043">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="447" x="380" y="5351.4043">If the account has been previosly processed (duplicated in the payload)</text><path d="M356,5382.1465 L356,5560.1465 L875,5560.1465 L875,5392.1465 L865,5382.1465 L356,5382.1465 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M865,5382.1465 L865,5392.1465 L875,5392.1465 L865,5382.1465 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="362" y="5399.7148">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="378" y="5415.0254">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="378" y="5430.3359">state: allAccounts[accountPayload.id].state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="378" y="5445.6465">reason: allAccounts[accountPayload.id].reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="378" y="5460.957">createdDate: allAccounts[accountPayload.id].createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="378" y="5476.2676">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="378" y="5491.5781">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="394" y="5506.8887">errorCode: &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="394" y="5522.1992">errorDescription: 'Account already processed once'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="378" y="5537.5098">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="362" y="5552.8203">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="257.5" x2="889" y1="5570.5625" y2="5570.5625"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="371" x="262.5" y="5581.1973">[allAccounts[account.id].state == accountPayload.state // allowed]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="393" y1="5605.8281" y2="5605.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="393" x2="393" y1="5605.8281" y2="5618.8281"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="352" x2="393" y1="5618.8281" y2="5618.8281"/><polygon fill="#A80036" points="362,5614.8281,352,5618.8281,362,5622.8281,358,5618.8281" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="358" y="5601.0859">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="354" x="380" y="5601.0859">All same-state reason insert is allowed (state preserved)</text><path d="M356,5631.8281 L356,5870.8281 L875,5870.8281 L875,5641.8281 L865,5631.8281 L356,5631.8281 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M865,5631.8281 L865,5641.8281 L875,5641.8281 L865,5631.8281 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="362" y="5649.3965">processedAccounts.push(accountPayload.id)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="362" y="5664.707">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="378" y="5680.0176">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="378" y="5695.3281">state: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="378" y="5710.6387">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="378" y="5725.9492">createdDate: transactionTimestamp,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="378" y="5741.2598">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="362" y="5756.5703">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="362" y="5771.8809">settlementParticipantCurrencyStateChange.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="378" y="5787.1914">settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="378" y="5802.502">settlementStateId: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="378" y="5817.8125">reason: accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="362" y="5833.123">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="362" y="5848.4336">allAccounts[accountPayload.id].reason = accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="362" y="5863.7441">allAccounts[accountPayload.id].createdDate = currentTimestamp</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="257.5" x2="889" y1="5881.4863" y2="5881.4863"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="616" x="262.5" y="5892.1211">[allAccounts[account.id].state == 'PENDING_SETTLEMENT' &amp;&amp; accountPayload.state == 'SETTLED' // allowed]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="393" y1="5916.752" y2="5916.752"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="393" x2="393" y1="5916.752" y2="5929.752"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="352" x2="393" y1="5929.752" y2="5929.752"/><polygon fill="#A80036" points="362,5925.752,352,5929.752,362,5933.752,358,5929.752" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="358" y="5912.0098">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="380" y="5912.0098">True settlement acknowledgement</text><path d="M356,5942.752 L356,6242.752 L875,6242.752 L875,5952.752 L865,5942.752 L356,5942.752 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M865,5942.752 L865,5952.752 L875,5952.752 L865,5942.752 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="362" y="5960.3203">processedAccounts.push(accountPayload.id)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="362" y="5975.6309">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="378" y="5990.9414">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="378" y="6006.252">state: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="378" y="6021.5625">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="378" y="6036.873">createdDate: transactionTimestamp,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="378" y="6052.1836">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="362" y="6067.4941">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="362" y="6082.8047">settlementParticipantCurrencyStateChange.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="378" y="6098.1152">settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="378" y="6113.4258">settlementStateId: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="378" y="6128.7363">reason: accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="362" y="6144.0469">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="362" y="6159.3574">settlementAccounts.pendingSettlementCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="362" y="6174.668">settlementAccounts.settledCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="382" x="362" y="6189.9785">allAccounts[accountPayload.id].state = accountPayload.state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="362" y="6205.2891">allAccounts[accountPayload.id].reason = accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="362" y="6220.5996">allAccounts[accountPayload.id].createdDate = currentTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="362" y="6235.9102">let settlementWindowId</text><path d="M346,6259.6523 L420,6259.6523 L420,6266.6523 L410,6276.6523 L346,6276.6523 L346,6259.6523 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="148.4844" style="stroke: #000000; stroke-width: 2.0;" width="510" x="346" y="6259.6523"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="361" y="6273.2207">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="320" x="435" y="6272.2871">[let aw IN accountsWindows[accountPayload.id].windows]</text><path d="M356,6281.9629 L356,6398.9629 L842,6398.9629 L842,6291.9629 L832,6281.9629 L356,6281.9629 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M832,6281.9629 L832,6291.9629 L842,6291.9629 L832,6281.9629 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="465" x="362" y="6299.5313">settlementWindowId = accountsWindows[accountPayload.id].windows[aw]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="362" y="6314.8418">windowsAccounts[settlementWindowId].pendingSettlementCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="355" x="362" y="6330.1523">windowsAccounts[settlementWindowId].settledCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="366" y="6345.4629"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="352" x="362" y="6360.7734">if (affectedWindows.indexOf(settlementWindowId) &lt; 0) {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="378" y="6376.084">affectedWindows.push(settlementWindowId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="362" y="6391.3945">}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="257.5" x2="889" y1="6416.1367" y2="6416.1367"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="393" y1="6438.4473" y2="6438.4473"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="393" x2="393" y1="6438.4473" y2="6451.4473"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="352" x2="393" y1="6451.4473" y2="6451.4473"/><polygon fill="#A80036" points="362,6447.4473,352,6451.4473,362,6455.4473,358,6451.4473" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="358" y="6433.7051">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="380" y="6433.7051">All other state transitions are not permitted</text><path d="M356,6464.4473 L356,6642.4473 L875,6642.4473 L875,6474.4473 L865,6464.4473 L356,6464.4473 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M865,6464.4473 L865,6474.4473 L875,6474.4473 L865,6464.4473 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="362" y="6482.0156">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="378" y="6497.3262">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="378" y="6512.6367">state: allAccounts[accountPayload.id].state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="378" y="6527.9473">reason: allAccounts[accountPayload.id].reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="378" y="6543.2578">createdDate: allAccounts[accountPayload.id].createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="378" y="6558.5684">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="378" y="6573.8789">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="394" y="6589.1895">errorCode: &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="394" y="6604.5">errorDescription: 'State change not allowed'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="378" y="6619.8105">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="362" y="6635.1211">})</text><path d="M237.5,6679.8633 L402.5,6679.8633 L402.5,6686.8633 L392.5,6696.8633 L237.5,6696.8633 L237.5,6679.8633 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1539.4102" style="stroke: #000000; stroke-width: 2.0;" width="1231.5" x="237.5" y="6679.8633"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="252.5" y="6693.4316">DB TRANSACTION</text><path d="M257.5,6704.1738 L670.5,6704.1738 L670.5,6711.1738 L660.5,6721.1738 L257.5,6721.1738 L257.5,6704.1738 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="395.9688" style="stroke: #000000; stroke-width: 2.0;" width="1201.5" x="257.5" y="6704.1738"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="368" x="272.5" y="6717.7422">Bulk insert settlementParticipantCurrencyStateChange</text><polygon fill="#A80036" points="822,6754.1055,832,6758.1055,822,6762.1055,826,6758.1055" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="828" y1="6758.1055" y2="6758.1055"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="358" y="6745.708">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="290" x="380" y="6738.0527">Change settlement participant currency states</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="380" y="6753.3633">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="457" y="6753.3633">2001</text><polygon fill="#A80036" points="1257,6783.416,1267,6787.416,1257,6791.416,1261,6787.416" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="844" x2="1263" y1="6787.416" y2="6787.416"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="851" y="6782.6738">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="873" y="6782.6738">Insert settlementParticipantCurrencyStateChange</text><polygon fill="#FFFFE0" filter="url(#f12mayglpo6wq)" points="1138,6800.416,1410,6800.416,1420,6811.416,1410,6823.416,1138,6823.416,1128,6811.416,1138,6800.416" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="1140" y="6816.9844">settlementParticipantCurrencyStateChange</text><polygon fill="#A80036" points="855,6846.0371,845,6850.0371,855,6854.0371,851,6850.0371" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="849" x2="1273" y1="6850.0371" y2="6850.0371"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="861" y="6845.2949">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="883" y="6845.2949">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="329" x="928" y="6845.2949">settlementParticipantCurrencyStateChangeIdList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="844" x2="886" y1="6909.9688" y2="6909.9688"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="886" x2="886" y1="6909.9688" y2="6922.9688"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="845" x2="886" y1="6922.9688" y2="6922.9688"/><polygon fill="#A80036" points="855,6918.9688,845,6922.9688,855,6926.9688,851,6922.9688" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="851" y="6889.916">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="345" x="873" y="6874.6055">Merge settlementParticipantCurrencyStateChangeIdList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="873" y="6889.916">to settlementParticipantCurrencyIdList in order to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="873" y="6905.2266">issue the following update in one knex command</text><polygon fill="#A80036" points="1257,6948.2793,1267,6952.2793,1257,6956.2793,1261,6952.2793" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="844" x2="1263" y1="6952.2793" y2="6952.2793"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="851" y="6947.5371">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="873" y="6947.5371">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#f12mayglpo6wq)" points="1108,6995.2793,1439,6995.2793,1449,7044.2793,1439,7094.2793,1108,7094.2793,1098,7044.2793,1108,6995.2793" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1110" y="7011.8477">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="1164" y="7011.8477">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="1110" y="7027.1582">SET currentStateChangeId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="1126" y="7042.4688">{settlementParticipantCurrencyStateChangeIdList}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="1110" y="7057.7793">WHERE settlementParticipantCurrencyId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="1134" y="7073.0898">{settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="1134" y="7088.4004">.settlementParticipantCurrencyIdList}</text><path d="M257.5,7114.1426 L642.5,7114.1426 L642.5,7121.1426 L632.5,7131.1426 L257.5,7131.1426 L257.5,7114.1426 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="697.2285" style="stroke: #000000; stroke-width: 2.0;" width="1200.5" x="257.5" y="7114.1426"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="340" x="272.5" y="7127.7109">Prepare and insert settlementWindowStateChange</text><path d="M356,7136.4531 L356,7222.4531 L668,7222.4531 L668,7146.4531 L658,7136.4531 L356,7136.4531 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M658,7136.4531 L658,7146.4531 L668,7146.4531 L658,7136.4531 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="362" y="7154.0215">let settlementWindowStateChange = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="362" y="7169.332">let settlementWindows = [] // response object</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="362" y="7184.6426">let windowAccountsInit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="362" y="7199.9531">let windowAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="362" y="7215.2637">let windowState</text><path d="M326,7239.0059 L400,7239.0059 L400,7246.0059 L390,7256.0059 L326,7256.0059 L326,7239.0059 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="293.8809" style="stroke: #000000; stroke-width: 2.0;" width="616" x="326" y="7239.0059"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="341" y="7252.5742">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="415" y="7251.6406">[let aw IN affectedWindows]</text><path d="M356,7261.3164 L356,7301.3164 L791,7301.3164 L791,7271.3164 L781,7261.3164 L356,7261.3164 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M781,7261.3164 L781,7271.3164 L791,7271.3164 L781,7261.3164 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="414" x="362" y="7278.8848">windowAccountsInit = windowAccountsInit[affectedWindows[aw]]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="379" x="362" y="7294.1953">windowAccounts = windowsAccounts[affectedWindows[aw]]</text><path d="M336,7317.9375 L403,7317.9375 L403,7324.9375 L393,7334.9375 L336,7334.9375 L336,7317.9375 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="207.9492" style="stroke: #000000; stroke-width: 2.0;" width="596" x="336" y="7317.9375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="351" y="7331.5059">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="509" x="418" y="7330.5723">[windowAccounts.pendingSettlementCount != windowAccountsInit.pendingSettlementCount</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="389" x="418" y="7343.5273">|| windowAccounts.settledCount != windowAccountsInit.settledCount]</text><path d="M346,7353.1582 L413,7353.1582 L413,7360.1582 L403,7370.1582 L346,7370.1582 L346,7353.1582 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="126.418" style="stroke: #000000; stroke-width: 2.0;" width="540" x="346" y="7353.1582"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="361" y="7366.7266">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="270" x="428" y="7365.793">[windowAccounts.pendingSettlementCount == 0</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="238" x="428" y="7378.748">&amp;&amp; windowAccounts.notSettledCount == 0</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="218" x="428" y="7391.7031">&amp;&amp; windowAccounts.settledCound &gt; 0]</text><path d="M356,7399.334 L356,7470.334 L872,7470.334 L872,7409.334 L862,7399.334 L356,7399.334 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M862,7399.334 L862,7409.334 L872,7409.334 L862,7399.334 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="324" x="362" y="7416.9023">allWindows[affectedWindows[aw]].state = 'SETTLED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="495" x="362" y="7432.2129">allWindows[affectedWindows[aw]].reason = 'All setlement accounts are settled'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="423" x="362" y="7447.5234">allWindows[affectedWindows[aw]].createdDate = currentTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="362" y="7462.834">settlementWindowStateChange.push(allWindows[affectedWindows[aw]])</text><path d="M356,7491.5762 L356,7516.5762 L754,7516.5762 L754,7501.5762 L744,7491.5762 L356,7491.5762 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M744,7491.5762 L744,7501.5762 L754,7501.5762 L744,7491.5762 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="377" x="362" y="7509.1445">settlementWindows.push(allWindows[affectedWindows[aw]])</text><polygon fill="#A80036" points="822,7572.5078,832,7576.5078,822,7580.5078,826,7576.5078" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="828" y1="7576.5078" y2="7576.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="358" y="7564.1104">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="380" y="7556.4551">Change settlement windows states</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="380" y="7571.7656">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="457" y="7571.7656">2001</text><polygon fill="#A80036" points="1257,7601.8184,1267,7605.8184,1257,7609.8184,1261,7605.8184" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="844" x2="1263" y1="7605.8184" y2="7605.8184"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="851" y="7601.0762">39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="873" y="7601.0762">Insert settlementWindowStateChange</text><polygon fill="#FFFFE0" filter="url(#f12mayglpo6wq)" points="1175,7618.8184,1373,7618.8184,1383,7629.8184,1373,7641.8184,1175,7641.8184,1165,7629.8184,1175,7618.8184" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1177" y="7635.3867">settlementWindowStateChange</text><polygon fill="#A80036" points="855,7664.4395,845,7668.4395,855,7672.4395,851,7668.4395" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="849" x2="1273" y1="7668.4395" y2="7668.4395"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="861" y="7663.6973">40</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="883" y="7663.6973">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="247" x="928" y="7663.6973">settlementWindowStateChangeIdList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="844" x2="886" y1="7697.75" y2="7697.75"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="886" x2="886" y1="7697.75" y2="7710.75"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="845" x2="886" y1="7710.75" y2="7710.75"/><polygon fill="#A80036" points="855,7706.75,845,7710.75,855,7714.75,851,7710.75" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="851" y="7693.0078">41</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="873" y="7693.0078">Merge ids to prepare for single update command</text><polygon fill="#A80036" points="1257,7736.0605,1267,7740.0605,1257,7744.0605,1261,7740.0605" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="844" x2="1263" y1="7740.0605" y2="7740.0605"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="851" y="7735.3184">42</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="873" y="7735.3184">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#f12mayglpo6wq)" points="1109,7783.0605,1438,7783.0605,1448,7794.0605,1438,7806.0605,1109,7806.0605,1099,7794.0605,1109,7783.0605" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1111" y="7799.6289">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="1165" y="7799.6289">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="1290" y="7799.6289">.currentStateChangeIds</text><path d="M247.5,7825.3711 L579.5,7825.3711 L579.5,7832.3711 L569.5,7842.3711 L247.5,7842.3711 L247.5,7825.3711 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="386.9023" style="stroke: #000000; stroke-width: 2.0;" width="1190.5" x="247.5" y="7825.3711"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="287" x="262.5" y="7838.9395">Prepare and insert settlementStateChange</text><path d="M257.5,7849.6816 L324.5,7849.6816 L324.5,7856.6816 L314.5,7866.6816 L257.5,7866.6816 L257.5,7849.6816 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="355.5918" style="stroke: #000000; stroke-width: 2.0;" width="1170.5" x="257.5" y="7849.6816"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="272.5" y="7863.25">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="407" x="339.5" y="7862.3164">[settlementAccounts.settledCount != settlementAccountsInit.settledCount</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="301" x="339.5" y="7875.2715">&amp;&amp; settlementAccounts.pendingSettlementCount == 0</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="257" x="339.5" y="7888.2266">&amp;&amp; settlementAccounts.notSettledCount == 0]</text><path d="M356,7895.8574 L356,7966.8574 L757,7966.8574 L757,7905.8574 L747,7895.8574 L356,7895.8574 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M747,7895.8574 L747,7905.8574 L757,7905.8574 L747,7895.8574 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="362" y="7913.4258">settlementData.state = 'SETTLED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="362" y="7928.7363">settlementData.reason = 'All setlement accounts are settled'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="362" y="7944.0469">settlementData.createdDate = currentTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="362" y="7959.3574">settlementStateChange.push(settlementData)</text><polygon fill="#A80036" points="822,8008.7207,832,8012.7207,822,8016.7207,826,8012.7207" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="828" y1="8012.7207" y2="8012.7207"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="358" y="8000.3232">43</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="380" y="7992.668">Change settlement state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="380" y="8007.9785">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="457" y="8007.9785">2001</text><polygon fill="#A80036" points="1257,8038.0313,1267,8042.0313,1257,8046.0313,1261,8042.0313" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="844" x2="1263" y1="8042.0313" y2="8042.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="851" y="8037.2891">44</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="873" y="8037.2891">Insert settlementStateChange</text><polygon fill="#FFFFE0" filter="url(#f12mayglpo6wq)" points="1199,8055.0313,1348,8055.0313,1358,8066.0313,1348,8078.0313,1199,8078.0313,1189,8066.0313,1199,8055.0313" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="1201" y="8071.5996">settlementStateChange</text><polygon fill="#A80036" points="855,8100.6523,845,8104.6523,855,8108.6523,851,8104.6523" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="849" x2="1273" y1="8104.6523" y2="8104.6523"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="861" y="8099.9102">45</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="883" y="8099.9102">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="928" y="8099.9102">settlementStateChangeId</text><polygon fill="#A80036" points="1257,8129.9629,1267,8133.9629,1257,8137.9629,1261,8133.9629" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="844" x2="1263" y1="8133.9629" y2="8133.9629"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="851" y="8129.2207">46</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="873" y="8129.2207">Update pointer to current state change id</text><polygon fill="#FFFFE0" filter="url(#f12mayglpo6wq)" points="1139,8176.9629,1408,8176.9629,1418,8187.9629,1408,8199.9629,1139,8199.9629,1129,8187.9629,1139,8176.9629" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1141" y="8193.5313">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="1195" y="8193.5313">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="1267" y="8193.5313">.currentStateChangeId</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="393" y1="8262.8945" y2="8262.8945"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="393" x2="393" y1="8262.8945" y2="8275.8945"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="352" x2="393" y1="8275.8945" y2="8275.8945"/><polygon fill="#A80036" points="362,8271.8945,352,8275.8945,362,8279.8945,358,8275.8945" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="358" y="8250.4971">47</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="105" x="380" y="8242.8418">Release DB lock</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="292" x="489" y="8242.8418">on settlementParticipantCurrencyStateChange,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="380" y="8258.1523">settlementWindowStateChange and settlementStateChange</text><path d="M40,8288.8945 L40,8910.8945 L332,8910.8945 L332,8298.8945 L322,8288.8945 L40,8288.8945 " fill="#D3D3D3" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M322,8288.8945 L322,8298.8945 L332,8298.8945 L322,8288.8945 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="46" y="8306.4629">Samples:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="46" y="8321.7734">"</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="132" x="51" y="8321.7734">settlementWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="183" y="8321.7734">": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="62" y="8337.084">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="78" y="8352.3945">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="78" y="8367.7051">"state": &lt;enum&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="78" y="8383.0156">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="78" y="8398.3262">"createdDate": &lt;date&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="62" y="8413.6367">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="46" y="8428.9473">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="46" y="8444.2578">"</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="51" y="8444.2578">participants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="132" y="8444.2578">": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="62" y="8459.5684">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="78" y="8474.8789">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="78" y="8490.1895">"accounts": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="94" y="8505.5">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="110" y="8520.8105">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="110" y="8536.1211">"state": "SETTLED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="110" y="8551.4316">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="110" y="8566.7422">"createdDate": &lt;date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="110" y="8582.0527">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="126" y="8597.3633">"amount": &lt;decimal&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="126" y="8612.6738">"currency": &lt;enum&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="110" y="8627.9844">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="94" y="8643.2949">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="94" y="8658.6055">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="110" y="8673.916">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="110" y="8689.2266">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="110" y="8704.5371">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="110" y="8719.8477">"createdDate": &lt;date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="110" y="8735.1582">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="126" y="8750.4688">"amount": &lt;decimal&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="126" y="8765.7793">"currency": &lt;enum&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="110" y="8781.0898">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="110" y="8796.4004">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="126" y="8811.7109">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="126" y="8827.0215">"errorDescription": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="110" y="8842.332">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="94" y="8857.6426">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="78" y="8872.9531">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="62" y="8888.2637">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="46" y="8903.5742">]</text><path d="M23,8925.3164 L23,9072.3164 L332,9072.3164 L332,8935.3164 L322,8925.3164 L23,8925.3164 " fill="#FFFFE0" filter="url(#f12mayglpo6wq)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M322,8925.3164 L322,8935.3164 L332,8935.3164 L322,8925.3164 " fill="#FFFFE0" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="29" y="8942.8848">[</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="37" y="8958.1953">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="45" y="8973.5059">"id": {id},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="45" y="8988.8164">"state": settlementData.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="45" y="9004.127">"createdDate": settlementData.createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="45" y="9019.4375">"settlementWindows": settlementWindows,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="45" y="9034.748">"participants": participants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="37" y="9050.0586">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="29" y="9065.3691">]</text><polygon fill="#A80036" points="179,9099.4219,169,9103.4219,179,9107.4219,175,9103.4219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="173" x2="345" y1="9103.4219" y2="9103.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="185" y="9098.6797">48</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="207" y="9098.6797">Return response</text><!--
@startuml
title 6.2.5. Acknowledgement of Settlement Transfer (updateSettlementById)
autonumber

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Settlement Service" #lightgreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

group Acknowledgement of Settlement Transfer
    activate OPERATOR
    note right of OPERATOR #yellow
        {
            "participants": [
                {
                    "id": 1
                    "accounts" : [
                        {
                            "id": 1,
                            "state": "PENDING_SETTLEMENT",
                            "reason": <string>
                        },
                        {
                            "id": 2,
                            "state": "SETTLED",
                            "reason": <string>
                        }
                    ]
                },
                {
                    "id": 2
                    "accounts" : [
                        {
                            "id": 3,
                            "state": "NOT_SETTLED",
                            "reason": <string>
                        }
                    ]
                }
            ]
        }
    end note

    OPERATOR -> SSAPI: PUT - /settlement/{id}
    activate SSAPI
    SSAPI -> SETTLE_DAO: Retrieve full information for settlement\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Select from DB
    activate DB
    hnote over DB #lightyellow
        SELECT s.settlementId, ssc.settlementStateId, 
               ssc.reason, ssc.createdDate
        FROM **settlement** s
        JOIN **settlementStateChange** ssc
        ON ssc.settlementStateChangeId = s.currentStateChangeId
        WHERE s.settlementId = {id}
    end hnote
    SETTLE_DAO <- - DB: Return data
    deactivate DB
    SSAPI <- - SETTLE_DAO: Return **settlementData**
    deactivate SETTLE_DAO

    SSAPI -> SETTLE_DAO: Retrive full information for settlement accounts\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Select from DB
    activate DB
    hnote over DB #lightyellow
        SELECT pc.participantId, spc.participantCurrencyId, 
               spcsc.settlementStateId, spcsc.reason,
               spcsc.createdDate, spc.netAmount, pc.currencyId, 
               spc.settlementParticipantCurrencyId AS <color #0000FF>key</color>
        FROM **settlementParticipantCurrency** spc
        JOIN **settlementParticipantCurrencyStateChange** spcsc
        ON spcsc.settlementParticipantCurrencyStateChangeId = 
           spc.currentStateChangeId
        JOIN **participantCurrency** pc
        ON pc.participantCurrencyId = spc.participantCurrencyId
        WHERE spc.settlementId = {id}
    end hnote
    SETTLE_DAO <- - DB: Return data
    deactivate DB
    SSAPI <- - SETTLE_DAO: Return **settlementAccountsList**
    deactivate SETTLE_DAO

    SSAPI -> SETTLE_DAO: Retrive full information for settlement windows\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Select from DB
    activate DB
    hnote over DB #lightyellow
        SELECT ssw.settlementWindowId, sswsc.settlementWindowStateId,
               sswsc.reason, sswsc.createdDate
        FROM **settlementSettlementWindow** ssw
        JOIN **settlementWindow** sw
        ON sw.settlementWindow = ssw.settlementWindowId
        JOIN **settlementWindowStateChange** swsc
        ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId
        WHERE ssw.settlementId = {id}
    end hnote
    SETTLE_DAO <- - DB: Return data
    deactivate DB
    SSAPI <- - SETTLE_DAO: Return **windowsList**
    deactivate SETTLE_DAO

    SSAPI -> SETTLE_DAO: Retrive full information for settlement windows accounts\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Select from DB
    activate DB
    hnote over DB #lightyellow
        SELECT DISTINCT settlementWindowId, participantCurrencyId
        FROM **settlementTransferParticipant**
        WHERE settlementId = {id}
    end hnote
    SETTLE_DAO <- - DB: Return data
    deactivate DB
    SSAPI <- - SETTLE_DAO: Return **windowsAccountsList**
    deactivate SETTLE_DAO

    note right of SSAPI #lightblue
        All objects below are done for the purposes of the syncronous request.
        If at same point Node process memory limit is reached we may decide to:
        A. Limit the amount of transfers per window and windows per settlement or
        B. Move to asyncronous processing where we don't need these objects
    end note
    note right of SSAPI #lightgray
        Available raw datasets from DB:
        **settlementData** contains information about settlement and its current state/reason
        **settlementAccountsList** holds information about all accounts and their current state/reason
        **windowsList** has information about all windows and their current state/reason
        **windowsAccountsList** has information about all accounts and windows

        Local variables and objects:
        **settlementAccounts**: { // (derived from <color 0000FF>settlementAccountsList</color>)
            pendingSettlementCount: <integer>, // count of accounts in PENDING_SETTLEMENT state
            settledCount: <integer>, // count of accounts in SETTLED state
            notSettledCount: <integer> // count of accounts in NOT_SETTLED state
        }
        **settlementAccountsInit** copy of previous object to be preserved for comparission at the end
        **allAccounts**: { // same as previous but accessed by account id (derived from <color 0000FF>settlementAccountsList</color>)
            participantCurrencyId_key: { // number used to access the object in map-like style
                id: participantCurrencyId,
                state: settlementStateId,
                reason: reason,
                createdDate: createdDate,
                netSettlementAmount: {
                    amount: netAmount,
                    currency: currencyId
                },
                participantId: participantId, // could be used to reconstruct allParticipants
                key: <color 0000FF>key</color> // will be used to insert new state for settlementParticipantCurrency
            }
        }
        **allWindows**: { // same as settlementWindows response object with initial data (derived from <color 0000FF>windowsList</color>)
            settlementWindowId_key: { // number used to access the object in map-like style
                id: settlementWindowId, // same as key value
                state: settlementWindowStateId, 
                reason: reason, 
                createdDate: createdDate
            }
        }
        **windowsAccounts**: {
            settlementWindowId_key: { // number used to access the object in map-like style
                id: settlementWindowId // same as key value
                pendingSettlementCount: <integer>, // count of accounts in PENDING_SETTLEMENT state
                settledCount: <integer>, // count of accounts in SETTLED state
                notSettledCount: <integer> // count of accounts in NOT_SETTLED state
            }
        }
        **windowsAccountsInit** copy of previous object to be preserved for comparission at the end
        **accountsWindows**: {
            participantCurrencyId_key: { // number used to access the object in map-like style
                id: participantCurrencyId, // same as key value
                windows: [] // array of windows to which the account settlement spans
            }
        }
        let **transactionTimestamp** = now()
    end note
    |||
    SSAPI -> SSAPI: <color FF0000>**Acquire DB lock**</color> on settlementParticipantCurrencyStateChange,\nsettlementWindowStateChange and settlementStateChange
    |||
    SSAPI -> SSAPI: Declare and initialize variables
    note right of SSAPI #lightgray
        let settlementAccounts = {
            pendingSettlementAccounts: 0,
            settledAccounts: 0,
            notSettledAccounts: 0,
        }
        let allAccounts = {} // declare sparse array
        let pid // participantId
        let aid // accountId (participantCurrencyId)
        let state
    end note

    loop settlementAccountsList as record
        SSAPI -> SSAPI: Populate **allAccounts** 
        note right of SSAPI #lightgray
            pid = record.participantId
            aid = record.participantCurrencyId
            state = record.settlementStateId

            allAccounts[aid] = {
                id: aid,
                state,
                reason: record.reason,
                createDate: record.createdDate,
                netSettlementAmount: {
                    amount: record.netAmount,
                    currency: record.currencyId
                },
                key
            }
        end note

        SSAPI -> SSAPI: Populate **settlementAccounts**
        alt state == 'PENDING_SETTLEMENT'
            note right of SSAPI #lightgray
                settlementAccounts.pendingSettlementCount++
            end note
        else state == 'SETTLED'
            note right of SSAPI #lightgray
                settlementAccounts.settledCount++
            end note
        else state == 'NOT_SETTLED'
            note right of SSAPI #lightgray
                settlementAccounts.notSettledCount++
            end note
        end
    end
    SSAPI -> SSAPI: Make a copy of settlementAccounts into **settlementAccountsInit**
    note right of SSAPI #lightgray
        settlementAccountsInit = Object.assign({}, settlementAccounts)
    end note
    |||
    SSAPI -> SSAPI: Declare and populate **allWindows**
    note right of SSAPI #lightgray
        let allWindows = {} // declare sparse array
        let wid // settlementWindowId
    end note
    loop windowsList as record
        note right of SSAPI #lightgray
            wid = record.settlementWindowId
            state = record.settlementWindowStateId

            allWindows[wid] = {
                id: wid,
                state,
                reason: record.reason,
                createDate: record.createdDate
            }
        end note
    end 
    |||
    SSAPI -> SSAPI: Declare and populate **accountsWindows** and **windowsAccounts**
    note right of SSAPI #lightgray
        let accountsWindows = {} // declare sparse array
        let windowsAccounts = {} // declare sparse array
    end note
    loop windowsAccountsList as record
        note right of SSAPI #lightgray
            wid = record.settlementWindowId
            aid = record.participantCurrencyId
            state = allAccounts[aid]

            accountsWindows[aid] = accountsWindows[aid] ? accountsWindows[aid] : {
                id: aid,
                windows: []
            }
            accountsWindows[aid].windows.push(wid)

            windowsAccounts[wid] = windowsAccounts[wid] ? windowsAccounts[wid] : {
                id: wid, 
                pendingSettlementCount: 0,
                settledCount: 0,
                notSettledCount: 0
            }
        end note
        alt state == 'PENDING_SETTLEMENT'
            note right of SSAPI #lightgray
                windowsAccounts[wid].pendingSettlementCount++
            end note
        else state == 'SETTLED'
            note right of SSAPI #lightgray
                windowsAccounts[wid].settledCount++
            end note
        else state == 'NOT_SETTLED'
            note right of SSAPI #lightgray
                windowsAccounts[wid].notSettledCount++
            end note
        end
    end
    SSAPI -> SSAPI: Make a copy of windowsAccounts into **windowsAccountsInit**
    note right of SSAPI #lightgray
        windowsAccountsInit = Object.assign({}, windowsAccounts)
    end note 
    |||
    note right of SSAPI #lightgray
        Available objects after the setup:
        **settlementAccounts** is used for tracing settlement state and state transition allowance
        **allAccounts** is helper object, same as previous, providing direct access to account by id
        **allWindows** has window information for all windows in the settlement
        **windowsAccounts** is used for tracing settlement window state and state transition allowance
        **accountsWindows** is helper object to show the list of windows to which settlement account spans

        Now we are ready to process the **payload**:
        **participants** = [] // part of the response object that lists the affected participants and respective accounts
        **affectedWindows** = [] // array of the affected windows
        **settlementParticipantCurrencyStateChange** = [] // array to collect inserts to the table
        **processedAccounts** = [] // array to log processed accounts and restrict subsequent processing
        let **pi** // declare participant index
        let **ai** // declare account index
        let **participant** - - declare pointer to current participant in the //response object//
        let **participantPayload** - - declare pointer to current participant in the //payload object//
        let **accountPayload** - - declare pointer to current account in the //payload object//
    end note
    |||
    loop let p IN payload.participants
        SSAPI -> SSAPI: Loop payload for each **participantPayload**
        note right of SSAPI #lightgray
            participantPayload = payload.participants[p]
            participants.push({id: participantPayload.id, accounts: []})
            pi = participants.length - 1
            participant = participants[pi]
        end note

        loop let a IN participantPayload.accounts
            SSAPI -> SSAPI: Loop payload for each **accountPayload**
            note right of SSAPI #lightgray
                accountPayload = participantPayload.accounts[a]
            end note
            alt allAccounts[accountPayload.id] == undefined
                SSAPI -> SSAPI: If the account doesn't match the settlement
                note right of SSAPI #lightgray
                    participant.accounts.push({
                        id: accountPayload.id,
                        errorInformation: {
                            errorCode: <integer>,
                            errorDescription: 'Account not found'
                        }
                    })
                end note
            else processedAccounts.indexOf(accountPayload.id) > -1
                SSAPI -> SSAPI: If the account has been previosly processed (duplicated in the payload)
                note right of SSAPI #lightgray
                    participant.accounts.push({
                        id: accountPayload.id,
                        state: allAccounts[accountPayload.id].state,
                        reason: allAccounts[accountPayload.id].reason,
                        createdDate: allAccounts[accountPayload.id].createdDate,
                        netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                        errorInformation: {
                            errorCode: <integer>,
                            errorDescription: 'Account already processed once'
                        }
                    })
                end note
            else allAccounts[account.id].state == accountPayload.state // allowed
                SSAPI -> SSAPI: All same-state reason insert is allowed (state preserved)
                note right of SSAPI #lightgray
                    processedAccounts.push(accountPayload.id)
                    participant.accounts.push({
                        id: accountPayload.id,
                        state: accountPayload.state,
                        reason: accountPayload.reason,
                        createdDate: transactionTimestamp,
                        netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                    })
                    settlementParticipantCurrencyStateChange.push({
                        settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,
                        settlementStateId: accountPayload.state,
                        reason: accountPayload.reason
                    })
                    allAccounts[accountPayload.id].reason = accountPayload.reason
                    allAccounts[accountPayload.id].createdDate = currentTimestamp
                end note
            else allAccounts[account.id].state == 'PENDING_SETTLEMENT' && accountPayload.state == 'SETTLED' // allowed
                SSAPI -> SSAPI: True settlement acknowledgement
                note right of SSAPI #lightgray
                    processedAccounts.push(accountPayload.id)
                    participant.accounts.push({
                        id: accountPayload.id,
                        state: accountPayload.state,
                        reason: accountPayload.reason,
                        createdDate: transactionTimestamp,
                        netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                    })
                    settlementParticipantCurrencyStateChange.push({
                        settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,
                        settlementStateId: accountPayload.state,
                        reason: accountPayload.reason
                    })
                    settlementAccounts.pendingSettlementCount- -
                    settlementAccounts.settledCount++
                    allAccounts[accountPayload.id].state = accountPayload.state
                    allAccounts[accountPayload.id].reason = accountPayload.reason
                    allAccounts[accountPayload.id].createdDate = currentTimestamp
                    let settlementWindowId
                end note
                loop let aw IN accountsWindows[accountPayload.id].windows
                    note right of SSAPI #lightgray
                        settlementWindowId = accountsWindows[accountPayload.id].windows[aw]
                        windowsAccounts[settlementWindowId].pendingSettlementCount- -
                        windowsAccounts[settlementWindowId].settledCount++

                        if (affectedWindows.indexOf(settlementWindowId) < 0) {
                            affectedWindows.push(settlementWindowId)
                        }
                    end note
                end
            else
                SSAPI -> SSAPI: All other state transitions are not permitted
                note right of SSAPI #lightgray
                    participant.accounts.push({
                        id: accountPayload.id,
                        state: allAccounts[accountPayload.id].state,
                        reason: allAccounts[accountPayload.id].reason,
                        createdDate: allAccounts[accountPayload.id].createdDate,
                        netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                        errorInformation: {
                            errorCode: <integer>,
                            errorDescription: 'State change not allowed'
                        }
                    })
                end note
            end
        end
    end
    group <color #blue>DB TRANSACTION</color>
        group Bulk insert settlementParticipantCurrencyStateChange
            SSAPI -> SETTLE_DAO: Change settlement participant currency states\n<color #FF0000><b>Error code:</b> 2001</color>
            activate SETTLE_DAO
            SETTLE_DAO -> DB: Insert settlementParticipantCurrencyStateChange
            activate DB
            hnote over DB #lightyellow
                settlementParticipantCurrencyStateChange
            end hnote
            SETTLE_DAO <- - DB: Return **settlementParticipantCurrencyStateChangeIdList**
            deactivate DB

            SETTLE_DAO -> SETTLE_DAO: Merge settlementParticipantCurrencyStateChangeIdList\nto settlementParticipantCurrencyIdList in order to\nissue the following update in one knex command

            SETTLE_DAO -> DB: Update pointers to current state change ids
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementParticipantCurrency**
                SET currentStateChangeId = 
                    {settlementParticipantCurrencyStateChangeIdList}
                WHERE settlementParticipantCurrencyId =
                      {settlementParticipantCurrencyStateChange
                      .settlementParticipantCurrencyIdList}
            end hnote
            deactivate DB

            deactivate SETTLE_DAO
        end
        group Prepare and insert settlementWindowStateChange
            note right of SSAPI #lightgray
                let settlementWindowStateChange = []
                let settlementWindows = [] // response object
                let windowAccountsInit
                let windowAccounts
                let windowState
            end note

            loop let aw IN affectedWindows
                note right of SSAPI #lightgray
                    windowAccountsInit = windowAccountsInit[affectedWindows[aw]]
                    windowAccounts = windowsAccounts[affectedWindows[aw]]
                end note
                opt windowAccounts.pendingSettlementCount != windowAccountsInit.pendingSettlementCount\n|| windowAccounts.settledCount != windowAccountsInit.settledCount
                    opt windowAccounts.pendingSettlementCount == 0\n&& windowAccounts.notSettledCount == 0\n&& windowAccounts.settledCound > 0
                        note right of SSAPI #lightgray
                            allWindows[affectedWindows[aw]].state = 'SETTLED'
                            allWindows[affectedWindows[aw]].reason = 'All setlement accounts are settled'
                            allWindows[affectedWindows[aw]].createdDate = currentTimestamp
                            settlementWindowStateChange.push(allWindows[affectedWindows[aw]])
                        end note
                    end
                    note right of SSAPI #lightgray
                        settlementWindows.push(allWindows[affectedWindows[aw]])
                    end note
                end
            end

            SSAPI -> SETTLE_DAO: Change settlement windows states\n<color #FF0000><b>Error code:</b> 2001</color>
            activate SETTLE_DAO
            SETTLE_DAO -> DB: Insert settlementWindowStateChange
            activate DB
            hnote over DB #lightyellow
                settlementWindowStateChange
            end hnote
            SETTLE_DAO <- - DB: Return **settlementWindowStateChangeIdList**
            deactivate DB

            SETTLE_DAO -> SETTLE_DAO: Merge ids to prepare for single update command

            SETTLE_DAO -> DB: Update pointers to current state change ids
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementWindow**.currentStateChangeIds
            end hnote
            deactivate DB

            deactivate SETTLE_DAO
        end

        group Prepare and insert settlementStateChange
            opt settlementAccounts.settledCount != settlementAccountsInit.settledCount\n&& settlementAccounts.pendingSettlementCount == 0\n&& settlementAccounts.notSettledCount == 0
                note right of SSAPI #lightgray
                    settlementData.state = 'SETTLED'
                    settlementData.reason = 'All setlement accounts are settled'
                    settlementData.createdDate = currentTimestamp
                    settlementStateChange.push(settlementData)
                end note

                SSAPI -> SETTLE_DAO: Change settlement state\n<color #FF0000><b>Error code:</b> 2001</color>
                activate SETTLE_DAO
                SETTLE_DAO -> DB: Insert settlementStateChange
                activate DB
                hnote over DB #lightyellow
                    settlementStateChange
                end hnote
                SETTLE_DAO <- - DB: Return **settlementStateChangeId**
                deactivate DB

                SETTLE_DAO -> DB: Update pointer to current state change id
                activate DB
                hnote over DB #lightyellow
                    UPDATE **settlement**.currentStateChangeId
                end hnote
                deactivate DB
            end
        end
    end
    SSAPI -> SSAPI: <color FF0000>**Release DB lock**</color> on settlementParticipantCurrencyStateChange,\nsettlementWindowStateChange and settlementStateChange

    note left of SSAPI #lightgray
        Samples:
        "**settlementWindows**": [
            {
                "id": <integer>,
                "state": <enum>,
                "reason": <string>,
                "createdDate": <date>
            }
        ]
        "**participants**": [
            {
                "id": <integer>,
                "accounts": [
                    {
                        "id": <integer>,
                        "state": "SETTLED",
                        "reason": <string>,
                        "createdDate": <date>,
                        "netSettlementAmount": {
                            "amount": <decimal>,
                            "currency": <enum>
                        }
                    },
                    {
                        "id": <integer>,
                        "state": "PENDING_SETTLEMENT",
                        "reason": <string>,
                        "createdDate": <date>,
                        "netSettlementAmount": {
                            "amount": <decimal>,
                            "currency": <enum>
                        },
                        "errorInformation": {
                            "errorCode": <integer>,
                            "errorDescription": <string>
                        }
                    }
                ]
            }
        ]
    end note

    note left of SSAPI #lightyellow
        [
          {
            "id": {id},
            "state": settlementData.state,
            "createdDate": settlementData.createdDate,
            "settlementWindows": settlementWindows,
            "participants": participants
          }
        ]
    end note

    SSAPI -> OPERATOR: Return response
    deactivate SSAPI
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>