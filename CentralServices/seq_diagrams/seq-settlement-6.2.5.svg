<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="8926px" preserveAspectRatio="none" style="width:1350px;height:8926px;" version="1.1" viewBox="0 0 1350 8926" width="1350px" zoomAndPan="magnify"><defs><filter height="300%" id="fyttyav3x5ch1" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="515" x="418.5" y="23.5352">6.2.5. Acknowledgement of Settlement Transfer (updateSettlementById)</text><rect fill="#FFB6C1" height="8881.2949" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="107" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="122.5" y="47.0566">Central HUB</text><rect fill="#90EE90" height="8881.2949" style="stroke: #A80036; stroke-width: 1.0;" width="387.5" x="263.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="395.25" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="8881.2949" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="1031" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="1034" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="8673.0078" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="158" y="147.2871"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="8143.3809" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="341" y="660.9141"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="7271.2324" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="585" y="705.5352"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="154.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="759.1563"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="231.0371" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="942.9512"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="185.1055" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="1203.2988"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="1417.7148"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="6605.8418"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="6770.7051"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="7379.623"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="7513.8652"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="7771.2148"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="7863.1465"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="8658.0078" style="stroke: #000000; stroke-width: 2.0;" width="1326" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="7227.9219" style="stroke: #000000; stroke-width: 2.0;" width="836" x="493" y="720.5352"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="604.3184" style="stroke: #000000; stroke-width: 2.0;" width="428" x="523" y="2675.7637"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="219.418" style="stroke: #000000; stroke-width: 2.0;" width="351" x="590" y="3053.6641"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="351" x="590" y="3110.2852"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="351" x="590" y="3164.5508"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="351" x="590" y="3218.8164"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="133.1738" style="stroke: #000000; stroke-width: 2.0;" width="326" x="590" y="3482.3242"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="465.4316" style="stroke: #000000; stroke-width: 2.0;" width="534" x="580" y="3751.4297"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="165.1523" style="stroke: #000000; stroke-width: 2.0;" width="369" x="590" y="4044.709"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="369" x="590" y="4101.3301"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="369" x="590" y="4155.5957"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="1983.0117" style="stroke: #000000; stroke-width: 2.0;" width="679" x="503" y="4570.209"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="1824.1484" style="stroke: #000000; stroke-width: 2.0;" width="659" x="513" y="4722.0723"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="1711.2168" style="stroke: #000000; stroke-width: 2.0;" width="639" x="523" y="4828.0039"/><rect fill="#FFFFFF" height="188.4395" style="stroke: none; stroke-width: 1.0;" width="639" x="523" y="5018.7988"/><rect fill="#FFFFFF" height="249.6816" style="stroke: none; stroke-width: 1.0;" width="639" x="523" y="5207.2383"/><rect fill="#FFFFFF" height="310.9238" style="stroke: none; stroke-width: 1.0;" width="639" x="523" y="5456.9199"/><rect fill="#FFFFFF" height="534.6504" style="stroke: none; stroke-width: 1.0;" width="639" x="523" y="5767.8438"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="148.4844" style="stroke: #000000; stroke-width: 2.0;" width="510" x="590" y="6147.0098"/><rect fill="#FFFFFF" height="236.7266" style="stroke: none; stroke-width: 1.0;" width="639" x="523" y="6302.4941"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="351.3477" style="stroke: #000000; stroke-width: 2.0;" width="750" x="523" y="6567.2207"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="652.6074" style="stroke: #000000; stroke-width: 2.0;" width="749" x="523" y="6932.5684"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="293.8809" style="stroke: #000000; stroke-width: 2.0;" width="625" x="570" y="7057.4316"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="207.9492" style="stroke: #000000; stroke-width: 2.0;" width="605" x="580" y="7136.3633"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="126.418" style="stroke: #000000; stroke-width: 2.0;" width="540" x="590" y="7171.584"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="342.2813" style="stroke: #000000; stroke-width: 2.0;" width="739" x="513" y="7599.1758"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="310.9707" style="stroke: #000000; stroke-width: 2.0;" width="719" x="523" y="7623.4863"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="163" x2="163" y1="137.2871" y2="8829.2949"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="345.5" x2="345.5" y1="137.2871" y2="8829.2949"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="590" x2="590" y1="137.2871" y2="8829.2949"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1088" x2="1088" y1="137.2871" y2="8829.2949"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="111" y="134.334">Hub Employee</text><ellipse cx="163" cy="63.7988" fill="#FEFECE" filter="url(#fyttyav3x5ch1)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M163,71.7988 L163,98.7988 M150,79.7988 L176,79.7988 M163,98.7988 L150,113.7988 M163,98.7988 L176,113.7988 " fill="none" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="111" y="8841.8301">Hub Employee</text><ellipse cx="163" cy="8854.7832" fill="#FEFECE" filter="url(#fyttyav3x5ch1)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M163,8862.7832 L163,8889.7832 M150,8870.7832 L176,8870.7832 M163,8889.7832 L150,8904.7832 M163,8889.7832 L176,8904.7832 " fill="none" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="267.5" y="134.334">Settlement Service API</text><path d="M325.5,92.7988 L325.5,116.7988 M325.5,104.7988 L342.5,104.7988 " fill="none" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="354.5" cy="104.7988" fill="#FEFECE" filter="url(#fyttyav3x5ch1)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="267.5" y="8841.8301">Settlement Service API</text><path d="M325.5,8848.7832 L325.5,8872.7832 M325.5,8860.7832 L342.5,8860.7832 " fill="none" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="354.5" cy="8860.7832" fill="#FEFECE" filter="url(#fyttyav3x5ch1)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="533" y="134.334">Settlement DAO</text><ellipse cx="590" cy="104.7988" fill="#FEFECE" filter="url(#fyttyav3x5ch1)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="578" x2="602" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="533" y="8841.8301">Settlement DAO</text><ellipse cx="590" cy="8860.7832" fill="#FEFECE" filter="url(#fyttyav3x5ch1)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="578" x2="602" y1="8874.7832" y2="8874.7832"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1040" y="134.334">Central Store</text><path d="M1070,84.7988 C1070,74.7988 1088,74.7988 1088,74.7988 C1088,74.7988 1106,74.7988 1106,84.7988 L1106,110.7988 C1106,120.7988 1088,120.7988 1088,120.7988 C1088,120.7988 1070,120.7988 1070,110.7988 L1070,84.7988 " fill="#FEFECE" filter="url(#fyttyav3x5ch1)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1070,84.7988 C1070,94.7988 1088,94.7988 1088,94.7988 C1088,94.7988 1106,94.7988 1106,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1040" y="8841.8301">Central Store</text><path d="M1070,8854.7832 C1070,8844.7832 1088,8844.7832 1088,8844.7832 C1088,8844.7832 1106,8844.7832 1106,8854.7832 L1106,8880.7832 C1106,8890.7832 1088,8890.7832 1088,8890.7832 C1088,8890.7832 1070,8890.7832 1070,8880.7832 L1070,8854.7832 " fill="#FEFECE" filter="url(#fyttyav3x5ch1)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1070,8854.7832 C1070,8864.7832 1088,8864.7832 1088,8864.7832 C1088,8864.7832 1106,8864.7832 1106,8854.7832 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="8673.0078" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="158" y="147.2871"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="8143.3809" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="341" y="660.9141"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="7271.2324" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="585" y="705.5352"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="154.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="759.1563"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="231.0371" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="942.9512"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="185.1055" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="1203.2988"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="1417.7148"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="6605.8418"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="6770.7051"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="7379.623"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="7513.8652"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="7771.2148"/><rect fill="#FFFFFF" filter="url(#fyttyav3x5ch1)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1083" y="7863.1465"/><path d="M13,154.2871 L339,154.2871 L339,161.2871 L329,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="8658.0078" style="stroke: #000000; stroke-width: 2.0;" width="1326" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="281" x="28" y="167.8555">Acknowledgement of Settlement Transfer</text><path d="M173,176.5977 L173,630.5977 L481,630.5977 L481,186.5977 L471,176.5977 L173,176.5977 " fill="#FFFF00" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M471,176.5977 L471,186.5977 L481,186.5977 L471,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="195" y="209.4766">"participants": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="211" y="224.7871">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="227" y="240.0977">"id": 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="227" y="255.4082">"accounts" : [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="243" y="270.7188">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="259" y="286.0293">"id": 1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="259" y="301.3398">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="259" y="316.6504">"reason": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="243" y="331.9609">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="243" y="347.2715">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="259" y="362.582">"id": 2,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="259" y="377.8926">"state": "SETTLED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="259" y="393.2031">"reason": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="243" y="408.5137">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="227" y="423.8242">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="211" y="439.1348">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="211" y="454.4453">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="38" x="227" y="469.7559">"id": 2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="227" y="485.0664">"accounts" : [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="243" y="500.377">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="259" y="515.6875">"id": 3,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="152" x="259" y="530.998">"state": "NOT_SETTLED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="259" y="546.3086">"reason": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="243" y="561.6191">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="227" y="576.9297">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="211" y="592.2402">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="195" y="607.5508">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="622.8613">}</text><polygon fill="#A80036" points="329,656.9141,339,660.9141,329,664.9141,333,660.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="168" x2="335" y1="660.9141" y2="660.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="175" y="656.1719">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="188" y="656.1719">PUT - /settlement/{id}</text><polygon fill="#A80036" points="573,701.5352,583,705.5352,573,709.5352,577,705.5352" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="351" x2="579" y1="705.5352" y2="705.5352"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="358" y="693.1377">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="371" y="685.4824">updateSettlementById command</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="371" y="700.793">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="448" y="700.793">2001</text><path d="M493,720.5352 L658,720.5352 L658,727.5352 L648,737.5352 L493,737.5352 L493,720.5352 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="7227.9219" style="stroke: #000000; stroke-width: 2.0;" width="836" x="493" y="720.5352"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="508" y="734.1035">DB TRANSACTION</text><polygon fill="#A80036" points="1071,755.1563,1081,759.1563,1071,763.1563,1075,759.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="1077" y1="759.1563" y2="759.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="602" y="754.4141">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="615" y="754.4141">Retrieve settlement information</text><polygon fill="#FFFFE0" filter="url(#fyttyav3x5ch1)" points="901,772.1563,1275,772.1563,1285,829.1563,1275,887.1563,901,887.1563,891,829.1563,901,772.1563" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="286" x="903" y="788.7246">SELECT s.settlementId, ssc.settlementStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="919" y="804.0352">ssc.reason, ssc.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="903" y="819.3457">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="943" y="819.3457">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="7" x="1019" y="819.3457">s</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="903" y="834.6563">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="935" y="834.6563">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="21" x="1096" y="834.6563">ssc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="370" x="903" y="849.9668">ON ssc.settlementStateChangeId = s.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="903" y="865.2773">WHERE s.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="903" y="880.5879">FOR UPDATE</text><polygon fill="#A80036" points="606,909.6406,596,913.6406,606,917.6406,602,913.6406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="600" x2="1087" y1="913.6406" y2="913.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="612" y="908.8984">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="625" y="908.8984">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="670" y="908.8984">settlementData</text><polygon fill="#A80036" points="1071,938.9512,1081,942.9512,1071,946.9512,1075,942.9512" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="1077" y1="942.9512" y2="942.9512"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="602" y="938.209">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="615" y="938.209">Retrive settlement accounts information</text><polygon fill="#FFFFE0" filter="url(#fyttyav3x5ch1)" points="904,955.9512,1272,955.9512,1282,1050.9512,1272,1146.9512,904,1146.9512,894,1050.9512,904,955.9512" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="322" x="906" y="972.5195">SELECT pc.participantId, spc.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="922" y="987.8301">spcsc.settlementStateId, spcsc.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="316" x="922" y="1003.1406">spcsc.createdDate, spc.netAmount, pc.currencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="248" x="922" y="1018.4512">spc.settlementParticipantCurrencyId AS</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1174" y="1018.4512">key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="906" y="1033.7617">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="946" y="1033.7617">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1157" y="1033.7617">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="906" y="1049.0723">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="938" y="1049.0723">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1234" y="1049.0723">spcsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="906" y="1064.3828">ON spcsc.settlementParticipantCurrencyStateChangeId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="161" x="906" y="1079.6934">spc.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="906" y="1095.0039">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="938" y="1095.0039">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1078" y="1095.0039">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="906" y="1110.3145">ON pc.participantCurrencyId = spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="906" y="1125.625">WHERE spc.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="906" y="1140.9355">FOR UPDATE</text><polygon fill="#A80036" points="606,1169.9883,596,1173.9883,606,1177.9883,602,1173.9883" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="600" x2="1087" y1="1173.9883" y2="1173.9883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="612" y="1169.2461">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="625" y="1169.2461">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="670" y="1169.2461">settlementAccountsList</text><polygon fill="#A80036" points="1071,1199.2988,1081,1203.2988,1071,1207.2988,1075,1203.2988" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="1077" y1="1203.2988" y2="1203.2988"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="602" y="1198.5566">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="615" y="1198.5566">Retrive settlement windows information</text><polygon fill="#FFFFE0" filter="url(#fyttyav3x5ch1)" points="866,1216.2988,1309,1216.2988,1319,1288.2988,1309,1361.2988,866,1361.2988,856,1288.2988,866,1216.2988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="868" y="1232.8672">SELECT ssw.settlementWindowId, swsc.settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="884" y="1248.1777">swsc.reason, swsc.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="868" y="1263.4883">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="908" y="1263.4883">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="1109" y="1263.4883">ssw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="868" y="1278.7988">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="900" y="1278.7988">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="1029" y="1278.7988">sw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="335" x="868" y="1294.1094">ON sw.settlementWindow = ssw.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="868" y="1309.4199">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="900" y="1309.4199">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="31" x="1114" y="1309.4199">swsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="439" x="868" y="1324.7305">ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="868" y="1340.041">WHERE ssw.settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="868" y="1355.3516">FOR UPDATE</text><polygon fill="#A80036" points="606,1384.4043,596,1388.4043,606,1392.4043,602,1388.4043" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="600" x2="1087" y1="1388.4043" y2="1388.4043"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="612" y="1383.6621">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="625" y="1383.6621">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="83" x="670" y="1383.6621">windowsList</text><polygon fill="#A80036" points="1071,1413.7148,1081,1417.7148,1071,1421.7148,1075,1417.7148" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="1077" y1="1417.7148" y2="1417.7148"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="602" y="1412.9727">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="615" y="1412.9727">Retrieve settlement windows accounts information</text><polygon fill="#FFFFE0" filter="url(#fyttyav3x5ch1)" points="893,1430.7148,1282,1430.7148,1292,1464.7148,1282,1499.7148,893,1499.7148,883,1464.7148,893,1430.7148" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="385" x="895" y="1447.2832">SELECT DISTINCT settlementWindowId, participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="895" y="1462.5938">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="203" x="935" y="1462.5938">settlementTransferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="164" x="895" y="1477.9043">WHERE settlementId = {id}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="895" y="1493.2148">FOR UPDATE</text><polygon fill="#A80036" points="606,1522.2676,596,1526.2676,606,1530.2676,602,1526.2676" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="600" x2="1087" y1="1526.2676" y2="1526.2676"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="612" y="1521.5254">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="634" y="1521.5254">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="145" x="679" y="1521.5254">windowsAccountsList</text><path d="M600,1539.2676 L600,1610.2676 L1097,1610.2676 L1097,1549.2676 L1087,1539.2676 L600,1539.2676 " fill="#ADD8E6" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1087,1539.2676 L1087,1549.2676 L1097,1549.2676 L1087,1539.2676 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="447" x="606" y="1556.8359">All objects below are done for the purposes of the syncronous request.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="462" x="606" y="1572.1465">If at same point Node process memory limit is reached we may decide to:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="476" x="606" y="1587.457">A. Limit the amount of transfers per window and windows per settlement or</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="442" x="606" y="1602.7676">B. Move to asyncronous processing where we don't need these objects</text><path d="M600,1624.5098 L600,2414.5098 L1289,2414.5098 L1289,1634.5098 L1279,1624.5098 L600,1624.5098 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1279,1624.5098 L1279,1634.5098 L1289,1634.5098 L1279,1624.5098 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="606" y="1642.0781">Available raw datasets from DB:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="103" x="606" y="1657.3887">settlementData</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="423" x="713" y="1657.3887">contains information about settlement and its current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="158" x="606" y="1672.6992">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="768" y="1672.6992">holds information about all accounts and their current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="83" x="606" y="1688.0098">windowsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="693" y="1688.0098">has information about all windows and their current state/reason</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="145" x="606" y="1703.3203">windowsAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="755" y="1703.3203">has information about all accounts and windows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="610" y="1718.6309"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="174" x="606" y="1733.9414">Local variables and objects:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="606" y="1749.252">settlementAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="740" y="1749.252">: { // (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="862" y="1749.252">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1011" y="1749.252">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="567" x="622" y="1764.5625">pendingSettlementCount: &lt;integer&gt;, // count of accounts in PENDING_SETTLEMENT state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="402" x="622" y="1779.873">settledCount: &lt;integer&gt;, // count of accounts in SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="454" x="622" y="1795.1836">notSettledCount: &lt;integer&gt; // count of accounts in NOT_SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="606" y="1810.4941">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="606" y="1825.8047">settlementAccountsInit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="427" x="766" y="1825.8047">copy of previous object to be preserved for comparission at the end</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="606" y="1841.1152">allAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="684" y="1841.1152">: { // same as previous but accessed by account id (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="1094" y="1841.1152">settlementAccountsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1243" y="1841.1152">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="523" x="622" y="1856.4258">participantCurrencyId_key: { // number used to access the object in map-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="160" x="638" y="1871.7363">id: participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="153" x="638" y="1887.0469">state: settlementStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="638" y="1902.3574">reason: reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="638" y="1917.668">createdDate: createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="638" y="1932.9785">netSettlementAmount: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="654" y="1948.2891">amount: netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="654" y="1963.5996">currency: currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="638" y="1978.9102">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="468" x="638" y="1994.2207">participantId: participantId, // could be used to reconstruct allParticipants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="26" x="638" y="2009.5313">key:</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="668" y="2009.5313">key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="430" x="694" y="2009.5313">// will be used to insert new state for settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="622" y="2024.8418">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="606" y="2040.1523">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76" x="606" y="2055.4629">allWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="506" x="682" y="2055.4629">: { // same as settlementWindows response object with initial data (derived from</text><text fill="#0000FF" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="78" x="1192" y="2055.4629">windowsList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="1270" y="2055.4629">)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="515" x="622" y="2070.7734">settlementWindowId_key: { // number used to access the object in map-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="288" x="638" y="2086.084">id: settlementWindowId, // same as key value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="638" y="2101.3945">state: settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="638" y="2116.7051">reason: reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="158" x="638" y="2132.0156">createdDate: createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="622" y="2147.3262">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="606" y="2162.6367">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121" x="606" y="2177.9473">windowsAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="727" y="2177.9473">: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="515" x="622" y="2193.2578">settlementWindowId_key: { // number used to access the object in map-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="638" y="2208.5684">id: settlementWindowId // same as key value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="567" x="638" y="2223.8789">pendingSettlementCount: &lt;integer&gt;, // count of accounts in PENDING_SETTLEMENT state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="402" x="638" y="2239.1895">settledCount: &lt;integer&gt;, // count of accounts in SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="454" x="638" y="2254.5">notSettledCount: &lt;integer&gt; // count of accounts in NOT_SETTLED state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="622" y="2269.8105">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="606" y="2285.1211">}</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="143" x="606" y="2300.4316">windowsAccountsInit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="427" x="753" y="2300.4316">copy of previous object to be preserved for comparission at the end</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="606" y="2315.7422">accountsWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="12" x="726" y="2315.7422">: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="523" x="622" y="2331.0527">participantCurrencyId_key: { // number used to access the object in map-like style</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="638" y="2346.3633">id: participantCurrencyId, // same as key value</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="638" y="2361.6738">windows: [] // array of windows to which the account settlement spans</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="622" y="2376.9844">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="606" y="2392.2949">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="606" y="2407.6055">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="626" y="2407.6055">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="782" y="2407.6055">= now()</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="2470.6582" y2="2470.6582"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="2470.6582" y2="2483.6582"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="2483.6582" y2="2483.6582"/><polygon fill="#A80036" points="606,2479.6582,596,2483.6582,606,2487.6582,602,2483.6582" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="2465.916">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="624" y="2465.916">Declare and initialize variables</text><path d="M600,2496.6582 L600,2659.6582 L892,2659.6582 L892,2506.6582 L882,2496.6582 L600,2496.6582 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M882,2496.6582 L882,2506.6582 L892,2506.6582 L882,2496.6582 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="606" y="2514.2266">let settlementAccounts = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="622" y="2529.5371">pendingSettlementAccounts: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="622" y="2544.8477">settledAccounts: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="622" y="2560.1582">notSettledAccounts: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="622" y="2575.4688">unknownCount: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="606" y="2590.7793">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="606" y="2606.0898">let allAccounts = {} // declare map</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="142" x="606" y="2621.4004">let pid // participantId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="271" x="606" y="2636.7109">let aid // accountId (participantCurrencyId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="51" x="606" y="2652.0215">let state</text><path d="M523,2675.7637 L597,2675.7637 L597,2682.7637 L587,2692.7637 L523,2692.7637 L523,2675.7637 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="604.3184" style="stroke: #000000; stroke-width: 2.0;" width="428" x="523" y="2675.7637"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="538" y="2689.332">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="200" x="612" y="2688.3984">[settlementAccountsList as account]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="2714.3848" y2="2714.3848"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="2714.3848" y2="2727.3848"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="2727.3848" y2="2727.3848"/><polygon fill="#A80036" points="606,2723.3848,596,2727.3848,606,2731.3848,602,2727.3848" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="2709.6426">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="624" y="2709.6426">Populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="682" y="2709.6426">allAccounts</text><path d="M600,2740.3848 L600,2994.3848 L848,2994.3848 L848,2750.3848 L838,2740.3848 L600,2740.3848 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M838,2740.3848 L838,2750.3848 L848,2750.3848 L838,2740.3848 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="606" y="2757.9531">pid = account.participantId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="227" x="606" y="2773.2637">aid = account.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="213" x="606" y="2788.5742">state = account.settlementStateId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="610" y="2803.8848"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="606" y="2819.1953">allAccounts[aid] = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="622" y="2834.5059">id: aid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="35" x="622" y="2849.8164">state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="622" y="2865.127">reason: account.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="622" y="2880.4375">createDate: account.createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="622" y="2895.748">netSettlementAmount: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="638" y="2911.0586">amount: account.netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="182" x="638" y="2926.3691">currency: account.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="622" y="2941.6797">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="622" y="2956.9902">participantId: pid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="622" y="2972.3008">key: account.key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="606" y="2987.6113">}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="3025.6641" y2="3025.6641"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="3025.6641" y2="3038.6641"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="3038.6641" y2="3038.6641"/><polygon fill="#A80036" points="606,3034.6641,596,3038.6641,606,3042.6641,602,3038.6641" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="3020.9219">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="624" y="3020.9219">Populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="682" y="3020.9219">settlementAccounts</text><path d="M590,3053.6641 L652,3053.6641 L652,3060.6641 L642,3070.6641 L590,3070.6641 L590,3053.6641 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="219.418" style="stroke: #000000; stroke-width: 2.0;" width="351" x="590" y="3053.6641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="605" y="3067.2324">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="667" y="3066.2988">[state === 'PENDING_SETTLEMENT']</text><path d="M600,3075.9746 L600,3100.9746 L927,3100.9746 L927,3085.9746 L917,3075.9746 L600,3075.9746 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M917,3075.9746 L917,3085.9746 L927,3085.9746 L917,3075.9746 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="606" y="3093.543">settlementAccounts.pendingSettlementCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="590" x2="941" y1="3111.2852" y2="3111.2852"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="126" x="595" y="3121.9199">[state === 'SETTLED']</text><path d="M600,3130.2402 L600,3155.2402 L852,3155.2402 L852,3140.2402 L842,3130.2402 L600,3130.2402 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M842,3130.2402 L842,3140.2402 L852,3140.2402 L842,3130.2402 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="606" y="3147.8086">settlementAccounts.settledCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="590" x2="941" y1="3165.5508" y2="3165.5508"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="595" y="3176.1855">[state === 'NOT_SETTLED']</text><path d="M600,3184.5059 L600,3209.5059 L873,3209.5059 L873,3194.5059 L863,3184.5059 L600,3184.5059 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M863,3184.5059 L863,3194.5059 L873,3194.5059 L863,3184.5059 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="606" y="3202.0742">settlementAccounts.notSettledCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="590" x2="941" y1="3219.8164" y2="3219.8164"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="47" x="595" y="3230.4512">[default]</text><path d="M600,3238.7715 L600,3263.7715 L867,3263.7715 L867,3248.7715 L857,3238.7715 L600,3238.7715 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M857,3238.7715 L857,3248.7715 L867,3248.7715 L857,3238.7715 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="246" x="606" y="3256.3398">settlementAccounts.unknownCount++</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="3308.3926" y2="3308.3926"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="3308.3926" y2="3321.3926"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="3321.3926" y2="3321.3926"/><polygon fill="#A80036" points="606,3317.3926,596,3321.3926,606,3325.3926,602,3321.3926" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="3303.6504">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="254" x="624" y="3303.6504">Make a copy of settlementAccounts into</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="882" y="3303.6504">settlementAccountsInit</text><path d="M600,3334.3926 L600,3359.3926 L1022,3359.3926 L1022,3344.3926 L1012,3334.3926 L600,3334.3926 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1012,3334.3926 L1012,3344.3926 L1022,3344.3926 L1012,3334.3926 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="401" x="606" y="3351.9609">settlementAccountsInit = Object.assign({}, settlementAccounts)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="3415.0137" y2="3415.0137"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="3415.0137" y2="3428.0137"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="3428.0137" y2="3428.0137"/><polygon fill="#A80036" points="606,3424.0137,596,3428.0137,606,3432.0137,602,3428.0137" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="3410.2715">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="624" y="3410.2715">Declare and populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76" x="761" y="3410.2715">allWindows</text><path d="M600,3441.0137 L600,3466.0137 L836,3466.0137 L836,3451.0137 L826,3441.0137 L600,3441.0137 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M826,3441.0137 L826,3451.0137 L836,3451.0137 L826,3441.0137 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="215" x="606" y="3458.582">let allWindows = {} // declare map</text><path d="M590,3482.3242 L664,3482.3242 L664,3489.3242 L654,3499.3242 L590,3499.3242 L590,3482.3242 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="133.1738" style="stroke: #000000; stroke-width: 2.0;" width="326" x="590" y="3482.3242"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="605" y="3495.8926">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="140" x="679" y="3494.959">[windowsList as window]</text><path d="M600,3504.6348 L600,3605.6348 L902,3605.6348 L902,3514.6348 L892,3504.6348 L600,3504.6348 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M892,3504.6348 L892,3514.6348 L902,3514.6348 L892,3504.6348 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="281" x="606" y="3522.2031">allWindows[window.settlementWindowId] = {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="622" y="3537.5137">id: window.settlementWindowId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="254" x="622" y="3552.8242">state: window.settlementWindowStateId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="622" y="3568.1348">reason: window.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="622" y="3583.4453">createDate: window.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="606" y="3598.7559">}</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="3668.8086" y2="3668.8086"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="3668.8086" y2="3681.8086"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="3681.8086" y2="3681.8086"/><polygon fill="#A80036" points="606,3677.8086,596,3681.8086,606,3685.8086,602,3681.8086" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="3664.0664">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="624" y="3664.0664">Declare and populate</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="761" y="3664.0664">accountsWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="885" y="3664.0664">and</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121" x="912" y="3664.0664">windowsAccounts</text><path d="M600,3694.8086 L600,3734.8086 L879,3734.8086 L879,3704.8086 L869,3694.8086 L600,3694.8086 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M869,3694.8086 L869,3704.8086 L879,3704.8086 L869,3694.8086 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="606" y="3712.377">let accountsWindows = {} // declare map</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="606" y="3727.6875">let windowsAccounts = {} // declare map</text><path d="M580,3751.4297 L654,3751.4297 L654,3758.4297 L644,3768.4297 L580,3768.4297 L580,3751.4297 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="465.4316" style="stroke: #000000; stroke-width: 2.0;" width="534" x="580" y="3751.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="595" y="3764.998">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="184" x="669" y="3764.0645">[windowsAccountsList as record]</text><path d="M600,3773.7402 L600,4027.7402 L1100,4027.7402 L1100,3783.7402 L1090,3773.7402 L600,3773.7402 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1090,3773.7402 L1090,3783.7402 L1100,3783.7402 L1090,3773.7402 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="606" y="3791.3086">wid = record.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="606" y="3806.6191">aid = record.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="150" x="606" y="3821.9297">state = allAccounts[aid]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="610" y="3837.2402"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="467" x="606" y="3852.5508">accountsWindows[aid] = accountsWindows[aid] ? accountsWindows[aid] : {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="622" y="3867.8613">id: aid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="622" y="3883.1719">windows: []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="606" y="3898.4824">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="606" y="3913.793">accountsWindows[aid].windows.push(wid)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="610" y="3929.1035"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="479" x="606" y="3944.4141">windowsAccounts[wid] = windowsAccounts[wid] ? windowsAccounts[wid] : {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="622" y="3959.7246">id: wid,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="622" y="3975.0352">pendingSettlementCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="101" x="622" y="3990.3457">settledCount: 0,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="118" x="622" y="4005.6563">notSettledCount: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="606" y="4020.9668">}</text><path d="M590,4044.709 L652,4044.709 L652,4051.709 L642,4061.709 L590,4061.709 L590,4044.709 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="165.1523" style="stroke: #000000; stroke-width: 2.0;" width="369" x="590" y="4044.709"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="605" y="4058.2773">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="667" y="4057.3438">[state === 'PENDING_SETTLEMENT']</text><path d="M600,4067.0195 L600,4092.0195 L945,4092.0195 L945,4077.0195 L935,4067.0195 L600,4067.0195 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M935,4067.0195 L935,4077.0195 L945,4077.0195 L935,4067.0195 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="324" x="606" y="4084.5879">windowsAccounts[wid].pendingSettlementCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="590" x2="959" y1="4102.3301" y2="4102.3301"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="126" x="595" y="4112.9648">[state === 'SETTLED']</text><path d="M600,4121.2852 L600,4146.2852 L870,4146.2852 L870,4131.2852 L860,4121.2852 L600,4121.2852 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M860,4121.2852 L860,4131.2852 L870,4131.2852 L860,4121.2852 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="249" x="606" y="4138.8535">windowsAccounts[wid].settledCount++</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="590" x2="959" y1="4156.5957" y2="4156.5957"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="595" y="4167.2305">[state === 'NOT_SETTLED']</text><path d="M600,4175.5508 L600,4200.5508 L891,4200.5508 L891,4185.5508 L881,4175.5508 L600,4175.5508 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M881,4175.5508 L881,4185.5508 L891,4185.5508 L881,4175.5508 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="606" y="4193.1191">windowsAccounts[wid].notSettledCount++</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="4245.1719" y2="4245.1719"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="4245.1719" y2="4258.1719"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="4258.1719" y2="4258.1719"/><polygon fill="#A80036" points="606,4254.1719,596,4258.1719,606,4262.1719,602,4258.1719" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="4240.4297">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="242" x="624" y="4240.4297">Make a copy of windowsAccounts into</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="143" x="870" y="4240.4297">windowsAccountsInit</text><path d="M600,4271.1719 L600,4296.1719 L998,4296.1719 L998,4281.1719 L988,4271.1719 L600,4271.1719 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M988,4271.1719 L988,4281.1719 L998,4281.1719 L988,4271.1719 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="377" x="606" y="4288.7402">windowsAccountsInit = Object.assign({}, windowsAccounts)</text><path d="M600,4335.4824 L600,4528.4824 L1294,4528.4824 L1294,4345.4824 L1284,4335.4824 L600,4335.4824 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1284,4335.4824 L1284,4345.4824 L1294,4345.4824 L1284,4335.4824 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="606" y="4353.0508">Available objects after the setup:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="134" x="606" y="4368.3613">settlementAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="414" x="744" y="4368.3613">is used for tracing settlement state and state transition allowance</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="78" x="606" y="4383.6719">allAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="474" x="688" y="4383.6719">is helper object, same as previous, providing direct access to account by id</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76" x="606" y="4398.9824">allWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="363" x="686" y="4398.9824">has window information for all windows in the settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="121" x="606" y="4414.293">windowsAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="466" x="731" y="4414.293">is used for tracing settlement window state and state transition allowance</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="606" y="4429.6035">accountsWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="499" x="730" y="4429.6035">is helper object to show the list of windows to which settlement account spans</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="610" y="4444.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="606" y="4460.2246">Now we are ready to process the</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="54" x="814" y="4460.2246">payload</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="868" y="4460.2246">:</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="606" y="4475.5352">participants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="588" x="691" y="4475.5352">= [] // part of the response object that lists the affected participants and respective accounts</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="115" x="606" y="4490.8457">affectedWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="230" x="725" y="4490.8457">= [] // array of the affected windows</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="606" y="4506.1563">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="261" x="902" y="4506.1563">= [] // array to collect inserts to the table</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="131" x="606" y="4521.4668">processedAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="471" x="741" y="4521.4668">= [] // array to log processed accounts and restrict subsequent processing</text><path d="M503,4570.209 L577,4570.209 L577,4577.209 L567,4587.209 L503,4587.209 L503,4570.209 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1983.0117" style="stroke: #000000; stroke-width: 2.0;" width="679" x="503" y="4570.209"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="518" y="4583.7773">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="218" x="592" y="4582.8438">[let participant IN payload.participants]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="4608.8301" y2="4608.8301"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="4608.8301" y2="4621.8301"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="4621.8301" y2="4621.8301"/><polygon fill="#A80036" points="606,4617.8301,596,4621.8301,606,4625.8301,602,4621.8301" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="4604.0879">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="624" y="4604.0879">Loop payload for each</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="767" y="4604.0879">participantPayload</text><path d="M600,4634.8301 L600,4705.8301 L980,4705.8301 L980,4644.8301 L970,4634.8301 L600,4634.8301 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M970,4634.8301 L970,4644.8301 L980,4644.8301 L970,4634.8301 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="606" y="4652.3984">let participantPayload = payload.participants[participant]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="606" y="4667.709">participants.push({id: participantPayload.id, accounts: []})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="606" y="4683.0195">let pi = participants.length - 1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="606" y="4698.3301">participant = participants[pi]</text><path d="M513,4722.0723 L587,4722.0723 L587,4729.0723 L577,4739.0723 L513,4739.0723 L513,4722.0723 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1824.1484" style="stroke: #000000; stroke-width: 2.0;" width="659" x="513" y="4722.0723"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="528" y="4735.6406">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="244" x="602" y="4734.707">[let account IN participantPayload.accounts]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="4760.6934" y2="4760.6934"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="4760.6934" y2="4773.6934"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="4773.6934" y2="4773.6934"/><polygon fill="#A80036" points="606,4769.6934,596,4773.6934,606,4777.6934,602,4773.6934" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="4755.9512">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="624" y="4755.9512">Loop payload for each</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="106" x="767" y="4755.9512">accountPayload</text><path d="M600,4786.6934 L600,4811.6934 L992,4811.6934 L992,4796.6934 L982,4786.6934 L600,4786.6934 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M982,4786.6934 L982,4796.6934 L992,4796.6934 L982,4786.6934 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="371" x="606" y="4804.2617">let accountPayload = participantPayload.accounts[account]</text><path d="M523,4828.0039 L585,4828.0039 L585,4835.0039 L575,4845.0039 L523,4845.0039 L523,4828.0039 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1711.2168" style="stroke: #000000; stroke-width: 2.0;" width="639" x="523" y="4828.0039"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="538" y="4841.5723">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="272" x="600" y="4840.6387">[allAccounts[accountPayload.id] === undefined]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="4866.625" y2="4866.625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="4866.625" y2="4879.625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="4879.625" y2="4879.625"/><polygon fill="#A80036" points="606,4875.625,596,4879.625,606,4883.625,602,4879.625" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="4861.8828">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="624" y="4861.8828">If the account doesn't match the settlement</text><path d="M600,4892.625 L600,5009.625 L888,5009.625 L888,4902.625 L878,4892.625 L600,4892.625 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M878,4892.625 L878,4902.625 L888,4902.625 L878,4892.625 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="606" y="4910.1934">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="622" y="4925.5039">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="622" y="4940.8145">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="638" y="4956.125">errorCode: 3000,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="235" x="638" y="4971.4355">errorDescription: 'Account not found'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="622" y="4986.7461">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="606" y="5002.0566">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="523" x2="1162" y1="5019.7988" y2="5019.7988"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="401" x="528" y="5030.4336">[participantPayload.id !== allAccounts[accountPayload.id].participantId]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="5055.0645" y2="5055.0645"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="5055.0645" y2="5068.0645"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="5068.0645" y2="5068.0645"/><polygon fill="#A80036" points="606,5064.0645,596,5068.0645,606,5072.0645,602,5068.0645" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="5050.3223">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="276" x="624" y="5050.3223">If the account doesn't match the participant</text><path d="M600,5081.0645 L600,5198.0645 L984,5198.0645 L984,5091.0645 L974,5081.0645 L600,5081.0645 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M974,5081.0645 L974,5091.0645 L984,5091.0645 L974,5081.0645 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="606" y="5098.6328">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="622" y="5113.9434">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="622" y="5129.2539">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="638" y="5144.5645">errorCode: 3000,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="331" x="638" y="5159.875">errorDescription: 'Participant and account mismatch'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="622" y="5175.1855">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="606" y="5190.4961">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="523" x2="1162" y1="5208.2383" y2="5208.2383"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="301" x="528" y="5218.873">[processedAccounts.indexOf(accountPayload.id) &gt; -1]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="5243.5039" y2="5243.5039"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="5243.5039" y2="5256.5039"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="5256.5039" y2="5256.5039"/><polygon fill="#A80036" points="606,5252.5039,596,5256.5039,606,5260.5039,602,5256.5039" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="5238.7617">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="447" x="624" y="5238.7617">If the account has been previosly processed (duplicated in the payload)</text><path d="M600,5269.5039 L600,5447.5039 L1119,5447.5039 L1119,5279.5039 L1109,5269.5039 L600,5269.5039 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1109,5269.5039 L1109,5279.5039 L1119,5279.5039 L1109,5269.5039 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="606" y="5287.0723">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="622" y="5302.3828">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="622" y="5317.6934">state: allAccounts[accountPayload.id].state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="622" y="5333.0039">reason: allAccounts[accountPayload.id].reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="622" y="5348.3145">createdDate: allAccounts[accountPayload.id].createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="622" y="5363.625">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="622" y="5378.9355">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="638" y="5394.2461">errorCode: 3000,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="320" x="638" y="5409.5566">errorDescription: 'Account already processed once'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="622" y="5424.8672">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="606" y="5440.1777">})</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="523" x2="1162" y1="5457.9199" y2="5457.9199"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="380" x="528" y="5468.5547">[allAccounts[account.id].state === accountPayload.state // allowed]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="5493.1855" y2="5493.1855"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="5493.1855" y2="5506.1855"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="5506.1855" y2="5506.1855"/><polygon fill="#A80036" points="606,5502.1855,596,5506.1855,606,5510.1855,602,5506.1855" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="5488.4434">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="354" x="624" y="5488.4434">All same-state reason insert is allowed (state preserved)</text><path d="M600,5519.1855 L600,5758.1855 L1119,5758.1855 L1119,5529.1855 L1109,5519.1855 L600,5519.1855 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1109,5519.1855 L1109,5529.1855 L1119,5529.1855 L1109,5519.1855 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="606" y="5536.7539">processedAccounts.push(accountPayload.id)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="606" y="5552.0645">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="622" y="5567.375">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="622" y="5582.6855">state: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="622" y="5597.9961">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="622" y="5613.3066">createdDate: transactionTimestamp,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="622" y="5628.6172">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="606" y="5643.9277">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="606" y="5659.2383">settlementParticipantCurrencyStateChange.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="622" y="5674.5488">settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="622" y="5689.8594">settlementStateId: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="622" y="5705.1699">reason: accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="606" y="5720.4805">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="606" y="5735.791">allAccounts[accountPayload.id].reason = accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="606" y="5751.1016">allAccounts[accountPayload.id].createdDate = currentTimestamp</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="523" x2="1162" y1="5768.8438" y2="5768.8438"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="634" x="528" y="5779.4785">[allAccounts[account.id].state === 'PENDING_SETTLEMENT' &amp;&amp; accountPayload.state === 'SETTLED' // allowed]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="5804.1094" y2="5804.1094"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="5804.1094" y2="5817.1094"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="5817.1094" y2="5817.1094"/><polygon fill="#A80036" points="606,5813.1094,596,5817.1094,606,5821.1094,602,5817.1094" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="5799.3672">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="217" x="624" y="5799.3672">True settlement acknowledgement</text><path d="M600,5830.1094 L600,6130.1094 L1119,6130.1094 L1119,5840.1094 L1109,5830.1094 L600,5830.1094 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1109,5830.1094 L1109,5840.1094 L1119,5840.1094 L1109,5830.1094 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="280" x="606" y="5847.6777">processedAccounts.push(accountPayload.id)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="606" y="5862.9883">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="622" y="5878.2988">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="176" x="622" y="5893.6094">state: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="622" y="5908.9199">reason: accountPayload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="622" y="5924.2305">createdDate: transactionTimestamp,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="622" y="5939.541">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="606" y="5954.8516">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="606" y="5970.1621">settlementParticipantCurrencyStateChange.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="622" y="5985.4727">settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="622" y="6000.7832">settlementStateId: accountPayload.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="622" y="6016.0938">reason: accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="606" y="6031.4043">})</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="302" x="606" y="6046.7148">settlementAccounts.pendingSettlementCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="606" y="6062.0254">settlementAccounts.settledCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="382" x="606" y="6077.3359">allAccounts[accountPayload.id].state = accountPayload.state</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="404" x="606" y="6092.6465">allAccounts[accountPayload.id].reason = accountPayload.reason</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="408" x="606" y="6107.957">allAccounts[accountPayload.id].createdDate = currentTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="606" y="6123.2676">let settlementWindowId</text><path d="M590,6147.0098 L664,6147.0098 L664,6154.0098 L654,6164.0098 L590,6164.0098 L590,6147.0098 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="148.4844" style="stroke: #000000; stroke-width: 2.0;" width="510" x="590" y="6147.0098"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="605" y="6160.5781">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="320" x="679" y="6159.6445">[let aw IN accountsWindows[accountPayload.id].windows]</text><path d="M600,6169.3203 L600,6286.3203 L1086,6286.3203 L1086,6179.3203 L1076,6169.3203 L600,6169.3203 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1076,6169.3203 L1076,6179.3203 L1086,6179.3203 L1076,6169.3203 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="465" x="606" y="6186.8887">settlementWindowId = accountsWindows[accountPayload.id].windows[aw]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="426" x="606" y="6202.1992">windowsAccounts[settlementWindowId].pendingSettlementCount--</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="355" x="606" y="6217.5098">windowsAccounts[settlementWindowId].settledCount++</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="610" y="6232.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="352" x="606" y="6248.1309">if (affectedWindows.indexOf(settlementWindowId) &lt; 0) {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="622" y="6263.4414">affectedWindows.push(settlementWindowId)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="606" y="6278.752">}</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="523" x2="1162" y1="6303.4941" y2="6303.4941"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="6325.8047" y2="6325.8047"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="6325.8047" y2="6338.8047"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="6338.8047" y2="6338.8047"/><polygon fill="#A80036" points="606,6334.8047,596,6338.8047,606,6342.8047,602,6338.8047" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="6321.0625">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="624" y="6321.0625">All other state transitions are not permitted</text><path d="M600,6351.8047 L600,6529.8047 L1119,6529.8047 L1119,6361.8047 L1109,6351.8047 L600,6351.8047 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1109,6351.8047 L1109,6361.8047 L1119,6361.8047 L1109,6351.8047 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="172" x="606" y="6369.373">participant.accounts.push({</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="622" y="6384.6836">id: accountPayload.id,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="622" y="6399.9941">state: allAccounts[accountPayload.id].state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="296" x="622" y="6415.3047">reason: allAccounts[accountPayload.id].reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="362" x="622" y="6430.6152">createdDate: allAccounts[accountPayload.id].createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="482" x="622" y="6445.9258">netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="622" y="6461.2363">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="138" x="638" y="6476.5469">errorCode: &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="638" y="6491.8574">errorDescription: 'State change not allowed'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="622" y="6507.168">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="606" y="6522.4785">})</text><path d="M523,6567.2207 L936,6567.2207 L936,6574.2207 L926,6584.2207 L523,6584.2207 L523,6567.2207 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="351.3477" style="stroke: #000000; stroke-width: 2.0;" width="750" x="523" y="6567.2207"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="368" x="538" y="6580.7891">Bulk insert settlementParticipantCurrencyStateChange</text><polygon fill="#A80036" points="1071,6601.8418,1081,6605.8418,1071,6609.8418,1075,6605.8418" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="1077" y1="6605.8418" y2="6605.8418"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="6601.0996">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="624" y="6601.0996">Insert settlementParticipantCurrencyStateChange</text><polygon fill="#FFFFE0" filter="url(#fyttyav3x5ch1)" points="952,6618.8418,1224,6618.8418,1234,6629.8418,1224,6641.8418,952,6641.8418,942,6629.8418,952,6618.8418" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="954" y="6635.4102">settlementParticipantCurrencyStateChange</text><polygon fill="#A80036" points="606,6664.4629,596,6668.4629,606,6672.4629,602,6668.4629" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="600" x2="1087" y1="6668.4629" y2="6668.4629"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="612" y="6663.7207">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="634" y="6663.7207">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="329" x="679" y="6663.7207">settlementParticipantCurrencyStateChangeIdList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="6728.3945" y2="6728.3945"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="6728.3945" y2="6741.3945"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="6741.3945" y2="6741.3945"/><polygon fill="#A80036" points="606,6737.3945,596,6741.3945,606,6745.3945,602,6741.3945" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="6708.3418">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="345" x="624" y="6693.0313">Merge settlementParticipantCurrencyStateChangeIdList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="624" y="6708.3418">to settlementParticipantCurrencyIdList in order to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="624" y="6723.6523">issue the following update in one knex command</text><polygon fill="#A80036" points="1071,6766.7051,1081,6770.7051,1071,6774.7051,1075,6770.7051" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="1077" y1="6770.7051" y2="6770.7051"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="6765.9629">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="624" y="6765.9629">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#fyttyav3x5ch1)" points="922,6813.7051,1253,6813.7051,1263,6862.7051,1253,6912.7051,922,6912.7051,912,6862.7051,922,6813.7051" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="924" y="6830.2734">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="978" y="6830.2734">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="924" y="6845.584">SET currentStateChangeId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="940" y="6860.8945">{settlementParticipantCurrencyStateChangeIdList}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="263" x="924" y="6876.2051">WHERE settlementParticipantCurrencyId =</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="956" y="6891.5156">{settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="233" x="956" y="6906.8262">.settlementParticipantCurrencyIdList}</text><path d="M523,6932.5684 L908,6932.5684 L908,6939.5684 L898,6949.5684 L523,6949.5684 L523,6932.5684 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="652.6074" style="stroke: #000000; stroke-width: 2.0;" width="749" x="523" y="6932.5684"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="340" x="538" y="6946.1367">Prepare and insert settlementWindowStateChange</text><path d="M600,6954.8789 L600,7040.8789 L912,7040.8789 L912,6964.8789 L902,6954.8789 L600,6954.8789 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M902,6954.8789 L902,6964.8789 L912,6964.8789 L902,6954.8789 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="606" y="6972.4473">let settlementWindowStateChange = []</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="291" x="606" y="6987.7578">let settlementWindows = [] // response object</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="606" y="7003.0684">let windowAccountsInit</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="606" y="7018.3789">let windowAccounts</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="606" y="7033.6895">let windowState</text><path d="M570,7057.4316 L644,7057.4316 L644,7064.4316 L634,7074.4316 L570,7074.4316 L570,7057.4316 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="293.8809" style="stroke: #000000; stroke-width: 2.0;" width="625" x="570" y="7057.4316"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="585" y="7071">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="659" y="7070.0664">[let aw IN affectedWindows]</text><path d="M600,7079.7422 L600,7119.7422 L1035,7119.7422 L1035,7089.7422 L1025,7079.7422 L600,7079.7422 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1025,7079.7422 L1025,7089.7422 L1035,7089.7422 L1025,7079.7422 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="414" x="606" y="7097.3105">windowAccountsInit = windowAccountsInit[affectedWindows[aw]]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="379" x="606" y="7112.6211">windowAccounts = windowsAccounts[affectedWindows[aw]]</text><path d="M580,7136.3633 L647,7136.3633 L647,7143.3633 L637,7153.3633 L580,7153.3633 L580,7136.3633 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="207.9492" style="stroke: #000000; stroke-width: 2.0;" width="605" x="580" y="7136.3633"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="595" y="7149.9316">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="518" x="662" y="7148.998">[windowAccounts.pendingSettlementCount !== windowAccountsInit.pendingSettlementCount</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="398" x="662" y="7161.9531">|| windowAccounts.settledCount !== windowAccountsInit.settledCount]</text><path d="M590,7171.584 L657,7171.584 L657,7178.584 L647,7188.584 L590,7188.584 L590,7171.584 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="126.418" style="stroke: #000000; stroke-width: 2.0;" width="540" x="590" y="7171.584"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="605" y="7185.1523">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="279" x="672" y="7184.2188">[windowAccounts.pendingSettlementCount === 0</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="247" x="672" y="7197.1738">&amp;&amp; windowAccounts.notSettledCount === 0</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="218" x="672" y="7210.1289">&amp;&amp; windowAccounts.settledCound &gt; 0]</text><path d="M600,7217.7598 L600,7288.7598 L1116,7288.7598 L1116,7227.7598 L1106,7217.7598 L600,7217.7598 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1106,7217.7598 L1106,7227.7598 L1116,7227.7598 L1106,7217.7598 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="324" x="606" y="7235.3281">allWindows[affectedWindows[aw]].state = 'SETTLED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="495" x="606" y="7250.6387">allWindows[affectedWindows[aw]].reason = 'All setlement accounts are settled'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="423" x="606" y="7265.9492">allWindows[affectedWindows[aw]].createdDate = currentTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="448" x="606" y="7281.2598">settlementWindowStateChange.push(allWindows[affectedWindows[aw]])</text><path d="M600,7310.002 L600,7335.002 L998,7335.002 L998,7320.002 L988,7310.002 L600,7310.002 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M988,7310.002 L988,7320.002 L998,7320.002 L988,7310.002 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="377" x="606" y="7327.5703">settlementWindows.push(allWindows[affectedWindows[aw]])</text><polygon fill="#A80036" points="1071,7375.623,1081,7379.623,1071,7383.623,1075,7379.623" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="1077" y1="7379.623" y2="7379.623"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="7374.8809">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="234" x="624" y="7374.8809">Insert settlementWindowStateChange</text><polygon fill="#FFFFE0" filter="url(#fyttyav3x5ch1)" points="989,7392.623,1187,7392.623,1197,7403.623,1187,7415.623,989,7415.623,979,7403.623,989,7392.623" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="991" y="7409.1914">settlementWindowStateChange</text><polygon fill="#A80036" points="606,7438.2441,596,7442.2441,606,7446.2441,602,7442.2441" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="600" x2="1087" y1="7442.2441" y2="7442.2441"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="612" y="7437.502">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="634" y="7437.502">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="247" x="679" y="7437.502">settlementWindowStateChangeIdList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="637" y1="7471.5547" y2="7471.5547"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="637" x2="637" y1="7471.5547" y2="7484.5547"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="596" x2="637" y1="7484.5547" y2="7484.5547"/><polygon fill="#A80036" points="606,7480.5547,596,7484.5547,606,7488.5547,602,7484.5547" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="7466.8125">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="624" y="7466.8125">Merge ids to prepare for single update command</text><polygon fill="#A80036" points="1071,7509.8652,1081,7513.8652,1071,7517.8652,1075,7513.8652" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="1077" y1="7513.8652" y2="7513.8652"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="7509.123">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="624" y="7509.123">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#fyttyav3x5ch1)" points="923,7556.8652,1252,7556.8652,1262,7567.8652,1252,7579.8652,923,7579.8652,913,7567.8652,923,7556.8652" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="925" y="7573.4336">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="979" y="7573.4336">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="1104" y="7573.4336">.currentStateChangeIds</text><path d="M513,7599.1758 L845,7599.1758 L845,7606.1758 L835,7616.1758 L513,7616.1758 L513,7599.1758 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="342.2813" style="stroke: #000000; stroke-width: 2.0;" width="739" x="513" y="7599.1758"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="287" x="528" y="7612.7441">Prepare and insert settlementStateChange</text><path d="M523,7623.4863 L590,7623.4863 L590,7630.4863 L580,7640.4863 L523,7640.4863 L523,7623.4863 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="310.9707" style="stroke: #000000; stroke-width: 2.0;" width="719" x="523" y="7623.4863"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="538" y="7637.0547">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="416" x="605" y="7636.1211">[settlementAccounts.settledCount !== settlementAccountsInit.settledCount</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="310" x="605" y="7649.0762">&amp;&amp; settlementAccounts.pendingSettlementCount === 0</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="266" x="605" y="7662.0313">&amp;&amp; settlementAccounts.notSettledCount === 0]</text><path d="M600,7669.6621 L600,7740.6621 L1001,7740.6621 L1001,7679.6621 L991,7669.6621 L600,7669.6621 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M991,7669.6621 L991,7679.6621 L1001,7679.6621 L991,7669.6621 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="606" y="7687.2305">settlementData.state = 'SETTLED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="606" y="7702.541">settlementData.reason = 'All setlement accounts are settled'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="606" y="7717.8516">settlementData.createdDate = currentTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="284" x="606" y="7733.1621">settlementStateChange.push(settlementData)</text><polygon fill="#A80036" points="1071,7767.2148,1081,7771.2148,1071,7775.2148,1075,7771.2148" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="1077" y1="7771.2148" y2="7771.2148"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="7766.4727">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="624" y="7766.4727">Insert settlementStateChange</text><polygon fill="#FFFFE0" filter="url(#fyttyav3x5ch1)" points="1013,7784.2148,1162,7784.2148,1172,7795.2148,1162,7807.2148,1013,7807.2148,1003,7795.2148,1013,7784.2148" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="1015" y="7800.7832">settlementStateChange</text><polygon fill="#A80036" points="606,7829.8359,596,7833.8359,606,7837.8359,602,7833.8359" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="600" x2="1087" y1="7833.8359" y2="7833.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="612" y="7829.0938">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="634" y="7829.0938">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="679" y="7829.0938">settlementStateChangeId</text><polygon fill="#A80036" points="1071,7859.1465,1081,7863.1465,1071,7867.1465,1075,7863.1465" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="595" x2="1077" y1="7863.1465" y2="7863.1465"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="602" y="7858.4043">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="624" y="7858.4043">Update pointer to current state change id</text><polygon fill="#FFFFE0" filter="url(#fyttyav3x5ch1)" points="953,7906.1465,1222,7906.1465,1232,7917.1465,1222,7929.1465,953,7929.1465,943,7917.1465,953,7906.1465" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="955" y="7922.7148">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="1009" y="7922.7148">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="1081" y="7922.7148">.currentStateChangeId</text><polygon fill="#A80036" points="362,7972.7676,352,7976.7676,362,7980.7676,358,7976.7676" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="356" x2="589" y1="7976.7676" y2="7976.7676"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="368" y="7972.0254">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="156" x="390" y="7972.0254">Return transaction result</text><path d="M40,7989.7676 L40,8611.7676 L332,8611.7676 L332,7999.7676 L322,7989.7676 L40,7989.7676 " fill="#D3D3D3" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M322,7989.7676 L322,7999.7676 L332,7999.7676 L322,7989.7676 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="56" x="46" y="8007.3359">Samples:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="46" y="8022.6465">"</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="132" x="51" y="8022.6465">settlementWindows</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="183" y="8022.6465">": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="62" y="8037.957">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="78" y="8053.2676">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="108" x="78" y="8068.5781">"state": &lt;enum&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="78" y="8083.8887">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="78" y="8099.1992">"createdDate": &lt;date&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="62" y="8114.5098">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="46" y="8129.8203">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="5" x="46" y="8145.1309">"</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="51" y="8145.1309">participants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="132" y="8145.1309">": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="62" y="8160.4414">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="78" y="8175.752">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="78" y="8191.0625">"accounts": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="94" y="8206.373">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="110" y="8221.6836">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="117" x="110" y="8236.9941">"state": "SETTLED",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="110" y="8252.3047">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="110" y="8267.6152">"createdDate": &lt;date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="110" y="8282.9258">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="126" y="8298.2363">"amount": &lt;decimal&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="126" y="8313.5469">"currency": &lt;enum&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="110" y="8328.8574">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="94" y="8344.168">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="94" y="8359.4785">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="110" y="8374.7891">"id": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="110" y="8390.0996">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="121" x="110" y="8405.4102">"reason": &lt;string&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="110" y="8420.7207">"createdDate": &lt;date&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="110" y="8436.0313">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="126" y="8451.3418">"amount": &lt;decimal&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="126" y="8466.6523">"currency": &lt;enum&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="110" y="8481.9629">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="110" y="8497.2734">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="126" y="8512.584">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="178" x="126" y="8527.8945">"errorDescription": &lt;string&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="110" y="8543.2051">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="94" y="8558.5156">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="78" y="8573.8262">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="62" y="8589.1367">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="46" y="8604.4473">]</text><path d="M23,8626.1895 L23,8773.1895 L332,8773.1895 L332,8636.1895 L322,8626.1895 L23,8626.1895 " fill="#FFFFE0" filter="url(#fyttyav3x5ch1)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M322,8626.1895 L322,8636.1895 L332,8636.1895 L322,8626.1895 " fill="#FFFFE0" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="29" y="8643.7578">[</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="37" y="8659.0684">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="45" y="8674.3789">"id": {id},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="45" y="8689.6895">"state": settlementData.state,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="45" y="8705">"createdDate": settlementData.createdDate,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="268" x="45" y="8720.3105">"settlementWindows": settlementWindows,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="45" y="8735.6211">"participants": participants</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="37" y="8750.9316">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="29" y="8766.2422">]</text><polygon fill="#A80036" points="179,8800.2949,169,8804.2949,179,8808.2949,175,8804.2949" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="173" x2="345" y1="8804.2949" y2="8804.2949"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="185" y="8799.5527">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="102" x="207" y="8799.5527">Return response</text><!--
@startuml
title 6.2.5. Acknowledgement of Settlement Transfer (updateSettlementById)
autonumber

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Settlement Service" #lightgreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

group Acknowledgement of Settlement Transfer
    activate OPERATOR
    note right of OPERATOR #yellow
        {
            "participants": [
                {
                    "id": 1
                    "accounts" : [
                        {
                            "id": 1,
                            "state": "PENDING_SETTLEMENT",
                            "reason": <string>
                        },
                        {
                            "id": 2,
                            "state": "SETTLED",
                            "reason": <string>
                        }
                    ]
                },
                {
                    "id": 2
                    "accounts" : [
                        {
                            "id": 3,
                            "state": "NOT_SETTLED",
                            "reason": <string>
                        }
                    ]
                }
            ]
        }
    end note

    OPERATOR -> SSAPI: PUT - /settlement/{id}
    activate SSAPI
    SSAPI -> SETTLE_DAO: updateSettlementById command\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    group <color #blue>DB TRANSACTION</color>
        SETTLE_DAO -> DB: Retrieve settlement information
        activate DB
        hnote over DB #lightyellow
            SELECT s.settlementId, ssc.settlementStateId, 
                ssc.reason, ssc.createdDate
            FROM **settlement** s
            JOIN **settlementStateChange** ssc
            ON ssc.settlementStateChangeId = s.currentStateChangeId
            WHERE s.settlementId = {id}
            FOR UPDATE
        end hnote
        SETTLE_DAO <- - DB: Return **settlementData**
        deactivate DB

        SETTLE_DAO -> DB: Retrive settlement accounts information
        activate DB
        hnote over DB #lightyellow
            SELECT pc.participantId, spc.participantCurrencyId, 
                spcsc.settlementStateId, spcsc.reason,
                spcsc.createdDate, spc.netAmount, pc.currencyId, 
                spc.settlementParticipantCurrencyId AS <color #0000FF>key</color>
            FROM **settlementParticipantCurrency** spc
            JOIN **settlementParticipantCurrencyStateChange** spcsc
            ON spcsc.settlementParticipantCurrencyStateChangeId = 
            spc.currentStateChangeId
            JOIN **participantCurrency** pc
            ON pc.participantCurrencyId = spc.participantCurrencyId
            WHERE spc.settlementId = {id}
            FOR UPDATE
        end hnote
        SETTLE_DAO <- - DB: Return **settlementAccountsList**
        deactivate DB

        SETTLE_DAO -> DB: Retrive settlement windows information
        activate DB
        hnote over DB #lightyellow
            SELECT ssw.settlementWindowId, swsc.settlementWindowStateId,
                swsc.reason, swsc.createdDate
            FROM **settlementSettlementWindow** ssw
            JOIN **settlementWindow** sw
            ON sw.settlementWindow = ssw.settlementWindowId
            JOIN **settlementWindowStateChange** swsc
            ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId
            WHERE ssw.settlementId = {id}
            FOR UPDATE
        end hnote
        SETTLE_DAO <- - DB: Return **windowsList**
        deactivate DB

        SETTLE_DAO -> DB: Retrieve settlement windows accounts information
        activate DB
        hnote over DB #lightyellow
            SELECT DISTINCT settlementWindowId, participantCurrencyId
            FROM **settlementTransferParticipant**
            WHERE settlementId = {id}
            FOR UPDATE
        end hnote
        SETTLE_DAO <- - DB: Return **windowsAccountsList**
        deactivate DB

        note right of SETTLE_DAO #lightblue
            All objects below are done for the purposes of the syncronous request.
            If at same point Node process memory limit is reached we may decide to:
            A. Limit the amount of transfers per window and windows per settlement or
            B. Move to asyncronous processing where we don't need these objects
        end note
        note right of SETTLE_DAO #lightgray
            Available raw datasets from DB:
            **settlementData** contains information about settlement and its current state/reason
            **settlementAccountsList** holds information about all accounts and their current state/reason
            **windowsList** has information about all windows and their current state/reason
            **windowsAccountsList** has information about all accounts and windows

            Local variables and objects:
            **settlementAccounts**: { // (derived from <color 0000FF>settlementAccountsList</color>)
                pendingSettlementCount: <integer>, // count of accounts in PENDING_SETTLEMENT state
                settledCount: <integer>, // count of accounts in SETTLED state
                notSettledCount: <integer> // count of accounts in NOT_SETTLED state
            }
            **settlementAccountsInit** copy of previous object to be preserved for comparission at the end
            **allAccounts**: { // same as previous but accessed by account id (derived from <color 0000FF>settlementAccountsList</color>)
                participantCurrencyId_key: { // number used to access the object in map-like style
                    id: participantCurrencyId,
                    state: settlementStateId,
                    reason: reason,
                    createdDate: createdDate,
                    netSettlementAmount: {
                        amount: netAmount,
                        currency: currencyId
                    },
                    participantId: participantId, // could be used to reconstruct allParticipants
                    key: <color 0000FF>key</color> // will be used to insert new state for settlementParticipantCurrency
                }
            }
            **allWindows**: { // same as settlementWindows response object with initial data (derived from <color 0000FF>windowsList</color>)
                settlementWindowId_key: { // number used to access the object in map-like style
                    id: settlementWindowId, // same as key value
                    state: settlementWindowStateId, 
                    reason: reason, 
                    createdDate: createdDate
                }
            }
            **windowsAccounts**: {
                settlementWindowId_key: { // number used to access the object in map-like style
                    id: settlementWindowId // same as key value
                    pendingSettlementCount: <integer>, // count of accounts in PENDING_SETTLEMENT state
                    settledCount: <integer>, // count of accounts in SETTLED state
                    notSettledCount: <integer> // count of accounts in NOT_SETTLED state
                }
            }
            **windowsAccountsInit** copy of previous object to be preserved for comparission at the end
            **accountsWindows**: {
                participantCurrencyId_key: { // number used to access the object in map-like style
                    id: participantCurrencyId, // same as key value
                    windows: [] // array of windows to which the account settlement spans
                }
            }
            let **transactionTimestamp** = now()
        end note
        |||
        SETTLE_DAO -> SETTLE_DAO: Declare and initialize variables
        note right of SETTLE_DAO #lightgray
            let settlementAccounts = {
                pendingSettlementAccounts: 0,
                settledAccounts: 0,
                notSettledAccounts: 0,
                unknownCount: 0
            }
            let allAccounts = {} // declare map
            let pid // participantId
            let aid // accountId (participantCurrencyId)
            let state
        end note

        loop settlementAccountsList as account
            SETTLE_DAO -> SETTLE_DAO: Populate **allAccounts** 
            note right of SETTLE_DAO #lightgray
                pid = account.participantId
                aid = account.participantCurrencyId
                state = account.settlementStateId

                allAccounts[aid] = {
                    id: aid,
                    state,
                    reason: account.reason,
                    createDate: account.createdDate,
                    netSettlementAmount: {
                        amount: account.netAmount,
                        currency: account.currencyId
                    },
                    participantId: pid,
                    key: account.key
                }
            end note

            SETTLE_DAO -> SETTLE_DAO: Populate **settlementAccounts**
            alt state === 'PENDING_SETTLEMENT'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.pendingSettlementCount++
                end note
            else state === 'SETTLED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.settledCount++
                end note
            else state === 'NOT_SETTLED'
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.notSettledCount++
                end note
            else default
                note right of SETTLE_DAO #lightgray
                    settlementAccounts.unknownCount++
                end note
            end
        end
        SETTLE_DAO -> SETTLE_DAO: Make a copy of settlementAccounts into **settlementAccountsInit**
        note right of SETTLE_DAO #lightgray
            settlementAccountsInit = Object.assign({}, settlementAccounts)
        end note
        |||
        SETTLE_DAO -> SETTLE_DAO: Declare and populate **allWindows**
        note right of SETTLE_DAO #lightgray
            let allWindows = {} // declare map
        end note
        loop windowsList as window
            note right of SETTLE_DAO #lightgray
                allWindows[window.settlementWindowId] = {
                    id: window.settlementWindowId,
                    state: window.settlementWindowStateId,
                    reason: window.reason,
                    createDate: window.createdDate
                }
            end note
        end 
        |||
        SETTLE_DAO -> SETTLE_DAO: Declare and populate **accountsWindows** and **windowsAccounts**
        note right of SETTLE_DAO #lightgray
            let accountsWindows = {} // declare map
            let windowsAccounts = {} // declare map
        end note
        loop windowsAccountsList as record
            note right of SETTLE_DAO #lightgray
                wid = record.settlementWindowId
                aid = record.participantCurrencyId
                state = allAccounts[aid]

                accountsWindows[aid] = accountsWindows[aid] ? accountsWindows[aid] : {
                    id: aid,
                    windows: []
                }
                accountsWindows[aid].windows.push(wid)

                windowsAccounts[wid] = windowsAccounts[wid] ? windowsAccounts[wid] : {
                    id: wid, 
                    pendingSettlementCount: 0,
                    settledCount: 0,
                    notSettledCount: 0
                }
            end note
            alt state === 'PENDING_SETTLEMENT'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].pendingSettlementCount++
                end note
            else state === 'SETTLED'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].settledCount++
                end note
            else state === 'NOT_SETTLED'
                note right of SETTLE_DAO #lightgray
                    windowsAccounts[wid].notSettledCount++
                end note
            end
        end
        SETTLE_DAO -> SETTLE_DAO: Make a copy of windowsAccounts into **windowsAccountsInit**
        note right of SETTLE_DAO #lightgray
            windowsAccountsInit = Object.assign({}, windowsAccounts)
        end note 
        |||
        note right of SETTLE_DAO #lightgray
            Available objects after the setup:
            **settlementAccounts** is used for tracing settlement state and state transition allowance
            **allAccounts** is helper object, same as previous, providing direct access to account by id
            **allWindows** has window information for all windows in the settlement
            **windowsAccounts** is used for tracing settlement window state and state transition allowance
            **accountsWindows** is helper object to show the list of windows to which settlement account spans

            Now we are ready to process the **payload**:
            **participants** = [] // part of the response object that lists the affected participants and respective accounts
            **affectedWindows** = [] // array of the affected windows
            **settlementParticipantCurrencyStateChange** = [] // array to collect inserts to the table
            **processedAccounts** = [] // array to log processed accounts and restrict subsequent processing
        end note
        |||
        loop let participant IN payload.participants
            SETTLE_DAO -> SETTLE_DAO: Loop payload for each **participantPayload**
            note right of SETTLE_DAO #lightgray
                let participantPayload = payload.participants[participant]
                participants.push({id: participantPayload.id, accounts: []})
                let pi = participants.length - 1
                participant = participants[pi]
            end note

            loop let account IN participantPayload.accounts
                SETTLE_DAO -> SETTLE_DAO: Loop payload for each **accountPayload**
                note right of SETTLE_DAO #lightgray
                    let accountPayload = participantPayload.accounts[account]
                end note
                alt allAccounts[accountPayload.id] === undefined
                    SETTLE_DAO -> SETTLE_DAO: If the account doesn't match the settlement
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            errorInformation: {
                                errorCode: 3000,
                                errorDescription: 'Account not found'
                            }
                        })
                    end note
                else participantPayload.id !== allAccounts[accountPayload.id].participantId
                    SETTLE_DAO -> SETTLE_DAO: If the account doesn't match the participant
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            errorInformation: {
                                errorCode: 3000,
                                errorDescription: 'Participant and account mismatch'
                            }
                        })
                    end note
                else processedAccounts.indexOf(accountPayload.id) > -1
                    SETTLE_DAO -> SETTLE_DAO: If the account has been previosly processed (duplicated in the payload)
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: allAccounts[accountPayload.id].state,
                            reason: allAccounts[accountPayload.id].reason,
                            createdDate: allAccounts[accountPayload.id].createdDate,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                            errorInformation: {
                                errorCode: 3000,
                                errorDescription: 'Account already processed once'
                            }
                        })
                    end note
                else allAccounts[account.id].state === accountPayload.state // allowed
                    SETTLE_DAO -> SETTLE_DAO: All same-state reason insert is allowed (state preserved)
                    note right of SETTLE_DAO #lightgray
                        processedAccounts.push(accountPayload.id)
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: accountPayload.state,
                            reason: accountPayload.reason,
                            createdDate: transactionTimestamp,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                        })
                        settlementParticipantCurrencyStateChange.push({
                            settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,
                            settlementStateId: accountPayload.state,
                            reason: accountPayload.reason
                        })
                        allAccounts[accountPayload.id].reason = accountPayload.reason
                        allAccounts[accountPayload.id].createdDate = currentTimestamp
                    end note
                else allAccounts[account.id].state === 'PENDING_SETTLEMENT' && accountPayload.state === 'SETTLED' // allowed
                    SETTLE_DAO -> SETTLE_DAO: True settlement acknowledgement
                    note right of SETTLE_DAO #lightgray
                        processedAccounts.push(accountPayload.id)
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: accountPayload.state,
                            reason: accountPayload.reason,
                            createdDate: transactionTimestamp,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                        })
                        settlementParticipantCurrencyStateChange.push({
                            settlementParticipantCurrencyId: allAccounts[accountPayload.id].key,
                            settlementStateId: accountPayload.state,
                            reason: accountPayload.reason
                        })
                        settlementAccounts.pendingSettlementCount- -
                        settlementAccounts.settledCount++
                        allAccounts[accountPayload.id].state = accountPayload.state
                        allAccounts[accountPayload.id].reason = accountPayload.reason
                        allAccounts[accountPayload.id].createdDate = currentTimestamp
                        let settlementWindowId
                    end note
                    loop let aw IN accountsWindows[accountPayload.id].windows
                        note right of SETTLE_DAO #lightgray
                            settlementWindowId = accountsWindows[accountPayload.id].windows[aw]
                            windowsAccounts[settlementWindowId].pendingSettlementCount- -
                            windowsAccounts[settlementWindowId].settledCount++

                            if (affectedWindows.indexOf(settlementWindowId) < 0) {
                                affectedWindows.push(settlementWindowId)
                            }
                        end note
                    end
                else
                    SETTLE_DAO -> SETTLE_DAO: All other state transitions are not permitted
                    note right of SETTLE_DAO #lightgray
                        participant.accounts.push({
                            id: accountPayload.id,
                            state: allAccounts[accountPayload.id].state,
                            reason: allAccounts[accountPayload.id].reason,
                            createdDate: allAccounts[accountPayload.id].createdDate,
                            netSettlementAmount: allAccounts[accountPayload.id].netSettlementAmount
                            errorInformation: {
                                errorCode: <integer>,
                                errorDescription: 'State change not allowed'
                            }
                        })
                    end note
                end
            end
        end
        group Bulk insert settlementParticipantCurrencyStateChange
            SETTLE_DAO -> DB: Insert settlementParticipantCurrencyStateChange
            activate DB
            hnote over DB #lightyellow
                settlementParticipantCurrencyStateChange
            end hnote
            SETTLE_DAO <- - DB: Return **settlementParticipantCurrencyStateChangeIdList**
            deactivate DB

            SETTLE_DAO -> SETTLE_DAO: Merge settlementParticipantCurrencyStateChangeIdList\nto settlementParticipantCurrencyIdList in order to\nissue the following update in one knex command

            SETTLE_DAO -> DB: Update pointers to current state change ids
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementParticipantCurrency**
                SET currentStateChangeId = 
                    {settlementParticipantCurrencyStateChangeIdList}
                WHERE settlementParticipantCurrencyId =
                        {settlementParticipantCurrencyStateChange
                        .settlementParticipantCurrencyIdList}
            end hnote
            deactivate DB
        end
        group Prepare and insert settlementWindowStateChange
            note right of SETTLE_DAO #lightgray
                let settlementWindowStateChange = []
                let settlementWindows = [] // response object
                let windowAccountsInit
                let windowAccounts
                let windowState
            end note

            loop let aw IN affectedWindows
                note right of SETTLE_DAO #lightgray
                    windowAccountsInit = windowAccountsInit[affectedWindows[aw]]
                    windowAccounts = windowsAccounts[affectedWindows[aw]]
                end note
                opt windowAccounts.pendingSettlementCount !== windowAccountsInit.pendingSettlementCount\n|| windowAccounts.settledCount !== windowAccountsInit.settledCount
                    opt windowAccounts.pendingSettlementCount === 0\n&& windowAccounts.notSettledCount === 0\n&& windowAccounts.settledCound > 0
                        note right of SETTLE_DAO #lightgray
                            allWindows[affectedWindows[aw]].state = 'SETTLED'
                            allWindows[affectedWindows[aw]].reason = 'All setlement accounts are settled'
                            allWindows[affectedWindows[aw]].createdDate = currentTimestamp
                            settlementWindowStateChange.push(allWindows[affectedWindows[aw]])
                        end note
                    end
                    note right of SETTLE_DAO #lightgray
                        settlementWindows.push(allWindows[affectedWindows[aw]])
                    end note
                end
            end

            SETTLE_DAO -> DB: Insert settlementWindowStateChange
            activate DB
            hnote over DB #lightyellow
                settlementWindowStateChange
            end hnote
            SETTLE_DAO <- - DB: Return **settlementWindowStateChangeIdList**
            deactivate DB

            SETTLE_DAO -> SETTLE_DAO: Merge ids to prepare for single update command

            SETTLE_DAO -> DB: Update pointers to current state change ids
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementWindow**.currentStateChangeIds
            end hnote
            deactivate DB
        end

        group Prepare and insert settlementStateChange
            opt settlementAccounts.settledCount !== settlementAccountsInit.settledCount\n&& settlementAccounts.pendingSettlementCount === 0\n&& settlementAccounts.notSettledCount === 0
                note right of SETTLE_DAO #lightgray
                    settlementData.state = 'SETTLED'
                    settlementData.reason = 'All setlement accounts are settled'
                    settlementData.createdDate = currentTimestamp
                    settlementStateChange.push(settlementData)
                end note

                SETTLE_DAO -> DB: Insert settlementStateChange
                activate DB
                hnote over DB #lightyellow
                    settlementStateChange
                end hnote
                SETTLE_DAO <- - DB: Return **settlementStateChangeId**
                deactivate DB

                SETTLE_DAO -> DB: Update pointer to current state change id
                activate DB
                hnote over DB #lightyellow
                    UPDATE **settlement**.currentStateChangeId
                end hnote
                deactivate DB
            end
        end
    end
    SSAPI <- - SETTLE_DAO: Return transaction result
    deactivate SETTLE_DAO

    note left of SSAPI #lightgray
        Samples:
        "**settlementWindows**": [
            {
                "id": <integer>,
                "state": <enum>,
                "reason": <string>,
                "createdDate": <date>
            }
        ]
        "**participants**": [
            {
                "id": <integer>,
                "accounts": [
                    {
                        "id": <integer>,
                        "state": "SETTLED",
                        "reason": <string>,
                        "createdDate": <date>,
                        "netSettlementAmount": {
                            "amount": <decimal>,
                            "currency": <enum>
                        }
                    },
                    {
                        "id": <integer>,
                        "state": "PENDING_SETTLEMENT",
                        "reason": <string>,
                        "createdDate": <date>,
                        "netSettlementAmount": {
                            "amount": <decimal>,
                            "currency": <enum>
                        },
                        "errorInformation": {
                            "errorCode": <integer>,
                            "errorDescription": <string>
                        }
                    }
                ]
            }
        ]
    end note

    note left of SSAPI #lightyellow
        [
          {
            "id": {id},
            "state": settlementData.state,
            "createdDate": settlementData.createdDate,
            "settlementWindows": settlementWindows,
            "participants": participants
          }
        ]
    end note

    SSAPI -> OPERATOR: Return response
    deactivate SSAPI
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>