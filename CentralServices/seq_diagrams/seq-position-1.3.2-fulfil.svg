<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1512px" preserveAspectRatio="none" style="width:1621px;height:1512px;" version="1.1" viewBox="0 0 1621 1512" width="1621px" zoomAndPan="magnify"><defs><filter height="300%" id="fxo3fa43fufhr" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="274" x="674.5" y="23.5352">1.3.2 Fulfil Position Handler Consume</text><rect fill="#FFFFE0" height="1466.6777" style="stroke: #A80036; stroke-width: 1.0;" width="1363" x="29" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="660" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#fxo3fa43fufhr)" height="1299.3906" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="87.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fxo3fa43fufhr)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="636.5" y="1380.0566"/><rect fill="#FFFFFF" filter="url(#fxo3fa43fufhr)" height="121.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="757.5" y="186.5977"/><rect fill="#FFFFFF" filter="url(#fxo3fa43fufhr)" height="502.9004" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="757.5" y="434.3926"/><rect fill="#FFFFFF" filter="url(#fxo3fa43fufhr)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1335" y="216.2188"/><rect fill="#FFFFFF" filter="url(#fxo3fa43fufhr)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1335" y="488.3242"/><rect fill="#FFFFFF" filter="url(#fxo3fa43fufhr)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1335" y="622.5664"/><rect fill="#FFFFFF" filter="url(#fxo3fa43fufhr)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1335" y="730.498"/><rect fill="#FFFFFF" filter="url(#fxo3fa43fufhr)" height="1285.3906" style="stroke: #000000; stroke-width: 2.0;" width="1597" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#fxo3fa43fufhr)" height="564.5215" style="stroke: #000000; stroke-width: 2.0;" width="1577" x="23" y="381.082"/><rect fill="#FFFFFF" filter="url(#fxo3fa43fufhr)" height="459.2793" style="stroke: #000000; stroke-width: 2.0;" width="885.5" x="704.5" y="450.0137"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="92" x2="92" y1="116.2871" y2="1435.6777"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="641.5" x2="641.5" y1="116.2871" y2="1435.6777"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="762.5" x2="762.5" y1="116.2871" y2="1435.6777"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1232" x2="1232" y1="116.2871" y2="1435.6777"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1340" x2="1340" y1="116.2871" y2="1435.6777"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="33" y="113.334">Position Handler</text><ellipse cx="92.5" cy="83.7988" fill="#FEFECE" filter="url(#fxo3fa43fufhr)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="88.5,71.7988,94.5,66.7988,92.5,71.7988,94.5,76.7988,88.5,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="33" y="1448.2129">Position Handler</text><ellipse cx="92.5" cy="1467.166" fill="#FEFECE" filter="url(#fxo3fa43fufhr)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="88.5,1455.166,94.5,1450.166,92.5,1455.166,94.5,1460.166,88.5,1455.166" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fxo3fa43fufhr)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="582.5" y="76.7988"/><rect fill="#FEFECE" filter="url(#fxo3fa43fufhr)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="578.5" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="585.5" y="101.334">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#fxo3fa43fufhr)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="582.5" y="1434.6777"/><rect fill="#FEFECE" filter="url(#fxo3fa43fufhr)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="578.5" y="1438.6777"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="585.5" y="1459.2129">Transfer-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="714.5" y="113.334">Position DAO</text><ellipse cx="762.5" cy="83.7988" fill="#FEFECE" filter="url(#fxo3fa43fufhr)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="750.5" x2="774.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="714.5" y="1448.2129">Position DAO</text><ellipse cx="762.5" cy="1467.166" fill="#FEFECE" filter="url(#fxo3fa43fufhr)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="750.5" x2="774.5" y1="1481.166" y2="1481.166"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1183" y="113.334">Transfer DAO</text><ellipse cx="1232.5" cy="83.7988" fill="#FEFECE" filter="url(#fxo3fa43fufhr)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1220.5" x2="1244.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1183" y="1448.2129">Transfer DAO</text><ellipse cx="1232.5" cy="1467.166" fill="#FEFECE" filter="url(#fxo3fa43fufhr)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1220.5" x2="1244.5" y1="1481.166" y2="1481.166"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1292" y="113.334">Central Store</text><path d="M1322,63.7988 C1322,53.7988 1340,53.7988 1340,53.7988 C1340,53.7988 1358,53.7988 1358,63.7988 L1358,89.7988 C1358,99.7988 1340,99.7988 1340,99.7988 C1340,99.7988 1322,99.7988 1322,89.7988 L1322,63.7988 " fill="#FEFECE" filter="url(#fxo3fa43fufhr)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1322,63.7988 C1322,73.7988 1340,73.7988 1340,73.7988 C1340,73.7988 1358,73.7988 1358,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1292" y="1448.2129">Central Store</text><path d="M1322,1461.166 C1322,1451.166 1340,1451.166 1340,1451.166 C1340,1451.166 1358,1451.166 1358,1461.166 L1358,1487.166 C1358,1497.166 1340,1497.166 1340,1497.166 C1340,1497.166 1322,1497.166 1322,1487.166 L1322,1461.166 " fill="#FEFECE" filter="url(#fxo3fa43fufhr)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1322,1461.166 C1322,1471.166 1340,1471.166 1340,1471.166 C1340,1471.166 1358,1471.166 1358,1461.166 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fxo3fa43fufhr)" height="1299.3906" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="87.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fxo3fa43fufhr)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="636.5" y="1380.0566"/><rect fill="#FFFFFF" filter="url(#fxo3fa43fufhr)" height="121.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="757.5" y="186.5977"/><rect fill="#FFFFFF" filter="url(#fxo3fa43fufhr)" height="502.9004" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="757.5" y="434.3926"/><rect fill="#FFFFFF" filter="url(#fxo3fa43fufhr)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1335" y="216.2188"/><rect fill="#FFFFFF" filter="url(#fxo3fa43fufhr)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1335" y="488.3242"/><rect fill="#FFFFFF" filter="url(#fxo3fa43fufhr)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1335" y="622.5664"/><rect fill="#FFFFFF" filter="url(#fxo3fa43fufhr)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1335" y="730.498"/><path d="M13,133.2871 L273,133.2871 L273,140.2871 L263,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1285.3906" style="stroke: #000000; stroke-width: 2.0;" width="1597" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="215" x="28" y="146.8555">Fulfil Position Handler Consume</text><polygon fill="#A80036" points="745.5,182.5977,755.5,186.5977,745.5,190.5977,749.5,186.5977" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="97.5" x2="751.5" y1="186.5977" y2="186.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="104.5" y="174.8213">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="117.5" y="167.166">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="117.5" y="182.4766">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="194.5" y="182.4766">2003</text><polygon fill="#A80036" points="1323,212.2188,1333,216.2188,1323,220.2188,1327,216.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="767.5" x2="1329" y1="216.2188" y2="216.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="774.5" y="211.7871">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="787.5" y="211.7871">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#fxo3fa43fufhr)" points="1274,229.5293,1405,229.5293,1415,240.5293,1405,252.5293,1274,252.5293,1264,240.5293,1274,229.5293" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1276" y="246.0977">transferStateChange</text><polygon fill="#A80036" points="778.5,274.8398,768.5,278.8398,778.5,282.8398,774.5,278.8398" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="772.5" x2="1339" y1="278.8398" y2="278.8398"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="784.5" y="274.4082">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="797.5" y="274.4082">Return current state of transfer from DB</text><polygon fill="#A80036" points="108.5,304.1504,98.5,308.1504,108.5,312.1504,104.5,308.1504" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="102.5" x2="761.5" y1="308.1504" y2="308.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="303.7188">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="127.5" y="303.7188">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="97.5" x2="139.5" y1="353.082" y2="353.082"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="139.5" x2="139.5" y1="353.082" y2="366.082"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="98.5" x2="139.5" y1="366.082" y2="366.082"/><polygon fill="#A80036" points="108.5,362.082,98.5,366.082,108.5,370.082,104.5,366.082" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="104.5" y="340.6846">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="512" x="117.5" y="333.0293">Validate current state (transferStateChange.transferStateId == 'RECEIVED-FULFIL')</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="117.5" y="348.3398">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="194.5" y="348.3398">2001</text><path d="M23,381.082 L744,381.082 L744,388.082 L734,398.082 L23,398.082 L23,381.082 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="564.5215" style="stroke: #000000; stroke-width: 2.0;" width="1577" x="23" y="381.082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="676" x="38" y="394.6504">Persist Position change and Transfer State (with transferState='COMMITTED' on position check pass)</text><polygon fill="#A80036" points="745.5,430.3926,755.5,434.3926,745.5,438.3926,749.5,434.3926" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="97.5" x2="751.5" y1="434.3926" y2="434.3926"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="104.5" y="422.6162">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="117.5" y="414.9609">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="117.5" y="430.2715">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="194.5" y="430.2715">2003</text><path d="M704.5,450.0137 L869.5,450.0137 L869.5,457.0137 L859.5,467.0137 L704.5,467.0137 L704.5,450.0137 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="459.2793" style="stroke: #000000; stroke-width: 2.0;" width="885.5" x="704.5" y="450.0137"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="719.5" y="463.582">DB TRANSACTION</text><polygon fill="#A80036" points="1323,484.3242,1333,488.3242,1323,492.3242,1327,488.3242" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="767.5" x2="1329" y1="488.3242" y2="488.3242"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="774.5" y="483.8926">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396" x="787.5" y="483.8926">Select participantPosition.value FOR UPDATE from DB for Payee</text><polygon fill="#FFFFE0" filter="url(#fxo3fa43fufhr)" points="1278,501.6348,1401,501.6348,1411,512.6348,1401,524.6348,1278,524.6348,1268,512.6348,1278,501.6348" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1280" y="518.2031">participantPosition</text><polygon fill="#A80036" points="778.5,546.9453,768.5,550.9453,778.5,554.9453,774.5,550.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="772.5" x2="1339" y1="550.9453" y2="550.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="784.5" y="546.5137">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="797.5" y="546.5137">Return participantPosition.value from DB for Payee</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="767.5" x2="809.5" y1="580.5664" y2="580.5664"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="809.5" x2="809.5" y1="580.5664" y2="593.5664"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="768.5" x2="809.5" y1="593.5664" y2="593.5664"/><polygon fill="#A80036" points="778.5,589.5664,768.5,593.5664,778.5,597.5664,774.5,593.5664" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="774.5" y="575.8242">9</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="787.5" y="575.8242">latestPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="339" x="881.5" y="575.8242">= participantPosition.value - payload.amount.amount</text><polygon fill="#A80036" points="1323,618.5664,1333,622.5664,1323,626.5664,1327,622.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="767.5" x2="1329" y1="622.5664" y2="622.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="774.5" y="618.1348">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="796.5" y="618.1348">Persist latestPosition to DB for Payee</text><polygon fill="#FFFFE0" filter="url(#fxo3fa43fufhr)" points="1247,665.877,1432,665.877,1442,684.877,1432,703.877,1247,703.877,1237,684.877,1247,665.877" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1249" y="682.4453">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1303" y="682.4453">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="1249" y="697.7559">SET value = latestPosition</text><polygon fill="#A80036" points="1323,726.498,1333,730.498,1323,734.498,1327,730.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="767.5" x2="1329" y1="730.498" y2="730.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="774.5" y="726.0664">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="334" x="796.5" y="726.0664">Persist transfer state and participant position change</text><polygon fill="#FFFFE0" filter="url(#fxo3fa43fufhr)" points="1109,773.8086,1570,773.8086,1580,838.8086,1570,903.8086,1109,903.8086,1099,838.8086,1109,773.8086" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="1111" y="790.377">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="1159" y="790.377">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="1302" y="790.377">transferStateId = 'COMMITTED'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1115" y="805.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="1111" y="820.998">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="1159" y="820.998">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="457" x="1111" y="836.3086">SET transferStateChangeId = transferStateChange.transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="407" x="1111" y="851.6191">participantPositionId = participantPosition.participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="1111" y="866.9297">value = latestPosition,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="1111" y="882.2402">reservedValue = participantPosition.reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="1111" y="897.5508">createdDate = new Date()</text><polygon fill="#A80036" points="108.5,933.293,98.5,937.293,108.5,941.293,104.5,937.293" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="102.5" x2="761.5" y1="937.293" y2="937.293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="932.8613">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="136.5" y="932.8613">Return success</text><path d="M102,957.6035 L102,1334.6035 L364,1334.6035 L364,967.6035 L354,957.6035 L102,957.6035 " fill="#FFFF00" filter="url(#fxo3fa43fufhr)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M354,957.6035 L354,967.6035 L364,967.6035 L354,957.6035 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="108" y="975.1719">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="108" y="990.4824">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="124" y="1005.793">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="124" y="1021.1035">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="124" y="1036.4141">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="124" y="1051.7246">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="124" y="1067.0352">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="140" y="1082.3457">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="140" y="1097.6563">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="124" y="1112.9668">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="124" y="1128.2773">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="140" y="1143.5879">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="156" y="1158.8984">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="156" y="1174.209">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="156" y="1189.5195">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="156" y="1204.8301">action: commit,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="156" y="1220.1406">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="156" y="1235.4512">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="172" y="1250.7617">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="172" y="1266.0723">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="156" y="1281.3828">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="140" y="1296.6934">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="124" y="1312.0039">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="108" y="1327.3145">}</text><polygon fill="#A80036" points="624.5,1376.0566,634.5,1380.0566,624.5,1384.0566,628.5,1380.0566" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="97.5" x2="630.5" y1="1380.0566" y2="1380.0566"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="104.5" y="1368.2803">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="126.5" y="1360.625">Publish Transfer event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="126.5" y="1375.9355">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="203.5" y="1375.9355">2003</text><!--
@startuml
title 1.3.2 Fulfil Position Handler Consume

autonumber


control "Position Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
entity "Position DAO" as POS_DAO
entity "Transfer DAO" as TRANS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant POS_DAO
    participant TRANS_DAO
    participant DB
end box

activate POS_HANDLER
group Fulfil Position Handler Consume
    POS_HANDLER -> POS_DAO: Request current state of transfer from DB \n<color #FF0000><b>Error code:</b> 2003</color>
    activate POS_DAO
    POS_DAO -> DB: Retrieve current state of transfer from DB
    activate DB
    hnote over DB #lightyellow
        transferStateChange
    end note
    DB - -> POS_DAO: Return current state of transfer from DB
    deactivate DB
    POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
    deactivate POS_DAO
    POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'RECEIVED-FULFIL')\n<color #FF0000><b>Error code:</b> 2001</color>
    group Persist Position change and Transfer State (with transferState='COMMITTED' on position check pass)
        POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
        group <color #blue>DB TRANSACTION</color>
            activate POS_DAO
            POS_DAO -> DB: Select participantPosition.value FOR UPDATE from DB for Payee
            activate DB
            hnote over DB #lightyellow
                participantPosition
            end note
            DB - -> POS_DAO: Return participantPosition.value from DB for Payee
            deactivate DB
            POS_DAO <-> POS_DAO: **latestPosition** = participantPosition.value - payload.amount.amount
            POS_DAO->DB: Persist latestPosition to DB for Payee
            hnote over DB #lightyellow
                UPDATE **participantPosition**
                SET value = latestPosition
            end note
            activate DB
            deactivate DB
            POS_DAO -> DB: Persist transfer state and participant position change
            hnote over DB #lightyellow
                    INSERT **transferStateChange** transferStateId = 'COMMITTED'

                    INSERT **participantPositionChange**
                    SET transferStateChangeId = transferStateChange.transferStateChangeId,
                    participantPositionId = participantPosition.participantPositionId,
                    value = latestPosition,
                    reservedValue = participantPosition.reservedValue
                    createdDate = new Date()
            end note
            activate DB
            deactivate DB
            deactivate TRANS_DAO
        end
        POS_DAO - -> POS_HANDLER: Return success
        deactivate POS_DAO
    end

    note right of POS_HANDLER #yellow
        Message:
        {
            id: <transferMessage.transferId>
            from: <transferMessage.payerFsp>,
            to: <transferMessage.payeeFsp>,
            type: application/json
            content: {
                headers: <transferHeaders>,
                payload: <transferMessage>
            },
            metadata: {
                event: {
                    id: <uuid>,
                    responseTo: <previous.uuid>,
                    type: transfer,
                    action: commit,
                    createdAt: <timestamp>,
                    state: {
                        status: "success",
                        code: 0
                    }
                }
            }
        }
    end note
    POS_HANDLER -> TOPIC_TRANSFERS: Publish Transfer event\n<color #FF0000><b>Error code:</b> 2003</color>
    activate TOPIC_TRANSFERS
    deactivate TOPIC_TRANSFERS
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.01(Sun Jan 28 20:08:22 SAST 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_152-release-1136-b20
Operating System: Mac OS X
OS Version: 10.13.5
Default Encoding: UTF-8
Language: en
Country: ZA
--></g></svg>