<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3365px" preserveAspectRatio="none" style="width:1639px;height:3365px;" version="1.1" viewBox="0 0 1639 3365" width="1639px" zoomAndPan="magnify"><defs><filter height="300%" id="fwjv152deap17" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="276" x="682.5" y="23.5352">1.3.3 Abort Position Handler Consume</text><rect fill="#FFFFE0" height="3320.0059" style="stroke: #A80036; stroke-width: 1.0;" width="1372.5" x="39" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="674.75" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="3152.7188" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="97.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="606.5" y="3233.3848"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="121.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="884.5" y="210.9082"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="487.5898" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="884.5" y="458.7031"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="121.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="884.5" y="1512.2305"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="120.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="884.5" y="1760.0254"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="121.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="884.5" y="2339.0313"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="120.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="884.5" y="2571.5156"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1354.5" y="240.5293"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1354.5" y="512.6348"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1354.5" y="646.877"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1354.5" y="754.8086"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1354.5" y="1541.8516"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1354.5" y="1813.957"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1354.5" y="2368.6523"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1354.5" y="2625.4473"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="3138.7188" style="stroke: #000000; stroke-width: 2.0;" width="1615" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="1287.3223" style="stroke: #000000; stroke-width: 2.0;" width="1595" x="23" y="157.5977"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="549.2109" style="stroke: #000000; stroke-width: 2.0;" width="1575" x="33" y="405.3926"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="443.9688" style="stroke: #000000; stroke-width: 2.0;" width="766.5" x="831.5" y="474.3242"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="812.8008" style="stroke: #000000; stroke-width: 2.0;" width="1422" x="23" y="1458.9199"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="181.8633" style="stroke: #000000; stroke-width: 2.0;" width="1394.5" x="33" y="1706.7148"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="76.6211" style="stroke: #000000; stroke-width: 2.0;" width="586" x="831.5" y="1775.6465"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="904.6641" style="stroke: #000000; stroke-width: 2.0;" width="1422" x="23" y="2285.7207"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="181.8633" style="stroke: #000000; stroke-width: 2.0;" width="1394.5" x="33" y="2518.2051"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="76.6211" style="stroke: #000000; stroke-width: 2.0;" width="586" x="831.5" y="2587.1367"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="102" x2="102" y1="116.2871" y2="3289.0059"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="611.5" x2="611.5" y1="116.2871" y2="3289.0059"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="757.5" x2="757.5" y1="116.2871" y2="3289.0059"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="889.5" x2="889.5" y1="116.2871" y2="3289.0059"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1359.5" x2="1359.5" y1="116.2871" y2="3289.0059"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="43" y="113.334">Position Handler</text><ellipse cx="102.5" cy="83.7988" fill="#FEFECE" filter="url(#fwjv152deap17)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="98.5,71.7988,104.5,66.7988,102.5,71.7988,104.5,76.7988,98.5,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="43" y="3301.541">Position Handler</text><ellipse cx="102.5" cy="3320.4941" fill="#FEFECE" filter="url(#fwjv152deap17)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="98.5,3308.4941,104.5,3303.4941,102.5,3308.4941,104.5,3313.4941,98.5,3308.4941" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fwjv152deap17)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="552.5" y="76.7988"/><rect fill="#FEFECE" filter="url(#fwjv152deap17)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="548.5" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="555.5" y="101.334">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#fwjv152deap17)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="552.5" y="3288.0059"/><rect fill="#FEFECE" filter="url(#fwjv152deap17)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="118" x="548.5" y="3292.0059"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="104" x="555.5" y="3312.541">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#fwjv152deap17)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="688.5" y="76.7988"/><rect fill="#FEFECE" filter="url(#fwjv152deap17)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="684.5" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="691.5" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#fwjv152deap17)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="688.5" y="3288.0059"/><rect fill="#FEFECE" filter="url(#fwjv152deap17)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="684.5" y="3292.0059"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="691.5" y="3312.541">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="841.5" y="113.334">Position DAO</text><ellipse cx="889.5" cy="83.7988" fill="#FEFECE" filter="url(#fwjv152deap17)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="877.5" x2="901.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="841.5" y="3301.541">Position DAO</text><ellipse cx="889.5" cy="3320.4941" fill="#FEFECE" filter="url(#fwjv152deap17)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="877.5" x2="901.5" y1="3334.4941" y2="3334.4941"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1311.5" y="113.334">Central Store</text><path d="M1341.5,63.7988 C1341.5,53.7988 1359.5,53.7988 1359.5,53.7988 C1359.5,53.7988 1377.5,53.7988 1377.5,63.7988 L1377.5,89.7988 C1377.5,99.7988 1359.5,99.7988 1359.5,99.7988 C1359.5,99.7988 1341.5,99.7988 1341.5,89.7988 L1341.5,63.7988 " fill="#FEFECE" filter="url(#fwjv152deap17)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1341.5,63.7988 C1341.5,73.7988 1359.5,73.7988 1359.5,73.7988 C1359.5,73.7988 1377.5,73.7988 1377.5,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1311.5" y="3301.541">Central Store</text><path d="M1341.5,3314.4941 C1341.5,3304.4941 1359.5,3304.4941 1359.5,3304.4941 C1359.5,3304.4941 1377.5,3304.4941 1377.5,3314.4941 L1377.5,3340.4941 C1377.5,3350.4941 1359.5,3350.4941 1359.5,3350.4941 C1359.5,3350.4941 1341.5,3350.4941 1341.5,3340.4941 L1341.5,3314.4941 " fill="#FEFECE" filter="url(#fwjv152deap17)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1341.5,3314.4941 C1341.5,3324.4941 1359.5,3324.4941 1359.5,3324.4941 C1359.5,3324.4941 1377.5,3324.4941 1377.5,3314.4941 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="3152.7188" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="97.5" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="606.5" y="3233.3848"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="121.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="884.5" y="210.9082"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="487.5898" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="884.5" y="458.7031"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="121.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="884.5" y="1512.2305"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="120.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="884.5" y="1760.0254"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="121.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="884.5" y="2339.0313"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="120.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="884.5" y="2571.5156"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1354.5" y="240.5293"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1354.5" y="512.6348"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1354.5" y="646.877"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1354.5" y="754.8086"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1354.5" y="1541.8516"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1354.5" y="1813.957"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1354.5" y="2368.6523"/><rect fill="#FFFFFF" filter="url(#fwjv152deap17)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1354.5" y="2625.4473"/><path d="M13,133.2871 L278,133.2871 L278,140.2871 L268,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3138.7188" style="stroke: #000000; stroke-width: 2.0;" width="1615" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="220" x="28" y="146.8555">Abort Position Handler Consume</text><path d="M23,157.5977 L90,157.5977 L90,164.5977 L80,174.5977 L23,174.5977 L23,157.5977 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1287.3223" style="stroke: #000000; stroke-width: 2.0;" width="1595" x="23" y="157.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="38" y="171.166">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="297" x="105" y="170.2324">[type == 'position' &amp;&amp; action == 'timeout-reserved']</text><polygon fill="#A80036" points="872.5,206.9082,882.5,210.9082,872.5,214.9082,876.5,210.9082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="878.5" y1="210.9082" y2="210.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="199.1318">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="127.5" y="191.4766">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="127.5" y="206.7871">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="204.5" y="206.7871">2003</text><polygon fill="#A80036" points="1342.5,236.5293,1352.5,240.5293,1342.5,244.5293,1346.5,240.5293" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="894.5" x2="1348.5" y1="240.5293" y2="240.5293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="901.5" y="236.0977">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="914.5" y="236.0977">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#fwjv152deap17)" points="1294,253.8398,1425,253.8398,1435,264.8398,1425,276.8398,1294,276.8398,1284,264.8398,1294,253.8398" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1296" y="270.4082">transferStateChange</text><polygon fill="#A80036" points="905.5,299.1504,895.5,303.1504,905.5,307.1504,901.5,303.1504" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="899.5" x2="1358.5" y1="303.1504" y2="303.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="911.5" y="298.7188">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="924.5" y="298.7188">Return current state of transfer from DB</text><polygon fill="#A80036" points="118.5,328.4609,108.5,332.4609,118.5,336.4609,114.5,332.4609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="888.5" y1="332.4609" y2="332.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="124.5" y="328.0293">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="137.5" y="328.0293">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="149.5" y1="377.3926" y2="377.3926"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149.5" x2="149.5" y1="377.3926" y2="390.3926"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108.5" x2="149.5" y1="390.3926" y2="390.3926"/><polygon fill="#A80036" points="118.5,386.3926,108.5,390.3926,118.5,394.3926,114.5,390.3926" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="364.9951">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="454" x="127.5" y="357.3398">Validate current state (transferStateChange.transferStateId == 'EXPIRED')</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="127.5" y="372.6504">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="204.5" y="372.6504">2001</text><path d="M33,405.3926 L234,405.3926 L234,412.3926 L224,422.3926 L33,422.3926 L33,405.3926 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="549.2109" style="stroke: #000000; stroke-width: 2.0;" width="1575" x="33" y="405.3926"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="156" x="48" y="418.9609">Persist Position change</text><polygon fill="#A80036" points="872.5,454.7031,882.5,458.7031,872.5,462.7031,876.5,458.7031" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="878.5" y1="458.7031" y2="458.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="114.5" y="446.9268">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="127.5" y="439.2715">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="127.5" y="454.582">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="204.5" y="454.582">2003</text><path d="M831.5,474.3242 L1123.5,474.3242 L1123.5,481.3242 L1113.5,491.3242 L831.5,491.3242 L831.5,474.3242 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="443.9688" style="stroke: #000000; stroke-width: 2.0;" width="766.5" x="831.5" y="474.3242"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="247" x="846.5" y="487.8926">DB TRANSACTION IMPLEMENTATION</text><polygon fill="#A80036" points="1342.5,508.6348,1352.5,512.6348,1342.5,516.6348,1346.5,512.6348" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="894.5" x2="1348.5" y1="512.6348" y2="512.6348"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="901.5" y="508.2031">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="394" x="914.5" y="508.2031">Select participantPosition.value FOR UPDATE from DB for Payer</text><polygon fill="#FFFFE0" filter="url(#fwjv152deap17)" points="1298,525.9453,1421,525.9453,1431,536.9453,1421,548.9453,1298,548.9453,1288,536.9453,1298,525.9453" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1300" y="542.5137">participantPosition</text><polygon fill="#A80036" points="905.5,571.2559,895.5,575.2559,905.5,579.2559,901.5,575.2559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="899.5" x2="1358.5" y1="575.2559" y2="575.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="911.5" y="570.8242">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="924.5" y="570.8242">Return participantPosition.value from DB for Payer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="894.5" x2="936.5" y1="604.877" y2="604.877"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="936.5" x2="936.5" y1="604.877" y2="617.877"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="895.5" x2="936.5" y1="617.877" y2="617.877"/><polygon fill="#A80036" points="905.5,613.877,895.5,617.877,905.5,621.877,901.5,617.877" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="901.5" y="600.1348">9</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="914.5" y="600.1348">latestPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="339" x="1008.5" y="600.1348">= participantPosition.value - payload.amount.amount</text><polygon fill="#A80036" points="1342.5,642.877,1352.5,646.877,1342.5,650.877,1346.5,646.877" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="894.5" x2="1348.5" y1="646.877" y2="646.877"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="901.5" y="642.4453">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="923.5" y="642.4453">Persist latestPosition to DB for Payer</text><polygon fill="#FFFFE0" filter="url(#fwjv152deap17)" points="1267,690.1875,1452,690.1875,1462,709.1875,1452,728.1875,1267,728.1875,1257,709.1875,1267,690.1875" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1269" y="706.7559">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="1323" y="706.7559">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="1269" y="722.0664">SET value = latestPosition</text><polygon fill="#A80036" points="1342.5,750.8086,1352.5,754.8086,1342.5,758.8086,1346.5,754.8086" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="894.5" x2="1348.5" y1="754.8086" y2="754.8086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="901.5" y="750.377">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="219" x="923.5" y="750.377">Persist participant position change</text><polygon fill="#FFFFE0" filter="url(#fwjv152deap17)" points="1141,798.1191,1578,798.1191,1588,855.1191,1578,913.1191,1141,913.1191,1131,855.1191,1141,798.1191" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1147" y="814.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="44" x="1143" y="829.998">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="1191" y="829.998">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="433" x="1143" y="845.3086">SET participantPositionId = participantPosition.participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="431" x="1143" y="860.6191">transferStateChangeId = transferStateChange.transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="1143" y="875.9297">value = latestPosition,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="1143" y="891.2402">reservedValue = participantPosition.reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="1143" y="906.5508">createdDate = new Date()</text><polygon fill="#A80036" points="118.5,942.293,108.5,946.293,118.5,950.293,114.5,946.293" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="888.5" y1="946.293" y2="946.293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="941.8613">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="146.5" y="941.8613">Return success</text><path d="M112,966.6035 L112,1435.6035 L705,1435.6035 L705,976.6035 L695,966.6035 L112,966.6035 " fill="#FFFF00" filter="url(#fwjv152deap17)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M695,966.6035 L695,976.6035 L705,976.6035 L695,966.6035 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="118" y="984.1719">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="134" y="999.4824">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="134" y="1014.793">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="134" y="1030.1035">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="134" y="1045.4141">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="134" y="1060.7246">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="150" y="1076.0352">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="150" y="1091.3457">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="170" y="1106.6563">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="186" y="1121.9668">"errorCode": 3303,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="504" x="186" y="1137.2773">"errorDescription": "Client requested to use a transfer that has already expired.",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="186" y="1152.5879">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="170" y="1167.8984">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="154" y="1183.209">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="134" y="1198.5195">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="134" y="1213.8301">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="150" y="1229.1406">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="166" y="1244.4512">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="166" y="1259.7617">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="166" y="1275.0723">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="166" y="1290.3828">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="166" y="1305.6934">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="166" y="1321.0039">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="182" y="1336.3145">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="182" y="1351.625">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="182" y="1366.9355">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="1382.2461">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="1397.5566">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="1412.8672">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="1428.1777">}</text><path d="M23,1458.9199 L90,1458.9199 L90,1465.9199 L80,1475.9199 L23,1475.9199 L23,1458.9199 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="812.8008" style="stroke: #000000; stroke-width: 2.0;" width="1422" x="23" y="1458.9199"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="38" y="1472.4883">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="230" x="105" y="1471.5547">[type == 'position' &amp;&amp; action == 'reject']</text><polygon fill="#A80036" points="872.5,1508.2305,882.5,1512.2305,872.5,1516.2305,876.5,1512.2305" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="878.5" y1="1512.2305" y2="1512.2305"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="1500.4541">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="136.5" y="1492.7988">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="1508.1094">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="1508.1094">2003</text><polygon fill="#A80036" points="1342.5,1537.8516,1352.5,1541.8516,1342.5,1545.8516,1346.5,1541.8516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="894.5" x2="1348.5" y1="1541.8516" y2="1541.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="901.5" y="1537.4199">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="923.5" y="1537.4199">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#fwjv152deap17)" points="1294,1555.1621,1425,1555.1621,1435,1566.1621,1425,1578.1621,1294,1578.1621,1284,1566.1621,1294,1555.1621" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1296" y="1571.7305">transferStateChange</text><polygon fill="#A80036" points="905.5,1600.4727,895.5,1604.4727,905.5,1608.4727,901.5,1604.4727" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="899.5" x2="1358.5" y1="1604.4727" y2="1604.4727"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="911.5" y="1600.041">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="933.5" y="1600.041">Return current state of transfer from DB</text><polygon fill="#A80036" points="118.5,1629.7832,108.5,1633.7832,118.5,1637.7832,114.5,1633.7832" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="888.5" y1="1633.7832" y2="1633.7832"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="1629.3516">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="146.5" y="1629.3516">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="149.5" y1="1678.7148" y2="1678.7148"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149.5" x2="149.5" y1="1678.7148" y2="1691.7148"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108.5" x2="149.5" y1="1691.7148" y2="1691.7148"/><polygon fill="#A80036" points="118.5,1687.7148,108.5,1691.7148,118.5,1695.7148,114.5,1691.7148" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="1666.3174">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="463" x="136.5" y="1658.6621">Validate current state (transferStateChange.transferStateId == 'REJECTED')</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="1673.9727">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="1673.9727">2001</text><path d="M33,1706.7148 L735,1706.7148 L735,1713.7148 L725,1723.7148 L33,1723.7148 L33,1706.7148 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="181.8633" style="stroke: #000000; stroke-width: 2.0;" width="1394.5" x="33" y="1706.7148"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="657" x="48" y="1720.2832">Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)</text><polygon fill="#A80036" points="872.5,1756.0254,882.5,1760.0254,872.5,1764.0254,876.5,1760.0254" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="878.5" y1="1760.0254" y2="1760.0254"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="1748.249">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="136.5" y="1740.5938">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="1755.9043">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="1755.9043">2003</text><path d="M831.5,1775.6465 L1242.5,1775.6465 L1242.5,1782.6465 L1232.5,1792.6465 L831.5,1792.6465 L831.5,1775.6465 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="76.6211" style="stroke: #000000; stroke-width: 2.0;" width="586" x="831.5" y="1775.6465"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="366" x="846.5" y="1789.2148">REFER TO DB TRANSACTION IMPLEMENTATION ABOVE</text><polygon fill="#A80036" points="1342.5,1809.957,1352.5,1813.957,1342.5,1817.957,1346.5,1813.957" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="894.5" x2="1348.5" y1="1813.957" y2="1813.957"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="901.5" y="1809.5254">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="923.5" y="1809.5254">Refer to implementation above</text><polygon fill="#A80036" points="118.5,1876.2676,108.5,1880.2676,118.5,1884.2676,114.5,1880.2676" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="888.5" y1="1880.2676" y2="1880.2676"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="1875.8359">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="146.5" y="1875.8359">Return success</text><path d="M112,1900.5781 L112,2262.5781 L374,2262.5781 L374,1910.5781 L364,1900.5781 L112,1900.5781 " fill="#FFFF00" filter="url(#fwjv152deap17)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M364,1900.5781 L364,1910.5781 L374,1910.5781 L364,1900.5781 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="118" y="1918.1465">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="134" y="1933.457">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="134" y="1948.7676">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="134" y="1964.0781">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="134" y="1979.3887">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="134" y="1994.6992">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="150" y="2010.0098">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="150" y="2025.3203">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="134" y="2040.6309">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="134" y="2055.9414">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="150" y="2071.252">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="166" y="2086.5625">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="166" y="2101.873">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="166" y="2117.1836">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="166" y="2132.4941">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="166" y="2147.8047">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="166" y="2163.1152">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="182" y="2178.4258">status: "rejected",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="182" y="2193.7363">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="2209.0469">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="2224.3574">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="2239.668">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="2254.9785">}</text><path d="M23,2285.7207 L90,2285.7207 L90,2292.7207 L80,2302.7207 L23,2302.7207 L23,2285.7207 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="904.6641" style="stroke: #000000; stroke-width: 2.0;" width="1422" x="23" y="2285.7207"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="38" y="2299.2891">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="455" x="105" y="2298.3555">[type == 'position' &amp;&amp; action == 'fail' (Unable to currently trigger this scenario)]</text><polygon fill="#A80036" points="872.5,2335.0313,882.5,2339.0313,872.5,2343.0313,876.5,2339.0313" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="878.5" y1="2339.0313" y2="2339.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="2327.2549">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="136.5" y="2319.5996">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="2334.9102">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="2334.9102">2003</text><polygon fill="#A80036" points="1342.5,2364.6523,1352.5,2368.6523,1342.5,2372.6523,1346.5,2368.6523" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="894.5" x2="1348.5" y1="2368.6523" y2="2368.6523"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="901.5" y="2364.2207">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="923.5" y="2364.2207">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#fwjv152deap17)" points="1294,2381.9629,1425,2381.9629,1435,2392.9629,1425,2404.9629,1294,2404.9629,1284,2392.9629,1294,2381.9629" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1296" y="2398.5313">transferStateChange</text><polygon fill="#A80036" points="905.5,2427.2734,895.5,2431.2734,905.5,2435.2734,901.5,2431.2734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="899.5" x2="1358.5" y1="2431.2734" y2="2431.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="911.5" y="2426.8418">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="933.5" y="2426.8418">Return current state of transfer from DB</text><polygon fill="#A80036" points="118.5,2456.584,108.5,2460.584,118.5,2464.584,114.5,2460.584" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="888.5" y1="2460.584" y2="2460.584"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="2456.1523">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="250" x="146.5" y="2456.1523">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="149.5" y1="2490.2051" y2="2490.2051"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="149.5" x2="149.5" y1="2490.2051" y2="2503.2051"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="108.5" x2="149.5" y1="2503.2051" y2="2503.2051"/><polygon fill="#A80036" points="118.5,2499.2051,108.5,2503.2051,118.5,2507.2051,114.5,2503.2051" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="2485.4629">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="447" x="136.5" y="2485.4629">Validate current state (transferStateChange.transferStateId == 'FAILED')</text><path d="M33,2518.2051 L735,2518.2051 L735,2525.2051 L725,2535.2051 L33,2535.2051 L33,2518.2051 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="181.8633" style="stroke: #000000; stroke-width: 2.0;" width="1394.5" x="33" y="2518.2051"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="657" x="48" y="2531.7734">Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)</text><polygon fill="#A80036" points="872.5,2567.5156,882.5,2571.5156,872.5,2575.5156,876.5,2571.5156" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="878.5" y1="2571.5156" y2="2571.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="2559.7393">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="309" x="136.5" y="2552.084">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="2567.3945">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="2567.3945">2003</text><path d="M831.5,2587.1367 L1242.5,2587.1367 L1242.5,2594.1367 L1232.5,2604.1367 L831.5,2604.1367 L831.5,2587.1367 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="76.6211" style="stroke: #000000; stroke-width: 2.0;" width="586" x="831.5" y="2587.1367"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="366" x="846.5" y="2600.7051">REFER TO DB TRANSACTION IMPLEMENTATION ABOVE</text><polygon fill="#A80036" points="1342.5,2621.4473,1352.5,2625.4473,1342.5,2629.4473,1346.5,2625.4473" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="894.5" x2="1348.5" y1="2625.4473" y2="2625.4473"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="901.5" y="2621.0156">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="923.5" y="2621.0156">Refer to implementation above</text><polygon fill="#A80036" points="118.5,2687.7578,108.5,2691.7578,118.5,2695.7578,114.5,2691.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="112.5" x2="888.5" y1="2691.7578" y2="2691.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="124.5" y="2687.3262">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="146.5" y="2687.3262">Return success</text><path d="M112,2712.0684 L112,3181.0684 L516,3181.0684 L516,2722.0684 L506,2712.0684 L112,2712.0684 " fill="#FFFF00" filter="url(#fwjv152deap17)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M506,2712.0684 L506,2722.0684 L516,2722.0684 L506,2712.0684 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="66" x="118" y="2729.6367">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="134" y="2744.9473">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="134" y="2760.2578">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="134" y="2775.5684">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="134" y="2790.8789">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="134" y="2806.1895">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="150" y="2821.5">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="150" y="2836.8105">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="170" y="2852.1211">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="186" y="2867.4316">"errorCode": 3100,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="186" y="2882.7422">"errorDescription": "Transfer failed",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="186" y="2898.0527">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="170" y="2913.3633">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="154" y="2928.6738">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="134" y="2943.9844">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="134" y="2959.2949">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="150" y="2974.6055">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="166" y="2989.916">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="166" y="3005.2266">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="88" x="166" y="3020.5371">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="166" y="3035.8477">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="166" y="3051.1582">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="166" y="3066.4688">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="182" y="3081.7793">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="182" y="3097.0898">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="182" y="3112.4004">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="3127.7109">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="150" y="3143.0215">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="134" y="3158.332">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="118" y="3173.6426">}</text><polygon fill="#A80036" points="594.5,3229.3848,604.5,3233.3848,594.5,3237.3848,598.5,3233.3848" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="107.5" x2="600.5" y1="3233.3848" y2="3233.3848"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="114.5" y="3221.6084">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="140" x="136.5" y="3213.9531">Publish Transfer event</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="136.5" y="3229.2637">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="213.5" y="3229.2637">2003</text><!--
@startuml
title 1.3.3 Abort Position Handler Consume

autonumber


control "Position Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
entity "Position DAO" as POS_DAO
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
database "Central Store" as DB

box "Central Service" #LightYellow
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant DB
end box

activate POS_HANDLER
group Abort Position Handler Consume
    opt type == 'position' && action == 'timeout-reserved'
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'EXPIRED')\n<color #FF0000><b>Error code:</b> 2001</color>

        group Persist Position change
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group <color #blue>DB TRANSACTION IMPLEMENTATION</color>
                activate POS_DAO
                POS_DAO -> DB: Select participantPosition.value FOR UPDATE from DB for Payer
                activate DB
                hnote over DB #lightyellow
                    participantPosition
                end note
                DB - -> POS_DAO: Return participantPosition.value from DB for Payer
                deactivate DB
                POS_DAO <-> POS_DAO: **latestPosition** = participantPosition.value - payload.amount.amount
                POS_DAO->DB: Persist latestPosition to DB for Payer
                hnote over DB #lightyellow
                    UPDATE **participantPosition**
                    SET value = latestPosition
                end note
                activate DB
                deactivate DB
                POS_DAO -> DB: Persist participant position change
                hnote over DB #lightyellow

                        INSERT **participantPositionChange**
                        SET participantPositionId = participantPosition.participantPositionId,
                        transferStateChangeId = transferStateChange.transferStateChangeId,
                        value = latestPosition,
                        reservedValue = participantPosition.reservedValue
                        createdDate = new Date()
                end note
                activate DB
                deactivate DB
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        note right of POS_HANDLER #yellow
            Message: {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                         "errorInformation": {
                             "errorCode": 3303,
                             "errorDescription": "Client requested to use a transfer that has already expired.",
                             "extensionList": <transferMessage.extensionList>
                         }
                     }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: abort,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
    end
    opt type == 'position' && action == 'reject'
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'REJECTED')\n<color #FF0000><b>Error code:</b> 2001</color>

        group Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group <color #blue>REFER TO DB TRANSACTION IMPLEMENTATION ABOVE</color>
                activate POS_DAO
                POS_DAO -> DB: Refer to implementation above
                activate DB
                deactivate DB
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        note right of POS_HANDLER #yellow
            Message: {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: abort,
                        createdAt: <timestamp>,
                        state: {
                            status: "rejected",
                            code: 0
                        }
                    }
                }
            }
        end note
    end
    opt type == 'position' && action == 'fail' (Unable to currently trigger this scenario)
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'FAILED')

        group Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group <color #blue>REFER TO DB TRANSACTION IMPLEMENTATION ABOVE</color>
                activate POS_DAO
                POS_DAO -> DB: Refer to implementation above
                activate DB
                deactivate DB
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        note right of POS_HANDLER #yellow
            Message: {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                         "errorInformation": {
                             "errorCode": 3100,
                             "errorDescription": "Transfer failed",
                             "extensionList": <transferMessage.extensionList>
                         }
                     }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: abort,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
    end
    POS_HANDLER -> TOPIC_TRANSFERS: Publish Transfer event\n<color #FF0000><b>Error code:</b> 2003</color>
    activate TOPIC_TRANSFERS
    deactivate TOPIC_TRANSFERS
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.01(Sun Jan 28 20:08:22 SAST 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_152-release-1136-b20
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: ZA
--></g></svg>