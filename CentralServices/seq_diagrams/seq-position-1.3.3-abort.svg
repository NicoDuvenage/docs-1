<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1954.8001px" preserveAspectRatio="none" style="width:990px;height:1954px;" version="1.1" viewBox="0 0 990 1954" width="990.6px" zoomAndPan="magnify"><defs><filter height="300%" id="f1i16d123fjw7j" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="1.2000000476837158"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="2.4000000953674316" dy="2.4000000953674316" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="8.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="165.6" x="413.1" y="14.1211">1.3.3 Abort Position Handler Consume</text><rect fill="#FFFFE0" height="1927.6993" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="823.5" x="23.4" y="20.693"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="60.6" x="404.85" y="28.234">Central Service</text><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="1827.327" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="58.5" y="75.7723"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="363.9" y="1875.7266"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="72.9316" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="530.7" y="126.5449"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="292.5539" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="530.7" y="275.2219"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="72.9316" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="530.7" y="907.3383"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="72.1453" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="530.7" y="1056.0153"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="72.9316" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="530.7" y="1403.4188"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="72.1453" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="530.7" y="1542.9094"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="37.5727" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="812.7" y="144.3176"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="37.5727" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="812.7" y="307.5809"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="812.7" y="388.1262"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="812.7" y="452.8852"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="37.5727" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="812.7" y="925.111"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="812.7" y="1088.3743"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="37.5727" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="812.7" y="1421.1915"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="812.7" y="1575.2684"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="1818.927" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="976.2" x="7.8" y="79.9723"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="772.3934" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="964.2" x="13.8" y="94.5586"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="329.5266" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="952.2" x="19.8" y="243.2356"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="266.3813" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="467.1" x="498.9" y="284.5945"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="487.6805" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="853.2" x="13.8" y="875.352"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="109.118" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="836.7" x="19.8" y="1024.0289"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="45.9727" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="351.6" x="498.9" y="1065.3879"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="478.4942" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="853.2" x="13.8" y="1371.4325"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="109.118" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="836.7" x="19.8" y="1510.9231"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="45.9727" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="351.6" x="498.9" y="1552.2821"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="61.2" x2="61.2" y1="69.7723" y2="1909.0993"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="366.9" x2="366.9" y1="69.7723" y2="1909.0993"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="454.5" x2="454.5" y1="69.7723" y2="1909.0993"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="533.7" x2="533.7" y1="69.7723" y2="1909.0993"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="815.7" x2="815.7" y1="69.7723" y2="1909.0993"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="67.8" x="25.8" y="68.0004">Position Handler</text><ellipse cx="61.5" cy="50.2793" fill="#FEFECE" filter="url(#f1i16d123fjw7j)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><polygon fill="#A80036" points="59.1,43.0793,62.7,40.0793,61.5,43.0793,62.7,46.0793,59.1,43.0793" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="67.8" x="25.8" y="1916.6204">Position Handler</text><ellipse cx="61.5" cy="1927.9923" fill="#FEFECE" filter="url(#f1i16d123fjw7j)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><polygon fill="#A80036" points="59.1,1920.7923,62.7,1917.7923,61.5,1920.7923,62.7,1923.7923,59.1,1920.7923" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><rect fill="#FEFECE" filter="url(#f1i16d123fjw7j)" height="18.293" style="stroke: #A80036; stroke-width: 0.9000000357627869;" width="70.8" x="331.5" y="46.0793"/><rect fill="#FEFECE" filter="url(#f1i16d123fjw7j)" height="18.293" style="stroke: #A80036; stroke-width: 0.9000000357627869;" width="70.8" x="329.1" y="48.4793"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="62.4" x="333.3" y="60.8004">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f1i16d123fjw7j)" height="18.293" style="stroke: #A80036; stroke-width: 0.9000000357627869;" width="70.8" x="331.5" y="1908.4993"/><rect fill="#FEFECE" filter="url(#f1i16d123fjw7j)" height="18.293" style="stroke: #A80036; stroke-width: 0.9000000357627869;" width="70.8" x="329.1" y="1910.8993"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="62.4" x="333.3" y="1923.2204">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f1i16d123fjw7j)" height="18.293" style="stroke: #A80036; stroke-width: 0.9000000357627869;" width="83.4" x="413.1" y="46.0793"/><rect fill="#FEFECE" filter="url(#f1i16d123fjw7j)" height="18.293" style="stroke: #A80036; stroke-width: 0.9000000357627869;" width="83.4" x="410.7" y="48.4793"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="75" x="414.9" y="60.8004">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f1i16d123fjw7j)" height="18.293" style="stroke: #A80036; stroke-width: 0.9000000357627869;" width="83.4" x="413.1" y="1908.4993"/><rect fill="#FEFECE" filter="url(#f1i16d123fjw7j)" height="18.293" style="stroke: #A80036; stroke-width: 0.9000000357627869;" width="83.4" x="410.7" y="1910.8993"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="75" x="414.9" y="1923.2204">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="54" x="504.9" y="68.0004">Position DAO</text><ellipse cx="533.7" cy="50.2793" fill="#FEFECE" filter="url(#f1i16d123fjw7j)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><line style="stroke: #A80036; stroke-width: 1.2000000476837158;" x1="526.5" x2="540.9" y1="58.6793" y2="58.6793"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="54" x="504.9" y="1916.6204">Position DAO</text><ellipse cx="533.7" cy="1927.9923" fill="#FEFECE" filter="url(#f1i16d123fjw7j)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><line style="stroke: #A80036; stroke-width: 1.2000000476837158;" x1="526.5" x2="540.9" y1="1936.3923" y2="1936.3923"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="54" x="786.9" y="68.0004">Central Store</text><path d="M804.9,38.2793 C804.9,32.2793 815.7,32.2793 815.7,32.2793 C815.7,32.2793 826.5,32.2793 826.5,38.2793 L826.5,53.8793 C826.5,59.8793 815.7,59.8793 815.7,59.8793 C815.7,59.8793 804.9,59.8793 804.9,53.8793 L804.9,38.2793 " fill="#FEFECE" filter="url(#f1i16d123fjw7j)" style="stroke: #000000; stroke-width: 0.9000000357627869;"/><path d="M804.9,38.2793 C804.9,44.2793 815.7,44.2793 815.7,44.2793 C815.7,44.2793 826.5,44.2793 826.5,38.2793 " fill="none" style="stroke: #000000; stroke-width: 0.9000000357627869;"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="54" x="786.9" y="1916.6204">Central Store</text><path d="M804.9,1924.3923 C804.9,1918.3923 815.7,1918.3923 815.7,1918.3923 C815.7,1918.3923 826.5,1918.3923 826.5,1924.3923 L826.5,1939.9923 C826.5,1945.9923 815.7,1945.9923 815.7,1945.9923 C815.7,1945.9923 804.9,1945.9923 804.9,1939.9923 L804.9,1924.3923 " fill="#FEFECE" filter="url(#f1i16d123fjw7j)" style="stroke: #000000; stroke-width: 0.9000000357627869;"/><path d="M804.9,1924.3923 C804.9,1930.3923 815.7,1930.3923 815.7,1930.3923 C815.7,1930.3923 826.5,1930.3923 826.5,1924.3923 " fill="none" style="stroke: #000000; stroke-width: 0.9000000357627869;"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="1827.327" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="58.5" y="75.7723"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="363.9" y="1875.7266"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="72.9316" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="530.7" y="126.5449"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="292.5539" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="530.7" y="275.2219"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="72.9316" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="530.7" y="907.3383"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="72.1453" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="530.7" y="1056.0153"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="72.9316" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="530.7" y="1403.4188"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="72.1453" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="530.7" y="1542.9094"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="37.5727" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="812.7" y="144.3176"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="37.5727" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="812.7" y="307.5809"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="812.7" y="388.1262"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="812.7" y="452.8852"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="37.5727" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="812.7" y="925.111"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="812.7" y="1088.3743"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="37.5727" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="812.7" y="1421.1915"/><rect fill="#FFFFFF" filter="url(#f1i16d123fjw7j)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="812.7" y="1575.2684"/><path d="M7.8,79.9723 L166.8,79.9723 L166.8,84.1723 L160.8,90.1723 L7.8,90.1723 L7.8,79.9723 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="1818.927" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="976.2" x="7.8" y="79.9723"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="132" x="16.8" y="88.1133">Abort Position Handler Consume</text><path d="M13.8,94.5586 L54,94.5586 L54,98.7586 L48,104.7586 L13.8,104.7586 L13.8,94.5586 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="772.3934" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="964.2" x="13.8" y="94.5586"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="13.2" x="22.8" y="102.6996">opt</text><text fill="#000000" font-family="sans-serif" font-size="6.6" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="360.6" x="63" y="102.1395">[type == 'position' &amp;&amp; action == 'timeout-received' || type == 'position' &amp;&amp; action == 'timeout-reserved']</text><polygon fill="#A80036" points="523.5,124.1449,529.5,126.5449,523.5,128.9449,525.9,126.5449" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="64.5" x2="527.1" y1="126.5449" y2="126.5449"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="68.7" y="119.4791">1</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="155.4" x="76.5" y="114.8859">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="76.5" y="124.0723">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="122.7" y="124.0723">2003</text><polygon fill="#A80036" points="805.5,141.9176,811.5,144.3176,805.5,146.7176,807.9,144.3176" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="536.7" x2="809.1" y1="144.3176" y2="144.3176"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="540.9" y="141.6586">2</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="155.4" x="548.7" y="141.6586">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#f1i16d123fjw7j)" points="776.4,152.3039,855,152.3039,861,158.9039,855,166.1039,776.4,166.1039,770.4,158.9039,776.4,152.3039" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="76.2" x="777.6" y="162.2449">transferStateChange</text><polygon fill="#A80036" points="543.3,179.4902,537.3,181.8902,543.3,184.2902,540.9,181.8902" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="539.7" x2="815.1" y1="181.8902" y2="181.8902"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="546.9" y="179.2313">3</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="150" x="554.7" y="179.2313">Return current state of transfer from DB</text><polygon fill="#A80036" points="71.1,197.0766,65.1,199.4766,71.1,201.8766,68.7,199.4766" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="67.5" x2="533.1" y1="199.4766" y2="199.4766"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="74.7" y="196.8176">4</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="150" x="82.5" y="196.8176">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="64.5" x2="89.7" y1="226.4356" y2="226.4356"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="89.7" x2="89.7" y1="226.4356" y2="234.2356"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="65.1" x2="89.7" y1="234.2356" y2="234.2356"/><polygon fill="#A80036" points="71.1,231.8356,65.1,234.2356,71.1,236.6356,68.7,234.2356" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="68.7" y="218.9971">5</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="272.4" x="76.5" y="214.4039">Validate current state (transferStateChange.transferStateId == 'EXPIRED')</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="76.5" y="223.5902">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="122.7" y="223.5902">2001</text><path d="M19.8,243.2356 L140.4,243.2356 L140.4,247.4356 L134.4,253.4356 L19.8,253.4356 L19.8,243.2356 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="329.5266" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="952.2" x="19.8" y="243.2356"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="93.6" x="28.8" y="251.3766">Persist Position change</text><polygon fill="#A80036" points="523.5,272.8219,529.5,275.2219,523.5,277.6219,525.9,275.2219" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="64.5" x2="527.1" y1="275.2219" y2="275.2219"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="68.7" y="268.1561">6</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="185.4" x="76.5" y="263.5629">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="76.5" y="272.7492">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="122.7" y="272.7492">2003</text><path d="M498.9,284.5945 L674.1,284.5945 L674.1,288.7945 L668.1,294.7945 L498.9,294.7945 L498.9,284.5945 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="266.3813" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="467.1" x="498.9" y="284.5945"/><text fill="#0000FF" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="148.2" x="507.9" y="292.7356">DB TRANSACTION IMPLEMENTATION</text><polygon fill="#A80036" points="805.5,305.1809,811.5,307.5809,805.5,309.9809,807.9,307.5809" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="536.7" x2="809.1" y1="307.5809" y2="307.5809"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="540.9" y="304.9219">7</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="237.6" x="548.7" y="304.9219">Select participantPosition.value FOR UPDATE from DB for Payee</text><polygon fill="#FFFFE0" filter="url(#f1i16d123fjw7j)" points="778.8,315.5672,852.6,315.5672,858.6,322.1672,852.6,329.3672,778.8,329.3672,772.8,322.1672,778.8,315.5672" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="71.4" x="780" y="325.5082">participantPosition</text><polygon fill="#A80036" points="543.3,342.7535,537.3,345.1535,543.3,347.5535,540.9,345.1535" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="539.7" x2="815.1" y1="345.1535" y2="345.1535"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="546.9" y="342.4945">8</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="190.2" x="554.7" y="342.4945">Return participantPosition.value from DB for Payee</text><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="536.7" x2="561.9" y1="362.9262" y2="362.9262"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="561.9" x2="561.9" y1="362.9262" y2="370.7262"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="537.3" x2="561.9" y1="370.7262" y2="370.7262"/><polygon fill="#A80036" points="543.3,368.3262,537.3,370.7262,543.3,373.1262,540.9,370.7262" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="540.9" y="360.0809">9</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="54" x="548.7" y="360.0809">latestPosition</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="203.4" x="605.1" y="360.0809">= participantPosition.value - payload.amount.amount</text><polygon fill="#A80036" points="805.5,385.7262,811.5,388.1262,805.5,390.5262,807.9,388.1262" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="536.7" x2="809.1" y1="388.1262" y2="388.1262"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="540.9" y="385.4672">10</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="138.6" x="554.1" y="385.4672">Persist latestPosition to DB for Payee</text><polygon fill="#FFFFE0" filter="url(#f1i16d123fjw7j)" points="760.2,414.1125,871.2,414.1125,877.2,425.5125,871.2,436.9125,760.2,436.9125,754.2,425.5125,760.2,414.1125" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="30" x="761.4" y="424.0535">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76.2" x="793.8" y="424.0535">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="97.8" x="761.4" y="433.2399">SET value = latestPosition</text><polygon fill="#A80036" points="805.5,450.4852,811.5,452.8852,805.5,455.2852,807.9,452.8852" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="536.7" x2="809.1" y1="452.8852" y2="452.8852"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="540.9" y="450.2262">11</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="131.4" x="554.1" y="450.2262">Persist participant position change</text><polygon fill="#FFFFE0" filter="url(#f1i16d123fjw7j)" points="677.4,478.8715,954,478.8715,960,513.0715,954,547.8715,677.4,547.8715,671.4,513.0715,677.4,478.8715" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="0" x="681" y="488.8125"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="26.4" x="678.6" y="497.9988">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="107.4" x="707.4" y="497.9988">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="274.2" x="678.6" y="507.1852">SET transferStateChangeId = transferStateChange.transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="244.2" x="678.6" y="516.3715">participantPositionId = participantPosition.participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="84.6" x="678.6" y="525.5578">value = latestPosition,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="189" x="678.6" y="534.7442">reservedValue = participantPosition.reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="95.4" x="678.6" y="543.9305">createdDate = new Date()</text><polygon fill="#A80036" points="71.1,565.3758,65.1,567.7758,71.1,570.1758,68.7,567.7758" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="67.5" x2="533.1" y1="567.7758" y2="567.7758"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="74.7" y="565.1168">12</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="57" x="87.9" y="565.1168">Return success</text><path d="M67.2,579.9621 L67.2,861.3621 L423,861.3621 L423,585.9621 L417,579.9621 L67.2,579.9621 " fill="#FFFF00" filter="url(#f1i16d123fjw7j)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M417,579.9621 L417,585.9621 L423,585.9621 L417,579.9621 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="39.6" x="70.8" y="590.5031">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="124.8" x="80.4" y="599.6895">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="135" x="80.4" y="608.8758">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="126" x="80.4" y="618.0621">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="83.4" x="80.4" y="627.2485">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="36" x="80.4" y="636.4348">content: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="108.6" x="90" y="645.6211">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="36.6" x="90" y="654.8074">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="75.6" x="102" y="663.9938">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="69.6" x="111.6" y="673.1801">"errorCode": 3303,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="302.4" x="111.6" y="682.3664">"errorDescription": "Client requested to use a transfer that has already expired.",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="189" x="111.6" y="691.5528">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="102" y="700.7391">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="92.4" y="709.9254">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="4.8" x="80.4" y="719.1117">},</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="42" x="80.4" y="728.2981">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="27.6" x="90" y="737.4844">event: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="43.2" x="99.6" y="746.6707">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="114.6" x="99.6" y="755.8571">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="52.8" x="99.6" y="765.0434">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="50.4" x="99.6" y="774.2297">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="95.4" x="99.6" y="783.416">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="25.8" x="99.6" y="792.6024">state: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="52.2" x="109.2" y="801.7887">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="136.8" x="109.2" y="810.975">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="186" x="109.2" y="820.1614">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="99.6" y="829.3477">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="90" y="838.534">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="80.4" y="847.7203">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="70.8" y="856.9067">}</text><path d="M13.8,875.352 L54,875.352 L54,879.552 L48,885.552 L13.8,885.552 L13.8,875.352 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="487.6805" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="853.2" x="13.8" y="875.352"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="13.2" x="22.8" y="883.493">opt</text><text fill="#000000" font-family="sans-serif" font-size="6.6" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="138" x="63" y="882.9328">[type == 'position' &amp;&amp; action == 'reject']</text><polygon fill="#A80036" points="523.5,904.9383,529.5,907.3383,523.5,909.7383,525.9,907.3383" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="64.5" x2="527.1" y1="907.3383" y2="907.3383"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="68.7" y="900.2725">13</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="155.4" x="81.9" y="895.6793">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="81.9" y="904.8657">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="128.1" y="904.8657">2003</text><polygon fill="#A80036" points="805.5,922.711,811.5,925.111,805.5,927.511,807.9,925.111" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="536.7" x2="809.1" y1="925.111" y2="925.111"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="540.9" y="922.452">14</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="155.4" x="554.1" y="922.452">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#f1i16d123fjw7j)" points="776.4,933.0973,855,933.0973,861,939.6973,855,946.8973,776.4,946.8973,770.4,939.6973,776.4,933.0973" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="76.2" x="777.6" y="943.0383">transferStateChange</text><polygon fill="#A80036" points="543.3,960.2836,537.3,962.6836,543.3,965.0836,540.9,962.6836" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="539.7" x2="815.1" y1="962.6836" y2="962.6836"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="546.9" y="960.0246">15</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="150" x="560.1" y="960.0246">Return current state of transfer from DB</text><polygon fill="#A80036" points="71.1,977.87,65.1,980.27,71.1,982.67,68.7,980.27" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="67.5" x2="533.1" y1="980.27" y2="980.27"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="74.7" y="977.611">16</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="150" x="87.9" y="977.611">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="64.5" x2="89.7" y1="1007.2289" y2="1007.2289"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="89.7" x2="89.7" y1="1007.2289" y2="1015.0289"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="65.1" x2="89.7" y1="1015.0289" y2="1015.0289"/><polygon fill="#A80036" points="71.1,1012.6289,65.1,1015.0289,71.1,1017.4289,68.7,1015.0289" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="68.7" y="999.7905">17</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="277.8" x="81.9" y="995.1973">Validate current state (transferStateChange.transferStateId == 'REJECTED')</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="81.9" y="1004.3836">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="128.1" y="1004.3836">2001</text><path d="M19.8,1024.0289 L441,1024.0289 L441,1028.2289 L435,1034.2289 L19.8,1034.2289 L19.8,1024.0289 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="109.118" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="836.7" x="19.8" y="1024.0289"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="394.2" x="28.8" y="1032.17">Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)</text><polygon fill="#A80036" points="523.5,1053.6153,529.5,1056.0153,523.5,1058.4153,525.9,1056.0153" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="64.5" x2="527.1" y1="1056.0153" y2="1056.0153"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="68.7" y="1048.9495">18</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="185.4" x="81.9" y="1044.3563">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="81.9" y="1053.5426">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="128.1" y="1053.5426">2003</text><path d="M498.9,1065.3879 L745.5,1065.3879 L745.5,1069.5879 L739.5,1075.5879 L498.9,1075.5879 L498.9,1065.3879 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="45.9727" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="351.6" x="498.9" y="1065.3879"/><text fill="#0000FF" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="219.6" x="507.9" y="1073.5289">REFER TO DB TRANSACTION IMPLEMENTATION ABOVE</text><polygon fill="#A80036" points="805.5,1085.9743,811.5,1088.3743,805.5,1090.7743,807.9,1088.3743" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="536.7" x2="809.1" y1="1088.3743" y2="1088.3743"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="540.9" y="1085.7153">19</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="115.8" x="554.1" y="1085.7153">Refer to implementation above</text><polygon fill="#A80036" points="71.1,1125.7606,65.1,1128.1606,71.1,1130.5606,68.7,1128.1606" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="67.5" x2="533.1" y1="1128.1606" y2="1128.1606"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="74.7" y="1125.5016">20</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="57" x="87.9" y="1125.5016">Return success</text><path d="M67.2,1140.3469 L67.2,1357.5469 L224.4,1357.5469 L224.4,1146.3469 L218.4,1140.3469 L67.2,1140.3469 " fill="#FFFF00" filter="url(#f1i16d123fjw7j)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M218.4,1140.3469 L218.4,1146.3469 L224.4,1146.3469 L218.4,1140.3469 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="39.6" x="70.8" y="1150.8879">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="124.8" x="80.4" y="1160.0743">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="135" x="80.4" y="1169.2606">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="126" x="80.4" y="1178.4469">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="83.4" x="80.4" y="1187.6333">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="36" x="80.4" y="1196.8196">content: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="108.6" x="90" y="1206.0059">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="108" x="90" y="1215.1922">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="4.8" x="80.4" y="1224.3786">},</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="42" x="80.4" y="1233.5649">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="27.6" x="90" y="1242.7512">event: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="43.2" x="99.6" y="1251.9375">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="114.6" x="99.6" y="1261.1239">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="52.8" x="99.6" y="1270.3102">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="50.4" x="99.6" y="1279.4965">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="95.4" x="99.6" y="1288.6829">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="25.8" x="99.6" y="1297.8692">state: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="66.6" x="109.2" y="1307.0555">status: "rejected",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="27.6" x="109.2" y="1316.2418">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="99.6" y="1325.4282">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="90" y="1334.6145">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="80.4" y="1343.8008">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="70.8" y="1352.9872">}</text><path d="M13.8,1371.4325 L54,1371.4325 L54,1375.6325 L48,1381.6325 L13.8,1381.6325 L13.8,1371.4325 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="478.4942" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="853.2" x="13.8" y="1371.4325"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="13.2" x="22.8" y="1379.5735">opt</text><text fill="#000000" font-family="sans-serif" font-size="6.6" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="280.8" x="63" y="1379.0133">[type == 'position' &amp;&amp; action == 'failed' (Unable to currently trigger this scenario)]</text><polygon fill="#A80036" points="523.5,1401.0188,529.5,1403.4188,523.5,1405.8188,525.9,1403.4188" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="64.5" x2="527.1" y1="1403.4188" y2="1403.4188"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="68.7" y="1396.353">21</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="155.4" x="81.9" y="1391.7598">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="81.9" y="1400.9461">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="128.1" y="1400.9461">2003</text><polygon fill="#A80036" points="805.5,1418.7915,811.5,1421.1915,805.5,1423.5915,807.9,1421.1915" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="536.7" x2="809.1" y1="1421.1915" y2="1421.1915"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="540.9" y="1418.5325">22</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="155.4" x="554.1" y="1418.5325">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#f1i16d123fjw7j)" points="776.4,1429.1778,855,1429.1778,861,1435.7778,855,1442.9778,776.4,1442.9778,770.4,1435.7778,776.4,1429.1778" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="76.2" x="777.6" y="1439.1188">transferStateChange</text><polygon fill="#A80036" points="543.3,1456.3641,537.3,1458.7641,543.3,1461.1641,540.9,1458.7641" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="539.7" x2="815.1" y1="1458.7641" y2="1458.7641"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="546.9" y="1456.1051">23</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="150" x="560.1" y="1456.1051">Return current state of transfer from DB</text><polygon fill="#A80036" points="71.1,1473.9504,65.1,1476.3504,71.1,1478.7504,68.7,1476.3504" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="67.5" x2="533.1" y1="1476.3504" y2="1476.3504"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="74.7" y="1473.6915">24</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="150" x="87.9" y="1473.6915">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="64.5" x2="89.7" y1="1494.1231" y2="1494.1231"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="89.7" x2="89.7" y1="1494.1231" y2="1501.9231"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="65.1" x2="89.7" y1="1501.9231" y2="1501.9231"/><polygon fill="#A80036" points="71.1,1499.5231,65.1,1501.9231,71.1,1504.3231,68.7,1501.9231" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="68.7" y="1491.2778">25</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="268.2" x="81.9" y="1491.2778">Validate current state (transferStateChange.transferStateId == 'FAILED')</text><path d="M19.8,1510.9231 L441,1510.9231 L441,1515.1231 L435,1521.1231 L19.8,1521.1231 L19.8,1510.9231 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="109.118" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="836.7" x="19.8" y="1510.9231"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="394.2" x="28.8" y="1519.0641">Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)</text><polygon fill="#A80036" points="523.5,1540.5094,529.5,1542.9094,523.5,1545.3094,525.9,1542.9094" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="64.5" x2="527.1" y1="1542.9094" y2="1542.9094"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="68.7" y="1535.8436">26</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="185.4" x="81.9" y="1531.2505">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="81.9" y="1540.4368">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="128.1" y="1540.4368">2003</text><path d="M498.9,1552.2821 L745.5,1552.2821 L745.5,1556.4821 L739.5,1562.4821 L498.9,1562.4821 L498.9,1552.2821 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="45.9727" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="351.6" x="498.9" y="1552.2821"/><text fill="#0000FF" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="219.6" x="507.9" y="1560.4231">REFER TO DB TRANSACTION IMPLEMENTATION ABOVE</text><polygon fill="#A80036" points="805.5,1572.8684,811.5,1575.2684,805.5,1577.6684,807.9,1575.2684" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="536.7" x2="809.1" y1="1575.2684" y2="1575.2684"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="540.9" y="1572.6094">27</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="115.8" x="554.1" y="1572.6094">Refer to implementation above</text><polygon fill="#A80036" points="71.1,1612.6548,65.1,1615.0548,71.1,1617.4548,68.7,1615.0548" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="67.5" x2="533.1" y1="1615.0548" y2="1615.0548"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="74.7" y="1612.3958">28</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="57" x="87.9" y="1612.3958">Return success</text><path d="M67.2,1627.2411 L67.2,1844.4411 L224.4,1844.4411 L224.4,1633.2411 L218.4,1627.2411 L67.2,1627.2411 " fill="#FFFF00" filter="url(#f1i16d123fjw7j)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M218.4,1627.2411 L218.4,1633.2411 L224.4,1633.2411 L218.4,1627.2411 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="39.6" x="70.8" y="1637.7821">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="124.8" x="80.4" y="1646.9684">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="135" x="80.4" y="1656.1548">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="126" x="80.4" y="1665.3411">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="83.4" x="80.4" y="1674.5274">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="36" x="80.4" y="1683.7137">content: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="108.6" x="90" y="1692.9001">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="108" x="90" y="1702.0864">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="4.8" x="80.4" y="1711.2727">},</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="42" x="80.4" y="1720.4591">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="27.6" x="90" y="1729.6454">event: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="43.2" x="99.6" y="1738.8317">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="114.6" x="99.6" y="1748.018">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="52.8" x="99.6" y="1757.2044">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="50.4" x="99.6" y="1766.3907">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="95.4" x="99.6" y="1775.577">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="25.8" x="99.6" y="1784.7634">state: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="66.6" x="109.2" y="1793.9497">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="27.6" x="109.2" y="1803.136">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="99.6" y="1812.3223">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="90" y="1821.5087">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="80.4" y="1830.695">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="70.8" y="1839.8813">}</text><polygon fill="#A80036" points="356.7,1873.3266,362.7,1875.7266,356.7,1878.1266,359.1,1875.7266" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="64.5" x2="360.3" y1="1875.7266" y2="1875.7266"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="68.7" y="1868.6608">29</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="84" x="81.9" y="1864.0677">Publish Transfer event</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="81.9" y="1873.254">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="128.1" y="1873.254">2003</text><!--
@startuml
title 1.3.3 Abort Position Handler Consume

autonumber


control "Position Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
entity "Position DAO" as POS_DAO
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
database "Central Store" as DB

box "Central Service" #LightYellow
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant DB
end box

activate POS_HANDLER
group Abort Position Handler Consume
    opt type == 'position' && action == 'timeout-received' || type == 'position' && action == 'timeout-reserved'
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'EXPIRED')\n<color #FF0000><b>Error code:</b> 2001</color>

        group Persist Position change
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group <color #blue>DB TRANSACTION IMPLEMENTATION</color>
                activate POS_DAO
                POS_DAO -> DB: Select participantPosition.value FOR UPDATE from DB for Payee
                activate DB
                hnote over DB #lightyellow
                    participantPosition
                end note
                DB - -> POS_DAO: Return participantPosition.value from DB for Payee
                deactivate DB
                POS_DAO <-> POS_DAO: **latestPosition** = participantPosition.value - payload.amount.amount
                POS_DAO->DB: Persist latestPosition to DB for Payee
                hnote over DB #lightyellow
                    UPDATE **participantPosition**
                    SET value = latestPosition
                end note
                activate DB
                deactivate DB
                POS_DAO -> DB: Persist participant position change
                hnote over DB #lightyellow

                        INSERT **participantPositionChange**
                        SET transferStateChangeId = transferStateChange.transferStateChangeId,
                        participantPositionId = participantPosition.participantPositionId,
                        value = latestPosition,
                        reservedValue = participantPosition.reservedValue
                        createdDate = new Date()
                end note
                activate DB
                deactivate DB
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        note right of POS_HANDLER #yellow
            Message: {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                         "errorInformation": {
                             "errorCode": 3303,
                             "errorDescription": "Client requested to use a transfer that has already expired.",
                             "extensionList": <transferMessage.extensionList>
                         }
                     }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: abort,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
    end
    opt type == 'position' && action == 'reject'
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'REJECTED')\n<color #FF0000><b>Error code:</b> 2001</color>

        group Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group <color #blue>REFER TO DB TRANSACTION IMPLEMENTATION ABOVE</color>
                activate POS_DAO
                POS_DAO -> DB: Refer to implementation above
                activate DB
                deactivate DB
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        note right of POS_HANDLER #yellow
            Message: {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: abort,
                        createdAt: <timestamp>,
                        state: {
                            status: "rejected",
                            code: 0
                        }
                    }
                }
            }
        end note
    end
    opt type == 'position' && action == 'failed' (Unable to currently trigger this scenario)
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'FAILED')

        group Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group <color #blue>REFER TO DB TRANSACTION IMPLEMENTATION ABOVE</color>
                activate POS_DAO
                POS_DAO -> DB: Refer to implementation above
                activate DB
                deactivate DB
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        note right of POS_HANDLER #yellow
            Message: {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: abort,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
    end
    POS_HANDLER -> TOPIC_TRANSFERS: Publish Transfer event\n<color #FF0000><b>Error code:</b> 2003</color>
    activate TOPIC_TRANSFERS
    deactivate TOPIC_TRANSFERS
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.01(Sun Jan 28 20:08:22 SAST 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_152-release-1136-b20
Operating System: Mac OS X
OS Version: 10.13.5
Default Encoding: UTF-8
Language: en
Country: ZA
--></g></svg>