<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2704px" preserveAspectRatio="none" style="width:1311px;height:2704px;" version="1.1" viewBox="0 0 1311 2704" width="1311.2px" zoomAndPan="magnify"><defs><filter height="300%" id="f1jeu75impi15i" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="1.600000023841858"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="3.200000047683716" dy="3.200000047683716" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="11.2" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="220.8" x="546" y="18.8281">1.3.3 Abort Position Handler Consume</text><rect fill="#FFFFE0" height="2668.2532" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="1098" x="31.2" y="27.5906"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80.8" x="539.8" y="37.6453">Central Service</text><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="2534.4235" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="78" y="101.0297"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="24" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="485.2" y="2598.9563"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="97.2422" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="707.6" y="168.7266"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="402.3203" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="707.6" y="366.9625"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="97.2422" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="707.6" y="1222.0328"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="96.1938" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="707.6" y="1420.2688"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="97.2422" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="707.6" y="1883.4735"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="96.1938" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="707.6" y="2069.461"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="50.0969" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1083.6" y="192.4234"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="50.0969" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1083.6" y="410.1078"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="24" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1083.6" y="517.5016"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="24" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1083.6" y="603.8469"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="50.0969" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1083.6" y="1245.7297"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="24" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1083.6" y="1463.4141"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="50.0969" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1083.6" y="1907.1703"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="24" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1083.6" y="2112.6063"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="2523.2235" style="stroke: #000000; stroke-width: 1.600000023841858;" width="1292" x="10.4" y="106.6297"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="1042.1063" style="stroke: #000000; stroke-width: 1.600000023841858;" width="1276" x="18.4" y="126.0781"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="451.6172" style="stroke: #000000; stroke-width: 1.600000023841858;" width="1260" x="26.4" y="324.3141"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="367.4234" style="stroke: #000000; stroke-width: 1.600000023841858;" width="613.2" x="665.2" y="379.4594"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="650.2406" style="stroke: #000000; stroke-width: 1.600000023841858;" width="1137.6" x="18.4" y="1179.3844"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="145.4906" style="stroke: #000000; stroke-width: 1.600000023841858;" width="1115.6" x="26.4" y="1377.6203"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="61.2969" style="stroke: #000000; stroke-width: 1.600000023841858;" width="468.8" x="665.2" y="1432.7656"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="723.7313" style="stroke: #000000; stroke-width: 1.600000023841858;" width="1137.6" x="18.4" y="1840.825"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="145.4906" style="stroke: #000000; stroke-width: 1.600000023841858;" width="1115.6" x="26.4" y="2026.8125"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="61.2969" style="stroke: #000000; stroke-width: 1.600000023841858;" width="468.8" x="665.2" y="2081.9578"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 5.0,5.0;" x1="81.6" x2="81.6" y1="93.0297" y2="2643.4532"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 5.0,5.0;" x1="489.2" x2="489.2" y1="93.0297" y2="2643.4532"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 5.0,5.0;" x1="606" x2="606" y1="93.0297" y2="2643.4532"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 5.0,5.0;" x1="711.6" x2="711.6" y1="93.0297" y2="2643.4532"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 5.0,5.0;" x1="1087.6" x2="1087.6" y1="93.0297" y2="2643.4532"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="90.4" x="34.4" y="90.6672">Position Handler</text><ellipse cx="82" cy="67.0391" fill="#FEFECE" filter="url(#f1jeu75impi15i)" rx="9.6" ry="9.6" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><polygon fill="#A80036" points="78.8,57.4391,83.6,53.4391,82,57.4391,83.6,61.4391,78.8,57.4391" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="90.4" x="34.4" y="2653.4813">Position Handler</text><ellipse cx="82" cy="2668.6438" fill="#FEFECE" filter="url(#f1jeu75impi15i)" rx="9.6" ry="9.6" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><polygon fill="#A80036" points="78.8,2659.0438,83.6,2655.0438,82,2659.0438,83.6,2663.0438,78.8,2659.0438" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><rect fill="#FEFECE" filter="url(#f1jeu75impi15i)" height="24.3906" style="stroke: #A80036; stroke-width: 1.2000000178813934;" width="94.4" x="442" y="61.4391"/><rect fill="#FEFECE" filter="url(#f1jeu75impi15i)" height="24.3906" style="stroke: #A80036; stroke-width: 1.2000000178813934;" width="94.4" x="438.8" y="64.6391"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="83.2" x="444.4" y="81.0672">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f1jeu75impi15i)" height="24.3906" style="stroke: #A80036; stroke-width: 1.2000000178813934;" width="94.4" x="442" y="2642.6532"/><rect fill="#FEFECE" filter="url(#f1jeu75impi15i)" height="24.3906" style="stroke: #A80036; stroke-width: 1.2000000178813934;" width="94.4" x="438.8" y="2645.8532"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="83.2" x="444.4" y="2662.2813">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#f1jeu75impi15i)" height="24.3906" style="stroke: #A80036; stroke-width: 1.2000000178813934;" width="111.2" x="550.8" y="61.4391"/><rect fill="#FEFECE" filter="url(#f1jeu75impi15i)" height="24.3906" style="stroke: #A80036; stroke-width: 1.2000000178813934;" width="111.2" x="547.6" y="64.6391"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="100" x="553.2" y="81.0672">Notification-Topic</text><rect fill="#FEFECE" filter="url(#f1jeu75impi15i)" height="24.3906" style="stroke: #A80036; stroke-width: 1.2000000178813934;" width="111.2" x="550.8" y="2642.6532"/><rect fill="#FEFECE" filter="url(#f1jeu75impi15i)" height="24.3906" style="stroke: #A80036; stroke-width: 1.2000000178813934;" width="111.2" x="547.6" y="2645.8532"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="100" x="553.2" y="2662.2813">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="72" x="673.2" y="90.6672">Position DAO</text><ellipse cx="711.6" cy="67.0391" fill="#FEFECE" filter="url(#f1jeu75impi15i)" rx="9.6" ry="9.6" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><line style="stroke: #A80036; stroke-width: 1.600000023841858;" x1="702" x2="721.2" y1="78.2391" y2="78.2391"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="72" x="673.2" y="2653.4813">Position DAO</text><ellipse cx="711.6" cy="2668.6438" fill="#FEFECE" filter="url(#f1jeu75impi15i)" rx="9.6" ry="9.6" style="stroke: #A80036; stroke-width: 1.600000023841858;"/><line style="stroke: #A80036; stroke-width: 1.600000023841858;" x1="702" x2="721.2" y1="2679.8438" y2="2679.8438"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="72" x="1049.2" y="90.6672">Central Store</text><path d="M1073.2,51.0391 C1073.2,43.0391 1087.6,43.0391 1087.6,43.0391 C1087.6,43.0391 1102,43.0391 1102,51.0391 L1102,71.8391 C1102,79.8391 1087.6,79.8391 1087.6,79.8391 C1087.6,79.8391 1073.2,79.8391 1073.2,71.8391 L1073.2,51.0391 " fill="#FEFECE" filter="url(#f1jeu75impi15i)" style="stroke: #000000; stroke-width: 1.2000000178813934;"/><path d="M1073.2,51.0391 C1073.2,59.0391 1087.6,59.0391 1087.6,59.0391 C1087.6,59.0391 1102,59.0391 1102,51.0391 " fill="none" style="stroke: #000000; stroke-width: 1.2000000178813934;"/><text fill="#000000" font-family="sans-serif" font-size="11.2" lengthAdjust="spacingAndGlyphs" textLength="72" x="1049.2" y="2653.4813">Central Store</text><path d="M1073.2,2663.8438 C1073.2,2655.8438 1087.6,2655.8438 1087.6,2655.8438 C1087.6,2655.8438 1102,2655.8438 1102,2663.8438 L1102,2684.6438 C1102,2692.6438 1087.6,2692.6438 1087.6,2692.6438 C1087.6,2692.6438 1073.2,2692.6438 1073.2,2684.6438 L1073.2,2663.8438 " fill="#FEFECE" filter="url(#f1jeu75impi15i)" style="stroke: #000000; stroke-width: 1.2000000178813934;"/><path d="M1073.2,2663.8438 C1073.2,2671.8438 1087.6,2671.8438 1087.6,2671.8438 C1087.6,2671.8438 1102,2671.8438 1102,2663.8438 " fill="none" style="stroke: #000000; stroke-width: 1.2000000178813934;"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="2534.4235" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="78" y="101.0297"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="24" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="485.2" y="2598.9563"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="97.2422" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="707.6" y="168.7266"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="402.3203" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="707.6" y="366.9625"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="97.2422" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="707.6" y="1222.0328"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="96.1938" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="707.6" y="1420.2688"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="97.2422" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="707.6" y="1883.4735"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="96.1938" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="707.6" y="2069.461"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="50.0969" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1083.6" y="192.4234"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="50.0969" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1083.6" y="410.1078"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="24" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1083.6" y="517.5016"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="24" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1083.6" y="603.8469"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="50.0969" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1083.6" y="1245.7297"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="24" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1083.6" y="1463.4141"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="50.0969" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1083.6" y="1907.1703"/><rect fill="#FFFFFF" filter="url(#f1jeu75impi15i)" height="24" style="stroke: #A80036; stroke-width: 0.800000011920929;" width="8" x="1083.6" y="2112.6063"/><path d="M10.4,106.6297 L222.4,106.6297 L222.4,112.2297 L214.4,120.2297 L10.4,120.2297 L10.4,106.6297 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.800000011920929;"/><rect fill="none" height="2523.2235" style="stroke: #000000; stroke-width: 1.600000023841858;" width="1292" x="10.4" y="106.6297"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="176" x="22.4" y="117.4844">Abort Position Handler Consume</text><path d="M18.4,126.0781 L72,126.0781 L72,131.6781 L64,139.6781 L18.4,139.6781 L18.4,126.0781 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.800000011920929;"/><rect fill="none" height="1042.1063" style="stroke: #000000; stroke-width: 1.600000023841858;" width="1276" x="18.4" y="126.0781"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17.6" x="30.4" y="136.9328">opt</text><text fill="#000000" font-family="sans-serif" font-size="8.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="237.6" x="84" y="136.1859">[type == 'position' &amp;&amp; action == 'timeout-reserved']</text><polygon fill="#A80036" points="698,165.5266,706,168.7266,698,171.9266,701.2,168.7266" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="86" x2="702.8" y1="168.7266" y2="168.7266"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="91.6" y="159.3055">1</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="207.2" x="102" y="153.1813">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="58.4" x="102" y="165.4297">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="25.6" x="163.6" y="165.4297">2003</text><polygon fill="#A80036" points="1074,189.2234,1082,192.4234,1074,195.6234,1077.2,192.4234" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="715.6" x2="1078.8" y1="192.4234" y2="192.4234"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="721.2" y="188.8781">2</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="207.2" x="731.6" y="188.8781">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#f1jeu75impi15i)" points="1035.2,203.0719,1140,203.0719,1148,211.8719,1140,221.4719,1035.2,221.4719,1027.2,211.8719,1035.2,203.0719" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="101.6" x="1036.8" y="216.3266">transferStateChange</text><polygon fill="#A80036" points="724.4,239.3203,716.4,242.5203,724.4,245.7203,721.2,242.5203" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 2.0,2.0;" x1="719.6" x2="1086.8" y1="242.5203" y2="242.5203"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="729.2" y="238.975">3</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="200" x="739.6" y="238.975">Return current state of transfer from DB</text><polygon fill="#A80036" points="94.8,262.7688,86.8,265.9688,94.8,269.1688,91.6,265.9688" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 2.0,2.0;" x1="90" x2="710.8" y1="265.9688" y2="265.9688"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="99.6" y="262.4234">4</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="200" x="110" y="262.4234">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="86" x2="119.6" y1="301.9141" y2="301.9141"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="119.6" x2="119.6" y1="301.9141" y2="312.3141"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="86.8" x2="119.6" y1="312.3141" y2="312.3141"/><polygon fill="#A80036" points="94.8,309.1141,86.8,312.3141,94.8,315.5141,91.6,312.3141" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="91.6" y="291.9961">5</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="363.2" x="102" y="285.8719">Validate current state (transferStateChange.transferStateId == 'EXPIRED')</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="58.4" x="102" y="298.1203">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="25.6" x="163.6" y="298.1203">2001</text><path d="M26.4,324.3141 L187.2,324.3141 L187.2,329.9141 L179.2,337.9141 L26.4,337.9141 L26.4,324.3141 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.800000011920929;"/><rect fill="none" height="451.6172" style="stroke: #000000; stroke-width: 1.600000023841858;" width="1260" x="26.4" y="324.3141"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124.8" x="38.4" y="335.1688">Persist Position change</text><polygon fill="#A80036" points="698,363.7625,706,366.9625,698,370.1625,701.2,366.9625" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="86" x2="702.8" y1="366.9625" y2="366.9625"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="91.6" y="357.5414">6</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="247.2" x="102" y="351.4172">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="58.4" x="102" y="363.6656">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="25.6" x="163.6" y="363.6656">2003</text><path d="M665.2,379.4594 L898.8,379.4594 L898.8,385.0594 L890.8,393.0594 L665.2,393.0594 L665.2,379.4594 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.800000011920929;"/><rect fill="none" height="367.4234" style="stroke: #000000; stroke-width: 1.600000023841858;" width="613.2" x="665.2" y="379.4594"/><text fill="#0000FF" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197.6" x="677.2" y="390.3141">DB TRANSACTION IMPLEMENTATION</text><polygon fill="#A80036" points="1074,406.9078,1082,410.1078,1074,413.3078,1077.2,410.1078" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="715.6" x2="1078.8" y1="410.1078" y2="410.1078"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="721.2" y="406.5625">7</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="315.2" x="731.6" y="406.5625">Select participantPosition.value FOR UPDATE from DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f1jeu75impi15i)" points="1038.4,420.7563,1136.8,420.7563,1144.8,429.5563,1136.8,439.1563,1038.4,439.1563,1030.4,429.5563,1038.4,420.7563" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="95.2" x="1040" y="434.0109">participantPosition</text><polygon fill="#A80036" points="724.4,457.0047,716.4,460.2047,724.4,463.4047,721.2,460.2047" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 2.0,2.0;" x1="719.6" x2="1086.8" y1="460.2047" y2="460.2047"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="729.2" y="456.6594">8</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="252" x="739.6" y="456.6594">Return participantPosition.value from DB for Payer</text><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="715.6" x2="749.2" y1="483.9016" y2="483.9016"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="749.2" x2="749.2" y1="483.9016" y2="494.3016"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="716.4" x2="749.2" y1="494.3016" y2="494.3016"/><polygon fill="#A80036" points="724.4,491.1016,716.4,494.3016,724.4,497.5016,721.2,494.3016" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7.2" x="721.2" y="480.1078">9</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="731.6" y="480.1078">latestPosition</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="271.2" x="806.8" y="480.1078">= participantPosition.value - payload.amount.amount</text><polygon fill="#A80036" points="1074,514.3016,1082,517.5016,1074,520.7016,1077.2,517.5016" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="715.6" x2="1078.8" y1="517.5016" y2="517.5016"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="721.2" y="513.9563">10</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="183.2" x="738.8" y="513.9563">Persist latestPosition to DB for Payer</text><polygon fill="#FFFFE0" filter="url(#f1jeu75impi15i)" points="1013.6,552.15,1161.6,552.15,1169.6,567.35,1161.6,582.55,1013.6,582.55,1005.6,567.35,1013.6,552.15" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="40" x="1015.2" y="565.4047">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101.6" x="1058.4" y="565.4047">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="130.4" x="1015.2" y="577.6531">SET value = latestPosition</text><polygon fill="#A80036" points="1074,600.6469,1082,603.8469,1074,607.0469,1077.2,603.8469" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="715.6" x2="1078.8" y1="603.8469" y2="603.8469"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="721.2" y="600.3016">11</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="264" x="738.8" y="600.3016">Persist participant position change and state change</text><polygon fill="#FFFFE0" filter="url(#f1jeu75impi15i)" points="912.8,638.4953,1262.4,638.4953,1270.4,690.4953,1262.4,742.4953,912.8,742.4953,904.8,690.4953,912.8,638.4953" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="35.2" x="914.4" y="651.75">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="111.2" x="952.8" y="651.75">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="140" x="1067.2" y="651.75">transferStateId = 'ABORTED'</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="0" x="917.6" y="663.9984"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="35.2" x="914.4" y="676.2469">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="143.2" x="952.8" y="676.2469">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="346.4" x="914.4" y="688.4953">SET participantPositionId = participantPosition.participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="344.8" x="914.4" y="700.7438">transferStateChangeId = transferStateChange.transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="112.8" x="914.4" y="712.9922">value = latestPosition,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="252" x="914.4" y="725.2406">reservedValue = participantPosition.reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="127.2" x="914.4" y="737.4891">createdDate = new Date()</text><polygon fill="#A80036" points="94.8,766.0828,86.8,769.2828,94.8,772.4828,91.6,769.2828" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 2.0,2.0;" x1="90" x2="710.8" y1="769.2828" y2="769.2828"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="99.6" y="765.7375">12</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="76" x="117.2" y="765.7375">Return success</text><path d="M89.6,785.5313 L89.6,1160.7313 L564,1160.7313 L564,793.5313 L556,785.5313 L89.6,785.5313 " fill="#FFFF00" filter="url(#f1jeu75impi15i)" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><path d="M556,785.5313 L556,793.5313 L564,793.5313 L556,785.5313 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="52.8" x="94.4" y="799.5859">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="166.4" x="107.2" y="811.8344">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="180" x="107.2" y="824.0828">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="168" x="107.2" y="836.3313">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="111.2" x="107.2" y="848.5797">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="48" x="107.2" y="860.8281">content: {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="144.8" x="120" y="873.0766">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="48.8" x="120" y="885.325">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="100.8" x="136" y="897.5735">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="92.8" x="148.8" y="909.8219">"errorCode": 3303,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="403.2" x="148.8" y="922.0703">"errorDescription": "Client requested to use a transfer that has already expired.",</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="252" x="148.8" y="934.3188">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="136" y="946.5672">}</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="123.2" y="958.8156">}</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="6.4" x="107.2" y="971.0641">},</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="56" x="107.2" y="983.3125">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="36.8" x="120" y="995.561">event: {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="57.6" x="132.8" y="1007.8094">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="152.8" x="132.8" y="1020.0578">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="70.4" x="132.8" y="1032.3063">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="67.2" x="132.8" y="1044.5547">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="127.2" x="132.8" y="1056.8031">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="34.4" x="132.8" y="1069.0516">state: {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="69.6" x="145.6" y="1081.3">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="182.4" x="145.6" y="1093.5485">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="248" x="145.6" y="1105.7969">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="132.8" y="1118.0453">}</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="120" y="1130.2938">}</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="107.2" y="1142.5422">}</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="94.4" y="1154.7906">}</text><path d="M18.4,1179.3844 L72,1179.3844 L72,1184.9844 L64,1192.9844 L18.4,1192.9844 L18.4,1179.3844 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.800000011920929;"/><rect fill="none" height="650.2406" style="stroke: #000000; stroke-width: 1.600000023841858;" width="1137.6" x="18.4" y="1179.3844"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17.6" x="30.4" y="1190.2391">opt</text><text fill="#000000" font-family="sans-serif" font-size="8.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="184" x="84" y="1189.4922">[type == 'position' &amp;&amp; action == 'reject']</text><polygon fill="#A80036" points="698,1218.8328,706,1222.0328,698,1225.2328,701.2,1222.0328" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="86" x2="702.8" y1="1222.0328" y2="1222.0328"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="91.6" y="1212.6117">13</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="207.2" x="109.2" y="1206.4875">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="58.4" x="109.2" y="1218.736">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="25.6" x="170.8" y="1218.736">2003</text><polygon fill="#A80036" points="1074,1242.5297,1082,1245.7297,1074,1248.9297,1077.2,1245.7297" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="715.6" x2="1078.8" y1="1245.7297" y2="1245.7297"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="721.2" y="1242.1844">14</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="207.2" x="738.8" y="1242.1844">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#f1jeu75impi15i)" points="1035.2,1256.3781,1140,1256.3781,1148,1265.1781,1140,1274.7781,1035.2,1274.7781,1027.2,1265.1781,1035.2,1256.3781" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="101.6" x="1036.8" y="1269.6328">transferStateChange</text><polygon fill="#A80036" points="724.4,1292.6266,716.4,1295.8266,724.4,1299.0266,721.2,1295.8266" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 2.0,2.0;" x1="719.6" x2="1086.8" y1="1295.8266" y2="1295.8266"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="729.2" y="1292.2813">15</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="200" x="746.8" y="1292.2813">Return current state of transfer from DB</text><polygon fill="#A80036" points="94.8,1316.075,86.8,1319.275,94.8,1322.475,91.6,1319.275" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 2.0,2.0;" x1="90" x2="710.8" y1="1319.275" y2="1319.275"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="99.6" y="1315.7297">16</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="200" x="117.2" y="1315.7297">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="86" x2="119.6" y1="1355.2203" y2="1355.2203"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="119.6" x2="119.6" y1="1355.2203" y2="1365.6203"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="86.8" x2="119.6" y1="1365.6203" y2="1365.6203"/><polygon fill="#A80036" points="94.8,1362.4203,86.8,1365.6203,94.8,1368.8203,91.6,1365.6203" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="91.6" y="1345.3024">17</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="370.4" x="109.2" y="1339.1781">Validate current state (transferStateChange.transferStateId == 'REJECTED')</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="58.4" x="109.2" y="1351.4266">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="25.6" x="170.8" y="1351.4266">2001</text><path d="M26.4,1377.6203 L588,1377.6203 L588,1383.2203 L580,1391.2203 L26.4,1391.2203 L26.4,1377.6203 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.800000011920929;"/><rect fill="none" height="145.4906" style="stroke: #000000; stroke-width: 1.600000023841858;" width="1115.6" x="26.4" y="1377.6203"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="525.6" x="38.4" y="1388.475">Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)</text><polygon fill="#A80036" points="698,1417.0688,706,1420.2688,698,1423.4688,701.2,1420.2688" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="86" x2="702.8" y1="1420.2688" y2="1420.2688"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="91.6" y="1410.8477">18</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="247.2" x="109.2" y="1404.7235">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="58.4" x="109.2" y="1416.9719">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="25.6" x="170.8" y="1416.9719">2003</text><path d="M665.2,1432.7656 L994,1432.7656 L994,1438.3656 L986,1446.3656 L665.2,1446.3656 L665.2,1432.7656 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.800000011920929;"/><rect fill="none" height="61.2969" style="stroke: #000000; stroke-width: 1.600000023841858;" width="468.8" x="665.2" y="1432.7656"/><text fill="#0000FF" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292.8" x="677.2" y="1443.6203">REFER TO DB TRANSACTION IMPLEMENTATION ABOVE</text><polygon fill="#A80036" points="1074,1460.2141,1082,1463.4141,1074,1466.6141,1077.2,1463.4141" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="715.6" x2="1078.8" y1="1463.4141" y2="1463.4141"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="721.2" y="1459.8688">19</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="154.4" x="738.8" y="1459.8688">Refer to implementation above</text><polygon fill="#A80036" points="94.8,1513.2625,86.8,1516.4625,94.8,1519.6625,91.6,1516.4625" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 2.0,2.0;" x1="90" x2="710.8" y1="1516.4625" y2="1516.4625"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="99.6" y="1512.9172">20</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="76" x="117.2" y="1512.9172">Return success</text><path d="M89.6,1532.711 L89.6,1822.311 L299.2,1822.311 L299.2,1540.711 L291.2,1532.711 L89.6,1532.711 " fill="#FFFF00" filter="url(#f1jeu75impi15i)" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><path d="M291.2,1532.711 L291.2,1540.711 L299.2,1540.711 L291.2,1532.711 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="52.8" x="94.4" y="1546.7656">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="166.4" x="107.2" y="1559.0141">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="180" x="107.2" y="1571.2625">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="168" x="107.2" y="1583.511">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="111.2" x="107.2" y="1595.7594">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="48" x="107.2" y="1608.0078">content: {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="144.8" x="120" y="1620.2563">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="144" x="120" y="1632.5047">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="6.4" x="107.2" y="1644.7531">},</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="56" x="107.2" y="1657.0016">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="36.8" x="120" y="1669.25">event: {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="57.6" x="132.8" y="1681.4985">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="152.8" x="132.8" y="1693.7469">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="70.4" x="132.8" y="1705.9953">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="67.2" x="132.8" y="1718.2438">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="127.2" x="132.8" y="1730.4922">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="34.4" x="132.8" y="1742.7407">state: {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="88.8" x="145.6" y="1754.9891">status: "rejected",</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="36.8" x="145.6" y="1767.2375">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="132.8" y="1779.486">}</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="120" y="1791.7344">}</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="107.2" y="1803.9828">}</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="94.4" y="1816.2313">}</text><path d="M18.4,1840.825 L72,1840.825 L72,1846.425 L64,1854.425 L18.4,1854.425 L18.4,1840.825 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.800000011920929;"/><rect fill="none" height="723.7313" style="stroke: #000000; stroke-width: 1.600000023841858;" width="1137.6" x="18.4" y="1840.825"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17.6" x="30.4" y="1851.6797">opt</text><text fill="#000000" font-family="sans-serif" font-size="8.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="364" x="84" y="1850.9328">[type == 'position' &amp;&amp; action == 'fail' (Unable to currently trigger this scenario)]</text><polygon fill="#A80036" points="698,1880.2735,706,1883.4735,698,1886.6735,701.2,1883.4735" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="86" x2="702.8" y1="1883.4735" y2="1883.4735"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="91.6" y="1874.0524">21</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="207.2" x="109.2" y="1867.9282">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="58.4" x="109.2" y="1880.1766">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="25.6" x="170.8" y="1880.1766">2003</text><polygon fill="#A80036" points="1074,1903.9703,1082,1907.1703,1074,1910.3703,1077.2,1907.1703" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="715.6" x2="1078.8" y1="1907.1703" y2="1907.1703"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="721.2" y="1903.625">22</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="207.2" x="738.8" y="1903.625">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#f1jeu75impi15i)" points="1035.2,1917.8188,1140,1917.8188,1148,1926.6188,1140,1936.2188,1035.2,1936.2188,1027.2,1926.6188,1035.2,1917.8188" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="101.6" x="1036.8" y="1931.0735">transferStateChange</text><polygon fill="#A80036" points="724.4,1954.0672,716.4,1957.2672,724.4,1960.4672,721.2,1957.2672" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 2.0,2.0;" x1="719.6" x2="1086.8" y1="1957.2672" y2="1957.2672"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="729.2" y="1953.7219">23</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="200" x="746.8" y="1953.7219">Return current state of transfer from DB</text><polygon fill="#A80036" points="94.8,1977.5157,86.8,1980.7157,94.8,1983.9157,91.6,1980.7157" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 2.0,2.0;" x1="90" x2="710.8" y1="1980.7157" y2="1980.7157"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="99.6" y="1977.1703">24</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="200" x="117.2" y="1977.1703">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="86" x2="119.6" y1="2004.4125" y2="2004.4125"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="119.6" x2="119.6" y1="2004.4125" y2="2014.8125"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="86.8" x2="119.6" y1="2014.8125" y2="2014.8125"/><polygon fill="#A80036" points="94.8,2011.6125,86.8,2014.8125,94.8,2018.0125,91.6,2014.8125" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="91.6" y="2000.6188">25</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="357.6" x="109.2" y="2000.6188">Validate current state (transferStateChange.transferStateId == 'FAILED')</text><path d="M26.4,2026.8125 L588,2026.8125 L588,2032.4125 L580,2040.4125 L26.4,2040.4125 L26.4,2026.8125 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.800000011920929;"/><rect fill="none" height="145.4906" style="stroke: #000000; stroke-width: 1.600000023841858;" width="1115.6" x="26.4" y="2026.8125"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="525.6" x="38.4" y="2037.6672">Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)</text><polygon fill="#A80036" points="698,2066.261,706,2069.461,698,2072.661,701.2,2069.461" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="86" x2="702.8" y1="2069.461" y2="2069.461"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="91.6" y="2060.0399">26</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="247.2" x="109.2" y="2053.9157">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="58.4" x="109.2" y="2066.1641">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="25.6" x="170.8" y="2066.1641">2003</text><path d="M665.2,2081.9578 L994,2081.9578 L994,2087.5578 L986,2095.5578 L665.2,2095.5578 L665.2,2081.9578 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.800000011920929;"/><rect fill="none" height="61.2969" style="stroke: #000000; stroke-width: 1.600000023841858;" width="468.8" x="665.2" y="2081.9578"/><text fill="#0000FF" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292.8" x="677.2" y="2092.8125">REFER TO DB TRANSACTION IMPLEMENTATION ABOVE</text><polygon fill="#A80036" points="1074,2109.4063,1082,2112.6063,1074,2115.8063,1077.2,2112.6063" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="715.6" x2="1078.8" y1="2112.6063" y2="2112.6063"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="721.2" y="2109.061">27</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="154.4" x="738.8" y="2109.061">Refer to implementation above</text><polygon fill="#A80036" points="94.8,2162.4547,86.8,2165.6547,94.8,2168.8547,91.6,2165.6547" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929; stroke-dasharray: 2.0,2.0;" x1="90" x2="710.8" y1="2165.6547" y2="2165.6547"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="99.6" y="2162.1094">28</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="76" x="117.2" y="2162.1094">Return success</text><path d="M89.6,2181.9032 L89.6,2557.1032 L412.8,2557.1032 L412.8,2189.9032 L404.8,2181.9032 L89.6,2181.9032 " fill="#FFFF00" filter="url(#f1jeu75impi15i)" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><path d="M404.8,2181.9032 L404.8,2189.9032 L412.8,2189.9032 L404.8,2181.9032 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="52.8" x="94.4" y="2195.9578">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="166.4" x="107.2" y="2208.2063">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="180" x="107.2" y="2220.4547">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="168" x="107.2" y="2232.7032">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="111.2" x="107.2" y="2244.9516">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="48" x="107.2" y="2257.2">content: {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="144.8" x="120" y="2269.4485">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="48.8" x="120" y="2281.6969">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="100.8" x="136" y="2293.9453">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="92.8" x="148.8" y="2306.1938">"errorCode": 3100,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="180.8" x="148.8" y="2318.4422">"errorDescription": "Transfer failed",</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="252" x="148.8" y="2330.6907">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="136" y="2342.9391">}</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="123.2" y="2355.1875">}</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="6.4" x="107.2" y="2367.436">},</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="56" x="107.2" y="2379.6844">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="36.8" x="120" y="2391.9328">event: {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="57.6" x="132.8" y="2404.1813">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="152.8" x="132.8" y="2416.4297">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="70.4" x="132.8" y="2428.6782">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="67.2" x="132.8" y="2440.9266">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="127.2" x="132.8" y="2453.175">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="34.4" x="132.8" y="2465.4235">state: {</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="69.6" x="145.6" y="2477.6719">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="182.4" x="145.6" y="2489.9203">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="248" x="145.6" y="2502.1688">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="132.8" y="2514.4172">}</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="120" y="2526.6657">}</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="107.2" y="2538.9141">}</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="3.2" x="94.4" y="2551.1625">}</text><polygon fill="#A80036" points="475.6,2595.7563,483.6,2598.9563,475.6,2602.1563,478.8,2598.9563" style="stroke: #A80036; stroke-width: 0.800000011920929;"/><line style="stroke: #A80036; stroke-width: 0.800000011920929;" x1="86" x2="480.4" y1="2598.9563" y2="2598.9563"/><text fill="#000000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="14.4" x="91.6" y="2589.5352">29</text><text fill="#000000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="112" x="109.2" y="2583.411">Publish Transfer event</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="58.4" x="109.2" y="2595.6594">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="10.4" lengthAdjust="spacingAndGlyphs" textLength="25.6" x="170.8" y="2595.6594">2003</text><!--
@startuml
title 1.3.3 Abort Position Handler Consume

autonumber


control "Position Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
entity "Position DAO" as POS_DAO
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
database "Central Store" as DB

box "Central Service" #LightYellow
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant DB
end box

activate POS_HANDLER
group Abort Position Handler Consume
    opt type == 'position' && action == 'timeout-reserved'
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'EXPIRED')\n<color #FF0000><b>Error code:</b> 2001</color>

        group Persist Position change
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group <color #blue>DB TRANSACTION IMPLEMENTATION</color>
                activate POS_DAO
                POS_DAO -> DB: Select participantPosition.value FOR UPDATE from DB for Payer
                activate DB
                hnote over DB #lightyellow
                    participantPosition
                end note
                DB - -> POS_DAO: Return participantPosition.value from DB for Payer
                deactivate DB
                POS_DAO <-> POS_DAO: **latestPosition** = participantPosition.value - payload.amount.amount
                POS_DAO->DB: Persist latestPosition to DB for Payer
                hnote over DB #lightyellow
                    UPDATE **participantPosition**
                    SET value = latestPosition
                end note
                activate DB
                deactivate DB
                POS_DAO -> DB: Persist participant position change and state change
                hnote over DB #lightyellow
                        INSERT **transferStateChange** transferStateId = 'ABORTED'

                        INSERT **participantPositionChange**
                        SET participantPositionId = participantPosition.participantPositionId,
                        transferStateChangeId = transferStateChange.transferStateChangeId,
                        value = latestPosition,
                        reservedValue = participantPosition.reservedValue
                        createdDate = new Date()
                end note
                activate DB
                deactivate DB
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        note right of POS_HANDLER #yellow
            Message: {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                         "errorInformation": {
                             "errorCode": 3303,
                             "errorDescription": "Client requested to use a transfer that has already expired.",
                             "extensionList": <transferMessage.extensionList>
                         }
                     }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: abort,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
    end
    opt type == 'position' && action == 'reject'
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'REJECTED')\n<color #FF0000><b>Error code:</b> 2001</color>

        group Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group <color #blue>REFER TO DB TRANSACTION IMPLEMENTATION ABOVE</color>
                activate POS_DAO
                POS_DAO -> DB: Refer to implementation above
                activate DB
                deactivate DB
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        note right of POS_HANDLER #yellow
            Message: {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: abort,
                        createdAt: <timestamp>,
                        state: {
                            status: "rejected",
                            code: 0
                        }
                    }
                }
            }
        end note
    end
    opt type == 'position' && action == 'fail' (Unable to currently trigger this scenario)
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'FAILED')

        group Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group <color #blue>REFER TO DB TRANSACTION IMPLEMENTATION ABOVE</color>
                activate POS_DAO
                POS_DAO -> DB: Refer to implementation above
                activate DB
                deactivate DB
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        note right of POS_HANDLER #yellow
            Message: {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                         "errorInformation": {
                             "errorCode": 3100,
                             "errorDescription": "Transfer failed",
                             "extensionList": <transferMessage.extensionList>
                         }
                     }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: abort,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
    end
    POS_HANDLER -> TOPIC_TRANSFERS: Publish Transfer event\n<color #FF0000><b>Error code:</b> 2003</color>
    activate TOPIC_TRANSFERS
    deactivate TOPIC_TRANSFERS
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.01(Sun Jan 28 20:08:22 SAST 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_152-release-1136-b20
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: ZA
--></g></svg>