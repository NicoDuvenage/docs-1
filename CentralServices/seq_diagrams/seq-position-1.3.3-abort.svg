<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2422.8001px" preserveAspectRatio="none" style="width:1060px;height:2422px;" version="1.1" viewBox="0 0 1060 2422" width="1060.2px" zoomAndPan="magnify"><defs><filter height="300%" id="fod9jm76vvwhz" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="1.2000000476837158"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="2.4000000953674316" dy="2.4000000953674316" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="8.4" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="165.6" x="447.9" y="14.1211">1.3.3 Abort Position Handler Consume</text><rect fill="#FFFFE0" height="2396.0755" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="893.4" x="23.4" y="20.693"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="60.6" x="439.8" y="28.234">Central Service</text><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="2295.7032" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="58.5" y="75.7723"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="363.9" y="2344.1028"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="72.9316" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="530.7" y="126.5449"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="301.7402" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="530.7" y="275.2219"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="72.9316" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="530.7" y="916.5246"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="301.7402" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="530.7" y="1065.2016"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="72.9316" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="530.7" y="1642.2001"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="301.7402" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="530.7" y="1781.6907"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="37.5727" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="882.6" y="144.3176"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="37.5727" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="882.6" y="307.5809"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="882.6" y="388.1262"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="882.6" y="452.8852"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="37.5727" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="882.6" y="934.2973"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="37.5727" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="882.6" y="1097.5606"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="882.6" y="1178.1059"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="882.6" y="1242.8649"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="37.5727" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="882.6" y="1659.9727"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="37.5727" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="882.6" y="1814.0497"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="882.6" y="1894.595"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="882.6" y="1959.354"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="2287.3032" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="1045.8" x="7.8" y="79.9723"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="781.5797" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="1033.8" x="13.8" y="94.5586"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="338.7129" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="1021.8" x="19.8" y="243.2356"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="275.5676" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="536.7" x="498.9" y="284.5945"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="717.2754" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="1033.8" x="13.8" y="884.5383"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="338.7129" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="1021.8" x="19.8" y="1033.2153"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="275.5676" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="536.7" x="498.9" y="1074.5743"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="708.0891" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="1033.8" x="13.8" y="1610.2137"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="338.7129" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="1021.8" x="19.8" y="1749.7044"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="275.5676" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="536.7" x="498.9" y="1791.0634"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="61.2" x2="61.2" y1="69.7723" y2="2377.4755"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="366.9" x2="366.9" y1="69.7723" y2="2377.4755"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="454.5" x2="454.5" y1="69.7723" y2="2377.4755"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="533.7" x2="533.7" y1="69.7723" y2="2377.4755"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="820.8" x2="820.8" y1="69.7723" y2="2377.4755"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 5.0,5.0;" x1="885.6" x2="885.6" y1="69.7723" y2="2377.4755"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="67.8" x="25.8" y="68.0004">Position Handler</text><ellipse cx="61.5" cy="50.2793" fill="#FEFECE" filter="url(#fod9jm76vvwhz)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><polygon fill="#A80036" points="59.1,43.0793,62.7,40.0793,61.5,43.0793,62.7,46.0793,59.1,43.0793" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="67.8" x="25.8" y="2384.9966">Position Handler</text><ellipse cx="61.5" cy="2396.3685" fill="#FEFECE" filter="url(#fod9jm76vvwhz)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><polygon fill="#A80036" points="59.1,2389.1685,62.7,2386.1685,61.5,2389.1685,62.7,2392.1685,59.1,2389.1685" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><rect fill="#FEFECE" filter="url(#fod9jm76vvwhz)" height="18.293" style="stroke: #A80036; stroke-width: 0.9000000357627869;" width="70.8" x="331.5" y="46.0793"/><rect fill="#FEFECE" filter="url(#fod9jm76vvwhz)" height="18.293" style="stroke: #A80036; stroke-width: 0.9000000357627869;" width="70.8" x="329.1" y="48.4793"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="62.4" x="333.3" y="60.8004">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#fod9jm76vvwhz)" height="18.293" style="stroke: #A80036; stroke-width: 0.9000000357627869;" width="70.8" x="331.5" y="2376.8755"/><rect fill="#FEFECE" filter="url(#fod9jm76vvwhz)" height="18.293" style="stroke: #A80036; stroke-width: 0.9000000357627869;" width="70.8" x="329.1" y="2379.2755"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="62.4" x="333.3" y="2391.5966">Transfer-Topic</text><rect fill="#FEFECE" filter="url(#fod9jm76vvwhz)" height="18.293" style="stroke: #A80036; stroke-width: 0.9000000357627869;" width="83.4" x="413.1" y="46.0793"/><rect fill="#FEFECE" filter="url(#fod9jm76vvwhz)" height="18.293" style="stroke: #A80036; stroke-width: 0.9000000357627869;" width="83.4" x="410.7" y="48.4793"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="75" x="414.9" y="60.8004">Notification-Topic</text><rect fill="#FEFECE" filter="url(#fod9jm76vvwhz)" height="18.293" style="stroke: #A80036; stroke-width: 0.9000000357627869;" width="83.4" x="413.1" y="2376.8755"/><rect fill="#FEFECE" filter="url(#fod9jm76vvwhz)" height="18.293" style="stroke: #A80036; stroke-width: 0.9000000357627869;" width="83.4" x="410.7" y="2379.2755"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="75" x="414.9" y="2391.5966">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="54" x="504.9" y="68.0004">Position DAO</text><ellipse cx="533.7" cy="50.2793" fill="#FEFECE" filter="url(#fod9jm76vvwhz)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><line style="stroke: #A80036; stroke-width: 1.2000000476837158;" x1="526.5" x2="540.9" y1="58.6793" y2="58.6793"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="54" x="504.9" y="2384.9966">Position DAO</text><ellipse cx="533.7" cy="2396.3685" fill="#FEFECE" filter="url(#fod9jm76vvwhz)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><line style="stroke: #A80036; stroke-width: 1.2000000476837158;" x1="526.5" x2="540.9" y1="2404.7685" y2="2404.7685"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="55.8" x="791.4" y="68.0004">Transfer DAO</text><ellipse cx="821.1" cy="50.2793" fill="#FEFECE" filter="url(#fod9jm76vvwhz)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><line style="stroke: #A80036; stroke-width: 1.2000000476837158;" x1="813.9" x2="828.3" y1="58.6793" y2="58.6793"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="55.8" x="791.4" y="2384.9966">Transfer DAO</text><ellipse cx="821.1" cy="2396.3685" fill="#FEFECE" filter="url(#fod9jm76vvwhz)" rx="7.2" ry="7.2" style="stroke: #A80036; stroke-width: 1.2000000476837158;"/><line style="stroke: #A80036; stroke-width: 1.2000000476837158;" x1="813.9" x2="828.3" y1="2404.7685" y2="2404.7685"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="54" x="856.8" y="68.0004">Central Store</text><path d="M874.8,38.2793 C874.8,32.2793 885.6,32.2793 885.6,32.2793 C885.6,32.2793 896.4,32.2793 896.4,38.2793 L896.4,53.8793 C896.4,59.8793 885.6,59.8793 885.6,59.8793 C885.6,59.8793 874.8,59.8793 874.8,53.8793 L874.8,38.2793 " fill="#FEFECE" filter="url(#fod9jm76vvwhz)" style="stroke: #000000; stroke-width: 0.9000000357627869;"/><path d="M874.8,38.2793 C874.8,44.2793 885.6,44.2793 885.6,44.2793 C885.6,44.2793 896.4,44.2793 896.4,38.2793 " fill="none" style="stroke: #000000; stroke-width: 0.9000000357627869;"/><text fill="#000000" font-family="sans-serif" font-size="8.4" lengthAdjust="spacingAndGlyphs" textLength="54" x="856.8" y="2384.9966">Central Store</text><path d="M874.8,2392.7685 C874.8,2386.7685 885.6,2386.7685 885.6,2386.7685 C885.6,2386.7685 896.4,2386.7685 896.4,2392.7685 L896.4,2408.3685 C896.4,2414.3685 885.6,2414.3685 885.6,2414.3685 C885.6,2414.3685 874.8,2414.3685 874.8,2408.3685 L874.8,2392.7685 " fill="#FEFECE" filter="url(#fod9jm76vvwhz)" style="stroke: #000000; stroke-width: 0.9000000357627869;"/><path d="M874.8,2392.7685 C874.8,2398.7685 885.6,2398.7685 885.6,2398.7685 C885.6,2398.7685 896.4,2398.7685 896.4,2392.7685 " fill="none" style="stroke: #000000; stroke-width: 0.9000000357627869;"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="2295.7032" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="58.5" y="75.7723"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="363.9" y="2344.1028"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="72.9316" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="530.7" y="126.5449"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="301.7402" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="530.7" y="275.2219"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="72.9316" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="530.7" y="916.5246"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="301.7402" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="530.7" y="1065.2016"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="72.9316" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="530.7" y="1642.2001"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="301.7402" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="530.7" y="1781.6907"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="37.5727" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="882.6" y="144.3176"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="37.5727" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="882.6" y="307.5809"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="882.6" y="388.1262"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="882.6" y="452.8852"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="37.5727" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="882.6" y="934.2973"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="37.5727" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="882.6" y="1097.5606"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="882.6" y="1178.1059"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="882.6" y="1242.8649"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="37.5727" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="882.6" y="1659.9727"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="37.5727" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="882.6" y="1814.0497"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="882.6" y="1894.595"/><rect fill="#FFFFFF" filter="url(#fod9jm76vvwhz)" height="18" style="stroke: #A80036; stroke-width: 0.6000000238418579;" width="6" x="882.6" y="1959.354"/><path d="M7.8,79.9723 L166.8,79.9723 L166.8,84.1723 L160.8,90.1723 L7.8,90.1723 L7.8,79.9723 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="2287.3032" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="1045.8" x="7.8" y="79.9723"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="132" x="16.8" y="88.1133">Abort Position Handler Consume</text><path d="M13.8,94.5586 L54,94.5586 L54,98.7586 L48,104.7586 L13.8,104.7586 L13.8,94.5586 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="781.5797" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="1033.8" x="13.8" y="94.5586"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="13.2" x="22.8" y="102.6996">opt</text><text fill="#000000" font-family="sans-serif" font-size="6.6" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="360.6" x="63" y="102.1395">[type == 'position' &amp;&amp; action == 'timeout-received' || type == 'position' &amp;&amp; action == 'timeout-reserved']</text><polygon fill="#A80036" points="523.5,124.1449,529.5,126.5449,523.5,128.9449,525.9,126.5449" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="64.5" x2="527.1" y1="126.5449" y2="126.5449"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="68.7" y="119.4791">1</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="155.4" x="76.5" y="114.8859">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="76.5" y="124.0723">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="122.7" y="124.0723">2003</text><polygon fill="#A80036" points="875.4,141.9176,881.4,144.3176,875.4,146.7176,877.8,144.3176" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="536.7" x2="879" y1="144.3176" y2="144.3176"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="540.9" y="141.6586">2</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="155.4" x="548.7" y="141.6586">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#fod9jm76vvwhz)" points="846,152.3039,924.6,152.3039,930.6,158.9039,924.6,166.1039,846,166.1039,840,158.9039,846,152.3039" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="76.2" x="847.2" y="162.2449">transferStateChange</text><polygon fill="#A80036" points="543.3,179.4902,537.3,181.8902,543.3,184.2902,540.9,181.8902" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="539.7" x2="885" y1="181.8902" y2="181.8902"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="546.9" y="179.2313">3</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="150" x="554.7" y="179.2313">Return current state of transfer from DB</text><polygon fill="#A80036" points="71.1,197.0766,65.1,199.4766,71.1,201.8766,68.7,199.4766" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="67.5" x2="533.1" y1="199.4766" y2="199.4766"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="74.7" y="196.8176">4</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="150" x="82.5" y="196.8176">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="64.5" x2="89.7" y1="226.4356" y2="226.4356"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="89.7" x2="89.7" y1="226.4356" y2="234.2356"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="65.1" x2="89.7" y1="234.2356" y2="234.2356"/><polygon fill="#A80036" points="71.1,231.8356,65.1,234.2356,71.1,236.6356,68.7,234.2356" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="68.7" y="218.9971">5</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="272.4" x="76.5" y="214.4039">Validate current state (transferStateChange.transferStateId == 'EXPIRED')</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="76.5" y="223.5902">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="122.7" y="223.5902">2001</text><path d="M19.8,243.2356 L441,243.2356 L441,247.4356 L435,253.4356 L19.8,253.4356 L19.8,243.2356 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="338.7129" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="1021.8" x="19.8" y="243.2356"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="394.2" x="28.8" y="251.3766">Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)</text><polygon fill="#A80036" points="523.5,272.8219,529.5,275.2219,523.5,277.6219,525.9,275.2219" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="64.5" x2="527.1" y1="275.2219" y2="275.2219"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="68.7" y="268.1561">6</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="185.4" x="76.5" y="263.5629">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="76.5" y="272.7492">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="122.7" y="272.7492">2003</text><path d="M498.9,284.5945 L597.9,284.5945 L597.9,288.7945 L591.9,294.7945 L498.9,294.7945 L498.9,284.5945 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="275.5676" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="536.7" x="498.9" y="284.5945"/><text fill="#0000FF" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="507.9" y="292.7356">DB TRANSACTION</text><polygon fill="#A80036" points="875.4,305.1809,881.4,307.5809,875.4,309.9809,877.8,307.5809" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="536.7" x2="879" y1="307.5809" y2="307.5809"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="540.9" y="304.9219">7</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="237.6" x="548.7" y="304.9219">Select participantPosition.value FOR UPDATE from DB for Payee</text><polygon fill="#FFFFE0" filter="url(#fod9jm76vvwhz)" points="848.4,315.5672,922.2,315.5672,928.2,322.1672,922.2,329.3672,848.4,329.3672,842.4,322.1672,848.4,315.5672" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="71.4" x="849.6" y="325.5082">participantPosition</text><polygon fill="#A80036" points="543.3,342.7535,537.3,345.1535,543.3,347.5535,540.9,345.1535" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="539.7" x2="885" y1="345.1535" y2="345.1535"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="546.9" y="342.4945">8</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="190.2" x="554.7" y="342.4945">Return participantPosition.value from DB for Payee</text><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="536.7" x2="561.9" y1="362.9262" y2="362.9262"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="561.9" x2="561.9" y1="362.9262" y2="370.7262"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="537.3" x2="561.9" y1="370.7262" y2="370.7262"/><polygon fill="#A80036" points="543.3,368.3262,537.3,370.7262,543.3,373.1262,540.9,370.7262" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="5.4" x="540.9" y="360.0809">9</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="54" x="548.7" y="360.0809">latestPosition</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="203.4" x="605.1" y="360.0809">= participantPosition.value - payload.amount.amount</text><polygon fill="#A80036" points="875.4,385.7262,881.4,388.1262,875.4,390.5262,877.8,388.1262" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="536.7" x2="879" y1="388.1262" y2="388.1262"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="540.9" y="385.4672">10</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="138.6" x="554.1" y="385.4672">Persist latestPosition to DB for Payee</text><polygon fill="#FFFFE0" filter="url(#fod9jm76vvwhz)" points="829.8,414.1125,940.8,414.1125,946.8,425.5125,940.8,436.9125,829.8,436.9125,823.8,425.5125,829.8,414.1125" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="30" x="831" y="424.0535">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76.2" x="863.4" y="424.0535">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="97.8" x="831" y="433.2399">SET value = latestPosition</text><polygon fill="#A80036" points="875.4,450.4852,881.4,452.8852,875.4,455.2852,877.8,452.8852" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="536.7" x2="879" y1="452.8852" y2="452.8852"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="540.9" y="450.2262">11</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="200.4" x="554.1" y="450.2262">Persist transfer state and participant position change</text><polygon fill="#FFFFE0" filter="url(#fod9jm76vvwhz)" points="747,478.8715,1023.6,478.8715,1029.6,517.8715,1023.6,556.8715,747,556.8715,741,517.8715,747,478.8715" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="26.4" x="748.2" y="488.8125">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="83.4" x="777" y="488.8125">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="105" x="862.8" y="488.8125">transferStateId = 'ABORTED'</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="0" x="750.6" y="497.9988"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="26.4" x="748.2" y="507.1852">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="107.4" x="777" y="507.1852">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="274.2" x="748.2" y="516.3715">SET transferStateChangeId = transferStateChange.transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="244.2" x="748.2" y="525.5578">participantPositionId = participantPosition.participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="84.6" x="748.2" y="534.7442">value = latestPosition,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="189" x="748.2" y="543.9305">reservedValue = participantPosition.reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="95.4" x="748.2" y="553.1168">createdDate = new Date()</text><polygon fill="#A80036" points="71.1,574.5621,65.1,576.9621,71.1,579.3621,68.7,576.9621" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="67.5" x2="533.1" y1="576.9621" y2="576.9621"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="74.7" y="574.3031">12</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="57" x="87.9" y="574.3031">Return success</text><path d="M67.2,589.1485 L67.2,870.5485 L315.6,870.5485 L315.6,595.1485 L309.6,589.1485 L67.2,589.1485 " fill="#FFFF00" filter="url(#fod9jm76vvwhz)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M309.6,589.1485 L309.6,595.1485 L315.6,595.1485 L309.6,589.1485 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="39.6" x="70.8" y="599.6895">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="124.8" x="80.4" y="608.8758">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="135" x="80.4" y="618.0621">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="126" x="80.4" y="627.2485">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="83.4" x="80.4" y="636.4348">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="36" x="80.4" y="645.6211">content: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="108.6" x="90" y="654.8074">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="36.6" x="90" y="663.9938">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="75.6" x="102" y="673.1801">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="69.6" x="111.6" y="682.3664">"errorCode": 4001,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="195" x="111.6" y="691.5528">"errorDescription": "Payer FSP insufficient liquidity",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="189" x="111.6" y="700.7391">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="102" y="709.9254">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="92.4" y="719.1117">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="4.8" x="80.4" y="728.2981">},</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="42" x="80.4" y="737.4844">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="27.6" x="90" y="746.6707">event: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="43.2" x="99.6" y="755.8571">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="114.6" x="99.6" y="765.0434">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="52.8" x="99.6" y="774.2297">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="50.4" x="99.6" y="783.416">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="95.4" x="99.6" y="792.6024">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="25.8" x="99.6" y="801.7887">state: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="52.2" x="109.2" y="810.975">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="136.8" x="109.2" y="820.1614">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="186" x="109.2" y="829.3477">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="99.6" y="838.534">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="90" y="847.7203">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="80.4" y="856.9067">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="70.8" y="866.093">}</text><path d="M13.8,884.5383 L54,884.5383 L54,888.7383 L48,894.7383 L13.8,894.7383 L13.8,884.5383 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="717.2754" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="1033.8" x="13.8" y="884.5383"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="13.2" x="22.8" y="892.6793">opt</text><text fill="#000000" font-family="sans-serif" font-size="6.6" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="138" x="63" y="892.1192">[type == 'position' &amp;&amp; action == 'reject']</text><polygon fill="#A80036" points="523.5,914.1246,529.5,916.5246,523.5,918.9246,525.9,916.5246" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="64.5" x2="527.1" y1="916.5246" y2="916.5246"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="68.7" y="909.4588">13</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="155.4" x="81.9" y="904.8657">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="81.9" y="914.052">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="128.1" y="914.052">2003</text><polygon fill="#A80036" points="875.4,931.8973,881.4,934.2973,875.4,936.6973,877.8,934.2973" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="536.7" x2="879" y1="934.2973" y2="934.2973"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="540.9" y="931.6383">14</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="155.4" x="554.1" y="931.6383">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#fod9jm76vvwhz)" points="846,942.2836,924.6,942.2836,930.6,948.8836,924.6,956.0836,846,956.0836,840,948.8836,846,942.2836" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="76.2" x="847.2" y="952.2246">transferStateChange</text><polygon fill="#A80036" points="543.3,969.47,537.3,971.87,543.3,974.27,540.9,971.87" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="539.7" x2="885" y1="971.87" y2="971.87"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="546.9" y="969.211">15</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="150" x="560.1" y="969.211">Return current state of transfer from DB</text><polygon fill="#A80036" points="71.1,987.0563,65.1,989.4563,71.1,991.8563,68.7,989.4563" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="67.5" x2="533.1" y1="989.4563" y2="989.4563"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="74.7" y="986.7973">16</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="150" x="87.9" y="986.7973">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="64.5" x2="89.7" y1="1016.4153" y2="1016.4153"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="89.7" x2="89.7" y1="1016.4153" y2="1024.2153"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="65.1" x2="89.7" y1="1024.2153" y2="1024.2153"/><polygon fill="#A80036" points="71.1,1021.8153,65.1,1024.2153,71.1,1026.6153,68.7,1024.2153" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="68.7" y="1008.9768">17</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="277.8" x="81.9" y="1004.3836">Validate current state (transferStateChange.transferStateId == 'REJECTED')</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="81.9" y="1013.57">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="128.1" y="1013.57">2001</text><path d="M19.8,1033.2153 L441,1033.2153 L441,1037.4153 L435,1043.4153 L19.8,1043.4153 L19.8,1033.2153 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="338.7129" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="1021.8" x="19.8" y="1033.2153"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="394.2" x="28.8" y="1041.3563">Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)</text><polygon fill="#A80036" points="523.5,1062.8016,529.5,1065.2016,523.5,1067.6016,525.9,1065.2016" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="64.5" x2="527.1" y1="1065.2016" y2="1065.2016"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="68.7" y="1058.1358">18</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="185.4" x="81.9" y="1053.5426">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="81.9" y="1062.7289">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="128.1" y="1062.7289">2003</text><path d="M498.9,1074.5743 L597.9,1074.5743 L597.9,1078.7743 L591.9,1084.7743 L498.9,1084.7743 L498.9,1074.5743 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="275.5676" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="536.7" x="498.9" y="1074.5743"/><text fill="#0000FF" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="507.9" y="1082.7153">DB TRANSACTION</text><polygon fill="#A80036" points="875.4,1095.1606,881.4,1097.5606,875.4,1099.9606,877.8,1097.5606" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="536.7" x2="879" y1="1097.5606" y2="1097.5606"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="540.9" y="1094.9016">19</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="237.6" x="554.1" y="1094.9016">Select participantPosition.value FOR UPDATE from DB for Payee</text><polygon fill="#FFFFE0" filter="url(#fod9jm76vvwhz)" points="848.4,1105.5469,922.2,1105.5469,928.2,1112.1469,922.2,1119.3469,848.4,1119.3469,842.4,1112.1469,848.4,1105.5469" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="71.4" x="849.6" y="1115.4879">participantPosition</text><polygon fill="#A80036" points="543.3,1132.7332,537.3,1135.1332,543.3,1137.5332,540.9,1135.1332" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="539.7" x2="885" y1="1135.1332" y2="1135.1332"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="546.9" y="1132.4743">20</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="190.2" x="560.1" y="1132.4743">Return participantPosition.value from DB for Payee</text><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="536.7" x2="561.9" y1="1152.9059" y2="1152.9059"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="561.9" x2="561.9" y1="1152.9059" y2="1160.7059"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="537.3" x2="561.9" y1="1160.7059" y2="1160.7059"/><polygon fill="#A80036" points="543.3,1158.3059,537.3,1160.7059,543.3,1163.1059,540.9,1160.7059" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="540.9" y="1150.0606">21</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="54" x="554.1" y="1150.0606">latestPosition</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="203.4" x="610.5" y="1150.0606">= participantPosition.value - payload.amount.amount</text><polygon fill="#A80036" points="875.4,1175.7059,881.4,1178.1059,875.4,1180.5059,877.8,1178.1059" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="536.7" x2="879" y1="1178.1059" y2="1178.1059"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="540.9" y="1175.4469">22</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="138.6" x="554.1" y="1175.4469">Persist latestPosition to DB for Payee</text><polygon fill="#FFFFE0" filter="url(#fod9jm76vvwhz)" points="829.8,1204.0922,940.8,1204.0922,946.8,1215.4922,940.8,1226.8922,829.8,1226.8922,823.8,1215.4922,829.8,1204.0922" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="30" x="831" y="1214.0333">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76.2" x="863.4" y="1214.0333">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="97.8" x="831" y="1223.2196">SET value = latestPosition</text><polygon fill="#A80036" points="875.4,1240.4649,881.4,1242.8649,875.4,1245.2649,877.8,1242.8649" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="536.7" x2="879" y1="1242.8649" y2="1242.8649"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="540.9" y="1240.2059">23</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="200.4" x="554.1" y="1240.2059">Persist transfer state and participant position change</text><polygon fill="#FFFFE0" filter="url(#fod9jm76vvwhz)" points="747,1268.8512,1023.6,1268.8512,1029.6,1307.8512,1023.6,1346.8512,747,1346.8512,741,1307.8512,747,1268.8512" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="26.4" x="748.2" y="1278.7922">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="83.4" x="777" y="1278.7922">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="105" x="862.8" y="1278.7922">transferStateId = 'ABORTED'</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="0" x="750.6" y="1287.9786"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="26.4" x="748.2" y="1297.1649">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="107.4" x="777" y="1297.1649">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="274.2" x="748.2" y="1306.3512">SET transferStateChangeId = transferStateChange.transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="244.2" x="748.2" y="1315.5376">participantPositionId = participantPosition.participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="84.6" x="748.2" y="1324.7239">value = latestPosition,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="189" x="748.2" y="1333.9102">reservedValue = participantPosition.reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="95.4" x="748.2" y="1343.0965">createdDate = new Date()</text><polygon fill="#A80036" points="71.1,1364.5419,65.1,1366.9419,71.1,1369.3419,68.7,1366.9419" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="67.5" x2="533.1" y1="1366.9419" y2="1366.9419"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="74.7" y="1364.2829">24</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="57" x="87.9" y="1364.2829">Return success</text><path d="M67.2,1379.1282 L67.2,1596.3282 L224.4,1596.3282 L224.4,1385.1282 L218.4,1379.1282 L67.2,1379.1282 " fill="#FFFF00" filter="url(#fod9jm76vvwhz)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M218.4,1379.1282 L218.4,1385.1282 L224.4,1385.1282 L218.4,1379.1282 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="39.6" x="70.8" y="1389.6692">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="124.8" x="80.4" y="1398.8555">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="135" x="80.4" y="1408.0419">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="126" x="80.4" y="1417.2282">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="83.4" x="80.4" y="1426.4145">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="36" x="80.4" y="1435.6008">content: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="108.6" x="90" y="1444.7872">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="108" x="90" y="1453.9735">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="4.8" x="80.4" y="1463.1598">},</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="42" x="80.4" y="1472.3462">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="27.6" x="90" y="1481.5325">event: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="43.2" x="99.6" y="1490.7188">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="114.6" x="99.6" y="1499.9051">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="52.8" x="99.6" y="1509.0915">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="50.4" x="99.6" y="1518.2778">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="95.4" x="99.6" y="1527.4641">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="25.8" x="99.6" y="1536.6505">state: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="66.6" x="109.2" y="1545.8368">status: "rejected",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="27.6" x="109.2" y="1555.0231">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="99.6" y="1564.2094">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="90" y="1573.3958">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="80.4" y="1582.5821">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="70.8" y="1591.7684">}</text><path d="M13.8,1610.2137 L54,1610.2137 L54,1614.4137 L48,1620.4137 L13.8,1620.4137 L13.8,1610.2137 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="708.0891" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="1033.8" x="13.8" y="1610.2137"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="13.2" x="22.8" y="1618.3548">opt</text><text fill="#000000" font-family="sans-serif" font-size="6.6" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="280.8" x="63" y="1617.7946">[type == 'position' &amp;&amp; action == 'failed' (Unable to currently trigger this scenario)]</text><polygon fill="#A80036" points="523.5,1639.8001,529.5,1642.2001,523.5,1644.6001,525.9,1642.2001" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="64.5" x2="527.1" y1="1642.2001" y2="1642.2001"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="68.7" y="1635.1342">25</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="155.4" x="81.9" y="1630.5411">Request current state of transfer from DB</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="81.9" y="1639.7274">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="128.1" y="1639.7274">2003</text><polygon fill="#A80036" points="875.4,1657.5727,881.4,1659.9727,875.4,1662.3727,877.8,1659.9727" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="536.7" x2="879" y1="1659.9727" y2="1659.9727"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="540.9" y="1657.3137">26</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="155.4" x="554.1" y="1657.3137">Retrieve current state of transfer from DB</text><polygon fill="#FFFFE0" filter="url(#fod9jm76vvwhz)" points="846,1667.9591,924.6,1667.9591,930.6,1674.5591,924.6,1681.7591,846,1681.7591,840,1674.5591,846,1667.9591" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="76.2" x="847.2" y="1677.9001">transferStateChange</text><polygon fill="#A80036" points="543.3,1695.1454,537.3,1697.5454,543.3,1699.9454,540.9,1697.5454" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="539.7" x2="885" y1="1697.5454" y2="1697.5454"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="546.9" y="1694.8864">27</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="150" x="560.1" y="1694.8864">Return current state of transfer from DB</text><polygon fill="#A80036" points="71.1,1712.7317,65.1,1715.1317,71.1,1717.5317,68.7,1715.1317" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="67.5" x2="533.1" y1="1715.1317" y2="1715.1317"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="74.7" y="1712.4727">28</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="150" x="87.9" y="1712.4727">Return current state of transfer from DB</text><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="64.5" x2="89.7" y1="1732.9044" y2="1732.9044"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="89.7" x2="89.7" y1="1732.9044" y2="1740.7044"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="65.1" x2="89.7" y1="1740.7044" y2="1740.7044"/><polygon fill="#A80036" points="71.1,1738.3044,65.1,1740.7044,71.1,1743.1044,68.7,1740.7044" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="68.7" y="1730.0591">29</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="268.2" x="81.9" y="1730.0591">Validate current state (transferStateChange.transferStateId == 'FAILED')</text><path d="M19.8,1749.7044 L441,1749.7044 L441,1753.9044 L435,1759.9044 L19.8,1759.9044 L19.8,1749.7044 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="338.7129" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="1021.8" x="19.8" y="1749.7044"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="394.2" x="28.8" y="1757.8454">Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)</text><polygon fill="#A80036" points="523.5,1779.2907,529.5,1781.6907,523.5,1784.0907,525.9,1781.6907" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="64.5" x2="527.1" y1="1781.6907" y2="1781.6907"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="68.7" y="1774.6249">30</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="185.4" x="81.9" y="1770.0317">Request to persist latest position and state to DB</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="81.9" y="1779.218">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="128.1" y="1779.218">2003</text><path d="M498.9,1791.0634 L597.9,1791.0634 L597.9,1795.2634 L591.9,1801.2634 L498.9,1801.2634 L498.9,1791.0634 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 0.6000000238418579;"/><rect fill="none" height="275.5676" style="stroke: #000000; stroke-width: 1.2000000476837158;" width="536.7" x="498.9" y="1791.0634"/><text fill="#0000FF" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="507.9" y="1799.2044">DB TRANSACTION</text><polygon fill="#A80036" points="875.4,1811.6497,881.4,1814.0497,875.4,1816.4497,877.8,1814.0497" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="536.7" x2="879" y1="1814.0497" y2="1814.0497"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="540.9" y="1811.3907">31</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="237.6" x="554.1" y="1811.3907">Select participantPosition.value FOR UPDATE from DB for Payee</text><polygon fill="#FFFFE0" filter="url(#fod9jm76vvwhz)" points="848.4,1822.036,922.2,1822.036,928.2,1828.636,922.2,1835.836,848.4,1835.836,842.4,1828.636,848.4,1822.036" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="71.4" x="849.6" y="1831.977">participantPosition</text><polygon fill="#A80036" points="543.3,1849.2223,537.3,1851.6223,543.3,1854.0223,540.9,1851.6223" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="539.7" x2="885" y1="1851.6223" y2="1851.6223"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="546.9" y="1848.9634">32</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="190.2" x="560.1" y="1848.9634">Return participantPosition.value from DB for Payee</text><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="536.7" x2="561.9" y1="1869.395" y2="1869.395"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="561.9" x2="561.9" y1="1869.395" y2="1877.195"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="537.3" x2="561.9" y1="1877.195" y2="1877.195"/><polygon fill="#A80036" points="543.3,1874.795,537.3,1877.195,543.3,1879.595,540.9,1877.195" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="540.9" y="1866.5497">33</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="54" x="554.1" y="1866.5497">latestPosition</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="203.4" x="610.5" y="1866.5497">= participantPosition.value - payload.amount.amount</text><polygon fill="#A80036" points="875.4,1892.195,881.4,1894.595,875.4,1896.995,877.8,1894.595" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="536.7" x2="879" y1="1894.595" y2="1894.595"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="540.9" y="1891.936">34</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="138.6" x="554.1" y="1891.936">Persist latestPosition to DB for Payee</text><polygon fill="#FFFFE0" filter="url(#fod9jm76vvwhz)" points="829.8,1920.5813,940.8,1920.5813,946.8,1931.9813,940.8,1943.3813,829.8,1943.3813,823.8,1931.9813,829.8,1920.5813" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="30" x="831" y="1930.5223">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="76.2" x="863.4" y="1930.5223">participantPosition</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="97.8" x="831" y="1939.7087">SET value = latestPosition</text><polygon fill="#A80036" points="875.4,1956.954,881.4,1959.354,875.4,1961.754,877.8,1959.354" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="536.7" x2="879" y1="1959.354" y2="1959.354"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="540.9" y="1956.695">35</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="200.4" x="554.1" y="1956.695">Persist transfer state and participant position change</text><polygon fill="#FFFFE0" filter="url(#fod9jm76vvwhz)" points="747,1985.3403,1023.6,1985.3403,1029.6,2024.3403,1023.6,2063.3403,747,2063.3403,741,2024.3403,747,1985.3403" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="26.4" x="748.2" y="1995.2813">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="83.4" x="777" y="1995.2813">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="105" x="862.8" y="1995.2813">transferStateId = 'ABORTED'</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="0" x="750.6" y="2004.4677"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="26.4" x="748.2" y="2013.654">INSERT</text><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="107.4" x="777" y="2013.654">participantPositionChange</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="274.2" x="748.2" y="2022.8403">SET transferStateChangeId = transferStateChange.transferStateChangeId,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="244.2" x="748.2" y="2032.0266">participantPositionId = participantPosition.participantPositionId,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="84.6" x="748.2" y="2041.213">value = latestPosition,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="189" x="748.2" y="2050.3993">reservedValue = participantPosition.reservedValue</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="95.4" x="748.2" y="2059.5856">createdDate = new Date()</text><polygon fill="#A80036" points="71.1,2081.0309,65.1,2083.4309,71.1,2085.8309,68.7,2083.4309" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579; stroke-dasharray: 2.0,2.0;" x1="67.5" x2="533.1" y1="2083.4309" y2="2083.4309"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="74.7" y="2080.772">36</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="57" x="87.9" y="2080.772">Return success</text><path d="M67.2,2095.6173 L67.2,2312.8173 L224.4,2312.8173 L224.4,2101.6173 L218.4,2095.6173 L67.2,2095.6173 " fill="#FFFF00" filter="url(#fod9jm76vvwhz)" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><path d="M218.4,2095.6173 L218.4,2101.6173 L224.4,2101.6173 L218.4,2095.6173 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="39.6" x="70.8" y="2106.1583">Message: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="124.8" x="80.4" y="2115.3446">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="135" x="80.4" y="2124.5309">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="126" x="80.4" y="2133.7173">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="83.4" x="80.4" y="2142.9036">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="36" x="80.4" y="2152.0899">content: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="108.6" x="90" y="2161.2763">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="108" x="90" y="2170.4626">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="4.8" x="80.4" y="2179.6489">},</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="42" x="80.4" y="2188.8352">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="27.6" x="90" y="2198.0216">event: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="43.2" x="99.6" y="2207.2079">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="114.6" x="99.6" y="2216.3942">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="52.8" x="99.6" y="2225.5806">type: transfer,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="50.4" x="99.6" y="2234.7669">action: abort,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="95.4" x="99.6" y="2243.9532">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="25.8" x="99.6" y="2253.1395">state: {</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="66.6" x="109.2" y="2262.3259">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="27.6" x="109.2" y="2271.5122">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="99.6" y="2280.6985">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="90" y="2289.8849">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="80.4" y="2299.0712">}</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="2.4" x="70.8" y="2308.2575">}</text><polygon fill="#A80036" points="356.7,2341.7028,362.7,2344.1028,356.7,2346.5028,359.1,2344.1028" style="stroke: #A80036; stroke-width: 0.6000000238418579;"/><line style="stroke: #A80036; stroke-width: 0.6000000238418579;" x1="64.5" x2="360.3" y1="2344.1028" y2="2344.1028"/><text fill="#000000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="10.8" x="68.7" y="2337.037">37</text><text fill="#000000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="84" x="81.9" y="2332.4438">Publish Transfer event</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="43.8" x="81.9" y="2341.6302">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="7.8" lengthAdjust="spacingAndGlyphs" textLength="19.2" x="128.1" y="2341.6302">2003</text><!--
@startuml
title 1.3.3 Abort Position Handler Consume

autonumber


control "Position Handler" as POS_HANDLER
collections "Transfer-Topic" as TOPIC_TRANSFERS
entity "Position DAO" as POS_DAO
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Transfer DAO" as TRANS_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant POS_HANDLER
    participant TOPIC_TRANSFERS
    participant TOPIC_NOTIFICATIONS
    participant POS_DAO
    participant TRANS_DAO
    participant DB
end box

activate POS_HANDLER
group Abort Position Handler Consume
    opt type == 'position' && action == 'timeout-received' || type == 'position' && action == 'timeout-reserved'
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'EXPIRED')\n<color #FF0000><b>Error code:</b> 2001</color>

        group Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group <color #blue>DB TRANSACTION</color>
                activate POS_DAO
                POS_DAO -> DB: Select participantPosition.value FOR UPDATE from DB for Payee
                activate DB
                hnote over DB #lightyellow
                    participantPosition
                end note
                DB - -> POS_DAO: Return participantPosition.value from DB for Payee
                deactivate DB
                POS_DAO <-> POS_DAO: **latestPosition** = participantPosition.value - payload.amount.amount
                POS_DAO->DB: Persist latestPosition to DB for Payee
                hnote over DB #lightyellow
                    UPDATE **participantPosition**
                    SET value = latestPosition
                end note
                activate DB
                deactivate DB
                POS_DAO -> DB: Persist transfer state and participant position change
                hnote over DB #lightyellow
                        INSERT **transferStateChange** transferStateId = 'ABORTED'

                        INSERT **participantPositionChange**
                        SET transferStateChangeId = transferStateChange.transferStateChangeId,
                        participantPositionId = participantPosition.participantPositionId,
                        value = latestPosition,
                        reservedValue = participantPosition.reservedValue
                        createdDate = new Date()
                end note
                activate DB
                deactivate DB
                deactivate TRANS_DAO
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        note right of POS_HANDLER #yellow
            Message: {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                         "errorInformation": {
                             "errorCode": 4001,
                             "errorDescription": "Payer FSP insufficient liquidity",
                             "extensionList": <transferMessage.extensionList>
                         }
                     }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: abort,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
    end
    opt type == 'position' && action == 'reject'
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'REJECTED')\n<color #FF0000><b>Error code:</b> 2001</color>

        group Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group <color #blue>DB TRANSACTION</color>
                activate POS_DAO
                POS_DAO -> DB: Select participantPosition.value FOR UPDATE from DB for Payee
                activate DB
                hnote over DB #lightyellow
                    participantPosition
                end note
                DB - -> POS_DAO: Return participantPosition.value from DB for Payee
                deactivate DB
                POS_DAO <-> POS_DAO: **latestPosition** = participantPosition.value - payload.amount.amount
                POS_DAO->DB: Persist latestPosition to DB for Payee
                hnote over DB #lightyellow
                    UPDATE **participantPosition**
                    SET value = latestPosition
                end note
                activate DB
                deactivate DB
                POS_DAO -> DB: Persist transfer state and participant position change
                hnote over DB #lightyellow
                        INSERT **transferStateChange** transferStateId = 'ABORTED'

                        INSERT **participantPositionChange**
                        SET transferStateChangeId = transferStateChange.transferStateChangeId,
                        participantPositionId = participantPosition.participantPositionId,
                        value = latestPosition,
                        reservedValue = participantPosition.reservedValue
                        createdDate = new Date()
                end note
                activate DB
                deactivate DB
                deactivate TRANS_DAO
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        note right of POS_HANDLER #yellow
            Message: {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: abort,
                        createdAt: <timestamp>,
                        state: {
                            status: "rejected",
                            code: 0
                        }
                    }
                }
            }
        end note
    end
    opt type == 'position' && action == 'failed' (Unable to currently trigger this scenario)
        POS_HANDLER -> POS_DAO: Request current state of transfer from DB\n<color #FF0000><b>Error code:</b> 2003</color>
        activate POS_DAO
        POS_DAO -> DB: Retrieve current state of transfer from DB
        activate DB
        hnote over DB #lightyellow
            transferStateChange
        end note
        DB - -> POS_DAO: Return current state of transfer from DB
        deactivate DB
        POS_DAO - -> POS_HANDLER: Return current state of transfer from DB
        deactivate POS_DAO
        POS_HANDLER <-> POS_HANDLER: Validate current state (transferStateChange.transferStateId == 'FAILED')

        group Persist Position change and Transfer State (with transferState='ABORTED' on position check pass)
            POS_HANDLER -> POS_DAO: Request to persist latest position and state to DB\n<color #FF0000><b>Error code:</b> 2003</color>
            group <color #blue>DB TRANSACTION</color>
                activate POS_DAO
                POS_DAO -> DB: Select participantPosition.value FOR UPDATE from DB for Payee
                activate DB
                hnote over DB #lightyellow
                    participantPosition
                end note
                DB - -> POS_DAO: Return participantPosition.value from DB for Payee
                deactivate DB
                POS_DAO <-> POS_DAO: **latestPosition** = participantPosition.value - payload.amount.amount
                POS_DAO->DB: Persist latestPosition to DB for Payee
                hnote over DB #lightyellow
                    UPDATE **participantPosition**
                    SET value = latestPosition
                end note
                activate DB
                deactivate DB
                POS_DAO -> DB: Persist transfer state and participant position change
                hnote over DB #lightyellow
                        INSERT **transferStateChange** transferStateId = 'ABORTED'

                        INSERT **participantPositionChange**
                        SET transferStateChangeId = transferStateChange.transferStateChangeId,
                        participantPositionId = participantPosition.participantPositionId,
                        value = latestPosition,
                        reservedValue = participantPosition.reservedValue
                        createdDate = new Date()
                end note
                activate DB
                deactivate DB
                deactivate TRANS_DAO
            end
            POS_DAO - -> POS_HANDLER: Return success
            deactivate POS_DAO
        end
        note right of POS_HANDLER #yellow
            Message: {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: transfer,
                        action: abort,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
    end
    POS_HANDLER -> TOPIC_TRANSFERS: Publish Transfer event\n<color #FF0000><b>Error code:</b> 2003</color>
    activate TOPIC_TRANSFERS
    deactivate TOPIC_TRANSFERS
end
deactivate POS_HANDLER
@enduml

PlantUML version 1.2018.01(Sun Jan 28 20:08:22 SAST 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_152-release-1136-b20
Operating System: Mac OS X
OS Version: 10.13.5
Default Encoding: UTF-8
Language: en
Country: ZA
--></g></svg>