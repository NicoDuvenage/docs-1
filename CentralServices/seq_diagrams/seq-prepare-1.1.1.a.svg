<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3638px" preserveAspectRatio="none" style="width:2010px;height:3638px;" version="1.1" viewBox="0 0 2010 3638" width="2010px" zoomAndPan="magnify"><defs><filter height="300%" id="fojyao4uqjpy4" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="366" x="823" y="23.5352">1.1.1.a. Prepare Handler Consume (single message)</text><rect fill="#FFFFE0" height="3593.25" style="stroke: #A80036; stroke-width: 1.0;" width="1906" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="921.5" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="102" y="171.9082"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="3425.9629" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="409" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1053" y="2927.3574"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1336.5" y="3500.25"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1469.5" y="933.9141"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1469.5" y="1108.7773"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1469.5" y="1497.7246"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="183.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1469.5" y="2301.1094"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1586" y="1687.2773"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1586" y="1942.0723"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1868" y="963.2246"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1868" y="1138.0879"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1868" y="1527.0352"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1868" y="1716.5879"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1868" y="1971.3828"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1868" y="2330.4199"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="3411.9629" style="stroke: #000000; stroke-width: 2.0;" width="1986" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="539" x="315" y="216.9082"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="519" x="325" y="241.2188"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="943" x="325" y="337.1504"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="1700.1641" style="stroke: #000000; stroke-width: 2.0;" width="1694" x="295" y="508.7031"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="947.0898" style="stroke: #000000; stroke-width: 2.0;" width="1674" x="305" y="687.5664"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="557.5" style="stroke: #000000; stroke-width: 2.0;" width="1654" x="315" y="1070.1563"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="90.2422" style="stroke: #000000; stroke-width: 2.0;" width="733" x="325" y="1260.3301"/><rect fill="#FFFFFF" height="88.5762" style="stroke: none; stroke-width: 1.0;" width="1654" x="315" y="1357.5723"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="244" x="325" y="1379.5273"/><rect fill="#FFFFFF" height="181.5078" style="stroke: none; stroke-width: 1.0;" width="1654" x="315" y="1446.1484"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1632" x="325" y="1648.6563"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1632" x="325" y="1903.4512"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="1315.3828" style="stroke: #000000; stroke-width: 2.0;" width="1653" x="315" y="2222.8672"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1633" x="325" y="2247.1777"/><rect fill="#FFFFFF" height="572.8926" style="stroke: none; stroke-width: 1.0;" width="1653" x="315" y="2965.3574"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="107" x2="107" y1="116.2871" y2="3562.25"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="414" x2="414" y1="116.2871" y2="3562.25"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1058" x2="1058" y1="116.2871" y2="3562.25"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1205" x2="1205" y1="116.2871" y2="3562.25"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1341" x2="1341" y1="116.2871" y2="3562.25"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1474" x2="1474" y1="116.2871" y2="3562.25"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1591" x2="1591" y1="116.2871" y2="3562.25"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1873" x2="1873" y1="116.2871" y2="3562.25"/><rect fill="#FEFECE" filter="url(#fojyao4uqjpy4)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="27" y="76.7988"/><rect fill="#FEFECE" filter="url(#fojyao4uqjpy4)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="23" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="146" x="30" y="101.334">Prepare-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#fojyao4uqjpy4)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="27" y="3561.25"/><rect fill="#FEFECE" filter="url(#fojyao4uqjpy4)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="23" y="3565.25"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="146" x="30" y="3585.7852">Prepare-Topic-dfsp1</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="335" y="113.334">Prepare Event Handler</text><ellipse cx="414" cy="83.7988" fill="#FEFECE" filter="url(#fojyao4uqjpy4)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="410,71.7988,416,66.7988,414,71.7988,416,76.7988,410,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="335" y="3574.7852">Prepare Event Handler</text><ellipse cx="414" cy="3593.7383" fill="#FEFECE" filter="url(#fojyao4uqjpy4)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="410,3581.7383,416,3576.7383,414,3581.7383,416,3586.7383,410,3581.7383" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fojyao4uqjpy4)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="977" y="76.7988"/><rect fill="#FEFECE" filter="url(#fojyao4uqjpy4)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="973" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="980" y="101.334">Position-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#fojyao4uqjpy4)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="977" y="3561.25"/><rect fill="#FEFECE" filter="url(#fojyao4uqjpy4)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="973" y="3565.25"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="980" y="3585.7852">Position-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#fojyao4uqjpy4)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1157" y="76.7988"/><rect fill="#FEFECE" filter="url(#fojyao4uqjpy4)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1153" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1160" y="101.334">Event-Topic</text><rect fill="#FEFECE" filter="url(#fojyao4uqjpy4)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1157" y="3561.25"/><rect fill="#FEFECE" filter="url(#fojyao4uqjpy4)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1153" y="3565.25"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1160" y="3585.7852">Event-Topic</text><rect fill="#FEFECE" filter="url(#fojyao4uqjpy4)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1272" y="76.7988"/><rect fill="#FEFECE" filter="url(#fojyao4uqjpy4)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1268" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1275" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#fojyao4uqjpy4)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1272" y="3561.25"/><rect fill="#FEFECE" filter="url(#fojyao4uqjpy4)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1268" y="3565.25"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1275" y="3585.7852">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1425" y="113.334">Transfer DAO</text><ellipse cx="1474.5" cy="83.7988" fill="#FEFECE" filter="url(#fojyao4uqjpy4)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1462.5" x2="1486.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1425" y="3574.7852">Transfer DAO</text><ellipse cx="1474.5" cy="3593.7383" fill="#FEFECE" filter="url(#fojyao4uqjpy4)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1462.5" x2="1486.5" y1="3607.7383" y2="3607.7383"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1534" y="113.334">Participant DAO</text><ellipse cx="1591" cy="83.7988" fill="#FEFECE" filter="url(#fojyao4uqjpy4)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1579" x2="1603" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1534" y="3574.7852">Participant DAO</text><ellipse cx="1591" cy="3593.7383" fill="#FEFECE" filter="url(#fojyao4uqjpy4)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1579" x2="1603" y1="3607.7383" y2="3607.7383"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1825" y="113.334">Central Store</text><path d="M1855,63.7988 C1855,53.7988 1873,53.7988 1873,53.7988 C1873,53.7988 1891,53.7988 1891,63.7988 L1891,89.7988 C1891,99.7988 1873,99.7988 1873,99.7988 C1873,99.7988 1855,99.7988 1855,89.7988 L1855,63.7988 " fill="#FEFECE" filter="url(#fojyao4uqjpy4)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1855,63.7988 C1855,73.7988 1873,73.7988 1873,73.7988 C1873,73.7988 1891,73.7988 1891,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1825" y="3574.7852">Central Store</text><path d="M1855,3587.7383 C1855,3577.7383 1873,3577.7383 1873,3577.7383 C1873,3577.7383 1891,3577.7383 1891,3587.7383 L1891,3613.7383 C1891,3623.7383 1873,3623.7383 1873,3623.7383 C1873,3623.7383 1855,3623.7383 1855,3613.7383 L1855,3587.7383 " fill="#FEFECE" filter="url(#fojyao4uqjpy4)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1855,3587.7383 C1855,3597.7383 1873,3597.7383 1873,3597.7383 C1873,3597.7383 1891,3597.7383 1891,3587.7383 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="102" y="171.9082"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="3425.9629" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="409" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1053" y="2927.3574"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1336.5" y="3500.25"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1469.5" y="933.9141"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1469.5" y="1108.7773"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1469.5" y="1497.7246"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="183.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1469.5" y="2301.1094"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1586" y="1687.2773"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1586" y="1942.0723"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1868" y="963.2246"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1868" y="1138.0879"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1868" y="1527.0352"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1868" y="1716.5879"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1868" y="1971.3828"/><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1868" y="2330.4199"/><path d="M13,133.2871 L236,133.2871 L236,140.2871 L226,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3411.9629" style="stroke: #000000; stroke-width: 2.0;" width="1986" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="28" y="146.8555">Prepare Handler Consume</text><polygon fill="#A80036" points="123,167.9082,113,171.9082,123,175.9082,119,171.9082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="117" x2="408" y1="171.9082" y2="171.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="129" y="167.166">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="142" y="167.166">Consume Prepare event message for Payer</text><path d="M315,216.9082 L399,216.9082 L399,223.9082 L389,233.9082 L315,233.9082 L315,216.9082 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="539" x="315" y="216.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="330" y="230.4766">break</text><path d="M325,241.2188 L467,241.2188 L467,248.2188 L457,258.2188 L325,258.2188 L325,241.2188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="519" x="325" y="241.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="340" y="254.7871">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="295.1504" y2="295.1504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="295.1504" y2="308.1504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="308.1504" y2="308.1504"/><polygon fill="#A80036" points="430,304.1504,420,308.1504,430,312.1504,426,308.1504" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="426" y="282.7529">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="393" x="439" y="275.0977">Validate event - Rule: type == 'prepare' &amp;&amp; action == 'prepare'</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="439" y="290.4082">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="523" y="290.4082">2001</text><path d="M325,337.1504 L540,337.1504 L540,344.1504 L530,354.1504 L325,354.1504 L325,337.1504 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="943" x="325" y="337.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="340" y="350.7188">Persist Event Information</text><polygon fill="#A80036" points="1193.5,396.7715,1203.5,400.7715,1193.5,404.7715,1197.5,400.7715" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1199.5" y1="400.7715" y2="400.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="426" y="396.0293">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="439" y="396.0293">Publish event information</text><rect fill="#FFFFFF" filter="url(#fojyao4uqjpy4)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="925" x="332" y="408.7715"/><polygon fill="#EEEEEE" points="332,408.7715,396,408.7715,396,415.7715,386,425.7715,332,425.7715,332,408.7715" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="345" y="423.3398">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="697.5" y="442.3398">Event Handler Consume {9.1.0}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="701.5" y="457.6504"/><path d="M295,508.7031 L514,508.7031 L514,515.7031 L504,525.7031 L295,525.7031 L295,508.7031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1700.1641" style="stroke: #000000; stroke-width: 2.0;" width="1694" x="295" y="508.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="174" x="310" y="522.2715">Validate Prepare Transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="547.3242" y2="547.3242"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="547.3242" y2="560.3242"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="560.3242" y2="560.3242"/><polygon fill="#A80036" points="430,556.3242,420,560.3242,430,564.3242,426,560.3242" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="426" y="542.582">4</text><text fill="#AAAAAA" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="439" y="542.582">Schema validation of the incoming message</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="589.6348" y2="589.6348"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="589.6348" y2="602.6348"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="602.6348" y2="602.6348"/><polygon fill="#A80036" points="430,598.6348,420,602.6348,430,606.6348,426,602.6348" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="426" y="584.8926">5</text><text fill="#AAAAAA" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="442" x="439" y="584.8926">Verify the message's signature (to be confirmed in future requirement)</text><path d="M424,615.6348 L424,670.6348 L789,670.6348 L789,625.6348 L779,615.6348 L424,615.6348 " fill="#D3D3D3" filter="url(#fojyao4uqjpy4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M779,615.6348 L779,625.6348 L789,625.6348 L779,615.6348 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="430" y="633.2031">The above validation steps are already handled by</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="430" y="648.5137">the ML-Adapter for the open source implementation.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="344" x="430" y="663.8242">It may need to be added in future for custom adapters.</text><path d="M305,687.5664 L516,687.5664 L516,694.5664 L506,704.5664 L305,704.5664 L305,687.5664 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="947.0898" style="stroke: #000000; stroke-width: 2.0;" width="1674" x="305" y="687.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="166" x="320" y="701.1348">Validate Duplicate check</text><path d="M424,709.877 L424,902.877 L858,902.877 L858,719.877 L848,709.877 L424,709.877 " fill="#ADD8E6" filter="url(#fojyao4uqjpy4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M848,709.877 L848,719.877 L858,719.877 L848,709.877 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="384" x="430" y="727.4453">The steps for checking duplicates (currently #6 to #18) if not</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="394" x="430" y="742.7559">already implemented, can be optimized by first trying to insert</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="402" x="430" y="758.0664">into the table 'transferDuplicateCheck' which would succeed for</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="406" x="430" y="773.377">valid/new Transfer requests. When it fails because the transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="386" x="430" y="788.6875">already exists in that table, then the hashes and transferState</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="376" x="430" y="803.998">can be verified and dealt with accordingly (as they are now).</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="379" x="430" y="819.3086">This way, hashes and transferStates are retrieved only if it is</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="374" x="430" y="834.6191">a duplicate (Prepare) (since that transerId exists in the table</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="122" x="430" y="849.9297">Steps #6-#9 Insert;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="413" x="430" y="865.2402">for failure (to insert) --&gt; #10-#13 Transfer Exists, Retrieve Hash;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="341" x="430" y="880.5508">If Hash matches --&gt; #14-#16 Retrieve Transfer State;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="192" x="430" y="895.8613">Hash does not match --&gt; #17</text><polygon fill="#A80036" points="1457.5,929.9141,1467.5,933.9141,1457.5,937.9141,1461.5,933.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1463.5" y1="933.9141" y2="933.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="426" y="929.1719">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="343" x="439" y="929.1719">Request to retrieve Transfer message hash (if it exists)</text><polygon fill="#A80036" points="1856,959.2246,1866,963.2246,1856,967.2246,1860,963.2246" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1479.5" x2="1862" y1="963.2246" y2="963.2246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1486.5" y="958.4824">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="1499.5" y="958.4824">Request Transfer message hash</text><polygon fill="#FFFFE0" filter="url(#fojyao4uqjpy4)" points="1797,976.2246,1949,976.2246,1959,987.2246,1949,999.2246,1797,999.2246,1787,987.2246,1797,976.2246" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="1799" y="992.793">transferDuplicateCheck</text><polygon fill="#A80036" points="1490.5,1021.8457,1480.5,1025.8457,1490.5,1029.8457,1486.5,1025.8457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1484.5" x2="1872" y1="1025.8457" y2="1025.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1496.5" y="1021.1035">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="1509.5" y="1021.1035">Return hash if it exists</text><polygon fill="#A80036" points="430,1051.1563,420,1055.1563,430,1059.1563,426,1055.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1473.5" y1="1055.1563" y2="1055.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="436" y="1050.4141">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="449" y="1050.4141">Return transfer message hash if it exists</text><path d="M315,1070.1563 L377,1070.1563 L377,1077.1563 L367,1087.1563 L315,1087.1563 L315,1070.1563 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="557.5" style="stroke: #000000; stroke-width: 2.0;" width="1654" x="315" y="1070.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="330" y="1083.7246">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="175" x="392" y="1082.791">[Transfer exists, hash matches]</text><polygon fill="#A80036" points="1457.5,1104.7773,1467.5,1108.7773,1457.5,1112.7773,1461.5,1108.7773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1463.5" y1="1108.7773" y2="1108.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1104.0352">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="448" y="1104.0352">Request to retrieve Transfer state</text><polygon fill="#A80036" points="1856,1134.0879,1866,1138.0879,1856,1142.0879,1860,1138.0879" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1479.5" x2="1862" y1="1138.0879" y2="1138.0879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1486.5" y="1133.3457">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="1508.5" y="1133.3457">Request Transfer state</text><polygon fill="#FFFFE0" filter="url(#fojyao4uqjpy4)" points="1807,1151.0879,1938,1151.0879,1948,1170.0879,1938,1189.0879,1807,1189.0879,1797,1170.0879,1807,1151.0879" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1809" y="1167.6563">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1809" y="1182.9668">transferStateChange</text><polygon fill="#A80036" points="1490.5,1212.0195,1480.5,1216.0195,1490.5,1220.0195,1486.5,1216.0195" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1484.5" x2="1872" y1="1216.0195" y2="1216.0195"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1496.5" y="1211.2773">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="1518.5" y="1211.2773">Return Transfer state</text><polygon fill="#A80036" points="430,1241.3301,420,1245.3301,430,1249.3301,426,1245.3301" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1473.5" y1="1245.3301" y2="1245.3301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="436" y="1240.5879">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="458" y="1240.5879">Return Transfer state</text><path d="M325,1260.3301 L409,1260.3301 L409,1267.3301 L399,1277.3301 L325,1277.3301 L325,1260.3301 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="90.2422" style="stroke: #000000; stroke-width: 2.0;" width="733" x="325" y="1260.3301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="340" y="1273.8984">break</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="1329.5723" y2="1329.5723"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="1329.5723" y2="1342.5723"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="1342.5723" y2="1342.5723"/><polygon fill="#A80036" points="430,1338.5723,420,1342.5723,430,1346.5723,426,1342.5723" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1309.5195">14</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="102" x="448" y="1294.209">Error handling:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="554" y="1294.209">If transferState is ['COMMITTED', 'ABORTED']</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="354" x="448" y="1309.5195">then send callback to Payer with the completed transfer,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="598" x="448" y="1324.8301">otherwise this new request can be ignored, because a callback is about to be sent to the client.</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="315" x2="1969" y1="1358.5723" y2="1358.5723"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="215" x="320" y="1369.207">[Transfer exists, hash does not match]</text><path d="M325,1379.5273 L409,1379.5273 L409,1386.5273 L399,1396.5273 L325,1396.5273 L325,1379.5273 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="244" x="325" y="1379.5273"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="340" y="1393.0957">break</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="1418.1484" y2="1418.1484"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="1418.1484" y2="1431.1484"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="1431.1484" y2="1431.1484"/><polygon fill="#A80036" points="430,1427.1484,420,1431.1484,430,1435.1484,426,1431.1484" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1413.4063">15</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="448" y="1413.4063">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="525" y="1413.4063">3100</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="315" x2="1969" y1="1447.1484" y2="1447.1484"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="168" x="320" y="1457.7832">[Transfer hash does not exist]</text><polygon fill="#A80036" points="1457.5,1493.7246,1467.5,1497.7246,1457.5,1501.7246,1461.5,1497.7246" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1463.5" y1="1497.7246" y2="1497.7246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1485.3271">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="448" y="1477.6719">Request to persist transfer hash</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="1492.9824">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="1492.9824">2003</text><polygon fill="#A80036" points="1856,1523.0352,1866,1527.0352,1856,1531.0352,1860,1527.0352" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1479.5" x2="1862" y1="1527.0352" y2="1527.0352"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1486.5" y="1522.293">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="76" x="1508.5" y="1522.293">Persist hash</text><polygon fill="#FFFFE0" filter="url(#fojyao4uqjpy4)" points="1797,1570.0352,1949,1570.0352,1959,1581.0352,1949,1593.0352,1797,1593.0352,1787,1581.0352,1797,1570.0352" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="1799" y="1586.6035">transferDuplicateCheck</text><polygon fill="#A80036" points="430,1615.6563,420,1619.6563,430,1623.6563,426,1619.6563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1473.5" y1="1619.6563" y2="1619.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="436" y="1614.9141">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="458" y="1614.9141">Return success</text><path d="M325,1648.6563 L467,1648.6563 L467,1655.6563 L457,1665.6563 L325,1665.6563 L325,1648.6563 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1632" x="325" y="1648.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="340" y="1662.2246">Validate Payer</text><polygon fill="#A80036" points="1574,1683.2773,1584,1687.2773,1574,1691.2773,1578,1687.2773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1580" y1="1687.2773" y2="1687.2773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1682.5352">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="348" x="448" y="1682.5352">Request to retrieve Payer Participant details (if it exists)</text><polygon fill="#A80036" points="1856,1712.5879,1866,1716.5879,1856,1720.5879,1860,1716.5879" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1596" x2="1862" y1="1716.5879" y2="1716.5879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1603" y="1711.8457">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="1625" y="1711.8457">Request Participant details</text><polygon fill="#FFFFE0" filter="url(#fojyao4uqjpy4)" points="1809,1729.5879,1937,1729.5879,1947,1748.5879,1937,1767.5879,1809,1767.5879,1799,1748.5879,1809,1729.5879" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1811" y="1746.1563">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="1811" y="1761.4668">participantCurrency</text><polygon fill="#A80036" points="1607,1790.5195,1597,1794.5195,1607,1798.5195,1603,1794.5195" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1601" x2="1872" y1="1794.5195" y2="1794.5195"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1613" y="1789.7773">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="1635" y="1789.7773">Return Participant details if it exists</text><polygon fill="#A80036" points="430,1819.8301,420,1823.8301,430,1827.8301,426,1823.8301" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1590" y1="1823.8301" y2="1823.8301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="436" y="1819.0879">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="458" y="1819.0879">Return Participant details if it exists</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="1868.4512" y2="1868.4512"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="1868.4512" y2="1881.4512"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="1881.4512" y2="1881.4512"/><polygon fill="#A80036" points="430,1877.4512,420,1881.4512,430,1885.4512,426,1881.4512" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1856.0537">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="448" y="1848.3984">Validate Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="1863.709">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="1863.709">3202</text><path d="M325,1903.4512 L469,1903.4512 L469,1910.4512 L459,1920.4512 L325,1920.4512 L325,1903.4512 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1632" x="325" y="1903.4512"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="99" x="340" y="1917.0195">Validate Payee</text><polygon fill="#A80036" points="1574,1938.0723,1584,1942.0723,1574,1946.0723,1578,1942.0723" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1580" y1="1942.0723" y2="1942.0723"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1937.3301">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="448" y="1937.3301">Request to retrieve Payee Participant details (if it exists)</text><polygon fill="#A80036" points="1856,1967.3828,1866,1971.3828,1856,1975.3828,1860,1971.3828" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1596" x2="1862" y1="1971.3828" y2="1971.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1603" y="1966.6406">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="1625" y="1966.6406">Request Participant details</text><polygon fill="#FFFFE0" filter="url(#fojyao4uqjpy4)" points="1809,1984.3828,1937,1984.3828,1947,2003.3828,1937,2022.3828,1809,2022.3828,1799,2003.3828,1809,1984.3828" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1811" y="2000.9512">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="1811" y="2016.2617">participantCurrency</text><polygon fill="#A80036" points="1607,2045.3145,1597,2049.3145,1607,2053.3145,1603,2049.3145" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1601" x2="1872" y1="2049.3145" y2="2049.3145"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1613" y="2044.5723">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="1635" y="2044.5723">Return Participant details if it exists</text><polygon fill="#A80036" points="430,2074.625,420,2078.625,430,2082.625,426,2078.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1590" y1="2078.625" y2="2078.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="436" y="2073.8828">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="458" y="2073.8828">Return Participant details if it exists</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="2123.2461" y2="2123.2461"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="2123.2461" y2="2136.2461"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="2136.2461" y2="2136.2461"/><polygon fill="#A80036" points="430,2132.2461,420,2136.2461,430,2140.2461,426,2136.2461" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="2110.8486">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="448" y="2103.1934">Validate Payee</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="2118.5039">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="2118.5039">3203</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="2187.8672" y2="2187.8672"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="2187.8672" y2="2200.8672"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="2200.8672" y2="2200.8672"/><polygon fill="#A80036" points="430,2196.8672,420,2200.8672,430,2204.8672,426,2200.8672" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="2175.4697">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="448" y="2167.8145">Validate crypto-condition</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="2183.125">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="2183.125">3100</text><path d="M315,2222.8672 L377,2222.8672 L377,2229.8672 L367,2239.8672 L315,2239.8672 L315,2222.8672 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1315.3828" style="stroke: #000000; stroke-width: 2.0;" width="1653" x="315" y="2222.8672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="330" y="2236.4355">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="206" x="392" y="2235.502">[Validate Prepare Transfer (success)]</text><path d="M325,2247.1777 L797,2247.1777 L797,2254.1777 L787,2264.1777 L325,2264.1777 L325,2247.1777 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1633" x="325" y="2247.1777"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="427" x="340" y="2260.7461">Persist Transfer State (with transferState='RECEIVED-PREPARE')</text><polygon fill="#A80036" points="1457.5,2297.1094,1467.5,2301.1094,1457.5,2305.1094,1461.5,2301.1094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1463.5" y1="2301.1094" y2="2301.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="2288.7119">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="448" y="2281.0566">Request to persist transfer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="2296.3672">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="2296.3672">2003</text><polygon fill="#A80036" points="1856,2326.4199,1866,2330.4199,1856,2334.4199,1860,2330.4199" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1479.5" x2="1862" y1="2330.4199" y2="2330.4199"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1486.5" y="2325.6777">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="1508.5" y="2325.6777">Persist transfer</text><polygon fill="#FFFFE0" filter="url(#fojyao4uqjpy4)" points="1807,2373.4199,1938,2373.4199,1948,2415.4199,1938,2457.4199,1807,2457.4199,1797,2415.4199,1807,2373.4199" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1809" y="2389.9883">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1809" y="2405.2988">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1809" y="2420.6094">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="1809" y="2435.9199">transferExtension</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57" x="1809" y="2451.2305">ilpPacket</text><polygon fill="#A80036" points="430,2480.2832,420,2484.2832,430,2488.2832,426,2484.2832" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1473.5" y1="2484.2832" y2="2484.2832"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="436" y="2479.541">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="458" y="2479.541">Return success</text><path d="M424,2504.2832 L424,2881.2832 L686,2881.2832 L686,2514.2832 L676,2504.2832 L424,2504.2832 " fill="#FFFF00" filter="url(#fojyao4uqjpy4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M676,2504.2832 L676,2514.2832 L686,2514.2832 L676,2504.2832 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="430" y="2521.8516">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="430" y="2537.1621">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="446" y="2552.4727">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="446" y="2567.7832">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="446" y="2583.0938">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="446" y="2598.4043">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="446" y="2613.7148">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="462" y="2629.0254">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="462" y="2644.3359">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="446" y="2659.6465">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="446" y="2674.957">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="462" y="2690.2676">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="478" y="2705.5781">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="478" y="2720.8887">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="478" y="2736.1992">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="478" y="2751.5098">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="478" y="2766.8203">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="478" y="2782.1309">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="494" y="2797.4414">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="494" y="2812.752">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="478" y="2828.0625">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="462" y="2843.373">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="446" y="2858.6836">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="430" y="2873.9941">}</text><polygon fill="#A80036" points="1041,2923.3574,1051,2927.3574,1041,2931.3574,1045,2927.3574" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1047" y1="2927.3574" y2="2927.3574"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="2914.96">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="448" y="2907.3047">Route &amp; Publish Position event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="2922.6152">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="2922.6152">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="315" x2="1968" y1="2966.3574" y2="2966.3574"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="200" x="320" y="2976.9922">[Validate Prepare Transfer (failure)]</text><path d="M424,2985.3125 L424,3454.3125 L1031,3454.3125 L1031,2995.3125 L1021,2985.3125 L424,2985.3125 " fill="#FFFF00" filter="url(#fojyao4uqjpy4)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1021,2985.3125 L1021,2995.3125 L1031,2995.3125 L1021,2985.3125 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="430" y="3002.8809">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="430" y="3018.1914">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="446" y="3033.502">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="446" y="3048.8125">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="446" y="3064.123">to: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="446" y="3079.4336">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="446" y="3094.7441">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="462" y="3110.0547">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="462" y="3125.3652">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="478" y="3140.6758">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="522" x="494" y="3155.9863">"errorCode": &lt;possible codes: [2003, 3100, 3105, 3106, 3202, 3203, 3300, 3301]&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="392" x="494" y="3171.2969">"errorDescription": "&lt;refer to section 35.1.3 for description&gt;",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="494" y="3186.6074">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="462" y="3201.918">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="446" y="3217.2285">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="446" y="3232.5391">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="462" y="3247.8496">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="478" y="3263.1602">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="478" y="3278.4707">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="478" y="3293.7813">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="478" y="3309.0918">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="478" y="3324.4023">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="478" y="3339.7129">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="494" y="3355.0234">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="494" y="3370.334">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="494" y="3385.6445">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="478" y="3400.9551">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="462" y="3416.2656">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="446" y="3431.5762">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="430" y="3446.8867">}</text><polygon fill="#A80036" points="1324.5,3496.25,1334.5,3500.25,1324.5,3504.25,1328.5,3500.25" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1330.5" y1="3500.25" y2="3500.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="3487.8525">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="448" y="3480.1973">Publish Notification (failure) event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="3495.5078">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="3495.5078">2003</text><!--
@startuml
title 1.1.1.a. Prepare Handler Consume (single message)

autonumber


collections "Prepare-Topic-dfsp1" as TOPIC_PREPARE_DFSP1
control "Prepare Event Handler" as PREP_HANDLER
collections "Position-Topic-dfsp1" as TOPIC_POSITION_DFSP1
collections "Event-Topic" as TOPIC_EVENTS
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Transfer DAO" as TRANS_DAO
entity "Participant DAO" as PARTICIPANT_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_PREPARE_DFSP1
    participant PREP_HANDLER
    participant TOPIC_POSITION_DFSP1
    participant TOPIC_EVENTS
    participant TOPIC_NOTIFICATIONS
    participant TRANS_DAO
    participant PARTICIPANT_DAO
    participant DB
end box

activate PREP_HANDLER
group Prepare Handler Consume
    TOPIC_PREPARE_DFSP1 <- PREP_HANDLER: Consume Prepare event message for Payer
    activate TOPIC_PREPARE_DFSP1
    deactivate TOPIC_PREPARE_DFSP1

    break
        group Validate Event
            PREP_HANDLER <-> PREP_HANDLER: Validate event - Rule: type == 'prepare' && action == 'prepare'\n<color #FF0000><b>Error codes:</b> 2001</color>
        end
    end

    group Persist Event Information
        |||
        PREP_HANDLER -> TOPIC_EVENTS: Publish event information
        ref over PREP_HANDLER, TOPIC_EVENTS :  Event Handler Consume {9.1.0} \n
        |||
    end

    group Validate Prepare Transfer
        PREP_HANDLER <-> PREP_HANDLER: <color #AAA>Schema validation of the incoming message</color>
        PREP_HANDLER <-> PREP_HANDLER: <color #AAA>Verify the message's signature (to be confirmed in future requirement)</color>
        note right of PREP_HANDLER #lightgrey
            The above validation steps are already handled by
            the ML-Adapter for the open source implementation.
            It may need to be added in future for custom adapters.
        end note
        group Validate Duplicate check
            note right of PREP_HANDLER #lightblue
                The steps for checking duplicates (currently #6 to #18) if not
                already implemented, can be optimized by first trying to insert
                into the table 'transferDuplicateCheck' which would succeed for 
                valid/new Transfer requests. When it fails because the transferId
                already exists in that table, then the hashes and transferState
                can be verified and dealt with accordingly (as they are now).
                This way, hashes and transferStates are retrieved only if it is
                a duplicate (Prepare) (since that transerId exists in the table
                Steps #6-#9 Insert;
                for failure (to insert) - -> #10-#13 Transfer Exists, Retrieve Hash;
                If Hash matches - -> #14-#16 Retrieve Transfer State;
                Hash does not match - -> #17 
            end note
            PREP_HANDLER -> TRANS_DAO: Request to retrieve Transfer message hash (if it exists)
            activate TRANS_DAO
            TRANS_DAO -> DB: Request Transfer message hash
            hnote over DB #lightyellow
                transferDuplicateCheck
            end note
            activate DB
            TRANS_DAO <- - DB: Return hash if it exists 
            deactivate DB
            TRANS_DAO - -> PREP_HANDLER: Return transfer message hash if it exists
            deactivate TRANS_DAO
            alt Transfer exists, hash matches
                PREP_HANDLER -> TRANS_DAO: Request to retrieve Transfer state
                activate TRANS_DAO
                TRANS_DAO -> DB: Request Transfer state
                hnote over DB #lightyellow
                    transfer
                    transferStateChange
                end note
                activate DB
                TRANS_DAO <- - DB: Return Transfer state
                deactivate DB
                TRANS_DAO - -> PREP_HANDLER: Return Transfer state
                deactivate TRANS_DAO
                break
                    PREP_HANDLER <-> PREP_HANDLER: <color #FF0000><b>Error handling:</b></color> If transferState is ['COMMITTED', 'ABORTED']\nthen send callback to Payer with the completed transfer,\notherwise this new request can be ignored, because a callback is about to be sent to the client.
                end
            else Transfer exists, hash does not match
                break
                    PREP_HANDLER <-> PREP_HANDLER: <color #FF0000><b>Error code:</b> 3100</color>
                end
            else Transfer hash does not exist
                PREP_HANDLER -> TRANS_DAO: Request to persist transfer hash\n<color #FF0000><b>Error codes:</b> 2003</color>
                activate TRANS_DAO
                TRANS_DAO -> DB: Persist hash
                hnote over DB #lightyellow
                    transferDuplicateCheck
                end note
                activate DB
                deactivate DB
                TRANS_DAO - -> PREP_HANDLER: Return success
                deactivate TRANS_DAO 
            end
        end
        group Validate Payer
            PREP_HANDLER -> PARTICIPANT_DAO: Request to retrieve Payer Participant details (if it exists)
            activate PARTICIPANT_DAO
            PARTICIPANT_DAO -> DB: Request Participant details
            hnote over DB #lightyellow
                participant
                participantCurrency
            end note
            activate DB
            PARTICIPANT_DAO <- - DB: Return Participant details if it exists
            deactivate DB
            PARTICIPANT_DAO - -> PREP_HANDLER: Return Participant details if it exists
            deactivate PARTICIPANT_DAO
            PREP_HANDLER <-> PREP_HANDLER: Validate Payer\n<color #FF0000><b>Error codes:</b> 3202</color>
        end
        group Validate Payee
            PREP_HANDLER -> PARTICIPANT_DAO: Request to retrieve Payee Participant details (if it exists)
            activate PARTICIPANT_DAO
            PARTICIPANT_DAO -> DB: Request Participant details
            hnote over DB #lightyellow
                participant
                participantCurrency
            end note
            activate DB
            PARTICIPANT_DAO <- - DB: Return Participant details if it exists
            deactivate DB
            PARTICIPANT_DAO - -> PREP_HANDLER: Return Participant details if it exists
            deactivate PARTICIPANT_DAO
            PREP_HANDLER <-> PREP_HANDLER: Validate Payee\n<color #FF0000><b>Error codes:</b> 3203</color>
        end
        PREP_HANDLER <-> PREP_HANDLER: Validate crypto-condition\n<color #FF0000><b>Error codes:</b> 3100</color>
    end
    alt Validate Prepare Transfer (success)
        group Persist Transfer State (with transferState='RECEIVED-PREPARE')
            PREP_HANDLER -> TRANS_DAO: Request to persist transfer\n<color #FF0000><b>Error codes:</b> 2003</color>
            activate TRANS_DAO
            TRANS_DAO -> DB: Persist transfer
            hnote over DB #lightyellow
                transfer
                transferParticipant
                transferStateChange
                transferExtension
                ilpPacket
            end note
            activate DB
            deactivate DB
            TRANS_DAO - -> PREP_HANDLER: Return success
            deactivate TRANS_DAO
        end

        note right of PREP_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: position,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        PREP_HANDLER -> TOPIC_POSITION_DFSP1: Route & Publish Position event for Payer\n<color #FF0000><b>Error codes:</b> 2003</color>
        activate TOPIC_POSITION_DFSP1
        deactivate TOPIC_POSITION_DFSP1
    else Validate Prepare Transfer (failure)
        note right of PREP_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <ledgerName>,
                to: <transferMessage.payerFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                        "errorInformation": {
                            "errorCode": <possible codes: [2003, 3100, 3105, 3106, 3202, 3203, 3300, 3301]>
                            "errorDescription": "<refer to section 35.1.3 for description>",
                            "extensionList": <transferMessage.extensionList>
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: notification,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        PREP_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification (failure) event for Payer\n<color #FF0000><b>Error codes:</b> 2003</color>
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
    end
end
deactivate PREP_HANDLER
@enduml

PlantUML version 1.2018.03(Thu Apr 05 22:29:15 IST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_151-b12
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>