<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="4150px" preserveAspectRatio="none" style="width:1919px;height:4150px;" version="1.1" viewBox="0 0 1919 4150" width="1919px" zoomAndPan="magnify"><defs><filter height="300%" id="fp0flawlv3q2k" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="366" x="777.5" y="23.5352">1.1.1.a. Prepare Handler Consume (single message)</text><rect fill="#FFFFE0" height="4104.7734" style="stroke: #A80036; stroke-width: 1.0;" width="1815" x="19" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="876" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="102" y="171.9082"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="3937.4863" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="409" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="962" y="3438.8809"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1245.5" y="4011.7734"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1378.5" y="726.1875"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1378.5" y="1154.5352"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="91.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1378.5" y="1703.2559"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="183.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1378.5" y="2469.6406"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="198.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1378.5" y="2759.0117"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1495" y="1862.8086"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1495" y="2117.6035"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1777" y="755.498"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1777" y="1183.8457"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1777" y="1892.1191"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1777" y="2146.9141"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1777" y="2498.9512"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1777" y="2788.3223"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="3923.4863" style="stroke: #000000; stroke-width: 2.0;" width="1895" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="539" x="315" y="216.9082"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="519" x="325" y="241.2188"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="852" x="325" y="337.1504"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="2470.793" style="stroke: #000000; stroke-width: 2.0;" width="1623" x="275" y="508.7031"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="1122.6211" style="stroke: #000000; stroke-width: 2.0;" width="1603" x="285" y="687.5664"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="940.7578" style="stroke: #000000; stroke-width: 2.0;" width="1583" x="295" y="862.4297"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="852" x="325" y="886.7402"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="544.0762" style="stroke: #000000; stroke-width: 2.0;" width="1562" x="305" y="1100.6035"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="225.3945" style="stroke: #000000; stroke-width: 2.0;" width="1029" x="315" y="1306.0879"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="194.084" style="stroke: #000000; stroke-width: 2.0;" width="1009" x="325" y="1330.3984"/><rect fill="#FFFFFF" height="57.2656" style="stroke: none; stroke-width: 1.0;" width="1009" x="325" y="1392.3301"/><rect fill="#FFFFFF" height="74.8867" style="stroke: none; stroke-width: 1.0;" width="1009" x="325" y="1449.5957"/><rect fill="#FFFFFF" height="106.1973" style="stroke: none; stroke-width: 1.0;" width="1562" x="305" y="1538.4824"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="77.2422" style="stroke: #000000; stroke-width: 2.0;" width="1009" x="325" y="1560.4375"/><rect fill="#FFFFFF" height="151.5078" style="stroke: none; stroke-width: 1.0;" width="1583" x="295" y="1651.6797"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1541" x="325" y="1824.1875"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1541" x="325" y="2078.9824"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="581.0977" style="stroke: #000000; stroke-width: 2.0;" width="1562" x="315" y="2391.3984"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1542" x="325" y="2415.709"/><rect fill="#FFFFFF" height="304.6816" style="stroke: none; stroke-width: 1.0;" width="1562" x="315" y="2667.8145"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="275.7266" style="stroke: #000000; stroke-width: 2.0;" width="1542" x="325" y="2689.7695"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="1056.2773" style="stroke: #000000; stroke-width: 2.0;" width="1009" x="325" y="2993.4961"/><rect fill="#FFFFFF" height="572.8926" style="stroke: none; stroke-width: 1.0;" width="1009" x="325" y="3476.8809"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="107" x2="107" y1="116.2871" y2="4073.7734"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="414" x2="414" y1="116.2871" y2="4073.7734"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="967" x2="967" y1="116.2871" y2="4073.7734"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1114" x2="1114" y1="116.2871" y2="4073.7734"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1250" x2="1250" y1="116.2871" y2="4073.7734"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1383" x2="1383" y1="116.2871" y2="4073.7734"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1500" x2="1500" y1="116.2871" y2="4073.7734"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1782" x2="1782" y1="116.2871" y2="4073.7734"/><rect fill="#FEFECE" filter="url(#fp0flawlv3q2k)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="27" y="76.7988"/><rect fill="#FEFECE" filter="url(#fp0flawlv3q2k)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="23" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="146" x="30" y="101.334">Prepare-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#fp0flawlv3q2k)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="27" y="4072.7734"/><rect fill="#FEFECE" filter="url(#fp0flawlv3q2k)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="160" x="23" y="4076.7734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="146" x="30" y="4097.3086">Prepare-Topic-dfsp1</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="335" y="113.334">Prepare Event Handler</text><ellipse cx="414" cy="83.7988" fill="#FEFECE" filter="url(#fp0flawlv3q2k)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="410,71.7988,416,66.7988,414,71.7988,416,76.7988,410,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="335" y="4086.3086">Prepare Event Handler</text><ellipse cx="414" cy="4105.2617" fill="#FEFECE" filter="url(#fp0flawlv3q2k)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="410,4093.2617,416,4088.2617,414,4093.2617,416,4098.2617,410,4093.2617" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fp0flawlv3q2k)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="886" y="76.7988"/><rect fill="#FEFECE" filter="url(#fp0flawlv3q2k)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="882" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="889" y="101.334">Position-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#fp0flawlv3q2k)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="886" y="4072.7734"/><rect fill="#FEFECE" filter="url(#fp0flawlv3q2k)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="882" y="4076.7734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="889" y="4097.3086">Position-Topic-dfsp1</text><rect fill="#FEFECE" filter="url(#fp0flawlv3q2k)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1066" y="76.7988"/><rect fill="#FEFECE" filter="url(#fp0flawlv3q2k)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1062" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1069" y="101.334">Event-Topic</text><rect fill="#FEFECE" filter="url(#fp0flawlv3q2k)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1066" y="4072.7734"/><rect fill="#FEFECE" filter="url(#fp0flawlv3q2k)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1062" y="4076.7734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1069" y="4097.3086">Event-Topic</text><rect fill="#FEFECE" filter="url(#fp0flawlv3q2k)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1181" y="76.7988"/><rect fill="#FEFECE" filter="url(#fp0flawlv3q2k)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1177" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1184" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#fp0flawlv3q2k)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1181" y="4072.7734"/><rect fill="#FEFECE" filter="url(#fp0flawlv3q2k)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1177" y="4076.7734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1184" y="4097.3086">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1334" y="113.334">Transfer DAO</text><ellipse cx="1383.5" cy="83.7988" fill="#FEFECE" filter="url(#fp0flawlv3q2k)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1371.5" x2="1395.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1334" y="4086.3086">Transfer DAO</text><ellipse cx="1383.5" cy="4105.2617" fill="#FEFECE" filter="url(#fp0flawlv3q2k)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1371.5" x2="1395.5" y1="4119.2617" y2="4119.2617"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1443" y="113.334">Participant DAO</text><ellipse cx="1500" cy="83.7988" fill="#FEFECE" filter="url(#fp0flawlv3q2k)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1488" x2="1512" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="1443" y="4086.3086">Participant DAO</text><ellipse cx="1500" cy="4105.2617" fill="#FEFECE" filter="url(#fp0flawlv3q2k)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1488" x2="1512" y1="4119.2617" y2="4119.2617"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1734" y="113.334">Central Store</text><path d="M1764,63.7988 C1764,53.7988 1782,53.7988 1782,53.7988 C1782,53.7988 1800,53.7988 1800,63.7988 L1800,89.7988 C1800,99.7988 1782,99.7988 1782,99.7988 C1782,99.7988 1764,99.7988 1764,89.7988 L1764,63.7988 " fill="#FEFECE" filter="url(#fp0flawlv3q2k)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1764,63.7988 C1764,73.7988 1782,73.7988 1782,73.7988 C1782,73.7988 1800,73.7988 1800,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1734" y="4086.3086">Central Store</text><path d="M1764,4099.2617 C1764,4089.2617 1782,4089.2617 1782,4089.2617 C1782,4089.2617 1800,4089.2617 1800,4099.2617 L1800,4125.2617 C1800,4135.2617 1782,4135.2617 1782,4135.2617 C1782,4135.2617 1764,4135.2617 1764,4125.2617 L1764,4099.2617 " fill="#FEFECE" filter="url(#fp0flawlv3q2k)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1764,4099.2617 C1764,4109.2617 1782,4109.2617 1782,4109.2617 C1782,4109.2617 1800,4109.2617 1800,4099.2617 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="102" y="171.9082"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="3937.4863" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="409" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="962" y="3438.8809"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1245.5" y="4011.7734"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1378.5" y="726.1875"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1378.5" y="1154.5352"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="91.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1378.5" y="1703.2559"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="183.1738" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1378.5" y="2469.6406"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="198.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1378.5" y="2759.0117"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1495" y="1862.8086"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1495" y="2117.6035"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1777" y="755.498"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1777" y="1183.8457"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1777" y="1892.1191"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1777" y="2146.9141"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1777" y="2498.9512"/><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1777" y="2788.3223"/><path d="M13,133.2871 L236,133.2871 L236,140.2871 L226,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3923.4863" style="stroke: #000000; stroke-width: 2.0;" width="1895" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="178" x="28" y="146.8555">Prepare Handler Consume</text><polygon fill="#A80036" points="123,167.9082,113,171.9082,123,175.9082,119,171.9082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="117" x2="408" y1="171.9082" y2="171.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="129" y="167.166">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="142" y="167.166">Consume Prepare event message for Payer</text><path d="M315,216.9082 L399,216.9082 L399,223.9082 L389,233.9082 L315,233.9082 L315,216.9082 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="539" x="315" y="216.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="330" y="230.4766">break</text><path d="M325,241.2188 L467,241.2188 L467,248.2188 L457,258.2188 L325,258.2188 L325,241.2188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="519" x="325" y="241.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="340" y="254.7871">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="295.1504" y2="295.1504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="295.1504" y2="308.1504"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="308.1504" y2="308.1504"/><polygon fill="#A80036" points="430,304.1504,420,308.1504,430,312.1504,426,308.1504" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="426" y="282.7529">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="393" x="439" y="275.0977">Validate event - Rule: type == 'prepare' &amp;&amp; action == 'prepare'</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="439" y="290.4082">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="523" y="290.4082">2001</text><path d="M325,337.1504 L540,337.1504 L540,344.1504 L530,354.1504 L325,354.1504 L325,337.1504 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="852" x="325" y="337.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="340" y="350.7188">Persist Event Information</text><polygon fill="#A80036" points="1102.5,396.7715,1112.5,400.7715,1102.5,404.7715,1106.5,400.7715" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1108.5" y1="400.7715" y2="400.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="426" y="396.0293">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="439" y="396.0293">Publish event information</text><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="834" x="332" y="408.7715"/><polygon fill="#EEEEEE" points="332,408.7715,396,408.7715,396,415.7715,386,425.7715,332,425.7715,332,408.7715" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="345" y="423.3398">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="652" y="442.3398">Event Handler Consume {9.1.0}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="656" y="457.6504"/><path d="M275,508.7031 L494,508.7031 L494,515.7031 L484,525.7031 L275,525.7031 L275,508.7031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2470.793" style="stroke: #000000; stroke-width: 2.0;" width="1623" x="275" y="508.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="174" x="290" y="522.2715">Validate Prepare Transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="547.3242" y2="547.3242"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="547.3242" y2="560.3242"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="560.3242" y2="560.3242"/><polygon fill="#A80036" points="430,556.3242,420,560.3242,430,564.3242,426,560.3242" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="426" y="542.582">4</text><text fill="#AAAAAA" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="439" y="542.582">Schema validation of the incoming message</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="589.6348" y2="589.6348"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="589.6348" y2="602.6348"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="602.6348" y2="602.6348"/><polygon fill="#A80036" points="430,598.6348,420,602.6348,430,606.6348,426,602.6348" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="426" y="584.8926">5</text><text fill="#AAAAAA" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="442" x="439" y="584.8926">Verify the message's signature (to be confirmed in future requirement)</text><path d="M424,615.6348 L424,670.6348 L789,670.6348 L789,625.6348 L779,615.6348 L424,615.6348 " fill="#D3D3D3" filter="url(#fp0flawlv3q2k)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M779,615.6348 L779,625.6348 L789,625.6348 L779,615.6348 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="313" x="430" y="633.2031">The above validation steps are already handled by</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="430" y="648.5137">the ML-Adapter for the open source implementation.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="344" x="430" y="663.8242">It may need to be added in future for custom adapters.</text><path d="M285,687.5664 L496,687.5664 L496,694.5664 L486,704.5664 L285,704.5664 L285,687.5664 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1122.6211" style="stroke: #000000; stroke-width: 2.0;" width="1603" x="285" y="687.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="166" x="300" y="701.1348">Validate Duplicate check</text><polygon fill="#A80036" points="1366.5,722.1875,1376.5,726.1875,1366.5,730.1875,1370.5,726.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1372.5" y1="726.1875" y2="726.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="426" y="721.4453">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="308" x="439" y="721.4453">Request to retrieve Transfer Hash for a transferId</text><polygon fill="#A80036" points="1765,751.498,1775,755.498,1765,759.498,1769,755.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1388.5" x2="1771" y1="755.498" y2="755.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1395.5" y="750.7559">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="240" x="1408.5" y="750.7559">Request Transfer Hash for a transferId</text><polygon fill="#FFFFE0" filter="url(#fp0flawlv3q2k)" points="1706,768.498,1858,768.498,1868,779.498,1858,791.498,1706,791.498,1696,779.498,1706,768.498" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="1708" y="785.0664">transferDuplicateCheck</text><polygon fill="#A80036" points="1399.5,814.1191,1389.5,818.1191,1399.5,822.1191,1395.5,818.1191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1393.5" x2="1781" y1="818.1191" y2="818.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1405.5" y="813.377">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="1418.5" y="813.377">Return hash if it exists</text><polygon fill="#A80036" points="430,843.4297,420,847.4297,430,851.4297,426,847.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1382.5" y1="847.4297" y2="847.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="436" y="842.6875">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="449" y="842.6875">Return hash if it exists</text><path d="M295,862.4297 L357,862.4297 L357,869.4297 L347,879.4297 L295,879.4297 L295,862.4297 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="940.7578" style="stroke: #000000; stroke-width: 2.0;" width="1583" x="295" y="862.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="310" y="875.998">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="112" x="372" y="875.0645">[If transferId exists]</text><path d="M325,886.7402 L540,886.7402 L540,893.7402 L530,903.7402 L325,903.7402 L325,886.7402 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="157.5527" style="stroke: #000000; stroke-width: 2.0;" width="852" x="325" y="886.7402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="340" y="900.3086">Persist Event Information</text><polygon fill="#A80036" points="1102.5,946.3613,1112.5,950.3613,1102.5,954.3613,1106.5,950.3613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1108.5" y1="950.3613" y2="950.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="945.6191">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="448" y="945.6191">Publish event information</text><rect fill="#FFFFFF" filter="url(#fp0flawlv3q2k)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="834" x="332" y="958.3613"/><polygon fill="#EEEEEE" points="332,958.3613,396,958.3613,396,965.3613,386,975.3613,332,975.3613,332,958.3613" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="345" y="972.9297">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="194" x="652" y="991.9297">Event Handler Consume {9.1.0}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="656" y="1007.2402"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="1072.6035" y2="1072.6035"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="1072.6035" y2="1085.6035"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="1085.6035" y2="1085.6035"/><polygon fill="#A80036" points="430,1081.6035,420,1085.6035,430,1089.6035,426,1085.6035" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1067.8613">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="392" x="448" y="1067.8613">Generate Hash for the incoming message and compare hashes</text><path d="M305,1100.6035 L367,1100.6035 L367,1107.6035 L357,1117.6035 L305,1117.6035 L305,1100.6035 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="544.0762" style="stroke: #000000; stroke-width: 2.0;" width="1562" x="305" y="1100.6035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="320" y="1114.1719">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="175" x="382" y="1113.2383">[Transfer exists, hash matches]</text><polygon fill="#A80036" points="1366.5,1150.5352,1376.5,1154.5352,1366.5,1158.5352,1370.5,1154.5352" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1372.5" y1="1154.5352" y2="1154.5352"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1142.1377">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="209" x="448" y="1134.4824">Request to retrieve Transfer state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="448" y="1149.793">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="525" y="1149.793">2003</text><polygon fill="#A80036" points="1765,1179.8457,1775,1183.8457,1765,1187.8457,1769,1183.8457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1388.5" x2="1771" y1="1183.8457" y2="1183.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1395.5" y="1179.1035">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="141" x="1417.5" y="1179.1035">Request Transfer state</text><polygon fill="#FFFFE0" filter="url(#fp0flawlv3q2k)" points="1716,1196.8457,1847,1196.8457,1857,1215.8457,1847,1234.8457,1716,1234.8457,1706,1215.8457,1716,1196.8457" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1718" y="1213.4141">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1718" y="1228.7246">transferStateChange</text><polygon fill="#A80036" points="1399.5,1257.7773,1389.5,1261.7773,1399.5,1265.7773,1395.5,1261.7773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1393.5" x2="1781" y1="1261.7773" y2="1261.7773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1405.5" y="1257.0352">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="1427.5" y="1257.0352">Return Transfer state</text><polygon fill="#A80036" points="430,1287.0879,420,1291.0879,430,1295.0879,426,1291.0879" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1382.5" y1="1291.0879" y2="1291.0879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="436" y="1286.3457">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="132" x="458" y="1286.3457">Return Transfer state</text><path d="M315,1306.0879 L399,1306.0879 L399,1313.0879 L389,1323.0879 L315,1323.0879 L315,1306.0879 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="225.3945" style="stroke: #000000; stroke-width: 2.0;" width="1029" x="315" y="1306.0879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="330" y="1319.6563">break</text><path d="M325,1330.3984 L387,1330.3984 L387,1337.3984 L377,1347.3984 L325,1347.3984 L325,1330.3984 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="194.084" style="stroke: #000000; stroke-width: 2.0;" width="1009" x="325" y="1330.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="340" y="1343.9668">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="342" x="402" y="1343.0332">[If transferState IN Enumeration ['COMMITTED', 'ABORTED']]</text><polygon fill="#A80036" points="1238.5,1380.3301,1248.5,1384.3301,1238.5,1388.3301,1242.5,1384.3301" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1244.5" y1="1384.3301" y2="1384.3301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1371.9326">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="395" x="448" y="1364.2773">Publish Notification event for Payer with the completed transer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="641" x="448" y="1379.5879">For the Data Model, refer to the Swagger (transerState - mandatory, fulfilment, completedTimestamp).</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="325" x2="1334" y1="1393.3301" y2="1393.3301"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="330" x="330" y="1403.9648">[If transferState in Enumeration ['RECEIVED', 'RESERVED']]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="1428.5957" y2="1428.5957"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="1428.5957" y2="1441.5957"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="1441.5957" y2="1441.5957"/><polygon fill="#A80036" points="430,1437.5957,420,1441.5957,430,1445.5957,426,1441.5957" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1423.8535">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="507" x="448" y="1423.8535">This request can be ignored, because a callback is about to be sent to the client.</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="325" x2="1334" y1="1450.5957" y2="1450.5957"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="165" x="330" y="1461.2305">[If transferState doesn't exist]</text><polygon fill="#A80036" points="1238.5,1512.4824,1248.5,1516.4824,1238.5,1520.4824,1242.5,1516.4824" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1244.5" y1="1516.4824" y2="1516.4824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1496.4297">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="327" x="448" y="1481.1191">Send /error callback with appropriate error message</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="163" x="448" y="1496.4297">(Invalid duplicate request)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="448" y="1511.7402">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="525" y="1511.7402">3100</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="305" x2="1867" y1="1539.4824" y2="1539.4824"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="215" x="310" y="1550.1172">[Transfer exists, hash does not match]</text><path d="M325,1560.4375 L409,1560.4375 L409,1567.4375 L399,1577.4375 L325,1577.4375 L325,1560.4375 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="77.2422" style="stroke: #000000; stroke-width: 2.0;" width="1009" x="325" y="1560.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="340" y="1574.0059">break</text><polygon fill="#A80036" points="1238.5,1625.6797,1248.5,1629.6797,1238.5,1633.6797,1242.5,1629.6797" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1244.5" y1="1629.6797" y2="1629.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1609.627">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="448" y="1594.3164">Publish Notification (failure) event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="1609.627">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="1609.627">3106</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="568" y="1609.627"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="487" x="448" y="1624.9375">For the Data Model, refer to the final step in this diagram (has the same text).</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="295" x2="1878" y1="1652.6797" y2="1652.6797"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="165" x="300" y="1663.3145">[If transferId does NOT exist]</text><polygon fill="#A80036" points="1366.5,1699.2559,1376.5,1703.2559,1366.5,1707.2559,1370.5,1703.2559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1372.5" y1="1703.2559" y2="1703.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1690.8584">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="206" x="448" y="1683.2031">Request to persist Transfer Hash</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="448" y="1698.5137">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="525" y="1698.5137">2003</text><polygon fill="#A80036" points="1770,1728.5664,1780,1732.5664,1770,1736.5664,1774,1732.5664" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1388.5" x2="1776" y1="1732.5664" y2="1732.5664"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1395.5" y="1727.8242">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="1417.5" y="1727.8242">Persist Transfer message hash</text><polygon fill="#FFFFE0" filter="url(#fp0flawlv3q2k)" points="1706,1745.5664,1858,1745.5664,1868,1756.5664,1858,1768.5664,1706,1768.5664,1696,1756.5664,1706,1745.5664" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="1708" y="1762.1348">transferDuplicateCheck</text><polygon fill="#A80036" points="430,1791.1875,420,1795.1875,430,1799.1875,426,1795.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1382.5" y1="1795.1875" y2="1795.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="436" y="1790.4453">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="458" y="1790.4453">Return success</text><path d="M325,1824.1875 L467,1824.1875 L467,1831.1875 L457,1841.1875 L325,1841.1875 L325,1824.1875 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1541" x="325" y="1824.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="340" y="1837.7559">Validate Payer</text><polygon fill="#A80036" points="1483,1858.8086,1493,1862.8086,1483,1866.8086,1487,1862.8086" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1489" y1="1862.8086" y2="1862.8086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="1858.0664">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="348" x="448" y="1858.0664">Request to retrieve Payer Participant details (if it exists)</text><polygon fill="#A80036" points="1765,1888.1191,1775,1892.1191,1765,1896.1191,1769,1892.1191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1505" x2="1771" y1="1892.1191" y2="1892.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1512" y="1887.377">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="1534" y="1887.377">Request Participant details</text><polygon fill="#FFFFE0" filter="url(#fp0flawlv3q2k)" points="1718,1905.1191,1846,1905.1191,1856,1924.1191,1846,1943.1191,1718,1943.1191,1708,1924.1191,1718,1905.1191" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1720" y="1921.6875">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="1720" y="1936.998">participantCurrency</text><polygon fill="#A80036" points="1516,1966.0508,1506,1970.0508,1516,1974.0508,1512,1970.0508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1510" x2="1781" y1="1970.0508" y2="1970.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1522" y="1965.3086">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="1544" y="1965.3086">Return Participant details if it exists</text><polygon fill="#A80036" points="430,1995.3613,420,1999.3613,430,2003.3613,426,1999.3613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1499" y1="1999.3613" y2="1999.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="436" y="1994.6191">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="458" y="1994.6191">Return Participant details if it exists</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="2043.9824" y2="2043.9824"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="2043.9824" y2="2056.9824"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="2056.9824" y2="2056.9824"/><polygon fill="#A80036" points="430,2052.9824,420,2056.9824,430,2060.9824,426,2056.9824" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="2031.585">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="448" y="2023.9297">Validate Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="2039.2402">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="2039.2402">3202</text><path d="M325,2078.9824 L469,2078.9824 L469,2085.9824 L459,2095.9824 L325,2095.9824 L325,2078.9824 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="240.7949" style="stroke: #000000; stroke-width: 2.0;" width="1541" x="325" y="2078.9824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="99" x="340" y="2092.5508">Validate Payee</text><polygon fill="#A80036" points="1483,2113.6035,1493,2117.6035,1483,2121.6035,1487,2117.6035" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1489" y1="2117.6035" y2="2117.6035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="2112.8613">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="350" x="448" y="2112.8613">Request to retrieve Payee Participant details (if it exists)</text><polygon fill="#A80036" points="1765,2142.9141,1775,2146.9141,1765,2150.9141,1769,2146.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1505" x2="1771" y1="2146.9141" y2="2146.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1512" y="2142.1719">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="1534" y="2142.1719">Request Participant details</text><polygon fill="#FFFFE0" filter="url(#fp0flawlv3q2k)" points="1718,2159.9141,1846,2159.9141,1856,2178.9141,1846,2197.9141,1718,2197.9141,1708,2178.9141,1718,2159.9141" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="68" x="1720" y="2176.4824">participant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="1720" y="2191.793">participantCurrency</text><polygon fill="#A80036" points="1516,2220.8457,1506,2224.8457,1516,2228.8457,1512,2224.8457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1510" x2="1781" y1="2224.8457" y2="2224.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1522" y="2220.1035">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="1544" y="2220.1035">Return Participant details if it exists</text><polygon fill="#A80036" points="430,2250.1563,420,2254.1563,430,2258.1563,426,2254.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1499" y1="2254.1563" y2="2254.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="436" y="2249.4141">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="226" x="458" y="2249.4141">Return Participant details if it exists</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="2298.7773" y2="2298.7773"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="2298.7773" y2="2311.7773"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="2311.7773" y2="2311.7773"/><polygon fill="#A80036" points="430,2307.7773,420,2311.7773,430,2315.7773,426,2311.7773" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="2286.3799">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="89" x="448" y="2278.7246">Validate Payee</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="2294.0352">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="2294.0352">3203</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="461" y1="2363.3984" y2="2363.3984"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="461" x2="461" y1="2363.3984" y2="2376.3984"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="420" x2="461" y1="2376.3984" y2="2376.3984"/><polygon fill="#A80036" points="430,2372.3984,420,2376.3984,430,2380.3984,426,2376.3984" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="2351.001">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="448" y="2343.3457">Validate crypto-condition</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="2358.6563">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="2358.6563">3100</text><path d="M315,2391.3984 L377,2391.3984 L377,2398.3984 L367,2408.3984 L315,2408.3984 L315,2391.3984 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="581.0977" style="stroke: #000000; stroke-width: 2.0;" width="1562" x="315" y="2391.3984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="330" y="2404.9668">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="206" x="392" y="2404.0332">[Validate Prepare Transfer (success)]</text><path d="M325,2415.709 L797,2415.709 L797,2422.709 L787,2432.709 L325,2432.709 L325,2415.709 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1542" x="325" y="2415.709"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="427" x="340" y="2429.2773">Persist Transfer State (with transferState='RECEIVED-PREPARE')</text><polygon fill="#A80036" points="1366.5,2465.6406,1376.5,2469.6406,1366.5,2473.6406,1370.5,2469.6406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1372.5" y1="2469.6406" y2="2469.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="2457.2432">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="448" y="2449.5879">Request to persist transfer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="2464.8984">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="2464.8984">2003</text><polygon fill="#A80036" points="1765,2494.9512,1775,2498.9512,1765,2502.9512,1769,2498.9512" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1388.5" x2="1771" y1="2498.9512" y2="2498.9512"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1395.5" y="2494.209">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="1417.5" y="2494.209">Persist transfer</text><polygon fill="#FFFFE0" filter="url(#fp0flawlv3q2k)" points="1716,2541.9512,1847,2541.9512,1857,2583.9512,1847,2625.9512,1716,2625.9512,1706,2583.9512,1716,2541.9512" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1718" y="2558.5195">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1718" y="2573.8301">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1718" y="2589.1406">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="1718" y="2604.4512">transferExtension</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57" x="1718" y="2619.7617">ilpPacket</text><polygon fill="#A80036" points="430,2648.8145,420,2652.8145,430,2656.8145,426,2652.8145" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1382.5" y1="2652.8145" y2="2652.8145"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="436" y="2648.0723">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="458" y="2648.0723">Return success</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="315" x2="1877" y1="2668.8145" y2="2668.8145"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="200" x="320" y="2679.4492">[Validate Prepare Transfer (failure)]</text><path d="M325,2689.7695 L1108,2689.7695 L1108,2696.7695 L1098,2706.7695 L325,2706.7695 L325,2689.7695 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="275.7266" style="stroke: #000000; stroke-width: 2.0;" width="1542" x="325" y="2689.7695"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="738" x="340" y="2703.3379">Persist Transfer State (with transferState='INVALID') (Introducing a new status INVALID to mark these entries)</text><polygon fill="#A80036" points="1366.5,2755.0117,1376.5,2759.0117,1366.5,2763.0117,1370.5,2759.0117" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1372.5" y1="2759.0117" y2="2759.0117"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="2738.959">37</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="448" y="2723.6484">Request to persist transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="332" x="448" y="2738.959">(when Payee/Payer/crypto-condition validation fails)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="2754.2695">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="2754.2695">2003</text><polygon fill="#A80036" points="1765,2784.3223,1775,2788.3223,1765,2792.3223,1769,2788.3223" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1388.5" x2="1771" y1="2788.3223" y2="2788.3223"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1395.5" y="2783.5801">38</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="1417.5" y="2783.5801">Persist transfer</text><polygon fill="#FFFFE0" filter="url(#fp0flawlv3q2k)" points="1716,2831.3223,1847,2831.3223,1857,2880.3223,1847,2930.3223,1716,2930.3223,1706,2880.3223,1716,2831.3223" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1718" y="2847.8906">transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1718" y="2863.2012">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1718" y="2878.5117">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="1718" y="2893.8223">transferExtension</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="1718" y="2909.1328">transferError</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="57" x="1718" y="2924.4434">ilpPacket</text><polygon fill="#A80036" points="430,2953.4961,420,2957.4961,430,2961.4961,426,2957.4961" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="424" x2="1382.5" y1="2957.4961" y2="2957.4961"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="436" y="2952.7539">39</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="458" y="2952.7539">Return success</text><path d="M325,2993.4961 L387,2993.4961 L387,3000.4961 L377,3010.4961 L325,3010.4961 L325,2993.4961 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1056.2773" style="stroke: #000000; stroke-width: 2.0;" width="1009" x="325" y="2993.4961"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="340" y="3007.0645">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="206" x="402" y="3006.1309">[Validate Prepare Transfer (success)]</text><path d="M424,3015.8066 L424,3392.8066 L686,3392.8066 L686,3025.8066 L676,3015.8066 L424,3015.8066 " fill="#FFFF00" filter="url(#fp0flawlv3q2k)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M676,3015.8066 L676,3025.8066 L686,3025.8066 L676,3015.8066 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="430" y="3033.375">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="430" y="3048.6855">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="446" y="3063.9961">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="225" x="446" y="3079.3066">from: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="210" x="446" y="3094.6172">to: &lt;transferMessage.payeeFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="446" y="3109.9277">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="446" y="3125.2383">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="462" y="3140.5488">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="462" y="3155.8594">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="446" y="3171.1699">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="446" y="3186.4805">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="462" y="3201.791">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="478" y="3217.1016">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="478" y="3232.4121">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="478" y="3247.7227">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="478" y="3263.0332">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="478" y="3278.3438">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="478" y="3293.6543">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="494" y="3308.9648">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="494" y="3324.2754">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="478" y="3339.5859">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="462" y="3354.8965">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="446" y="3370.207">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="430" y="3385.5176">}</text><polygon fill="#A80036" points="950,3434.8809,960,3438.8809,950,3442.8809,954,3438.8809" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="956" y1="3438.8809" y2="3438.8809"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="3426.4834">40</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="251" x="448" y="3418.8281">Route &amp; Publish Position event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="3434.1387">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="3434.1387">2003</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="325" x2="1334" y1="3477.8809" y2="3477.8809"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="200" x="330" y="3488.5156">[Validate Prepare Transfer (failure)]</text><path d="M424,3496.8359 L424,3965.8359 L1031,3965.8359 L1031,3506.8359 L1021,3496.8359 L424,3496.8359 " fill="#FFFF00" filter="url(#fp0flawlv3q2k)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1021,3496.8359 L1021,3506.8359 L1031,3506.8359 L1021,3496.8359 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="430" y="3514.4043">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="430" y="3529.7148">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="446" y="3545.0254">id: &lt;transferMessage.transferId&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="137" x="446" y="3560.3359">from: &lt;ledgerName&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="208" x="446" y="3575.6465">to: &lt;transferMessage.payerFsp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="446" y="3590.957">type: application/json</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="446" y="3606.2676">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="462" y="3621.5781">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="61" x="462" y="3636.8887">payload: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="126" x="478" y="3652.1992">"errorInformation": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="522" x="494" y="3667.5098">"errorCode": &lt;possible codes: [2003, 3100, 3105, 3106, 3202, 3203, 3300, 3301]&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="392" x="494" y="3682.8203">"errorDescription": "&lt;refer to section 35.1.3 for description&gt;",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="315" x="494" y="3698.1309">"extensionList": &lt;transferMessage.extensionList&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="462" y="3713.4414">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="446" y="3728.752">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="446" y="3744.0625">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="462" y="3759.373">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="478" y="3774.6836">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="478" y="3789.9941">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="112" x="478" y="3805.3047">type: notification,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="98" x="478" y="3820.6152">action: prepare,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="478" y="3835.9258">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="478" y="3851.2363">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="494" y="3866.5469">status: 'error',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="228" x="494" y="3881.8574">code: &lt;errorInformation.errorCode&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="310" x="494" y="3897.168">description: &lt;errorInformation.errorDescription&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="478" y="3912.4785">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="462" y="3927.7891">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="446" y="3943.0996">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="430" y="3958.4102">}</text><polygon fill="#A80036" points="1233.5,4007.7734,1243.5,4011.7734,1233.5,4015.7734,1237.5,4011.7734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="1239.5" y1="4011.7734" y2="4011.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="426" y="3999.376">41</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="448" y="3991.7207">Publish Notification (failure) event for Payer</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="448" y="4007.0313">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="532" y="4007.0313">2003</text><!--
@startuml
title 1.1.1.a. Prepare Handler Consume (single message)

autonumber


collections "Prepare-Topic-dfsp1" as TOPIC_PREPARE_DFSP1
control "Prepare Event Handler" as PREP_HANDLER
collections "Position-Topic-dfsp1" as TOPIC_POSITION_DFSP1
collections "Event-Topic" as TOPIC_EVENTS
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Transfer DAO" as TRANS_DAO
entity "Participant DAO" as PARTICIPANT_DAO
database "Central Store" as DB

box "Central Service" #LightYellow
    participant TOPIC_PREPARE_DFSP1
    participant PREP_HANDLER
    participant TOPIC_POSITION_DFSP1
    participant TOPIC_EVENTS
    participant TOPIC_NOTIFICATIONS
    participant TRANS_DAO
    participant PARTICIPANT_DAO
    participant DB
end box

activate PREP_HANDLER
group Prepare Handler Consume
    TOPIC_PREPARE_DFSP1 <- PREP_HANDLER: Consume Prepare event message for Payer
    activate TOPIC_PREPARE_DFSP1
    deactivate TOPIC_PREPARE_DFSP1

    break
        group Validate Event
            PREP_HANDLER <-> PREP_HANDLER: Validate event - Rule: type == 'prepare' && action == 'prepare'\n<color #FF0000><b>Error codes:</b> 2001</color>
        end
    end

    group Persist Event Information
        |||
        PREP_HANDLER -> TOPIC_EVENTS: Publish event information
        ref over PREP_HANDLER, TOPIC_EVENTS :  Event Handler Consume {9.1.0} \n
        |||
    end

    group Validate Prepare Transfer 
        PREP_HANDLER <-> PREP_HANDLER: <color #AAA>Schema validation of the incoming message</color>
        PREP_HANDLER <-> PREP_HANDLER: <color #AAA>Verify the message's signature (to be confirmed in future requirement)</color>
        note right of PREP_HANDLER #lightgrey
            The above validation steps are already handled by
            the ML-Adapter for the open source implementation.
            It may need to be added in future for custom adapters.
        end note
        group Validate Duplicate check
            PREP_HANDLER -> TRANS_DAO: Request to retrieve Transfer Hash for a transferId
            activate TRANS_DAO
            TRANS_DAO -> DB: Request Transfer Hash for a transferId
            activate DB
            hnote over DB #lightyellow
                transferDuplicateCheck
            end note
            TRANS_DAO <- - DB: Return hash if it exists
            deactivate DB
            PREP_HANDLER <- - TRANS_DAO: Return hash if it exists
            deactivate TRANS_DAO

            alt If transferId exists
                group Persist Event Information
                    |||
                    PREP_HANDLER -> TOPIC_EVENTS: Publish event information
                    ref over PREP_HANDLER, TOPIC_EVENTS :  Event Handler Consume {9.1.0} \n
                    |||
                end
                PREP_HANDLER -> PREP_HANDLER: Generate Hash for the incoming message and compare hashes

                alt Transfer exists, hash matches    
                    PREP_HANDLER -> TRANS_DAO: Request to retrieve Transfer state \n<color #FF0000><b>Error code:</b> 2003</color>
                    activate TRANS_DAO
                    TRANS_DAO -> DB: Request Transfer state
                    hnote over DB #lightyellow
                        transfer
                        transferStateChange
                    end note
                    activate DB
                    TRANS_DAO <- - DB: Return Transfer state
                    deactivate DB
                    TRANS_DAO - -> PREP_HANDLER: Return Transfer state
                    deactivate TRANS_DAO
                    break
                        alt If transferState IN Enumeration ['COMMITTED', 'ABORTED']
                            PREP_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification event for Payer with the completed transer \nFor the Data Model, refer to the Swagger (transerState - mandatory, fulfilment, completedTimestamp).
                        else If transferState in Enumeration ['RECEIVED', 'RESERVED']
                            PREP_HANDLER <-> PREP_HANDLER: This request can be ignored, because a callback is about to be sent to the client.
                        else If transferState doesn't exist
                            PREP_HANDLER -> TOPIC_NOTIFICATIONS: Send /error callback with appropriate error message\n(Invalid duplicate request)\n<color #FF0000><b>Error code:</b> 3100</color>
                        end
                    end
                else Transfer exists, hash does not match
                    break
                        PREP_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification (failure) event for Payer\n<color #FF0000><b>Error codes:</b> 3106</color> \nFor the Data Model, refer to the final step in this diagram (has the same text).
                    end
                end

            else If transferId does NOT exist
                PREP_HANDLER -> TRANS_DAO: Request to persist Transfer Hash \n<color #FF0000><b>Error code:</b> 2003</color>
                activate TRANS_DAO
                TRANS_DAO -> DB: Persist Transfer message hash
                hnote over DB #lightyellow
                    transferDuplicateCheck
                end note
                TRANS_DAO - -> PREP_HANDLER: Return success
                deactivate TRANS_DAO
            end
            deactivate TRANS_DAO
            
        end

        group Validate Payer
            PREP_HANDLER -> PARTICIPANT_DAO: Request to retrieve Payer Participant details (if it exists)
            activate PARTICIPANT_DAO
            PARTICIPANT_DAO -> DB: Request Participant details
            hnote over DB #lightyellow
                participant
                participantCurrency
            end note
            activate DB
            PARTICIPANT_DAO <- - DB: Return Participant details if it exists
            deactivate DB
            PARTICIPANT_DAO - -> PREP_HANDLER: Return Participant details if it exists
            deactivate PARTICIPANT_DAO
            PREP_HANDLER <-> PREP_HANDLER: Validate Payer\n<color #FF0000><b>Error codes:</b> 3202</color>
        end
        group Validate Payee
            PREP_HANDLER -> PARTICIPANT_DAO: Request to retrieve Payee Participant details (if it exists)
            activate PARTICIPANT_DAO
            PARTICIPANT_DAO -> DB: Request Participant details
            hnote over DB #lightyellow
                participant
                participantCurrency
            end note
            activate DB
            PARTICIPANT_DAO <- - DB: Return Participant details if it exists
            deactivate DB
            PARTICIPANT_DAO - -> PREP_HANDLER: Return Participant details if it exists
            deactivate PARTICIPANT_DAO
            PREP_HANDLER <-> PREP_HANDLER: Validate Payee\n<color #FF0000><b>Error codes:</b> 3203</color>
        end
        PREP_HANDLER <-> PREP_HANDLER: Validate crypto-condition\n<color #FF0000><b>Error codes:</b> 3100</color>
        
        alt Validate Prepare Transfer (success)
            group Persist Transfer State (with transferState='RECEIVED-PREPARE')
                PREP_HANDLER -> TRANS_DAO: Request to persist transfer\n<color #FF0000><b>Error codes:</b> 2003</color>
                activate TRANS_DAO
                TRANS_DAO -> DB: Persist transfer
                hnote over DB #lightyellow
                    transfer
                    transferParticipant
                    transferStateChange
                    transferExtension
                    ilpPacket
                end note
                activate DB
                deactivate DB
                TRANS_DAO - -> PREP_HANDLER: Return success
                deactivate TRANS_DAO
            end
        else Validate Prepare Transfer (failure)
            group Persist Transfer State (with transferState='INVALID') (Introducing a new status INVALID to mark these entries)
                PREP_HANDLER -> TRANS_DAO: Request to persist transfer\n(when Payee/Payer/crypto-condition validation fails)\n<color #FF0000><b>Error codes:</b> 2003</color>
                activate TRANS_DAO
                TRANS_DAO -> DB: Persist transfer
                hnote over DB #lightyellow
                    transfer
                    transferParticipant
                    transferStateChange
                    transferExtension
                    transferError
                    ilpPacket
                end note
                activate DB
                deactivate DB
                TRANS_DAO - -> PREP_HANDLER: Return success
                deactivate TRANS_DAO
            end
        end

    end
    alt Validate Prepare Transfer (success)
        note right of PREP_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <transferMessage.payerFsp>,
                to: <transferMessage.payeeFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: <transferMessage>
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: position,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: "success",
                            code: 0
                        }
                    }
                }
            }
        end note
        PREP_HANDLER -> TOPIC_POSITION_DFSP1: Route & Publish Position event for Payer\n<color #FF0000><b>Error codes:</b> 2003</color>
        activate TOPIC_POSITION_DFSP1
        deactivate TOPIC_POSITION_DFSP1
    else Validate Prepare Transfer (failure)
        note right of PREP_HANDLER #yellow
            Message:
            {
                id: <transferMessage.transferId>
                from: <ledgerName>,
                to: <transferMessage.payerFsp>,
                type: application/json
                content: {
                    headers: <transferHeaders>,
                    payload: {
                        "errorInformation": {
                            "errorCode": <possible codes: [2003, 3100, 3105, 3106, 3202, 3203, 3300, 3301]>
                            "errorDescription": "<refer to section 35.1.3 for description>",
                            "extensionList": <transferMessage.extensionList>
                    }
                },
                metadata: {
                    event: {
                        id: <uuid>,
                        responseTo: <previous.uuid>,
                        type: notification,
                        action: prepare,
                        createdAt: <timestamp>,
                        state: {
                            status: 'error',
                            code: <errorInformation.errorCode>
                            description: <errorInformation.errorDescription>
                        }
                    }
                }
            }
        end note
        PREP_HANDLER -> TOPIC_NOTIFICATIONS: Publish Notification (failure) event for Payer\n<color #FF0000><b>Error codes:</b> 2003</color>
        activate TOPIC_NOTIFICATIONS
        deactivate TOPIC_NOTIFICATIONS
    end
end
deactivate PREP_HANDLER
@enduml

PlantUML version 1.2018.03(Thu Apr 05 22:29:15 IST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_151-b12
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>