<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3707px" preserveAspectRatio="none" style="width:1466px;height:3707px;" version="1.1" viewBox="0 0 1466 3707" width="1466px" zoomAndPan="magnify"><defs><filter height="300%" id="f1w7bbb0gqy0ff" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="357" x="555.5" y="23.5352">6.2.1. Trigger Settlement Event (createSettlement)</text><rect fill="#FFB6C1" height="3662.3535" style="stroke: #A80036; stroke-width: 1.0;" width="112" x="75" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="81" x="90.5" y="47.0566">Central HUB</text><rect fill="#90EE90" height="3662.3535" style="stroke: #A80036; stroke-width: 1.0;" width="370.5" x="318.5" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="441.75" y="47.0566">Settlement Service</text><rect fill="#FFFFE0" height="3662.3535" style="stroke: #A80036; stroke-width: 1.0;" width="114" x="1061" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="1064" y="47.0566">Central Services</text><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="3431.0664" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="126" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="3193.0293" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="396" y="385.3242"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="182.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="623" y="429.9453"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="1995.3965" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="623" y="899.1563"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="459.2559"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="992.0879"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="1099.3301"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="1207.2617"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="246.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="1544.8516"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="1820.5098"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="2031.3047"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="2154.5469"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="2350.0313"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="2473.2734"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="2611.1367"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="2741.3789"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="3439.0664" style="stroke: #000000; stroke-width: 2.0;" width="1442" x="13" y="154.2871"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="203.7949" style="stroke: #000000; stroke-width: 2.0;" width="646" x="391" y="627.4297"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="102.5527" style="stroke: #000000; stroke-width: 2.0;" width="303" x="401" y="721.6719"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="2741.1289" style="stroke: #000000; stroke-width: 2.0;" width="1422" x="23" y="845.2246"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="1798.9121" style="stroke: #000000; stroke-width: 2.0;" width="874" x="561" y="914.1563"/><rect fill="#FFFFFF" height="186.4844" style="stroke: none; stroke-width: 1.0;" width="1422" x="23" y="3399.8691"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="131" x2="131" y1="137.2871" y2="3610.3535"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="400.5" x2="400.5" y1="137.2871" y2="3610.3535"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="628" x2="628" y1="137.2871" y2="3610.3535"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1118" x2="1118" y1="137.2871" y2="3610.3535"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="79" y="134.334">Hub Employee</text><ellipse cx="131" cy="63.7988" fill="#FEFECE" filter="url(#f1w7bbb0gqy0ff)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M131,71.7988 L131,98.7988 M118,79.7988 L144,79.7988 M131,98.7988 L118,113.7988 M131,98.7988 L144,113.7988 " fill="none" filter="url(#f1w7bbb0gqy0ff)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="79" y="3622.8887">Hub Employee</text><ellipse cx="131" cy="3635.8418" fill="#FEFECE" filter="url(#f1w7bbb0gqy0ff)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M131,3643.8418 L131,3670.8418 M118,3651.8418 L144,3651.8418 M131,3670.8418 L118,3685.8418 M131,3670.8418 L144,3685.8418 " fill="none" filter="url(#f1w7bbb0gqy0ff)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="322.5" y="134.334">Settlement Service API</text><path d="M380.5,92.7988 L380.5,116.7988 M380.5,104.7988 L397.5,104.7988 " fill="none" filter="url(#f1w7bbb0gqy0ff)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="409.5" cy="104.7988" fill="#FEFECE" filter="url(#f1w7bbb0gqy0ff)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="151" x="322.5" y="3622.8887">Settlement Service API</text><path d="M380.5,3629.8418 L380.5,3653.8418 M380.5,3641.8418 L397.5,3641.8418 " fill="none" filter="url(#f1w7bbb0gqy0ff)" style="stroke: #A80036; stroke-width: 2.0;"/><ellipse cx="409.5" cy="3641.8418" fill="#FEFECE" filter="url(#f1w7bbb0gqy0ff)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="571" y="134.334">Settlement DAO</text><ellipse cx="628" cy="104.7988" fill="#FEFECE" filter="url(#f1w7bbb0gqy0ff)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="616" x2="640" y1="118.7988" y2="118.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="108" x="571" y="3622.8887">Settlement DAO</text><ellipse cx="628" cy="3641.8418" fill="#FEFECE" filter="url(#f1w7bbb0gqy0ff)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="616" x2="640" y1="3655.8418" y2="3655.8418"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1070" y="134.334">Central Store</text><path d="M1100,84.7988 C1100,74.7988 1118,74.7988 1118,74.7988 C1118,74.7988 1136,74.7988 1136,84.7988 L1136,110.7988 C1136,120.7988 1118,120.7988 1118,120.7988 C1118,120.7988 1100,120.7988 1100,110.7988 L1100,84.7988 " fill="#FEFECE" filter="url(#f1w7bbb0gqy0ff)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1100,84.7988 C1100,94.7988 1118,94.7988 1118,94.7988 C1118,94.7988 1136,94.7988 1136,84.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1070" y="3622.8887">Central Store</text><path d="M1100,3635.8418 C1100,3625.8418 1118,3625.8418 1118,3625.8418 C1118,3625.8418 1136,3625.8418 1136,3635.8418 L1136,3661.8418 C1136,3671.8418 1118,3671.8418 1118,3671.8418 C1118,3671.8418 1100,3671.8418 1100,3661.8418 L1100,3635.8418 " fill="#FEFECE" filter="url(#f1w7bbb0gqy0ff)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1100,3635.8418 C1100,3645.8418 1118,3645.8418 1118,3645.8418 C1118,3645.8418 1136,3645.8418 1136,3635.8418 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="3431.0664" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="126" y="147.2871"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="3193.0293" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="396" y="385.3242"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="182.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="623" y="429.9453"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="1995.3965" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="623" y="899.1563"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="459.2559"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="992.0879"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="1099.3301"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="1207.2617"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="246.3477" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="1544.8516"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="1820.5098"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="2031.3047"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="2154.5469"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="2350.0313"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="108.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="2473.2734"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="2611.1367"/><rect fill="#FFFFFF" filter="url(#f1w7bbb0gqy0ff)" height="123.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1113" y="2741.3789"/><path d="M13,154.2871 L227,154.2871 L227,161.2871 L217,171.2871 L13,171.2871 L13,154.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3439.0664" style="stroke: #000000; stroke-width: 2.0;" width="1442" x="13" y="154.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="169" x="28" y="167.8555">Trigger Settlement Event</text><path d="M141,176.5977 L141,354.5977 L323,354.5977 L323,186.5977 L313,176.5977 L141,176.5977 " fill="#FFFF00" filter="url(#f1w7bbb0gqy0ff)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M313,176.5977 L313,186.5977 L323,186.5977 L313,176.5977 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="147" y="194.166">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="163" y="209.4766">"reason": "string",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="163" y="224.7871">"settlementWindows": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="240.0977">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="195" y="255.4082">"id": 1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="179" y="270.7188">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="286.0293">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="42" x="195" y="301.3398">"id": 2,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="179" y="316.6504">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="163" y="331.9609">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="147" y="347.2715">}</text><polygon fill="#A80036" points="384,381.3242,394,385.3242,384,389.3242,388,385.3242" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="136" x2="390" y1="385.3242" y2="385.3242"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="143" y="380.582">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="156" y="380.582">POST - /settlements</text><polygon fill="#A80036" points="611,425.9453,621,429.9453,611,433.9453,615,429.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="406" x2="617" y1="429.9453" y2="429.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="413" y="417.5479">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="426" y="409.8926">Request settlementWindow(s)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="426" y="425.2031">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="503" y="425.2031">2001</text><polygon fill="#A80036" points="1101,455.2559,1111,459.2559,1101,463.2559,1105,459.2559" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="1107" y1="459.2559" y2="459.2559"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="640" y="454.5137">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="185" x="653" y="454.5137">Retrieve settlementWindow(s)</text><polygon fill="#FFFFE0" filter="url(#f1w7bbb0gqy0ff)" points="864,472.2559,1372,472.2559,1382,514.2559,1372,556.2559,864,556.2559,854,514.2559,864,472.2559" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="504" x="866" y="488.8242">SELECT sw.settlementWindowId, swsc.settlementWindowStateId, sw.createdDate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="866" y="504.1348">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="906" y="504.1348">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="17" x="1035" y="504.1348">sw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="866" y="519.4453">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="898" y="519.4453">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="31" x="1112" y="519.4453">swsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="439" x="866" y="534.7559">ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="441" x="866" y="550.0664">WHERE sw.settlementWindowId IN {payload.settlementWindows.idList}</text><polygon fill="#A80036" points="644,579.1191,634,583.1191,644,587.1191,640,583.1191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="638" x2="1117" y1="583.1191" y2="583.1191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="650" y="578.377">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="663" y="578.377">Return data</text><polygon fill="#A80036" points="417,608.4297,407,612.4297,417,616.4297,413,612.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="411" x2="627" y1="612.4297" y2="612.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="423" y="607.6875">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="436" y="607.6875">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="90" x="481" y="607.6875">windowsData</text><path d="M391,627.4297 L794,627.4297 L794,634.4297 L784,644.4297 L391,644.4297 L391,627.4297 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="203.7949" style="stroke: #000000; stroke-width: 2.0;" width="646" x="391" y="627.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="358" x="406" y="640.998">Validate all requested windows are found and closed</text><path d="M411,649.7402 L411,704.7402 L1023,704.7402 L1023,659.7402 L1013,649.7402 L411,649.7402 " fill="#D3D3D3" filter="url(#f1w7bbb0gqy0ff)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M1013,649.7402 L1013,659.7402 L1023,659.7402 L1013,649.7402 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="591" x="417" y="667.3086">let allSettlementWindowsFound = payload.settlementWindows.length == windowsData.length</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="244" x="417" y="682.6191">let allSettlementWindowsClosed = true</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="417" y="697.9297">let settlementWindow</text><path d="M401,721.6719 L475,721.6719 L475,728.6719 L465,738.6719 L401,738.6719 L401,721.6719 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="102.5527" style="stroke: #000000; stroke-width: 2.0;" width="303" x="401" y="721.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="29" x="416" y="735.2402">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="111" x="490" y="734.3066">[w IN windowsData]</text><path d="M411,743.9824 L411,814.9824 L690,814.9824 L690,753.9824 L680,743.9824 L411,743.9824 " fill="#D3D3D3" filter="url(#f1w7bbb0gqy0ff)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M680,743.9824 L680,753.9824 L690,753.9824 L680,743.9824 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="236" x="417" y="761.5508">settlementWindow = windowsData[w]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="417" y="776.8613">if (settlementWindow.state != 'CLOSED') {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="229" x="433" y="792.1719">allSettlementWindowsClosed = false</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="417" y="807.4824">}</text><path d="M23,845.2246 L85,845.2246 L85,852.2246 L75,862.2246 L23,862.2246 L23,845.2246 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2741.1289" style="stroke: #000000; stroke-width: 2.0;" width="1422" x="23" y="845.2246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="858.793">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="348" x="100" y="857.8594">[allSettlementWindowsFound &amp;&amp; allSettlementWindowsClosed]</text><polygon fill="#A80036" points="611,895.1563,621,899.1563,611,903.1563,615,899.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="406" x2="617" y1="899.1563" y2="899.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="413" y="886.7588">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="426" y="879.1035">Create settlement</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="426" y="894.4141">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="503" y="894.4141">2001</text><path d="M561,914.1563 L726,914.1563 L726,921.1563 L716,931.1563 L561,931.1563 L561,914.1563 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1798.9121" style="stroke: #000000; stroke-width: 2.0;" width="874" x="561" y="914.1563"/><text fill="#0000FF" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="120" x="576" y="927.7246">DB TRANSACTION</text><path d="M638,936.4668 L638,961.4668 L883,961.4668 L883,946.4668 L873,936.4668 L638,936.4668 " fill="#D3D3D3" filter="url(#f1w7bbb0gqy0ff)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M873,936.4668 L873,946.4668 L883,946.4668 L873,936.4668 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="16" x="644" y="954.0352">let</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="664" y="954.0352">transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="48" x="820" y="954.0352">= now()</text><polygon fill="#A80036" points="1101,988.0879,1111,992.0879,1101,996.0879,1105,992.0879" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="1107" y1="992.0879" y2="992.0879"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="640" y="987.3457">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="136" x="653" y="987.3457">Insert new settlement</text><polygon fill="#FFFFE0" filter="url(#f1w7bbb0gqy0ff)" points="956,1005.0879,1279,1005.0879,1289,1024.0879,1279,1043.0879,956,1043.0879,946,1024.0879,956,1005.0879" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="958" y="1021.6563">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="1042" y="1021.6563">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="133" x="1118" y="1021.6563">(reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="319" x="958" y="1036.9668">VALUES ({payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="644,1066.0195,634,1070.0195,644,1074.0195,640,1070.0195" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="638" x2="1117" y1="1070.0195" y2="1070.0195"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="650" y="1065.2773">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="663" y="1065.2773">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="85" x="708" y="1065.2773">settlementId</text><polygon fill="#A80036" points="1101,1095.3301,1111,1099.3301,1101,1103.3301,1105,1099.3301" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="1107" y1="1099.3301" y2="1099.3301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="640" y="1094.5879">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="317" x="653" y="1094.5879">Associate settlement windows with the settlement</text><polygon fill="#FFFFE0" filter="url(#f1w7bbb0gqy0ff)" points="820,1142.3301,1415,1142.3301,1425,1161.3301,1415,1180.3301,820,1180.3301,810,1161.3301,820,1142.3301" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="822" y="1158.8984">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="906" y="1158.8984">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="1107" y="1158.8984">(settlementId, settlementWindowId, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="534" x="822" y="1174.209">VALUES ({settlementId}, {payload.settlementWindows.idList}, {transactionTimestamp})</text><polygon fill="#A80036" points="1101,1203.2617,1111,1207.2617,1101,1211.2617,1105,1207.2617" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="1107" y1="1207.2617" y2="1207.2617"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="640" y="1202.5195">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="380" x="662" y="1202.5195">Populate settlementTransferParticipant with aggregated data</text><polygon fill="#FFFFE0" filter="url(#f1w7bbb0gqy0ff)" points="871,1250.2617,1364,1250.2617,1374,1384.2617,1364,1518.2617,871,1518.2617,861,1384.2617,871,1250.2617" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="873" y="1266.8301">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="203" x="957" y="1266.8301">settlementTransferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="367" x="901" y="1282.1406">(settlementId, settlementWindowId, participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="449" x="905" y="1297.4512">transferParticipantRoleTypeId, ledgerEntryTypeId, amount, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="485" x="873" y="1312.7617">SELECT ssw.settlementId, ssw.settlementWindowId, tp.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="452" x="901" y="1328.0723">tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId, SUM(tp.amount),</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="149" x="901" y="1343.3828">{transactionTimestamp}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="873" y="1358.6934">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="197" x="913" y="1358.6934">settlementSettlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="24" x="1114" y="1358.6934">ssw</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="873" y="1374.0039">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="122" x="905" y="1374.0039">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="30" x="1031" y="1374.0039">AS tf</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="873" y="1389.3145">ON tf.settlementWindowId = ssw.settlementWindowId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="873" y="1404.625">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="139" x="905" y="1404.625">transferStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="39" x="1048" y="1404.625">AS tsc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="873" y="1419.9355">ON tsc.transferId = tf.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="873" y="1435.2461">AND tsc.transferStateId = ‘COMMITTED’</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="873" y="1450.5566">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="127" x="905" y="1450.5566">transferParticipant</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="33" x="1036" y="1450.5566">AS tp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="195" x="873" y="1465.8672">ON tp.transferId = tf.transferId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="873" y="1481.1777">WHERE ssw.settlementId = {settlementId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="387" x="873" y="1496.4883">GROUP BY ssw.settlementWindowId, tp.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="340" x="909" y="1511.7988">tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId</text><polygon fill="#A80036" points="1101,1540.8516,1111,1544.8516,1101,1548.8516,1105,1544.8516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="1107" y1="1544.8516" y2="1544.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="640" y="1540.1094">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="384" x="662" y="1540.1094">Populate settlementParticipantCurrency with aggregated data</text><polygon fill="#FFFFE0" filter="url(#f1w7bbb0gqy0ff)" points="896,1557.8516,1339,1557.8516,1349,1660.8516,1339,1764.8516,896,1764.8516,886,1660.8516,896,1557.8516" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="898" y="1574.4199">INSERT INTO settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="392" x="926" y="1589.7305">(settlementId, participantCurrencyId, createdDate, netAmount)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="433" x="898" y="1605.041">SELECT settlementId, participantCurrencyId, {transactionTimestamp},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="63" x="898" y="1620.3516">SUM(CASE</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="354" x="914" y="1635.6621">WHEN stp.transferParticipantRoleTypeId = {PAYER_DFSP}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="397" x="930" y="1650.9727">AND stp.ledgerEntryTypeId = {PRINCIPLE_VALUE} THEN amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="353" x="914" y="1666.2832">WHEN stp.transferParticipantRoleTypeId = {PAYEE_DFSP}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="405" x="930" y="1681.5938">AND stp.ledgerEntryTypeId = {PRINCIPLE_VALUE} THEN -amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="423" x="914" y="1696.9043">WHEN stp.ledgerEntryTypeId = {INTERCHANGE_FEE} THEN -amount</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="385" x="914" y="1712.2148">WHEN stp.ledgerEntryTypeId = {HUB_FEE} THEN amount END)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="270" x="898" y="1727.5254">FROM settlementTransferParticipant AS stp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="898" y="1742.8359">WHERE settlementId = {settlementId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="898" y="1758.1465">GROUP BY settlementId, participantCurrencyId</text><polygon fill="#A80036" points="644,1787.1992,634,1791.1992,644,1795.1992,640,1791.1992" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="638" x2="1117" y1="1791.1992" y2="1791.1992"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="650" y="1786.457">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="672" y="1786.457">Return inserted</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="244" x="772" y="1786.457">settlementParticipantCurrencyIdList</text><polygon fill="#A80036" points="1101,1816.5098,1111,1820.5098,1101,1824.5098,1105,1820.5098" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="1107" y1="1820.5098" y2="1820.5098"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="640" y="1815.7676">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="397" x="662" y="1815.7676">Insert initial settlement accounts state 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f1w7bbb0gqy0ff)" points="871,1833.5098,1364,1833.5098,1374,1867.5098,1364,1902.5098,871,1902.5098,861,1867.5098,871,1833.5098" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="873" y="1850.0781">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="292" x="957" y="1850.0781">settlementParticipantCurrencyStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="461" x="901" y="1865.3887">(settlementParticipantCurrencyId, settlementStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="450" x="873" y="1880.6992">VALUES ({settlementParticipantCurrencyIdList}, 'PENDING_SETTLEMENT',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="901" y="1896.0098">{payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="644,1925.0625,634,1929.0625,644,1933.0625,640,1929.0625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="638" x2="1117" y1="1929.0625" y2="1929.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="650" y="1924.3203">14</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="672" y="1924.3203">Return inserted</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="329" x="772" y="1924.3203">settlementParticipantCurrencyStateChangeIdList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="675" y1="1988.9941" y2="1988.9941"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="675" x2="675" y1="1988.9941" y2="2001.9941"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="634" x2="675" y1="2001.9941" y2="2001.9941"/><polygon fill="#A80036" points="644,1997.9941,634,2001.9941,644,2005.9941,640,2001.9941" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="640" y="1968.9414">15</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="345" x="662" y="1953.6309">Merge settlementParticipantCurrencyStateChangeIdList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="312" x="662" y="1968.9414">to settlementParticipantCurrencyIdList in order to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="311" x="662" y="1984.252">issue the following update in one knex command</text><polygon fill="#A80036" points="1101,2027.3047,1111,2031.3047,1101,2035.3047,1105,2031.3047" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="1107" y1="2031.3047" y2="2031.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="640" y="2026.5625">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="662" y="2026.5625">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#f1w7bbb0gqy0ff)" points="866,2074.3047,1370,2074.3047,1380,2100.3047,1370,2127.3047,866,2127.3047,856,2100.3047,866,2074.3047" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="868" y="2090.873">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="922" y="2090.873">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="490" x="868" y="2106.1836">SET currentStateChangeId = {settlementParticipantCurrencyStateChangeIdList}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="500" x="868" y="2121.4941">WHERE settlementParticipantCurrencyId = {settlementParticipantCurrencyIdList}</text><polygon fill="#A80036" points="1101,2150.5469,1111,2154.5469,1101,2158.5469,1105,2154.5469" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="1107" y1="2154.5469" y2="2154.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="640" y="2149.8047">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="396" x="662" y="2149.8047">Insert new state for settlementWindow 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f1w7bbb0gqy0ff)" points="884,2167.5469,1352,2167.5469,1362,2201.5469,1352,2236.5469,884,2236.5469,874,2201.5469,884,2167.5469" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="886" y="2184.1152">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="210" x="970" y="2184.1152">settlementWindowStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="436" x="914" y="2199.4258">(settlementWindowId, settlementWindowStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="440" x="886" y="2214.7363">VALUES ({payload.settlementWindows.idList}, 'PENDING_SETTLEMENT',</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="914" y="2230.0469">{payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="644,2259.0996,634,2263.0996,644,2267.0996,640,2263.0996" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="638" x2="1117" y1="2263.0996" y2="2263.0996"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="650" y="2258.3574">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="672" y="2258.3574">Return inserted</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="247" x="772" y="2258.3574">settlementWindowStateChangeIdList</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="675" y1="2307.7207" y2="2307.7207"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="675" x2="675" y1="2307.7207" y2="2320.7207"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="634" x2="675" y1="2320.7207" y2="2320.7207"/><polygon fill="#A80036" points="644,2316.7207,634,2320.7207,644,2324.7207,640,2320.7207" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="640" y="2295.3232">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="271" x="662" y="2287.668">Merge settlementWindowStateChangeIdList</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="232" x="662" y="2302.9785">to payload.settlementWindows.idList</text><polygon fill="#A80036" points="1101,2346.0313,1111,2350.0313,1101,2354.0313,1105,2350.0313" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="1107" y1="2350.0313" y2="2350.0313"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="640" y="2345.2891">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="662" y="2345.2891">Update pointers to current state change ids</text><polygon fill="#FFFFE0" filter="url(#f1w7bbb0gqy0ff)" points="871,2393.0313,1365,2393.0313,1375,2419.0313,1365,2446.0313,871,2446.0313,861,2419.0313,871,2393.0313" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="873" y="2409.5996">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="125" x="927" y="2409.5996">settlementWindow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="416" x="873" y="2424.9102">SET currentStateChangeId = {settlementWindowStateChangeIdList}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="490" x="873" y="2440.2207">WHERE settlementParticipantCurrencyId = {payload.settlementWindows.idList}</text><polygon fill="#A80036" points="1101,2469.2734,1111,2473.2734,1101,2477.2734,1105,2473.2734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="1107" y1="2473.2734" y2="2473.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="640" y="2468.5313">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="358" x="662" y="2468.5313">Insert initial state for settlement 'PENDING_SETTLEMENT'</text><polygon fill="#FFFFE0" filter="url(#f1w7bbb0gqy0ff)" points="933,2486.2734,1303,2486.2734,1313,2520.2734,1303,2555.2734,933,2555.2734,923,2520.2734,933,2486.2734" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="80" x="935" y="2502.8418">INSERT INTO</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="157" x="1019" y="2502.8418">settlementStateChange</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="338" x="963" y="2518.1523">(settlementId, settlementStateId, reason, createdDate)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="935" y="2533.4629">VALUES ({settlementId}, ‘PENDING_SETTLEMENT’,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="264" x="963" y="2548.7734">{payload.reason}, {transactionTimestamp})</text><polygon fill="#A80036" points="644,2577.8262,634,2581.8262,644,2585.8262,640,2581.8262" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="638" x2="1117" y1="2581.8262" y2="2581.8262"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="650" y="2577.084">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="672" y="2577.084">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="717" y="2577.084">settlementStateChangeId</text><polygon fill="#A80036" points="1101,2607.1367,1111,2611.1367,1101,2615.1367,1105,2611.1367" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="1107" y1="2611.1367" y2="2611.1367"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="640" y="2606.3945">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="259" x="662" y="2606.3945">Update pointer to current state change id</text><polygon fill="#FFFFE0" filter="url(#f1w7bbb0gqy0ff)" points="944,2654.1367,1292,2654.1367,1302,2680.1367,1292,2707.1367,944,2707.1367,934,2680.1367,944,2654.1367" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="946" y="2670.7051">UPDATE</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="1000" y="2670.7051">settlement</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="344" x="946" y="2686.0156">SET currentStateChangeId = {settlementStateChangeId}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="231" x="946" y="2701.3262">WHERE settlementId = {settlementId}</text><polygon fill="#A80036" points="1101,2737.3789,1111,2741.3789,1101,2745.3789,1105,2741.3789" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="633" x2="1107" y1="2741.3789" y2="2741.3789"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="640" y="2736.6367">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="205" x="662" y="2736.6367">Select account data for response</text><polygon fill="#FFFFE0" filter="url(#f1w7bbb0gqy0ff)" points="858,2754.3789,1377,2754.3789,1387,2796.3789,1377,2838.3789,858,2838.3789,848,2796.3789,858,2754.3789" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="515" x="860" y="2770.9473">SELECT pc.participantId, spc.participantCurrencyId, spc.netAmount, pc.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="860" y="2786.2578">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="207" x="900" y="2786.2578">settlementParticipantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="22" x="1111" y="2786.2578">spc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="28" x="860" y="2801.5684">JOIN</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="136" x="892" y="2801.5684">participantCurrency</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="1032" y="2801.5684">pc</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="359" x="860" y="2816.8789">ON pc.participantCurrencyId = spc.participantCurrencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="257" x="860" y="2832.1895">WHERE spc.settlementId = {settlementId}</text><polygon fill="#A80036" points="644,2861.2422,634,2865.2422,644,2869.2422,640,2865.2422" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="638" x2="1117" y1="2865.2422" y2="2865.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="650" y="2860.5">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="41" x="672" y="2860.5">Return</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="84" x="717" y="2860.5">accountData</text><polygon fill="#A80036" points="417,2890.5527,407,2894.5527,417,2898.5527,413,2894.5527" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="411" x2="627" y1="2894.5527" y2="2894.5527"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="423" y="2889.8105">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="445" y="2889.8105">Construct and return result</text><path d="M33,2907.5527 L33,3361.5527 L387,3361.5527 L387,2917.5527 L377,2907.5527 L33,2907.5527 " fill="#FFFF00" filter="url(#f1w7bbb0gqy0ff)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M377,2907.5527 L377,2917.5527 L387,2917.5527 L377,2907.5527 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="39" y="2925.1211">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="55" y="2940.4316">"id": settlementId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="55" y="2955.7422">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="55" y="2971.0527">"settlementWindows": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="71" y="2986.3633">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="273" x="87" y="3001.6738">"id": windowsData.settlementWindowIdList,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="87" y="3016.9844">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="87" y="3032.2949">"reason": payload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="87" y="3047.6055">"createdDate": windowsData.createdDateList,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="87" y="3062.916">"changedDate": transactionTimestamp</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="71" y="3078.2266">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="55" y="3093.5371">],</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="97" x="55" y="3108.8477">"participants": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="71" y="3124.1582">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="197" x="87" y="3139.4688">"id": accountData.participantId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="87" y="3154.7793">"accounts": [</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="103" y="3170.0898">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="119" y="3185.4004">"id": accountData.participantCurrencyId,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="119" y="3200.7109">"state": "PENDING_SETTLEMENT",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="119" y="3216.0215">"reason": payload.reason,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="119" y="3231.332">"netSettlementAmount": {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="135" y="3246.6426">"amount": accountData.netAmount,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="221" x="135" y="3261.9531">"currency": accountData.currencyId</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="119" y="3277.2637">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="103" y="3292.5742">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="87" y="3307.8848">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="71" y="3323.1953">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="55" y="3338.5059">]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="39" y="3353.8164">}</text><polygon fill="#A80036" points="147,3387.8691,137,3391.8691,147,3395.8691,143,3391.8691" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="141" x2="395" y1="3391.8691" y2="3391.8691"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="153" y="3387.127">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="175" y="3387.127">Respond HTTP - 201 (Created)</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1445" y1="3400.8691" y2="3400.8691"/><path d="M411,3406.8691 L411,3431.8691 L538,3431.8691 L538,3416.8691 L528,3406.8691 L411,3406.8691 " fill="#D3D3D3" filter="url(#f1w7bbb0gqy0ff)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M528,3406.8691 L528,3416.8691 L538,3416.8691 L528,3406.8691 " fill="#D3D3D3" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="106" x="417" y="3424.4375">Log ERROR event</text><path d="M57,3446.1797 L57,3547.1797 L387,3547.1797 L387,3456.1797 L377,3446.1797 L57,3446.1797 " fill="#FFFF00" filter="url(#f1w7bbb0gqy0ff)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M377,3446.1797 L377,3456.1797 L387,3456.1797 L377,3446.1797 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="63" y="3463.748">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="79" y="3479.0586">errorInformation: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="95" y="3494.3691">"errorCode": &lt;integer&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="95" y="3509.6797">"errorDescription": "Client error description"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="79" y="3524.9902">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="63" y="3540.3008">}</text><polygon fill="#A80036" points="142,3574.3535,132,3578.3535,142,3582.3535,138,3578.3535" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="136" x2="400" y1="3578.3535" y2="3578.3535"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="148" y="3573.6113">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="214" x="170" y="3573.6113">Respond HTTP - 4xx (Client error)</text><!--
@startuml
title 6.2.1. Trigger Settlement Event (createSettlement)
autonumber

actor "Hub Employee" as OPERATOR
boundary "Settlement Service API" as SSAPI
entity "Settlement DAO" as SETTLE_DAO
database "Central Store" as DB

box "Central HUB" #lightpink
    participant OPERATOR
end box

box "Settlement Service" #lightgreen
    participant SSAPI
    participant SETTLE_DAO
end box

box "Central Services" #lightyellow
    participant DB
end box

group Trigger Settlement Event
activate OPERATOR
    note right of OPERATOR #yellow
        {
            "reason": "string",
            "settlementWindows": [
                {
                    "id": 1,
                },
                {
                    "id": 2,
                }
            ]
        }
    end note
    OPERATOR -> SSAPI: POST - /settlements
    activate SSAPI

    SSAPI-> SETTLE_DAO: Request settlementWindow(s)\n<color #FF0000><b>Error code:</b> 2001</color>
    activate SETTLE_DAO
    SETTLE_DAO -> DB: Retrieve settlementWindow(s)
    activate DB
    hnote over DB #lightyellow
        SELECT sw.settlementWindowId, swsc.settlementWindowStateId, sw.createdDate
        FROM **settlementWindow** sw
        JOIN **settlementWindowStateChange** swsc
        ON swsc.settlementWindowStateChangeId = sw.currentStateChangeId
        WHERE sw.settlementWindowId IN {payload.settlementWindows.idList}
    end hnote
    SETTLE_DAO <- - DB: Return data
    deactivate DB
    SSAPI <- - SETTLE_DAO: Return **windowsData**
    deactivate SETTLE_DAO

    group Validate all requested windows are found and closed
        note right of SSAPI #lightgray
            let allSettlementWindowsFound = payload.settlementWindows.length == windowsData.length
            let allSettlementWindowsClosed = true
            let settlementWindow
        end note
        loop w IN windowsData
            note right of SSAPI #lightgray
                settlementWindow = windowsData[w]
                if (settlementWindow.state != 'CLOSED') {
                    allSettlementWindowsClosed = false
                }
            end note
        end loop
    end

    alt allSettlementWindowsFound && allSettlementWindowsClosed
        SSAPI ->SETTLE_DAO: Create settlement\n<color #FF0000><b>Error code:</b> 2001</color>
        activate SETTLE_DAO
        group <color #blue>DB TRANSACTION</color>
            note right of SETTLE_DAO #lightgray
                let **transactionTimestamp** = now()
            end note

            SETTLE_DAO -> DB: Insert new settlement
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlement** (reason, createdDate)
                VALUES ({payload.reason}, {transactionTimestamp})
            end hnote
            SETTLE_DAO <- - DB: Return **settlementId**
            deactivate DB

            SETTLE_DAO -> DB: Associate settlement windows with the settlement
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementSettlementWindow** (settlementId, settlementWindowId, createdDate)
                VALUES ({settlementId}, {payload.settlementWindows.idList}, {transactionTimestamp})
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: Populate settlementTransferParticipant with aggregated data
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementTransferParticipant**
                       (settlementId, settlementWindowId, participantCurrencyId,
                        transferParticipantRoleTypeId, ledgerEntryTypeId, amount, createdDate)
                SELECT ssw.settlementId, ssw.settlementWindowId, tp.participantCurrencyId, 
                       tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId, SUM(tp.amount),
                       {transactionTimestamp}
                FROM **settlementSettlementWindow** ssw
                JOIN **transferFulfilment** AS tf
                ON tf.settlementWindowId = ssw.settlementWindowId
                JOIN **transferStateChange** AS tsc
                ON tsc.transferId = tf.transferId 
                AND tsc.transferStateId = ‘COMMITTED’
                JOIN **transferParticipant** AS tp
                ON tp.transferId = tf.transferId
                WHERE ssw.settlementId = {settlementId}
                GROUP BY ssw.settlementWindowId, tp.participantCurrencyId, 
                         tp.transferParticipantRoleTypeId, tp.ledgerEntryTypeId
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: Populate settlementParticipantCurrency with aggregated data
            activate DB
            hnote over DB #lightyellow
                INSERT INTO settlementParticipantCurrency
                       (settlementId, participantCurrencyId, createdDate, netAmount)
                SELECT settlementId, participantCurrencyId, {transactionTimestamp},
                SUM(CASE
                    WHEN stp.transferParticipantRoleTypeId = {PAYER_DFSP} 
                        AND stp.ledgerEntryTypeId = {PRINCIPLE_VALUE} THEN amount
                    WHEN stp.transferParticipantRoleTypeId = {PAYEE_DFSP} 
                        AND stp.ledgerEntryTypeId = {PRINCIPLE_VALUE} THEN -amount
                    WHEN stp.ledgerEntryTypeId = {INTERCHANGE_FEE} THEN -amount
                    WHEN stp.ledgerEntryTypeId = {HUB_FEE} THEN amount END)
                FROM settlementTransferParticipant AS stp
                WHERE settlementId = {settlementId}
                GROUP BY settlementId, participantCurrencyId
            end hnote
            SETTLE_DAO <- - DB: Return inserted **settlementParticipantCurrencyIdList**
            deactivate DB

            SETTLE_DAO -> DB: Insert initial settlement accounts state 'PENDING_SETTLEMENT'
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementParticipantCurrencyStateChange**
                       (settlementParticipantCurrencyId, settlementStateId, reason, createdDate)
                VALUES ({settlementParticipantCurrencyIdList}, 'PENDING_SETTLEMENT',
                       {payload.reason}, {transactionTimestamp})
            end hnote
            SETTLE_DAO <- - DB: Return inserted **settlementParticipantCurrencyStateChangeIdList**
            deactivate DB
            SETTLE_DAO -> SETTLE_DAO: Merge settlementParticipantCurrencyStateChangeIdList\nto settlementParticipantCurrencyIdList in order to\nissue the following update in one knex command

            SETTLE_DAO -> DB: Update pointers to current state change ids
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementParticipantCurrency**
                SET currentStateChangeId = {settlementParticipantCurrencyStateChangeIdList}
                WHERE settlementParticipantCurrencyId = {settlementParticipantCurrencyIdList}
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: Insert new state for settlementWindow 'PENDING_SETTLEMENT'
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementWindowStateChange**
                       (settlementWindowId, settlementWindowStateId, reason, createdDate)
                VALUES ({payload.settlementWindows.idList}, 'PENDING_SETTLEMENT',
                       {payload.reason}, {transactionTimestamp})
            end hnote
            SETTLE_DAO <- - DB: Return inserted **settlementWindowStateChangeIdList**
            deactivate DB

            SETTLE_DAO -> SETTLE_DAO: Merge settlementWindowStateChangeIdList\nto payload.settlementWindows.idList

            SETTLE_DAO -> DB: Update pointers to current state change ids
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlementWindow**
                SET currentStateChangeId = {settlementWindowStateChangeIdList}
                WHERE settlementParticipantCurrencyId = {payload.settlementWindows.idList}
            end hnote
            deactivate DB

            SETTLE_DAO -> DB: Insert initial state for settlement 'PENDING_SETTLEMENT'
            activate DB
            hnote over DB #lightyellow
                INSERT INTO **settlementStateChange**
                       (settlementId, settlementStateId, reason, createdDate)
                VALUES ({settlementId}, ‘PENDING_SETTLEMENT’,
                       {payload.reason}, {transactionTimestamp})
            end hnote
            SETTLE_DAO <- - DB: Return **settlementStateChangeId**
            deactivate DB

            SETTLE_DAO -> DB: Update pointer to current state change id
            activate DB
            hnote over DB #lightyellow
                UPDATE **settlement**
                SET currentStateChangeId = {settlementStateChangeId}
                WHERE settlementId = {settlementId}
            end hnote
            deactivate DB
        end

        SETTLE_DAO -> DB: Select account data for response
        activate DB
        hnote over DB #lightyellow
            SELECT pc.participantId, spc.participantCurrencyId, spc.netAmount, pc.currencyId
            FROM **settlementParticipantCurrency** spc
            JOIN **participantCurrency** pc
            ON pc.participantCurrencyId = spc.participantCurrencyId
            WHERE spc.settlementId = {settlementId}
        end hnote
        SETTLE_DAO <- - DB: Return **accountData**
        deactivate DB

        SSAPI <- - SETTLE_DAO: Construct and return result
        deactivate SETTLE_DAO
        note left of SSAPI #yellow
            {
                "id": settlementId,
                "state": "PENDING_SETTLEMENT",
                "settlementWindows": [
                    {
                        "id": windowsData.settlementWindowIdList,
                        "state": "PENDING_SETTLEMENT",
                        "reason": payload.reason,
                        "createdDate": windowsData.createdDateList,
                        "changedDate": transactionTimestamp
                    }
                ],
                "participants": [
                    {
                        "id": accountData.participantId,
                        "accounts": [
                            {
                                "id": accountData.participantCurrencyId,
                                "state": "PENDING_SETTLEMENT",
                                "reason": payload.reason,
                                "netSettlementAmount": {
                                    "amount": accountData.netAmount,
                                    "currency": accountData.currencyId
                                }
                            }
                        ]
                    }
                ]
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 201 (Created)
    else
        note right of SSAPI #lightgray
            Log ERROR event
        end note
        note left of SSAPI #yellow
            {
                errorInformation: {
                    "errorCode": <integer>,
                    "errorDescription": "Client error description"
                }
            }
        end note
        OPERATOR <- - SSAPI: Respond HTTP - 4xx (Client error)
        deactivate SSAPI
        deactivate OPERATOR
    end
end
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.6
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>