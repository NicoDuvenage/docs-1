<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2967px" preserveAspectRatio="none" style="width:2041px;height:2967px;" version="1.1" viewBox="0 0 2041 2967" width="2041px" zoomAndPan="magnify"><defs><filter height="300%" id="ff165vsbphrxs" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="282" x="880.5" y="23.5352">2.1.1. Fulfil Handler Consume (Success)</text><rect fill="#FFFFE0" height="2921.8516" style="stroke: #A80036; stroke-width: 1.0;" width="1864.5" x="29" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="910.75" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="79" y="195.9082"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="2754.5645" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="386" y="126.2871"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1009" y="2654.6992"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1292.5" y="2753.2754"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="201.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425.5" y="514.0137"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="136.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425.5" y="874.3613"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="122.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425.5" y="1278.6191"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="121.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425.5" y="1483.4824"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="137.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425.5" y="1700.9668"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="958.7109" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425.5" y="1923.1406"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1430.5" y="2105.6934"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1836.5" y="592.9453"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1836.5" y="903.9824"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1836.5" y="1308.2402"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1836.5" y="1513.1035"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1836.5" y="1730.2773"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1836.5" y="1952.4512"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1836.5" y="2135.0039"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="2740.5645" style="stroke: #000000; stroke-width: 2.0;" width="2017" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="2709.2539" style="stroke: #000000; stroke-width: 2.0;" width="1997" x="23" y="157.5977"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="513.5" x="301.5" y="241.2188"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="493.5" x="311.5" y="265.5293"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="92.2422" style="stroke: #000000; stroke-width: 2.0;" width="912.5" x="311.5" y="361.4609"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="948.4688" style="stroke: #000000; stroke-width: 2.0;" width="1718.5" x="291.5" y="467.7031"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="588.1211" style="stroke: #000000; stroke-width: 2.0;" width="1667.5" x="301.5" y="821.0508"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="105.5527" style="stroke: #000000; stroke-width: 2.0;" width="702.5" x="311.5" y="1026.5352"/><rect fill="#FFFFFF" height="88.5762" style="stroke: none; stroke-width: 1.0;" width="1667.5" x="301.5" y="1139.0879"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="334" x="311.5" y="1161.043"/><rect fill="#FFFFFF" height="181.5078" style="stroke: none; stroke-width: 1.0;" width="1667.5" x="301.5" y="1227.6641"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="1375.4141" style="stroke: #000000; stroke-width: 2.0;" width="1655.5" x="291.5" y="1430.1719"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="183.8633" style="stroke: #000000; stroke-width: 2.0;" width="1608.5" x="311.5" y="1662.6563"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="938.0664" style="stroke: #000000; stroke-width: 2.0;" width="1635.5" x="301.5" y="1860.5195"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1615.5" x="311.5" y="1884.8301"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="167.8633" style="stroke: #000000; stroke-width: 2.0;" width="1609.5" x="311.5" y="2067.3828"/><rect fill="#FFFFFF" height="105.5762" style="stroke: none; stroke-width: 1.0;" width="1635.5" x="301.5" y="2693.0098"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="76.6211" style="stroke: #000000; stroke-width: 2.0;" width="1069.5" x="311.5" y="2714.9648"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="1997" x="23" y="2812.5859"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="84" x2="84" y1="116.2871" y2="2890.8516"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="390.5" x2="390.5" y1="116.2871" y2="2890.8516"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1014" x2="1014" y1="116.2871" y2="2890.8516"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1161" x2="1161" y1="116.2871" y2="2890.8516"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1297" x2="1297" y1="116.2871" y2="2890.8516"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1430" x2="1430" y1="116.2871" y2="2890.8516"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1841.5" x2="1841.5" y1="116.2871" y2="2890.8516"/><rect fill="#FEFECE" filter="url(#ff165vsbphrxs)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="37" y="76.7988"/><rect fill="#FEFECE" filter="url(#ff165vsbphrxs)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="33" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="40" y="101.334">Fulfil-Topic</text><rect fill="#FEFECE" filter="url(#ff165vsbphrxs)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="37" y="2889.8516"/><rect fill="#FEFECE" filter="url(#ff165vsbphrxs)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="33" y="2893.8516"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="40" y="2914.3867">Fulfil-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="133" x="321.5" y="113.334">Fulfil Event Handler</text><ellipse cx="391" cy="83.7988" fill="#FEFECE" filter="url(#ff165vsbphrxs)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="387,71.7988,393,66.7988,391,71.7988,393,76.7988,387,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="133" x="321.5" y="2903.3867">Fulfil Event Handler</text><ellipse cx="391" cy="2922.3398" fill="#FEFECE" filter="url(#ff165vsbphrxs)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="387,2910.3398,393,2905.3398,391,2910.3398,393,2915.3398,387,2910.3398" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#ff165vsbphrxs)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="933" y="76.7988"/><rect fill="#FEFECE" filter="url(#ff165vsbphrxs)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="929" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="936" y="101.334">Position-Topic-dfsp2</text><rect fill="#FEFECE" filter="url(#ff165vsbphrxs)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="933" y="2889.8516"/><rect fill="#FEFECE" filter="url(#ff165vsbphrxs)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="929" y="2893.8516"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="936" y="2914.3867">Position-Topic-dfsp2</text><rect fill="#FEFECE" filter="url(#ff165vsbphrxs)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1113" y="76.7988"/><rect fill="#FEFECE" filter="url(#ff165vsbphrxs)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1109" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1116" y="101.334">Event-Topic</text><rect fill="#FEFECE" filter="url(#ff165vsbphrxs)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1113" y="2889.8516"/><rect fill="#FEFECE" filter="url(#ff165vsbphrxs)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1109" y="2893.8516"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1116" y="2914.3867">Event-Topic</text><rect fill="#FEFECE" filter="url(#ff165vsbphrxs)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1228" y="76.7988"/><rect fill="#FEFECE" filter="url(#ff165vsbphrxs)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1224" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1231" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#ff165vsbphrxs)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1228" y="2889.8516"/><rect fill="#FEFECE" filter="url(#ff165vsbphrxs)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1224" y="2893.8516"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1231" y="2914.3867">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1381" y="113.334">Transfer DAO</text><ellipse cx="1430.5" cy="83.7988" fill="#FEFECE" filter="url(#ff165vsbphrxs)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1418.5" x2="1442.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1381" y="2903.3867">Transfer DAO</text><ellipse cx="1430.5" cy="2922.3398" fill="#FEFECE" filter="url(#ff165vsbphrxs)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1418.5" x2="1442.5" y1="2936.3398" y2="2936.3398"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1793.5" y="113.334">Central Store</text><path d="M1823.5,63.7988 C1823.5,53.7988 1841.5,53.7988 1841.5,53.7988 C1841.5,53.7988 1859.5,53.7988 1859.5,63.7988 L1859.5,89.7988 C1859.5,99.7988 1841.5,99.7988 1841.5,99.7988 C1841.5,99.7988 1823.5,99.7988 1823.5,89.7988 L1823.5,63.7988 " fill="#FEFECE" filter="url(#ff165vsbphrxs)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1823.5,63.7988 C1823.5,73.7988 1841.5,73.7988 1841.5,73.7988 C1841.5,73.7988 1859.5,73.7988 1859.5,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1793.5" y="2903.3867">Central Store</text><path d="M1823.5,2916.3398 C1823.5,2906.3398 1841.5,2906.3398 1841.5,2906.3398 C1841.5,2906.3398 1859.5,2906.3398 1859.5,2916.3398 L1859.5,2942.3398 C1859.5,2952.3398 1841.5,2952.3398 1841.5,2952.3398 C1841.5,2952.3398 1823.5,2952.3398 1823.5,2942.3398 L1823.5,2916.3398 " fill="#FEFECE" filter="url(#ff165vsbphrxs)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1823.5,2916.3398 C1823.5,2926.3398 1841.5,2926.3398 1841.5,2926.3398 C1841.5,2926.3398 1859.5,2926.3398 1859.5,2916.3398 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="79" y="195.9082"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="2754.5645" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="386" y="126.2871"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1009" y="2654.6992"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1292.5" y="2753.2754"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="201.4844" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425.5" y="514.0137"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="136.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425.5" y="874.3613"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="122.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425.5" y="1278.6191"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="121.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425.5" y="1483.4824"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="137.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425.5" y="1700.9668"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="958.7109" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1425.5" y="1923.1406"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1430.5" y="2105.6934"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1836.5" y="592.9453"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1836.5" y="903.9824"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1836.5" y="1308.2402"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1836.5" y="1513.1035"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1836.5" y="1730.2773"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1836.5" y="1952.4512"/><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1836.5" y="2135.0039"/><path d="M13,133.2871 L282,133.2871 L282,140.2871 L272,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2740.5645" style="stroke: #000000; stroke-width: 2.0;" width="2017" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="28" y="146.8555">Fulfil Handler Consume (Success)</text><path d="M23,157.5977 L85,157.5977 L85,164.5977 L75,174.5977 L23,174.5977 L23,157.5977 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="2709.2539" style="stroke: #000000; stroke-width: 2.0;" width="1997" x="23" y="157.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="171.166">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="149" x="100" y="170.2324">[Consume Single Message]</text><polygon fill="#A80036" points="100,191.9082,90,195.9082,100,199.9082,96,195.9082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="94" x2="385" y1="195.9082" y2="195.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="106" y="191.4766">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="119" y="191.4766">Consume Prepare event message for Payer</text><path d="M301.5,241.2188 L385.5,241.2188 L385.5,248.2188 L375.5,258.2188 L301.5,258.2188 L301.5,241.2188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="513.5" x="301.5" y="241.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="316.5" y="254.7871">break</text><path d="M311.5,265.5293 L453.5,265.5293 L453.5,272.5293 L443.5,282.5293 L311.5,282.5293 L311.5,265.5293 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="493.5" x="311.5" y="265.5293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="326.5" y="279.0977">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="438" y1="319.4609" y2="319.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="438" x2="438" y1="319.4609" y2="332.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="397" x2="438" y1="332.4609" y2="332.4609"/><polygon fill="#A80036" points="407,328.4609,397,332.4609,407,336.4609,403,332.4609" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="403" y="307.0635">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="377" x="416" y="299.4082">Validate event - Rule: type == 'fulfil' &amp;&amp; action == 'commit'</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="416" y="314.7188">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="500" y="314.7188">2001</text><path d="M311.5,361.4609 L526.5,361.4609 L526.5,368.4609 L516.5,378.4609 L311.5,378.4609 L311.5,361.4609 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="92.2422" style="stroke: #000000; stroke-width: 2.0;" width="912.5" x="311.5" y="361.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="326.5" y="375.0293">Persist Event Information</text><polygon fill="#A80036" points="1149.5,395.7715,1159.5,399.7715,1149.5,403.7715,1153.5,399.7715" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="1155.5" y1="399.7715" y2="399.7715"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="403" y="395.3398">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="416" y="395.3398">Publish event information</text><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="40.6211" style="stroke: #000000; stroke-width: 2.0;" width="894.5" x="318.5" y="408.082"/><polygon fill="#EEEEEE" points="318.5,408.082,382.5,408.082,382.5,415.082,372.5,425.082,318.5,425.082,318.5,408.082" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="331.5" y="422.6504">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="668.75" y="441.6504">Event Handler Consume {9.1.0.}</text><path d="M291.5,467.7031 L638.5,467.7031 L638.5,474.7031 L628.5,484.7031 L291.5,484.7031 L291.5,467.7031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="948.4688" style="stroke: #000000; stroke-width: 2.0;" width="1718.5" x="291.5" y="467.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="302" x="306.5" y="481.2715">Validate Transfer Fulfilment Duplicate Check</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="443" y1="501.3242" y2="501.3242"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="443" x2="443" y1="501.3242" y2="514.3242"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="402" x2="443" y1="514.3242" y2="514.3242"/><polygon fill="#A80036" points="412,510.3242,402,514.3242,412,518.3242,408,514.3242" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="408" y="496.582">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="421" y="496.582">Generate transferFulfilmentId</text><polygon fill="#A80036" points="1413.5,559.3242,1423.5,563.3242,1413.5,567.3242,1417.5,563.3242" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="1419.5" y1="563.3242" y2="563.3242"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="403" y="551.5479">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="411" x="416" y="543.8926">Request to retrieve Transfer Fulfilment message hash (if it exists)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="416" y="559.2031">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="493" y="559.2031">2003</text><polygon fill="#A80036" points="1824.5,588.9453,1834.5,592.9453,1824.5,596.9453,1828.5,592.9453" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1435.5" x2="1830.5" y1="592.9453" y2="592.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1442.5" y="588.5137">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="327" x="1455.5" y="588.5137">Request Transfer fulfilment duplicate message hash</text><polygon fill="#FFFFE0" filter="url(#ff165vsbphrxs)" points="1693,606.2559,1990,606.2559,2000,632.2559,1990,659.2559,1693,659.2559,1683,632.2559,1693,606.2559" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="1695" y="622.8242">SELET transferId, hash</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="252" x="1695" y="638.1348">FROM transferFulfilmentDuplicateCheck</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="293" x="1695" y="653.4453">WHERE transferId = payload.transfer.transferId</text><polygon fill="#A80036" points="1446.5,682.1875,1436.5,686.1875,1446.5,690.1875,1442.5,686.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1440.5" x2="1840.5" y1="686.1875" y2="686.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1452.5" y="681.7559">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="1465.5" y="681.7559">Return hash if it exists</text><polygon fill="#A80036" points="407,711.498,397,715.498,407,719.498,403,715.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="401" x2="1429.5" y1="715.498" y2="715.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="413" y="711.0664">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="330" x="426" y="711.0664">Return list of transfer fulfil message hash if it exists</text><polygon fill="#A80036" points="1149.5,740.8086,1159.5,744.8086,1149.5,748.8086,1153.5,744.8086" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="1155.5" y1="744.8086" y2="744.8086"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="403" y="740.377">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="416" y="740.377">Publish event information</text><rect fill="#FFFFFF" filter="url(#ff165vsbphrxs)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="458" x="318.5" y="753.1191"/><polygon fill="#EEEEEE" points="318.5,753.1191,382.5,753.1191,382.5,760.1191,372.5,770.1191,318.5,770.1191,318.5,753.1191" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="331.5" y="767.6875">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="450" x="324.5" y="786.6875">Validate message.content.headers.FSPIOP_SIGNATURE {seq-fulfil-2.1.4}</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="324.5" y="801.998">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="408.5" y="801.998">2001</text><path d="M301.5,821.0508 L363.5,821.0508 L363.5,828.0508 L353.5,838.0508 L301.5,838.0508 L301.5,821.0508 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="588.1211" style="stroke: #000000; stroke-width: 2.0;" width="1667.5" x="301.5" y="821.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="316.5" y="834.6191">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="209" x="378.5" y="833.6855">[Transfer Fulfil exists, hash matches]</text><polygon fill="#A80036" points="1413.5,870.3613,1423.5,874.3613,1413.5,878.3613,1417.5,874.3613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="1419.5" y1="874.3613" y2="874.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="862.585">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="360" x="425" y="854.9297">Request to retrieve Transfer Fulfilment and Transfer state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="425" y="870.2402">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="502" y="870.2402">2003</text><polygon fill="#A80036" points="1824.5,899.9824,1834.5,903.9824,1824.5,907.9824,1828.5,903.9824" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1435.5" x2="1830.5" y1="903.9824" y2="903.9824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1442.5" y="899.5508">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="360" x="1464.5" y="899.5508">Request to retrieve Transfer Fulfilment and Transfer state</text><polygon fill="#FFFFE0" filter="url(#ff165vsbphrxs)" points="1776,917.293,1907,917.293,1917,936.293,1907,955.293,1776,955.293,1766,936.293,1776,917.293" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="1778" y="933.8613">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1778" y="949.1719">transferStateChange</text><polygon fill="#A80036" points="1446.5,977.9141,1436.5,981.9141,1446.5,985.9141,1442.5,981.9141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1440.5" x2="1840.5" y1="981.9141" y2="981.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1452.5" y="977.4824">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="1474.5" y="977.4824">Return Transfer Fulfilment and Transfer state</text><polygon fill="#A80036" points="407,1007.2246,397,1011.2246,407,1015.2246,403,1011.2246" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="401" x2="1429.5" y1="1011.2246" y2="1011.2246"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413" y="1006.793">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="435" y="1006.793">Return Transfer Fulfilment and Transfer state</text><path d="M311.5,1026.5352 L395.5,1026.5352 L395.5,1033.5352 L385.5,1043.5352 L311.5,1043.5352 L311.5,1026.5352 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="105.5527" style="stroke: #000000; stroke-width: 2.0;" width="702.5" x="311.5" y="1026.5352"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="326.5" y="1040.1035">break</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="438" y1="1111.0879" y2="1111.0879"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="438" x2="438" y1="1111.0879" y2="1124.0879"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="397" x2="438" y1="1124.0879" y2="1124.0879"/><polygon fill="#A80036" points="407,1120.0879,397,1124.0879,407,1128.0879,403,1124.0879" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="1083.3799">14</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="102" x="425" y="1060.4141">Error handling:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="467" x="531" y="1060.4141">If transferState is ['COMMITTED', 'ABORTED'] and transferFulfilment.isValid</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="405" x="425" y="1075.7246">then send notification to Payee and Payer with complete transfer</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="175" x="425" y="1091.0352">else if not 'RESERVED' throw</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="604" y="1091.0352">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="681" y="1091.0352">2001</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="333" x="425" y="1106.3457">else ignore and allow normal processing to complete</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="301.5" x2="1969" y1="1140.0879" y2="1140.0879"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="215" x="306.5" y="1150.7227">[Transfer exists, hash does not match]</text><path d="M311.5,1161.043 L395.5,1161.043 L395.5,1168.043 L385.5,1178.043 L311.5,1178.043 L311.5,1161.043 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="334" x="311.5" y="1161.043"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="326.5" y="1174.6113">break</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="230" x="410.5" y="1173.6777">[If the transferFulfilment.isValid = false]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="438" y1="1199.6641" y2="1199.6641"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="438" x2="438" y1="1199.6641" y2="1212.6641"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="397" x2="438" y1="1212.6641" y2="1212.6641"/><polygon fill="#A80036" points="407,1208.6641,397,1212.6641,407,1216.6641,403,1212.6641" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="1194.9219">15</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="425" y="1194.9219">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="502" y="1194.9219">3100</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="301.5" x2="1969" y1="1228.6641" y2="1228.6641"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="168" x="306.5" y="1239.2988">[Transfer hash does not exist]</text><polygon fill="#A80036" points="1413.5,1274.6191,1423.5,1278.6191,1413.5,1282.6191,1417.5,1278.6191" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="1419.5" y1="1278.6191" y2="1278.6191"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="1266.8428">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="425" y="1259.1875">Request to persist transfer hash</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="425" y="1274.498">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="509" y="1274.498">2003</text><polygon fill="#A80036" points="1824.5,1304.2402,1834.5,1308.2402,1824.5,1312.2402,1828.5,1308.2402" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1435.5" x2="1830.5" y1="1308.2402" y2="1308.2402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1442.5" y="1303.8086">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="76" x="1464.5" y="1303.8086">Persist hash</text><polygon fill="#FFFFE0" filter="url(#ff165vsbphrxs)" points="1733,1351.5508,1949,1351.5508,1959,1362.5508,1949,1374.5508,1733,1374.5508,1723,1362.5508,1733,1351.5508" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="1735" y="1368.1191">transferFulfilmentDuplicateCheck</text><polygon fill="#A80036" points="407,1396.8613,397,1400.8613,407,1404.8613,403,1400.8613" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="401" x2="1429.5" y1="1400.8613" y2="1400.8613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413" y="1396.4297">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="435" y="1396.4297">Return success</text><path d="M291.5,1430.1719 L605.5,1430.1719 L605.5,1437.1719 L595.5,1447.1719 L291.5,1447.1719 L291.5,1430.1719 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1375.4141" style="stroke: #000000; stroke-width: 2.0;" width="1655.5" x="291.5" y="1430.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="269" x="306.5" y="1443.7402">Validate and persist Transfer Fulfilment</text><polygon fill="#A80036" points="1413.5,1479.4824,1423.5,1483.4824,1413.5,1487.4824,1417.5,1483.4824" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="1419.5" y1="1483.4824" y2="1483.4824"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="1471.7061">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="425" y="1464.0508">Request information for the validate checks</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="425" y="1479.3613">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="502" y="1479.3613">2001</text><polygon fill="#A80036" points="1824.5,1509.1035,1834.5,1513.1035,1824.5,1517.1035,1828.5,1513.1035" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1435.5" x2="1830.5" y1="1513.1035" y2="1513.1035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1442.5" y="1508.6719">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="1464.5" y="1508.6719">Fetch from database</text><polygon fill="#A80036" points="1446.5,1538.4141,1436.5,1542.4141,1446.5,1546.4141,1442.5,1542.4141" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1440.5" x2="1840.5" y1="1542.4141" y2="1542.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1452.5" y="1537.9824">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1478.5" y="1537.9824"/><polygon fill="#FFFFE0" filter="url(#ff165vsbphrxs)" points="1815,1555.7246,1868,1555.7246,1878,1566.7246,1868,1578.7246,1815,1578.7246,1805,1566.7246,1815,1555.7246" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1817" y="1572.293">transfer</text><polygon fill="#A80036" points="407,1601.0352,397,1605.0352,407,1609.0352,403,1605.0352" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="401" x2="1429.5" y1="1605.0352" y2="1605.0352"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413" y="1600.6035">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="435" y="1600.6035">Return transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="438" y1="1634.6563" y2="1634.6563"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="438" x2="438" y1="1634.6563" y2="1647.6563"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="397" x2="438" y1="1647.6563" y2="1647.6563"/><polygon fill="#A80036" points="407,1643.6563,397,1647.6563,407,1651.6563,403,1647.6563" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="1629.9141">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="487" x="425" y="1629.9141">Validate that Transfer.ilpCondition = SHA-256(payload.transfer.ilpFulfilment)</text><path d="M311.5,1662.6563 L471.5,1662.6563 L471.5,1669.6563 L461.5,1679.6563 L311.5,1679.6563 L311.5,1662.6563 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="183.8633" style="stroke: #000000; stroke-width: 2.0;" width="1608.5" x="311.5" y="1662.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="115" x="326.5" y="1676.2246">Persist fulfilment</text><polygon fill="#A80036" points="1413.5,1696.9668,1423.5,1700.9668,1413.5,1704.9668,1417.5,1700.9668" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="1419.5" y1="1700.9668" y2="1700.9668"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="1696.5352">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="425" y="1696.5352">In all cases persist fulfilment</text><polygon fill="#A80036" points="1824.5,1726.2773,1834.5,1730.2773,1824.5,1734.2773,1828.5,1730.2773" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1435.5" x2="1830.5" y1="1730.2773" y2="1730.2773"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1442.5" y="1725.8457">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1464.5" y="1725.8457">Persist to database</text><polygon fill="#FFFFE0" filter="url(#ff165vsbphrxs)" points="1783,1773.5879,1900,1773.5879,1910,1792.5879,1900,1811.5879,1783,1811.5879,1773,1792.5879,1783,1773.5879" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="1785" y="1790.1563">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="1785" y="1805.4668">transferExtension</text><polygon fill="#A80036" points="407,1834.209,397,1838.209,407,1842.209,403,1838.209" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="401" x2="1429.5" y1="1838.209" y2="1838.209"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413" y="1833.7773">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="435" y="1833.7773">Return success</text><path d="M301.5,1860.5195 L363.5,1860.5195 L363.5,1867.5195 L353.5,1877.5195 L301.5,1877.5195 L301.5,1860.5195 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="938.0664" style="stroke: #000000; stroke-width: 2.0;" width="1635.5" x="301.5" y="1860.5195"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="316.5" y="1874.0879">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="116" x="378.5" y="1873.1543">[Validate successful]</text><path d="M311.5,1884.8301 L767.5,1884.8301 L767.5,1891.8301 L757.5,1901.8301 L311.5,1901.8301 L311.5,1884.8301 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="168.5527" style="stroke: #000000; stroke-width: 2.0;" width="1615.5" x="311.5" y="1884.8301"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="411" x="326.5" y="1898.3984">Persist Transfer State (with transferState='RECEIVED-FULFIL')</text><polygon fill="#A80036" points="1413.5,1919.1406,1423.5,1923.1406,1413.5,1927.1406,1417.5,1923.1406" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="1419.5" y1="1923.1406" y2="1923.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="1918.709">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="425" y="1918.709">Request to persist transfer state</text><polygon fill="#A80036" points="1824.5,1948.4512,1834.5,1952.4512,1824.5,1956.4512,1828.5,1952.4512" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1435.5" x2="1830.5" y1="1952.4512" y2="1952.4512"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1442.5" y="1948.0195">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1464.5" y="1948.0195">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#ff165vsbphrxs)" points="1776,1995.7617,1907,1995.7617,1917,2006.7617,1907,2018.7617,1776,2018.7617,1766,2006.7617,1776,1995.7617" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1778" y="2012.3301">transferStateChange</text><polygon fill="#A80036" points="407,2041.0723,397,2045.0723,407,2049.0723,403,2045.0723" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="401" x2="1424.5" y1="2045.0723" y2="2045.0723"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413" y="2040.6406">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="435" y="2040.6406">Return success</text><path d="M311.5,2067.3828 L560.5,2067.3828 L560.5,2074.3828 L550.5,2084.3828 L311.5,2084.3828 L311.5,2067.3828 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="167.8633" style="stroke: #000000; stroke-width: 2.0;" width="1609.5" x="311.5" y="2067.3828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="204" x="326.5" y="2080.9512">Append to Settlement Window</text><polygon fill="#A80036" points="1418.5,2101.6934,1428.5,2105.6934,1418.5,2109.6934,1422.5,2105.6934" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="1424.5" y1="2105.6934" y2="2105.6934"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="2101.2617">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="385" x="425" y="2101.2617">Request to retrieve current/latest transfer settlement window</text><polygon fill="#A80036" points="1824.5,2131.0039,1834.5,2135.0039,1824.5,2139.0039,1828.5,2135.0039" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1440.5" x2="1830.5" y1="2135.0039" y2="2135.0039"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1447.5" y="2130.5723">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="1469.5" y="2130.5723">Fetch settlementWindowId</text><polygon fill="#A80036" points="1451.5,2160.3145,1441.5,2164.3145,1451.5,2168.3145,1447.5,2164.3145" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1445.5" x2="1840.5" y1="2164.3145" y2="2164.3145"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1457.5" y="2159.8828">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1483.5" y="2159.8828"/><polygon fill="#FFFFE0" filter="url(#ff165vsbphrxs)" points="1781,2177.625,1901,2177.625,1911,2188.625,1901,2200.625,1781,2200.625,1771,2188.625,1781,2177.625" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1783" y="2194.1934">settlementWindow</text><polygon fill="#A80036" points="407,2222.9355,397,2226.9355,407,2230.9355,403,2226.9355" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="401" x2="1424.5" y1="2226.9355" y2="2226.9355"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413" y="2222.5039">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="435" y="2222.5039">Return settlementWindowId to be appended</text><path d="M401,2247.2461 L401,2624.2461 L710,2624.2461 L710,2257.2461 L700,2247.2461 L401,2247.2461 " fill="#FFFF00" filter="url(#ff165vsbphrxs)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M700,2247.2461 L700,2257.2461 L710,2257.2461 L700,2247.2461 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="407" y="2264.8145">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="407" y="2280.125">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="423" y="2295.4355">id: &lt;ID&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="423" y="2310.7461">from: &lt;transferHeaders.FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="423" y="2326.0566">to: &lt;transferHeaders.FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="423" y="2341.3672">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="423" y="2356.6777">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="439" y="2371.9883">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="439" y="2387.2988">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="423" y="2402.6094">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="423" y="2417.9199">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="439" y="2433.2305">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="455" y="2448.541">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="455" y="2463.8516">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="455" y="2479.1621">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="455" y="2494.4727">action: commit,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="455" y="2509.7832">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="455" y="2525.0938">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="471" y="2540.4043">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="471" y="2555.7148">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="455" y="2571.0254">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="439" y="2586.3359">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="423" y="2601.6465">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="407" y="2616.957">}</text><polygon fill="#A80036" points="997,2650.6992,1007,2654.6992,997,2658.6992,1001,2654.6992" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="1003" y1="2654.6992" y2="2654.6992"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="2650.2676">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="425" y="2650.2676">Route &amp; Publish Position event for Payee</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="301.5" x2="1937" y1="2694.0098" y2="2694.0098"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="306.5" y="2704.6445">[Validate Fulfil Transfer not successful]</text><path d="M311.5,2714.9648 L395.5,2714.9648 L395.5,2721.9648 L385.5,2731.9648 L311.5,2731.9648 L311.5,2714.9648 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="76.6211" style="stroke: #000000; stroke-width: 2.0;" width="1069.5" x="311.5" y="2714.9648"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="326.5" y="2728.5332">break</text><polygon fill="#A80036" points="1280.5,2749.2754,1290.5,2753.2754,1280.5,2757.2754,1284.5,2753.2754" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="1286.5" y1="2753.2754" y2="2753.2754"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="2748.8438">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="286" x="425" y="2748.8438">Route &amp; Publish Notification event for Payee f</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="2020" y1="2813.5859" y2="2813.5859"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="151" x="28" y="2824.2207">[Consume Batch Messages]</text><path d="M163,2832.541 L163,2857.541 L377,2857.541 L377,2842.541 L367,2832.541 L163,2832.541 " fill="#ADD8E6" filter="url(#ff165vsbphrxs)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M367,2832.541 L367,2842.541 L377,2842.541 L367,2832.541 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="169" y="2850.1094">To be delivered by future story</text><!--
@startuml
title 2.1.1. Fulfil Handler Consume (Success)
autonumber
collections "Fulfil-Topic" as TOPIC_FULFIL
control "Fulfil Event Handler" as FULF_HANDLER
collections "Event-Topic" as TOPIC_EVENT
collections "Position-Topic-dfsp2" as TOPIC_POSITION_DFSP2
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Transfer DAO" as TRANS_DAO
database "Central Store" as DB
box "Central Service" #LightYellow
    participant TOPIC_FULFIL
    participant FULF_HANDLER
    participant TOPIC_POSITION_DFSP2
    participant TOPIC_EVENT
    participant TOPIC_NOTIFICATIONS
    participant TRANS_DAO
    participant DB
end box
activate FULF_HANDLER
group Fulfil Handler Consume (Success)
    alt Consume Single Message
        TOPIC_FULFIL <- FULF_HANDLER: Consume Prepare event message for Payer
        activate TOPIC_FULFIL
        deactivate TOPIC_FULFIL
        break
            group Validate Event
                FULF_HANDLER <-> FULF_HANDLER: Validate event - Rule: type == 'fulfil' && action == 'commit'\n<color #FF0000><b>Error codes:</b> 2001</color>
            end
        end
        group Persist Event Information
            FULF_HANDLER -> TOPIC_EVENT: Publish event information
            ref over FULF_HANDLER, TOPIC_EVENT :  Event Handler Consume {9.1.0.}
        end
        group Validate Transfer Fulfilment Duplicate Check
            FULF_HANDLER -> FULF_HANDLER: Generate transferFulfilmentId
            activate TRANS_DAO
            FULF_HANDLER -> TRANS_DAO: Request to retrieve Transfer Fulfilment message hash (if it exists)\n<color #FF0000><b>Error code:</b> 2003</color>
            TRANS_DAO -> DB: Request Transfer fulfilment duplicate message hash
            hnote over DB #lightyellow
                SELET transferId, hash
                FROM transferFulfilmentDuplicateCheck
                WHERE transferId = payload.transfer.transferId
            end note
            activate DB
            TRANS_DAO <- - DB: Return hash if it exists
            deactivate DB
            TRANS_DAO - -> FULF_HANDLER: Return list of transfer fulfil message hash if it exists
            deactivate TRANS_DAO
            FULF_HANDLER -> TOPIC_EVENT: Publish event information
            ref over FULF_HANDLER, FULF_HANDLER : Validate message.content.headers.FSPIOP_SIGNATURE {seq-fulfil-2.1.4}\n<color #FF0000><b>Error codes:</b> 2001</color>
            alt Transfer Fulfil exists, hash matches
                FULF_HANDLER -> TRANS_DAO: Request to retrieve Transfer Fulfilment and Transfer state\n<color #FF0000><b>Error code:</b> 2003</color>
                activate TRANS_DAO
                TRANS_DAO -> DB: Request to retrieve Transfer Fulfilment and Transfer state
                hnote over DB #lightyellow
                    transferFulfilment
                    transferStateChange
                end note
                activate DB
                TRANS_DAO <- - DB: Return Transfer Fulfilment and Transfer state
                deactivate DB
                TRANS_DAO - -> FULF_HANDLER: Return Transfer Fulfilment and Transfer state
                deactivate TRANS_DAO
                break
                    FULF_HANDLER <-> FULF_HANDLER: <color #FF0000><b>Error handling:</b></color> If transferState is ['COMMITTED', 'ABORTED'] and transferFulfilment.isValid \nthen send notification to Payee and Payer with complete transfer\nelse if not 'RESERVED' throw <color #FF0000><b>Error code:</b> 2001</color>\nelse ignore and allow normal processing to complete
                end
            else Transfer exists, hash does not match
                break If the transferFulfilment.isValid = false
                    FULF_HANDLER <-> FULF_HANDLER: <color #FF0000><b>Error code:</b> 3100</color>
                end
            else Transfer hash does not exist
                FULF_HANDLER -> TRANS_DAO: Request to persist transfer hash\n<color #FF0000><b>Error codes:</b> 2003</color>
                activate TRANS_DAO
                TRANS_DAO -> DB: Persist hash
                hnote over DB #lightyellow
                    transferFulfilmentDuplicateCheck
                end note
                activate DB
                deactivate DB
                TRANS_DAO - -> FULF_HANDLER: Return success
                deactivate TRANS_DAO
            end
        end
        group Validate and persist Transfer Fulfilment
            FULF_HANDLER -> TRANS_DAO: Request information for the validate checks\n<color #FF0000><b>Error code:</b> 2001</color>
            activate TRANS_DAO
            TRANS_DAO -> DB: Fetch from database
            activate DB

            DB - -> TRANS_DAO
            deactivate DB
            hnote over DB #lightyellow
                transfer
            end note
            FULF_HANDLER <- - TRANS_DAO: Return transfer
            deactivate TRANS_DAO
            FULF_HANDLER ->FULF_HANDLER: Validate that Transfer.ilpCondition = SHA-256(payload.transfer.ilpFulfilment)

            group Persist fulfilment
                FULF_HANDLER -> TRANS_DAO: In all cases persist fulfilment
                activate TRANS_DAO
                TRANS_DAO -> DB: Persist to database
                activate DB
                deactivate DB
                hnote over DB #lightyellow
                    transferFulfilment
                    transferExtension
                end note
                FULF_HANDLER <- - TRANS_DAO: Return success
                deactivate TRANS_DAO
            end
            alt Validate successful
                group Persist Transfer State (with transferState='RECEIVED-FULFIL')
                    FULF_HANDLER -> TRANS_DAO: Request to persist transfer state
                    activate TRANS_DAO
                    TRANS_DAO -> DB: Persist transfer state
                    activate DB
                    hnote over DB #lightyellow
                        transferStateChange
                    end note
                    deactivate DB
                    TRANS_DAO - -> FULF_HANDLER: Return success
                end
                group Append to Settlement Window
                    FULF_HANDLER -> TRANS_DAO: Request to retrieve current/latest transfer settlement window
                    activate TRANS_DAO
                    TRANS_DAO -> DB: Fetch settlementWindowId
                    activate DB
                    DB - -> TRANS_DAO
                    hnote over DB #lightyellow
                        settlementWindow
                    end note
                    deactivate DB
                    FULF_HANDLER <- - TRANS_DAO: Return settlementWindowId to be appended
                    deactivate TRANS_DAO
                end


                note right of FULF_HANDLER #yellow
                    Message:
                    {
                        id: <ID>,
                        from: <transferHeaders.FSPIOP-Source>,
                        to: <transferHeaders.FSPIOP-Destination>,
                        type: application/json,
                        content: {
                            headers: <transferHeaders>,
                            payload: <transferMessage>
                        },
                        metadata: {
                            event: {
                                id: <uuid>,
                                responseTo: <previous.uuid>,
                                type: position,
                                action: commit,
                                createdAt: <timestamp>,
                                state: {
                                    status: "success",
                                    code: 0
                                }
                            }
                        }
                    }
                end note
                FULF_HANDLER -> TOPIC_POSITION_DFSP2: Route & Publish Position event for Payee
                activate TOPIC_POSITION_DFSP2
                deactivate TOPIC_POSITION_DFSP2
            else Validate Fulfil Transfer not successful
                break
                    FULF_HANDLER -> TOPIC_NOTIFICATIONS: Route & Publish Notification event for Payee f
                    activate TOPIC_NOTIFICATIONS
                    deactivate TOPIC_NOTIFICATIONS
                end
            end
        end
    else Consume Batch Messages
        note left of FULF_HANDLER #lightblue
            To be delivered by future story
        end note
    end
end
deactivate FULF_HANDLER
@enduml

PlantUML version 1.2018.01(Sun Jan 28 20:08:22 SAST 2018)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_152-release-1136-b20
Operating System: Mac OS X
OS Version: 10.13.5
Default Encoding: UTF-8
Language: en
Country: ZA
--></g></svg>