<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="3328px" preserveAspectRatio="none" style="width:2013px;height:3328px;" version="1.1" viewBox="0 0 2013 3328" width="2013px" zoomAndPan="magnify"><defs><filter height="300%" id="fmo6nrdbb5xff" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="282" x="866.5" y="23.5352">2.1.1. Fulfil Handler Consume (Success)</text><rect fill="#FFFFE0" height="3282.5332" style="stroke: #A80036; stroke-width: 1.0;" width="1849.5" x="29" y="34.4883"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="903.25" y="47.0566">Central Service</text><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="79" y="196.2188"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="3115.2461" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="386" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="994" y="3015.6914"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1277.5" y="3114.2676"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1410.5" y="681.1875"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1410.5" y="944.293"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1410.5" y="1516.748"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1410.5" y="1721.6113"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1410.5" y="1993.7168"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="137.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1410.5" y="2228.5117"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="776.5371" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1410.5" y="2465.9961"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1821.5" y="710.498"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1821.5" y="973.6035"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1821.5" y="1546.0586"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1821.5" y="1750.9219"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1821.5" y="2023.0273"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1821.5" y="2257.8223"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1821.5" y="2495.3066"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="3101.2461" style="stroke: #000000; stroke-width: 2.0;" width="1989" x="13" y="133.2871"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="3069.9355" style="stroke: #000000; stroke-width: 2.0;" width="1969" x="23" y="157.5977"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="513.5" x="301.5" y="241.2188"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="493.5" x="311.5" y="265.5293"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="92.2422" style="stroke: #000000; stroke-width: 2.0;" width="897.5" x="311.5" y="361.4609"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="103.2422" style="stroke: #000000; stroke-width: 2.0;" width="1054.5" x="311.5" y="467.7031"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="1068.7344" style="stroke: #000000; stroke-width: 2.0;" width="1700.5" x="281.5" y="584.9453"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="756.3184" style="stroke: #000000; stroke-width: 2.0;" width="1662.5" x="291.5" y="890.3613"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="362.3262" style="stroke: #000000; stroke-width: 2.0;" width="1074.5" x="301.5" y="1095.8457"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="263.5" x="311.5" y="1120.1563"/><rect fill="#FFFFFF" height="107.1973" style="stroke: none; stroke-width: 1.0;" width="1074.5" x="301.5" y="1186.7773"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="78.2422" style="stroke: #000000; stroke-width: 2.0;" width="1054.5" x="311.5" y="1208.7324"/><rect fill="#FFFFFF" height="88.5762" style="stroke: none; stroke-width: 1.0;" width="1074.5" x="301.5" y="1293.9746"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="234.5" x="311.5" y="1315.9297"/><rect fill="#FFFFFF" height="75.6211" style="stroke: none; stroke-width: 1.0;" width="1074.5" x="301.5" y="1382.5508"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="348.5" x="311.5" y="1391.5508"/><rect fill="#FFFFFF" height="181.5078" style="stroke: none; stroke-width: 1.0;" width="1662.5" x="291.5" y="1465.1719"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="1498.5879" style="stroke: #000000; stroke-width: 2.0;" width="1640.5" x="291.5" y="1667.6797"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1614.5" x="301.5" y="1915.4746"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="213.7949" style="stroke: #000000; stroke-width: 2.0;" width="1594.5" x="311.5" y="1939.7852"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="199.1738" style="stroke: #000000; stroke-width: 2.0;" width="1593.5" x="311.5" y="2174.5801"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="771.5137" style="stroke: #000000; stroke-width: 2.0;" width="1620.5" x="301.5" y="2387.7539"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="183.8633" style="stroke: #000000; stroke-width: 2.0;" width="1600.5" x="311.5" y="2412.0645"/><rect fill="#FFFFFF" height="105.5762" style="stroke: none; stroke-width: 1.0;" width="1620.5" x="301.5" y="3053.6914"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="76.6211" style="stroke: #000000; stroke-width: 2.0;" width="1054.5" x="311.5" y="3075.6465"/><rect fill="#FFFFFF" height="54.2656" style="stroke: none; stroke-width: 1.0;" width="1969" x="23" y="3173.2676"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="84" x2="84" y1="116.2871" y2="3251.5332"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="390.5" x2="390.5" y1="116.2871" y2="3251.5332"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="999" x2="999" y1="116.2871" y2="3251.5332"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1146" x2="1146" y1="116.2871" y2="3251.5332"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1282" x2="1282" y1="116.2871" y2="3251.5332"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1415" x2="1415" y1="116.2871" y2="3251.5332"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1826.5" x2="1826.5" y1="116.2871" y2="3251.5332"/><rect fill="#FEFECE" filter="url(#fmo6nrdbb5xff)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="37" y="76.7988"/><rect fill="#FEFECE" filter="url(#fmo6nrdbb5xff)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="33" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="40" y="101.334">Fulfil-Topic</text><rect fill="#FEFECE" filter="url(#fmo6nrdbb5xff)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="37" y="3250.5332"/><rect fill="#FEFECE" filter="url(#fmo6nrdbb5xff)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="94" x="33" y="3254.5332"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="80" x="40" y="3275.0684">Fulfil-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="133" x="321.5" y="113.334">Fulfil Event Handler</text><ellipse cx="391" cy="83.7988" fill="#FEFECE" filter="url(#fmo6nrdbb5xff)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="387,71.7988,393,66.7988,391,71.7988,393,76.7988,387,71.7988" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="133" x="321.5" y="3264.0684">Fulfil Event Handler</text><ellipse cx="391" cy="3283.0215" fill="#FEFECE" filter="url(#fmo6nrdbb5xff)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><polygon fill="#A80036" points="387,3271.0215,393,3266.0215,391,3271.0215,393,3276.0215,387,3271.0215" style="stroke: #A80036; stroke-width: 1.0;"/><rect fill="#FEFECE" filter="url(#fmo6nrdbb5xff)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="918" y="76.7988"/><rect fill="#FEFECE" filter="url(#fmo6nrdbb5xff)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="914" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="921" y="101.334">Position-Topic-dfsp2</text><rect fill="#FEFECE" filter="url(#fmo6nrdbb5xff)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="918" y="3250.5332"/><rect fill="#FEFECE" filter="url(#fmo6nrdbb5xff)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="162" x="914" y="3254.5332"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="148" x="921" y="3275.0684">Position-Topic-dfsp2</text><rect fill="#FEFECE" filter="url(#fmo6nrdbb5xff)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1098" y="76.7988"/><rect fill="#FEFECE" filter="url(#fmo6nrdbb5xff)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1094" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1101" y="101.334">Event-Topic</text><rect fill="#FEFECE" filter="url(#fmo6nrdbb5xff)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1098" y="3250.5332"/><rect fill="#FEFECE" filter="url(#fmo6nrdbb5xff)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="1094" y="3254.5332"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="1101" y="3275.0684">Event-Topic</text><rect fill="#FEFECE" filter="url(#fmo6nrdbb5xff)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1213" y="76.7988"/><rect fill="#FEFECE" filter="url(#fmo6nrdbb5xff)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1209" y="80.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1216" y="101.334">Notification-Topic</text><rect fill="#FEFECE" filter="url(#fmo6nrdbb5xff)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1213" y="3250.5332"/><rect fill="#FEFECE" filter="url(#fmo6nrdbb5xff)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="139" x="1209" y="3254.5332"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="125" x="1216" y="3275.0684">Notification-Topic</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1366" y="113.334">Transfer DAO</text><ellipse cx="1415.5" cy="83.7988" fill="#FEFECE" filter="url(#fmo6nrdbb5xff)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1403.5" x2="1427.5" y1="97.7988" y2="97.7988"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="93" x="1366" y="3264.0684">Transfer DAO</text><ellipse cx="1415.5" cy="3283.0215" fill="#FEFECE" filter="url(#fmo6nrdbb5xff)" rx="12" ry="12" style="stroke: #A80036; stroke-width: 2.0;"/><line style="stroke: #A80036; stroke-width: 2.0;" x1="1403.5" x2="1427.5" y1="3297.0215" y2="3297.0215"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1778.5" y="113.334">Central Store</text><path d="M1808.5,63.7988 C1808.5,53.7988 1826.5,53.7988 1826.5,53.7988 C1826.5,53.7988 1844.5,53.7988 1844.5,63.7988 L1844.5,89.7988 C1844.5,99.7988 1826.5,99.7988 1826.5,99.7988 C1826.5,99.7988 1808.5,99.7988 1808.5,89.7988 L1808.5,63.7988 " fill="#FEFECE" filter="url(#fmo6nrdbb5xff)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1808.5,63.7988 C1808.5,73.7988 1826.5,73.7988 1826.5,73.7988 C1826.5,73.7988 1844.5,73.7988 1844.5,63.7988 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="90" x="1778.5" y="3264.0684">Central Store</text><path d="M1808.5,3277.0215 C1808.5,3267.0215 1826.5,3267.0215 1826.5,3267.0215 C1826.5,3267.0215 1844.5,3267.0215 1844.5,3277.0215 L1844.5,3303.0215 C1844.5,3313.0215 1826.5,3313.0215 1826.5,3313.0215 C1826.5,3313.0215 1808.5,3313.0215 1808.5,3303.0215 L1808.5,3277.0215 " fill="#FEFECE" filter="url(#fmo6nrdbb5xff)" style="stroke: #000000; stroke-width: 1.5;"/><path d="M1808.5,3277.0215 C1808.5,3287.0215 1826.5,3287.0215 1826.5,3287.0215 C1826.5,3287.0215 1844.5,3287.0215 1844.5,3277.0215 " fill="none" style="stroke: #000000; stroke-width: 1.5;"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="79" y="196.2188"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="3115.2461" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="386" y="126.2871"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="994" y="3015.6914"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1277.5" y="3114.2676"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1410.5" y="681.1875"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="136.5527" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1410.5" y="944.293"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="121.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1410.5" y="1516.748"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="121.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1410.5" y="1721.6113"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="151.8633" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1410.5" y="1993.7168"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="137.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1410.5" y="2228.5117"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="776.5371" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1410.5" y="2465.9961"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="93.2422" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1821.5" y="710.498"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="77.9316" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1821.5" y="973.6035"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1821.5" y="1546.0586"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="62.6211" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1821.5" y="1750.9219"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="29.3105" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1821.5" y="2023.0273"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1821.5" y="2257.8223"/><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="30" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1821.5" y="2495.3066"/><path d="M13,133.2871 L282,133.2871 L282,140.2871 L272,150.2871 L13,150.2871 L13,133.2871 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3101.2461" style="stroke: #000000; stroke-width: 2.0;" width="1989" x="13" y="133.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="28" y="146.8555">Fulfil Handler Consume (Success)</text><path d="M23,157.5977 L85,157.5977 L85,164.5977 L75,174.5977 L23,174.5977 L23,157.5977 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="3069.9355" style="stroke: #000000; stroke-width: 2.0;" width="1969" x="23" y="157.5977"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="38" y="171.166">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="149" x="100" y="170.2324">[Consume Single Message]</text><polygon fill="#A80036" points="100,192.2188,90,196.2188,100,200.2188,96,196.2188" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="94" x2="385" y1="196.2188" y2="196.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="106" y="191.4766">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="265" x="119" y="191.4766">Consume Prepare event message for Payer</text><path d="M301.5,241.2188 L385.5,241.2188 L385.5,248.2188 L375.5,258.2188 L301.5,258.2188 L301.5,241.2188 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="106.2422" style="stroke: #000000; stroke-width: 2.0;" width="513.5" x="301.5" y="241.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="316.5" y="254.7871">break</text><path d="M311.5,265.5293 L453.5,265.5293 L453.5,272.5293 L443.5,282.5293 L311.5,282.5293 L311.5,265.5293 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="74.9316" style="stroke: #000000; stroke-width: 2.0;" width="493.5" x="311.5" y="265.5293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="97" x="326.5" y="279.0977">Validate Event</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="438" y1="319.4609" y2="319.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="438" x2="438" y1="319.4609" y2="332.4609"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="397" x2="438" y1="332.4609" y2="332.4609"/><polygon fill="#A80036" points="407,328.4609,397,332.4609,407,336.4609,403,332.4609" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="403" y="307.0635">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="377" x="416" y="299.4082">Validate event - Rule: type == 'fulfil' &amp;&amp; action == 'commit'</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="416" y="314.7188">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="500" y="314.7188">2001</text><path d="M311.5,361.4609 L526.5,361.4609 L526.5,368.4609 L516.5,378.4609 L311.5,378.4609 L311.5,361.4609 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="92.2422" style="stroke: #000000; stroke-width: 2.0;" width="897.5" x="311.5" y="361.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="170" x="326.5" y="375.0293">Persist Event Information</text><polygon fill="#A80036" points="1134.5,396.082,1144.5,400.082,1134.5,404.082,1138.5,400.082" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="1140.5" y1="400.082" y2="400.082"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="403" y="395.3398">3</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="162" x="416" y="395.3398">Publish event information</text><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="40.6211" style="stroke: #000000; stroke-width: 2.0;" width="879.5" x="318.5" y="408.082"/><polygon fill="#EEEEEE" points="318.5,408.082,382.5,408.082,382.5,415.082,372.5,425.082,318.5,425.082,318.5,408.082" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="331.5" y="422.6504">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="198" x="661.25" y="441.6504">Event Handler Consume {9.1.0.}</text><path d="M311.5,467.7031 L533.5,467.7031 L533.5,474.7031 L523.5,484.7031 L311.5,484.7031 L311.5,467.7031 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="103.2422" style="stroke: #000000; stroke-width: 2.0;" width="1054.5" x="311.5" y="467.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="177" x="326.5" y="481.2715">Validate FSPIOP-Signature</text><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="1036.5" x="318.5" y="510.0137"/><polygon fill="#EEEEEE" points="318.5,510.0137,382.5,510.0137,382.5,517.0137,372.5,527.0137,318.5,527.0137,318.5,510.0137" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="331.5" y="524.582">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="218" x="583.25" y="543.582">Validate message.content.headers.</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="118" x="801.25" y="543.582">FSPIOP-Signature</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="167" x="923.25" y="543.582">{seq-signature-validation}</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="583.25" y="558.8926">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="667.25" y="558.8926">2001</text><path d="M281.5,584.9453 L628.5,584.9453 L628.5,591.9453 L618.5,601.9453 L281.5,601.9453 L281.5,584.9453 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1068.7344" style="stroke: #000000; stroke-width: 2.0;" width="1700.5" x="281.5" y="584.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="302" x="296.5" y="598.5137">Validate Transfer Fulfilment Duplicate Check</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="438" y1="623.5664" y2="623.5664"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="438" x2="438" y1="623.5664" y2="636.5664"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="397" x2="438" y1="636.5664" y2="636.5664"/><polygon fill="#A80036" points="407,632.5664,397,636.5664,407,640.5664,403,636.5664" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="403" y="618.8242">4</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="216" x="416" y="618.8242">Generate transferFulfilmentId uuid</text><polygon fill="#A80036" points="1398.5,677.1875,1408.5,681.1875,1398.5,685.1875,1402.5,681.1875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="1404.5" y1="681.1875" y2="681.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="403" y="668.79">5</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="369" x="416" y="661.1348">Request to retrieve transfer fulfilment hashes by transferId</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="416" y="676.4453">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="493" y="676.4453">2003</text><polygon fill="#A80036" points="1809.5,706.498,1819.5,710.498,1809.5,714.498,1813.5,710.498" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1420.5" x2="1815.5" y1="710.498" y2="710.498"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1427.5" y="705.7559">6</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="341" x="1440.5" y="705.7559">Request Transfer fulfilment duplicate message hashes</text><polygon fill="#FFFFE0" filter="url(#fmo6nrdbb5xff)" points="1691,723.498,1962,723.498,1972,749.498,1962,776.498,1691,776.498,1681,749.498,1691,723.498" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="1693" y="740.0664">SELET transferId, hash</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="36" x="1693" y="755.377">FROM</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="227" x="1733" y="755.377">transferFulfilmentDuplicateCheck</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="239" x="1693" y="770.6875">WHERE transferId = request.params.id</text><polygon fill="#A80036" points="1431.5,799.7402,1421.5,803.7402,1431.5,807.7402,1427.5,803.7402" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1425.5" x2="1825.5" y1="803.7402" y2="803.7402"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="1437.5" y="798.998">7</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="144" x="1450.5" y="798.998">Return existing hashes</text><polygon fill="#A80036" points="407,829.0508,397,833.0508,407,837.0508,403,833.0508" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="401" x2="1414.5" y1="833.0508" y2="833.0508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="413" y="828.3086">8</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="299" x="426" y="828.3086">Return (list of) transfer fulfil messages hash(es)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="438" y1="862.3613" y2="862.3613"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="438" x2="438" y1="862.3613" y2="875.3613"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="397" x2="438" y1="875.3613" y2="875.3613"/><polygon fill="#A80036" points="407,871.3613,397,875.3613,407,879.3613,403,875.3613" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="9" x="403" y="857.6191">9</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="571" x="416" y="857.6191">Loop the list of returned hashes and compare each entry with the calculated message hash</text><path d="M291.5,890.3613 L353.5,890.3613 L353.5,897.3613 L343.5,907.3613 L291.5,907.3613 L291.5,890.3613 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="756.3184" style="stroke: #000000; stroke-width: 2.0;" width="1662.5" x="291.5" y="890.3613"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="306.5" y="903.9297">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="87" x="368.5" y="902.9961">[Hash matched]</text><polygon fill="#A80036" points="1398.5,940.293,1408.5,944.293,1398.5,948.293,1402.5,944.293" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="1404.5" y1="944.293" y2="944.293"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="931.8955">10</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="360" x="425" y="924.2402">Request to retrieve Transfer Fulfilment and Transfer state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="425" y="939.5508">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="502" y="939.5508">2003</text><polygon fill="#A80036" points="1809.5,969.6035,1819.5,973.6035,1809.5,977.6035,1813.5,973.6035" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1420.5" x2="1815.5" y1="973.6035" y2="973.6035"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1427.5" y="968.8613">11</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="360" x="1449.5" y="968.8613">Request to retrieve Transfer Fulfilment and Transfer state</text><polygon fill="#FFFFE0" filter="url(#fmo6nrdbb5xff)" points="1761,986.6035,1892,986.6035,1902,1005.6035,1892,1024.6035,1761,1024.6035,1751,1005.6035,1761,986.6035" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="1763" y="1003.1719">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1763" y="1018.4824">transferStateChange</text><polygon fill="#A80036" points="1431.5,1047.5352,1421.5,1051.5352,1431.5,1055.5352,1427.5,1051.5352" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1425.5" x2="1825.5" y1="1051.5352" y2="1051.5352"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1437.5" y="1046.793">12</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="1459.5" y="1046.793">Return Transfer Fulfilment and Transfer state</text><polygon fill="#A80036" points="407,1076.8457,397,1080.8457,407,1084.8457,403,1080.8457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="401" x2="1414.5" y1="1080.8457" y2="1080.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413" y="1076.1035">13</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="283" x="435" y="1076.1035">Return Transfer Fulfilment and Transfer state</text><path d="M301.5,1095.8457 L363.5,1095.8457 L363.5,1102.8457 L353.5,1112.8457 L301.5,1112.8457 L301.5,1095.8457 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="362.3262" style="stroke: #000000; stroke-width: 2.0;" width="1074.5" x="301.5" y="1095.8457"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="316.5" y="1109.4141">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="185" x="378.5" y="1108.4805">[transferFulfilment.isValid == 0]</text><path d="M311.5,1120.1563 L395.5,1120.1563 L395.5,1127.1563 L385.5,1137.1563 L311.5,1137.1563 L311.5,1120.1563 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="263.5" x="311.5" y="1120.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="326.5" y="1133.7246">break</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="438" y1="1158.7773" y2="1158.7773"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="438" x2="438" y1="1158.7773" y2="1171.7773"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="397" x2="438" y1="1171.7773" y2="1171.7773"/><polygon fill="#A80036" points="407,1167.7773,397,1171.7773,407,1175.7773,403,1171.7773" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="1154.0352">14</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="102" x="425" y="1154.0352">Error handling:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="531" y="1154.0352">3105</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="301.5" x2="1376" y1="1187.7773" y2="1187.7773"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="254" x="306.5" y="1198.4121">[transferState IN ['COMMITTED', 'ABORTED']]</text><path d="M311.5,1208.7324 L395.5,1208.7324 L395.5,1215.7324 L385.5,1225.7324 L311.5,1225.7324 L311.5,1208.7324 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="78.2422" style="stroke: #000000; stroke-width: 2.0;" width="1054.5" x="311.5" y="1208.7324"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="326.5" y="1222.3008">break</text><rect fill="#FFFFFF" filter="url(#fmo6nrdbb5xff)" height="55.9316" style="stroke: #000000; stroke-width: 2.0;" width="1036.5" x="318.5" y="1226.043"/><polygon fill="#EEEEEE" points="318.5,1226.043,382.5,1226.043,382.5,1233.043,372.5,1243.043,318.5,1243.043,318.5,1226.043" style="stroke: #000000; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="331.5" y="1240.6113">ref</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="290" x="691.75" y="1259.6113">Send notification to Participant (Payee) {1.1.4.}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="695.75" y="1274.9219"/><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="301.5" x2="1376" y1="1294.9746" y2="1294.9746"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="177" x="306.5" y="1305.6094">[transferState NOT 'RESERVED']</text><path d="M311.5,1315.9297 L395.5,1315.9297 L395.5,1322.9297 L385.5,1332.9297 L311.5,1332.9297 L311.5,1315.9297 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="234.5" x="311.5" y="1315.9297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="326.5" y="1329.498">break</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="438" y1="1354.5508" y2="1354.5508"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="438" x2="438" y1="1354.5508" y2="1367.5508"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="397" x2="438" y1="1367.5508" y2="1367.5508"/><polygon fill="#A80036" points="407,1363.5508,397,1367.5508,407,1371.5508,403,1367.5508" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="1349.8086">15</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="425" y="1349.8086">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="502" y="1349.8086">2001</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="301.5" x2="1376" y1="1383.5508" y2="1383.5508"/><path d="M311.5,1391.5508 L395.5,1391.5508 L395.5,1398.5508 L385.5,1408.5508 L311.5,1408.5508 L311.5,1391.5508 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="59.6211" style="stroke: #000000; stroke-width: 2.0;" width="348.5" x="311.5" y="1391.5508"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="326.5" y="1405.1191">break</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="438" y1="1430.1719" y2="1430.1719"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="438" x2="438" y1="1430.1719" y2="1443.1719"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="397" x2="438" y1="1443.1719" y2="1443.1719"/><polygon fill="#A80036" points="407,1439.1719,397,1443.1719,407,1447.1719,403,1443.1719" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="1425.4297">16</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="223" x="425" y="1425.4297">Allow previous request to complete</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="291.5" x2="1954" y1="1466.1719" y2="1466.1719"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="109" x="296.5" y="1476.8066">[Hash not matched]</text><polygon fill="#A80036" points="1398.5,1512.748,1408.5,1516.748,1398.5,1520.748,1402.5,1516.748" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="1404.5" y1="1516.748" y2="1516.748"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="1504.3506">17</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="201" x="425" y="1496.6953">Request to persist transfer hash</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="80" x="425" y="1512.0059">Error codes:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="509" y="1512.0059">2003</text><polygon fill="#A80036" points="1809.5,1542.0586,1819.5,1546.0586,1809.5,1550.0586,1813.5,1546.0586" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1420.5" x2="1815.5" y1="1546.0586" y2="1546.0586"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1427.5" y="1541.3164">18</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="76" x="1449.5" y="1541.3164">Persist hash</text><polygon fill="#FFFFE0" filter="url(#fmo6nrdbb5xff)" points="1718,1589.0586,1934,1589.0586,1944,1600.0586,1934,1612.0586,1718,1612.0586,1708,1600.0586,1718,1589.0586" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="1720" y="1605.627">transferFulfilmentDuplicateCheck</text><polygon fill="#A80036" points="407,1634.6797,397,1638.6797,407,1642.6797,403,1638.6797" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="401" x2="1414.5" y1="1638.6797" y2="1638.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413" y="1633.9375">19</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="435" y="1633.9375">Return success</text><path d="M291.5,1667.6797 L605.5,1667.6797 L605.5,1674.6797 L595.5,1684.6797 L291.5,1684.6797 L291.5,1667.6797 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="1498.5879" style="stroke: #000000; stroke-width: 2.0;" width="1640.5" x="291.5" y="1667.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="269" x="306.5" y="1681.248">Validate and persist Transfer Fulfilment</text><polygon fill="#A80036" points="1398.5,1717.6113,1408.5,1721.6113,1398.5,1725.6113,1402.5,1721.6113" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="1404.5" y1="1721.6113" y2="1721.6113"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="1709.2139">20</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="275" x="425" y="1701.5586">Request information for the validate checks</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="425" y="1716.8691">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="502" y="1716.8691">2003</text><polygon fill="#A80036" points="1809.5,1746.9219,1819.5,1750.9219,1809.5,1754.9219,1813.5,1750.9219" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1420.5" x2="1815.5" y1="1750.9219" y2="1750.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1427.5" y="1746.1797">21</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="1449.5" y="1746.1797">Fetch from database</text><polygon fill="#FFFFE0" filter="url(#fmo6nrdbb5xff)" points="1800,1763.9219,1853,1763.9219,1863,1774.9219,1853,1786.9219,1800,1786.9219,1790,1774.9219,1800,1763.9219" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="1802" y="1780.4902">transfer</text><polygon fill="#A80036" points="1431.5,1809.543,1421.5,1813.543,1431.5,1817.543,1427.5,1813.543" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1425.5" x2="1825.5" y1="1813.543" y2="1813.543"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1437.5" y="1808.8008">22</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1463.5" y="1808.8008"/><polygon fill="#A80036" points="407,1838.8535,397,1842.8535,407,1846.8535,403,1842.8535" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="401" x2="1414.5" y1="1842.8535" y2="1842.8535"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413" y="1838.1113">23</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="94" x="435" y="1838.1113">Return transfer</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="438" y1="1887.4746" y2="1887.4746"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="438" x2="438" y1="1887.4746" y2="1900.4746"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="397" x2="438" y1="1900.4746" y2="1900.4746"/><polygon fill="#A80036" points="407,1896.4746,397,1900.4746,407,1904.4746,403,1900.4746" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="1875.0771">24</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="472" x="425" y="1867.4219">Validate that Transfer.ilpCondition = SHA-256 (content.payload.fulfilment)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="425" y="1882.7324">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="502" y="1882.7324">2001</text><path d="M301.5,1915.4746 L368.5,1915.4746 L368.5,1922.4746 L358.5,1932.4746 L301.5,1932.4746 L301.5,1915.4746 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="245.1055" style="stroke: #000000; stroke-width: 2.0;" width="1614.5" x="301.5" y="1915.4746"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="22" x="316.5" y="1929.043">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="240" x="383.5" y="1928.1094">[Transfer.ilpCondition validate successful]</text><path d="M311.5,1939.7852 L598.5,1939.7852 L598.5,1946.7852 L588.5,1956.7852 L311.5,1956.7852 L311.5,1939.7852 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="213.7949" style="stroke: #000000; stroke-width: 2.0;" width="1594.5" x="311.5" y="1939.7852"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="242" x="326.5" y="1953.3535">Request current Settlement Window</text><polygon fill="#A80036" points="1398.5,1989.7168,1408.5,1993.7168,1398.5,1997.7168,1402.5,1993.7168" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="1404.5" y1="1993.7168" y2="1993.7168"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="1981.3193">25</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="385" x="425" y="1973.6641">Request to retrieve current/latest transfer settlement window</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="425" y="1988.9746">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="502" y="1988.9746">2003</text><polygon fill="#A80036" points="1809.5,2019.0273,1819.5,2023.0273,1809.5,2027.0273,1813.5,2023.0273" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1420.5" x2="1815.5" y1="2023.0273" y2="2023.0273"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1427.5" y="2018.2852">26</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="1449.5" y="2018.2852">Fetch settlementWindowId</text><polygon fill="#A80036" points="1431.5,2048.3379,1421.5,2052.3379,1431.5,2056.3379,1427.5,2052.3379" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1425.5" x2="1825.5" y1="2052.3379" y2="2052.3379"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1437.5" y="2047.5957">27</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="0" x="1463.5" y="2047.5957"/><polygon fill="#FFFFE0" filter="url(#fmo6nrdbb5xff)" points="1766,2065.3379,1886,2065.3379,1896,2076.3379,1886,2088.3379,1766,2088.3379,1756,2076.3379,1766,2065.3379" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="116" x="1768" y="2081.9063">settlementWindow</text><polygon fill="#A80036" points="407,2141.5801,397,2145.5801,407,2149.5801,403,2145.5801" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="401" x2="1414.5" y1="2145.5801" y2="2145.5801"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413" y="2125.5273">28</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="476" x="435" y="2110.2168">Return settlementWindowId to be appended during transferFulfilment insert</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="41" x="435" y="2125.5273">TODO</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="432" x="476" y="2125.5273">: During settlement design make sure transfers in 'RECEIVED-FULFIL'</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="305" x="435" y="2140.8379">state are updated to the next settlement window</text><path d="M311.5,2174.5801 L471.5,2174.5801 L471.5,2181.5801 L461.5,2191.5801 L311.5,2191.5801 L311.5,2174.5801 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="199.1738" style="stroke: #000000; stroke-width: 2.0;" width="1593.5" x="311.5" y="2174.5801"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="115" x="326.5" y="2188.1484">Persist fulfilment</text><polygon fill="#A80036" points="1398.5,2224.5117,1408.5,2228.5117,1398.5,2232.5117,1402.5,2228.5117" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="1404.5" y1="2228.5117" y2="2228.5117"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="2216.1143">29</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="497" x="425" y="2208.459">Persist fulfilment with the result of the above check (transferFulfilment.isValid)</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="425" y="2223.7695">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="502" y="2223.7695">2003</text><polygon fill="#A80036" points="1809.5,2253.8223,1819.5,2257.8223,1809.5,2261.8223,1813.5,2257.8223" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1420.5" x2="1815.5" y1="2257.8223" y2="2257.8223"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1427.5" y="2253.0801">30</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="1449.5" y="2253.0801">Persist to database</text><polygon fill="#FFFFE0" filter="url(#fmo6nrdbb5xff)" points="1768,2300.8223,1885,2300.8223,1895,2319.8223,1885,2338.8223,1768,2338.8223,1758,2319.8223,1768,2300.8223" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="1770" y="2317.3906">transferFulfilment</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="1770" y="2332.7012">transferExtension</text><polygon fill="#A80036" points="407,2361.7539,397,2365.7539,407,2369.7539,403,2365.7539" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="401" x2="1414.5" y1="2365.7539" y2="2365.7539"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413" y="2361.0117">31</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="435" y="2361.0117">Return success</text><path d="M301.5,2387.7539 L363.5,2387.7539 L363.5,2394.7539 L353.5,2404.7539 L301.5,2404.7539 L301.5,2387.7539 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="771.5137" style="stroke: #000000; stroke-width: 2.0;" width="1620.5" x="301.5" y="2387.7539"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="17" x="316.5" y="2401.3223">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="240" x="378.5" y="2400.3887">[Transfer.ilpCondition validate successful]</text><path d="M311.5,2412.0645 L767.5,2412.0645 L767.5,2419.0645 L757.5,2429.0645 L311.5,2429.0645 L311.5,2412.0645 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="183.8633" style="stroke: #000000; stroke-width: 2.0;" width="1600.5" x="311.5" y="2412.0645"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="411" x="326.5" y="2425.6328">Persist Transfer State (with transferState='RECEIVED-FULFIL')</text><polygon fill="#A80036" points="1398.5,2461.9961,1408.5,2465.9961,1398.5,2469.9961,1402.5,2465.9961" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="1404.5" y1="2465.9961" y2="2465.9961"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="2453.5986">32</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="202" x="425" y="2445.9434">Request to persist transfer state</text><text fill="#FF0000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="73" x="425" y="2461.2539">Error code:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="32" x="502" y="2461.2539">2003</text><polygon fill="#A80036" points="1809.5,2491.3066,1819.5,2495.3066,1809.5,2499.3066,1813.5,2495.3066" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1420.5" x2="1815.5" y1="2495.3066" y2="2495.3066"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="1427.5" y="2490.5645">33</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="1449.5" y="2490.5645">Persist transfer state</text><polygon fill="#FFFFE0" filter="url(#fmo6nrdbb5xff)" points="1761,2538.3066,1892,2538.3066,1902,2549.3066,1892,2561.3066,1761,2561.3066,1751,2549.3066,1761,2538.3066" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="127" x="1763" y="2554.875">transferStateChange</text><polygon fill="#A80036" points="407,2583.9277,397,2587.9277,407,2591.9277,403,2587.9277" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="401" x2="1409.5" y1="2587.9277" y2="2587.9277"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="413" y="2583.1855">34</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="95" x="435" y="2583.1855">Return success</text><path d="M401,2607.9277 L401,2984.9277 L710,2984.9277 L710,2617.9277 L700,2607.9277 L401,2607.9277 " fill="#FFFF00" filter="url(#fmo6nrdbb5xff)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M700,2607.9277 L700,2617.9277 L710,2617.9277 L700,2607.9277 " fill="#FFFF00" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="407" y="2625.4961">Message:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="407" y="2640.8066">{</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="58" x="423" y="2656.1172">id: &lt;ID&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="258" x="423" y="2671.4277">from: &lt;transferHeaders.FSPIOP-Source&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="272" x="423" y="2686.7383">to: &lt;transferHeaders.FSPIOP-Destination&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="143" x="423" y="2702.0488">type: application/json,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="60" x="423" y="2717.3594">content: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="181" x="439" y="2732.6699">headers: &lt;transferHeaders&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="180" x="439" y="2747.9805">payload: &lt;transferMessage&gt;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="8" x="423" y="2763.291">},</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="423" y="2778.6016">metadata: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="439" y="2793.9121">event: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="455" y="2809.2227">id: &lt;uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="191" x="455" y="2824.5332">responseTo: &lt;previous.uuid&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="91" x="455" y="2839.8438">type: position,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="99" x="455" y="2855.1543">action: commit,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="455" y="2870.4648">createdAt: &lt;timestamp&gt;,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="43" x="455" y="2885.7754">state: {</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="471" y="2901.0859">status: "success",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="46" x="471" y="2916.3965">code: 0</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="455" y="2931.707">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="439" y="2947.0176">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="423" y="2962.3281">}</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="407" y="2977.6387">}</text><polygon fill="#A80036" points="982,3011.6914,992,3015.6914,982,3019.6914,986,3015.6914" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="988" y1="3015.6914" y2="3015.6914"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="3010.9492">35</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="253" x="425" y="3010.9492">Route &amp; Publish Position event for Payee</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="301.5" x2="1922" y1="3054.6914" y2="3054.6914"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="224" x="306.5" y="3065.3262">[Validate Fulfil Transfer not successful]</text><path d="M311.5,3075.6465 L395.5,3075.6465 L395.5,3082.6465 L385.5,3092.6465 L311.5,3092.6465 L311.5,3075.6465 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="76.6211" style="stroke: #000000; stroke-width: 2.0;" width="1054.5" x="311.5" y="3075.6465"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="39" x="326.5" y="3089.2148">break</text><polygon fill="#A80036" points="1265.5,3110.2676,1275.5,3114.2676,1265.5,3118.2676,1269.5,3114.2676" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="396" x2="1271.5" y1="3114.2676" y2="3114.2676"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="18" x="403" y="3109.5254">36</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="277" x="425" y="3109.5254">Route &amp; Publish Notification event for Payee</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="23" x2="1992" y1="3174.2676" y2="3174.2676"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="151" x="28" y="3184.9023">[Consume Batch Messages]</text><path d="M163,3193.2227 L163,3218.2227 L377,3218.2227 L377,3203.2227 L367,3193.2227 L163,3193.2227 " fill="#ADD8E6" filter="url(#fmo6nrdbb5xff)" style="stroke: #A80036; stroke-width: 1.0;"/><path d="M367,3193.2227 L367,3203.2227 L377,3203.2227 L367,3193.2227 " fill="#ADD8E6" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="193" x="169" y="3210.791">To be delivered by future story</text><!--
@startuml
title 2.1.1. Fulfil Handler Consume (Success)
autonumber
collections "Fulfil-Topic" as TOPIC_FULFIL
control "Fulfil Event Handler" as FULF_HANDLER
collections "Event-Topic" as TOPIC_EVENT
collections "Position-Topic-dfsp2" as TOPIC_POSITION_DFSP2
collections "Notification-Topic" as TOPIC_NOTIFICATIONS
entity "Transfer DAO" as TRANS_DAO
database "Central Store" as DB
box "Central Service" #LightYellow
    participant TOPIC_FULFIL
    participant FULF_HANDLER
    participant TOPIC_POSITION_DFSP2
    participant TOPIC_EVENT
    participant TOPIC_NOTIFICATIONS
    participant TRANS_DAO
    participant DB
end box
activate FULF_HANDLER
group Fulfil Handler Consume (Success)
    alt Consume Single Message
        TOPIC_FULFIL <- FULF_HANDLER: Consume Prepare event message for Payer
        activate TOPIC_FULFIL
        deactivate TOPIC_FULFIL
        break
            group Validate Event
                FULF_HANDLER <-> FULF_HANDLER: Validate event - Rule: type == 'fulfil' && action == 'commit'\n<color #FF0000><b>Error codes:</b> 2001</color>
            end
        end
        group Persist Event Information
            FULF_HANDLER -> TOPIC_EVENT: Publish event information
            ref over FULF_HANDLER, TOPIC_EVENT:  Event Handler Consume {9.1.0.}
        end
        group Validate FSPIOP-Signature
            |||
            ref over FULF_HANDLER, TOPIC_NOTIFICATIONS: Validate message.content.headers.**FSPIOP-Signature** {seq-signature-validation} \n<color #FF0000><b>Error codes:</b> 2001</color>
        end
        group Validate Transfer Fulfilment Duplicate Check
            FULF_HANDLER -> FULF_HANDLER: Generate transferFulfilmentId uuid
            FULF_HANDLER -> TRANS_DAO: Request to retrieve transfer fulfilment hashes by transferId\n<color #FF0000><b>Error code:</b> 2003</color>
            activate TRANS_DAO
            TRANS_DAO -> DB: Request Transfer fulfilment duplicate message hashes
            hnote over DB #lightyellow
                SELET transferId, hash
                FROM **transferFulfilmentDuplicateCheck**
                WHERE transferId = request.params.id
            end note
            activate DB
            TRANS_DAO <- - DB: Return existing hashes
            deactivate DB
            TRANS_DAO - -> FULF_HANDLER: Return (list of) transfer fulfil messages hash(es)
            deactivate TRANS_DAO
            FULF_HANDLER -> FULF_HANDLER: Loop the list of returned hashes and compare each entry with the calculated message hash
            alt Hash matched
                FULF_HANDLER -> TRANS_DAO: Request to retrieve Transfer Fulfilment and Transfer state\n<color #FF0000><b>Error code:</b> 2003</color>
                activate TRANS_DAO
                TRANS_DAO -> DB: Request to retrieve Transfer Fulfilment and Transfer state
                hnote over DB #lightyellow
                    transferFulfilment
                    transferStateChange
                end note
                activate DB
                TRANS_DAO <- - DB: Return Transfer Fulfilment and Transfer state
                deactivate DB
                TRANS_DAO - -> FULF_HANDLER: Return Transfer Fulfilment and Transfer state
                deactivate TRANS_DAO
                alt transferFulfilment.isValid == 0
                    break
                        FULF_HANDLER <-> FULF_HANDLER: <color #FF0000><b>Error handling:</b> 3105</color>
                    end
                else transferState IN ['COMMITTED', 'ABORTED']
                    break
                        ref over FULF_HANDLER, TOPIC_NOTIFICATIONS: Send notification to Participant (Payee) {1.1.4.} \n
                    end
                else transferState NOT 'RESERVED'
                    break
                        FULF_HANDLER <-> FULF_HANDLER: <color #FF0000><b>Error code:</b> 2001</color>
                    end
                else
                    break
                        FULF_HANDLER <-> FULF_HANDLER: Allow previous request to complete
                    end
                end
            else Hash not matched
                FULF_HANDLER -> TRANS_DAO: Request to persist transfer hash\n<color #FF0000><b>Error codes:</b> 2003</color>
                activate TRANS_DAO
                TRANS_DAO -> DB: Persist hash
                hnote over DB #lightyellow
                    transferFulfilmentDuplicateCheck
                end note
                activate DB
                deactivate DB
                TRANS_DAO - -> FULF_HANDLER: Return success
                deactivate TRANS_DAO
            end
        end
        group Validate and persist Transfer Fulfilment
            FULF_HANDLER -> TRANS_DAO: Request information for the validate checks\n<color #FF0000><b>Error code:</b> 2003</color>
            activate TRANS_DAO
            TRANS_DAO -> DB: Fetch from database
            activate DB
            hnote over DB #lightyellow
                transfer
            end note
            DB - -> TRANS_DAO
            deactivate DB
            FULF_HANDLER <- - TRANS_DAO: Return transfer
            deactivate TRANS_DAO
            FULF_HANDLER ->FULF_HANDLER: Validate that Transfer.ilpCondition = SHA-256 (content.payload.fulfilment)\n<color #FF0000><b>Error code:</b> 2001</color>

            opt Transfer.ilpCondition validate successful
                group Request current Settlement Window
                    FULF_HANDLER -> TRANS_DAO: Request to retrieve current/latest transfer settlement window\n<color #FF0000><b>Error code:</b> 2003</color>
                    activate TRANS_DAO
                    TRANS_DAO -> DB: Fetch settlementWindowId
                    activate DB
                    DB - -> TRANS_DAO
                    hnote over DB #lightyellow
                        settlementWindow
                    end note
                    deactivate DB
                    FULF_HANDLER <- - TRANS_DAO: Return settlementWindowId to be appended during transferFulfilment insert\n**TODO**: During settlement design make sure transfers in 'RECEIVED-FULFIL'\nstate are updated to the next settlement window
                    deactivate TRANS_DAO
                end
            end

            group Persist fulfilment
                FULF_HANDLER -> TRANS_DAO: Persist fulfilment with the result of the above check (transferFulfilment.isValid)\n<color #FF0000><b>Error code:</b> 2003</color>
                activate TRANS_DAO
                TRANS_DAO -> DB: Persist to database
                activate DB
                deactivate DB
                hnote over DB #lightyellow
                    transferFulfilment
                    transferExtension
                end note
                FULF_HANDLER <- - TRANS_DAO: Return success
                deactivate TRANS_DAO
            end

            alt Transfer.ilpCondition validate successful
                group Persist Transfer State (with transferState='RECEIVED-FULFIL')
                    FULF_HANDLER -> TRANS_DAO: Request to persist transfer state\n<color #FF0000><b>Error code:</b> 2003</color>
                    activate TRANS_DAO
                    TRANS_DAO -> DB: Persist transfer state
                    activate DB
                    hnote over DB #lightyellow
                        transferStateChange
                    end note
                    deactivate DB
                    TRANS_DAO - -> FULF_HANDLER: Return success
                end



                note right of FULF_HANDLER #yellow
                    Message:
                    {
                        id: <ID>,
                        from: <transferHeaders.FSPIOP-Source>,
                        to: <transferHeaders.FSPIOP-Destination>,
                        type: application/json,
                        content: {
                            headers: <transferHeaders>,
                            payload: <transferMessage>
                        },
                        metadata: {
                            event: {
                                id: <uuid>,
                                responseTo: <previous.uuid>,
                                type: position,
                                action: commit,
                                createdAt: <timestamp>,
                                state: {
                                    status: "success",
                                    code: 0
                                }
                            }
                        }
                    }
                end note
                FULF_HANDLER -> TOPIC_POSITION_DFSP2: Route & Publish Position event for Payee
                activate TOPIC_POSITION_DFSP2
                deactivate TOPIC_POSITION_DFSP2
            else Validate Fulfil Transfer not successful
                break
                    FULF_HANDLER -> TOPIC_NOTIFICATIONS: Route & Publish Notification event for Payee
                    activate TOPIC_NOTIFICATIONS
                    deactivate TOPIC_NOTIFICATIONS
                end
            end
        end
    else Consume Batch Messages
        note left of FULF_HANDLER #lightblue
            To be delivered by future story
        end note
    end
end
deactivate FULF_HANDLER
@enduml

PlantUML version 1.2018.05(Sat May 05 23:00:17 EEST 2018)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Java Version: 1.8.0_131-b11
Operating System: Mac OS X
OS Version: 10.13.5
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>